<!doctype html><html lang=en-us data-theme=dark><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>Using DNS as C2 Communication - Evasive Techniques (Part 3) - archive://syrull</title><meta name=description content="Series Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1) Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2) (this one) Overview Following my last post about some evasion techniques that the Symbiote uses which I tried to recreate in their simplest form, this post will see how the Symbiote is communicating to the command and control C2 server.
Upon reading the article, we can see that the Symbiote uses the DNS Protocol to exfiltrate data out of the infected machine, the way that it does that is by chunking it into a bunch of A Resource Records (RR) that it sends through the UDP."><link rel=icon type=image/x-icon href=https://sy1.sh/favicon.ico><link rel=apple-touch-icon-precomposed href=https://sy1.sh/favicon.png><style>body{visibility:hidden;opacity:0}</style><noscript><style>body{visibility:visible;opacity:1}</style></noscript><link rel=stylesheet href=https://sy1.sh/css/style.min.7b484c18b5aa36260a07e6a3b45241486b220324ddf54305ab4258bf32342527.css integrity="sha256-e0hMGLWqNiYKB+ajtFJBSGsiAyTd9UMFq0JYvzI0JSc="><script src=https://sy1.sh/js/script.min.74bf1a3fcf1af396efa4acf3e660e876b61a2153ab9cbe1893ac24ea6d4f94ee.js type=text/javascript integrity="sha256-dL8aP88a85bvpKzz5mDodrYaIVOrnL4Yk6wk6m1PlO4="></script><meta property="og:title" content="Using DNS as C2 Communication - Evasive Techniques (Part 3)"><meta property="og:description" content="Series Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1) Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2) (this one) Overview Following my last post about some evasion techniques that the Symbiote uses which I tried to recreate in their simplest form, this post will see how the Symbiote is communicating to the command and control C2 server.
Upon reading the article, we can see that the Symbiote uses the DNS Protocol to exfiltrate data out of the infected machine, the way that it does that is by chunking it into a bunch of A Resource Records (RR) that it sends through the UDP."><meta property="og:type" content="article"><meta property="og:url" content="https://sy1.sh/posts/dns-c2-communcation/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-26T20:45:03+03:00"><meta property="article:modified_time" content="2022-10-26T20:45:03+03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using DNS as C2 Communication - Evasive Techniques (Part 3)"><meta name=twitter:description content="Series Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1) Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2) (this one) Overview Following my last post about some evasion techniques that the Symbiote uses which I tried to recreate in their simplest form, this post will see how the Symbiote is communicating to the command and control C2 server.
Upon reading the article, we can see that the Symbiote uses the DNS Protocol to exfiltrate data out of the infected machine, the way that it does that is by chunking it into a bunch of A Resource Records (RR) that it sends through the UDP."></head><body><a class=skip-main href=#main>Skip to main content</a><div class=container><header class=common-header><div class=header-top><h1 class=site-title><a href=/>archive://syrull</a></h1><ul class=social-icons><li><a href=https://github.com/syrull title=Github rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></li><li><a href=mailto:dganev@pm.me title=Email rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M464 64H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 4e2V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V4e2H48z"/></svg></span></a></li><li><a href="tg://resolve?domain=pwnm3rcury" title=Telegram rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"/></svg></span></a></li><li><a href=https://sy1.sh/index.xml title=RSS rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328.0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765.0 183.105.0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686.0 38.981.0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg></span></a></li></ul></div><nav><a href=https://sy1.sh/posts/ title=Archive>Archive</a>
<a href=https://sy1.sh/cv title=CV>CV</a></nav></header><main id=main tabindex=-1><article class="post h-entry"><div class=post-header><header><h1 class="p-name post-title">Using DNS as C2 Communication - Evasive Techniques (Part 3)</h1></header></div><div class="content e-content"><h2 id=series>Series
<span><a href=#series><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><ol><li><a href=https://sy1.sh/posts/dynamic-linker-hijacking-experiments/>Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1)</a></li><li><a href=https://sy1.sh/posts/dynamic-linker-hijacking-experiments-2/>Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2)</a></li><li>(this one)</li></ol><h2 id=overview>Overview
<span><a href=#overview><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><p>Following my last post about some evasion techniques that the <a href=https://blogs.blackberry.com/en/2022/06/symbiote-a-new-nearly-impossible-to-detect-linux-threat>Symbiote</a> uses which I tried to recreate in their simplest form, this post will see how the Symbiote is communicating to the command and control <a href=https://www.malwarepatrol.net/command-control-servers-c2-servers-fundamentals/>C2</a> server.</p><p>Upon reading the article, we can see that the Symbiote uses the DNS Protocol to exfiltrate data out of the infected machine, the way that it does that is by chunking it into a bunch of <a href=https://www.cloudflare.com/learning/dns/dns-records/dns-a-record/>A</a> Resource Records (RR) that it sends through the UDP. The <code>A</code> Record looks like this:</p><pre tabindex=0><code>{PACKET_NUMBER}.{MACHINE_ID}.{HEX_ENCODED_PAYLOAD}.{DOMAIN_NAME}
</code></pre><p>I will deliberately skip the whole authentication process that the malware uses, since it gets out of the scope of the post.</p><h2 id=why-dns-and-not-arbitrary-protocol>Why DNS and not {arbitrary protocol}?
<span><a href=#why-dns-and-not-arbitrary-protocol><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><p>DNS is being used in order to avoid/bypass the firewall rules and in some special scenarios that no TCP outgoing communication is possible.</p><p><a href=https://resources.infosecinstitute.com/topic/bypassing-security-products-via-dns-data-exfiltration/>Bypassing security products via DNS data exfiltration</a></p><h2 id=implementation>Implementation
<span><a href=#implementation><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><p>I will explain it briefly from the agent&rsquo;s point of view. We are sending the C2 server a beam (in a shape of a DNS request) every n seconds to check if there is a command for us to execute if we receive a non empty Answer with a <code>TXT</code> Record (containing a command such as <code>ls</code>) we execute that command and after we have the output of the command, we exfiltrate it back to the C2 Server. This happens by sending multiple DNS A record questions (chunks) back to the server. I used the same format that the Symbiote uses for the records.</p><p>Note: Each element of a domain name can contain up to 63 chars of information, a full domain name can contain 253 chars. <a href=https://stackoverflow.com/a/28918017>More info</a></p><p>After the server receives a request with the packet number and the total number of packets (that&rsquo;s the first part of the message) it starts building the output message that we will see after we receive all the packets (through the <code>{HEX_ENCODED_PAYLOAD}</code> part of the message).</p><h2 id=code--demo>Code / Demo
<span><a href=#code--demo><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><p><a href=https://github.com/syrull/dnsc2>Repository</a> - The repository is created for a starting point to improve/build upon.</p><p><img src=/dnsc2/demo.gif alt=DNSC2Demo></p><p>The repository contains both the agent and the server. When the server is being ran it sets the default handler <code>dns.HandleFunc(".", AgentHandler)</code> to handle any pattern for domain question this is for convenience, in some other cases you will want to specify some special handles.</p><h3 id=usage>Usage
<span><a href=#usage><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h3><ol><li>Start the server<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ go run main.go 127.0.0.1:8053 
</span></span></code></pre></div></li><li>Start the agent<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>$ go run ./agent/main.go
</span></span></code></pre></div></li><li>Execute commands on the server side shell (In the case below simple <code>dir</code>). Note that I type <code>cmd /C dir</code> - <a href=https://superuser.com/a/1246360>Why?</a><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>&gt;&lt;<span style=color:#f92672>((((</span>&gt; dns c2 by syl &lt;<span style=color:#f92672>))))</span>&gt;&lt;
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>dnsc2&gt; cmd /C dir
</span></span><span style=display:flex><span>Volume in drive C is OS
</span></span><span style=display:flex><span>Volume Serial Number is XXXX-XXXX
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Directory of C:\code\dnsc2\agent
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>10/28/2022  08:40 PM    &lt;DIR&gt;          .
</span></span><span style=display:flex><span>10/29/2022  11:03 PM    &lt;DIR&gt;          ..
</span></span><span style=display:flex><span>10/28/2022  08:40 PM               481 go.mod
</span></span><span style=display:flex><span>10/28/2022  08:40 PM             3,755 go.sum
</span></span><span style=display:flex><span>10/30/2022  12:37 PM             1,762 main.go
</span></span><span style=display:flex><span>            3 File(s)          5,998 bytes
</span></span><span style=display:flex><span>            2 Dir(s)  107,561,959,424 bytes free
</span></span></code></pre></div></li></ol><h2 id=conclusion>Conclusion
<span><a href=#conclusion><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><p>Please note that there could be some easier ways to do this, and some information can be wrong I did my best to research everything that I post here, if you find an error or if you think that something can be improved somewhere you can drop me a message!</p><h1 id=resources>Resources
<span><a href=#resources><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h1><ul><li><a href=https://blogs.blackberry.com/en/2022/06/symbiote-a-new-nearly-impossible-to-detect-linux-threat>https://blogs.blackberry.com/en/2022/06/symbiote-a-new-nearly-impossible-to-detect-linux-threat</a></li><li><a href=https://stackoverflow.com/a/28918017>https://stackoverflow.com/a/28918017</a></li><li><a href=https://www.cloudflare.com/learning/dns/what-is-dns/>https://www.cloudflare.com/learning/dns/what-is-dns/</a></li><li><a href=https://resources.infosecinstitute.com/topic/bypassing-security-products-via-dns-data-exfiltration/>https://resources.infosecinstitute.com/topic/bypassing-security-products-via-dns-data-exfiltration/</a></li></ul></div><div class=post-info><div class="post-date dt-published">2022-10-26</div><a class="post-hidden-url u-url" href=https://sy1.sh/posts/dns-c2-communcation/>https://sy1.sh/posts/dns-c2-communcation/</a>
<a href=https://sy1.sh class="p-name p-author post-hidden-author h-card" rel=me>Dimitar Ganev</a><div class=post-taxonomies></div></div></article><div class="pagination post-pagination"><div class="left pagination-item disabled"></div><div class="right pagination-item"><a href=/posts/dynamic-linker-hijacking-experiments-2/>Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2)</a></div></div></main><footer class=common-footer><div class=common-footer-bottom><div class=copyright><p>© Dimitar Ganev, 2022<br>Powered by <a target=_blank rel="noopener noreferrer" href=https://gohugo.io/>Hugo</a>, theme <a target=_blank rel="noopener noreferrer" href=https://github.com/mitrichius/hugo-theme-anubis>Anubis</a>.<br></p></div><script>const STORAGE_KEY="user-color-scheme",defaultTheme="dark-without-switcher";let currentTheme,switchButton,autoDefinedScheme=window.matchMedia("(prefers-color-scheme: dark)");const autoChangeScheme=e=>{currentTheme=e.matches?"dark":"light",document.documentElement.setAttribute("data-theme",currentTheme),changeButtonText()};document.addEventListener("DOMContentLoaded",function(){switchButton=document.querySelector(".theme-switcher"),currentTheme=detectCurrentScheme(),currentTheme=="dark"&&document.documentElement.setAttribute("data-theme","dark"),currentTheme=="auto"&&(autoChangeScheme(autoDefinedScheme),autoDefinedScheme.addListener(autoChangeScheme)),switchButton&&(changeButtonText(),switchButton.addEventListener("click",switchTheme,!1)),showContent()});function detectCurrentScheme(){return localStorage.getItem(STORAGE_KEY)?localStorage.getItem(STORAGE_KEY):defaultTheme?defaultTheme:window.matchMedia?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":"light"}function changeButtonText(){switchButton&&(switchButton.textContent=currentTheme=="dark"?"Light theme":"Dark theme")}function switchTheme(){currentTheme=="dark"?(localStorage.setItem(STORAGE_KEY,"light"),document.documentElement.setAttribute("data-theme","light"),currentTheme="light"):(localStorage.setItem(STORAGE_KEY,"dark"),document.documentElement.setAttribute("data-theme","dark"),currentTheme="dark"),changeButtonText()}function showContent(){document.body.style.visibility="visible",document.body.style.opacity=1}</script></div><p class="h-card vcard"><a href=https://sy1.sh class="p-name u-url url fn" rel=me>Dimitar Ganev</a>
/
<a class="p-email u-email email" rel=me href=mailto:dganev@pm.me>dganev@pm.me</a></p></footer></div></body></html>