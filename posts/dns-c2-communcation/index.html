<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Using DNS as C2 Communication - Evasive Techniques (Part 3) | 0x73796C31</title><meta name=keywords content><meta name=description content="Series Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1) Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2) (this one) Overview Following my last post about some evasion techniques that the Symbiote uses which I tried to recreate in their simplest form, this post will see how the Symbiote is communicating to the command and control C2 server.
Upon reading the article, we can see that the Symbiote uses the DNS Protocol to exfiltrate data out of the infected machine, the way that it does that is by chunking it into a bunch of A Resource Records (RR) that it sends through the UDP."><meta name=author content="Dimitar Ganev"><link rel=canonical href=https://sy1.sh/posts/dns-c2-communcation/><link crossorigin=anonymous href=/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://sy1.sh/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://sy1.sh/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://sy1.sh/favicon-32x32.png><link rel=apple-touch-icon href=https://sy1.sh/apple-touch-icon.png><link rel=mask-icon href=https://sy1.sh/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Using DNS as C2 Communication - Evasive Techniques (Part 3)"><meta property="og:description" content="Series Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1) Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2) (this one) Overview Following my last post about some evasion techniques that the Symbiote uses which I tried to recreate in their simplest form, this post will see how the Symbiote is communicating to the command and control C2 server.
Upon reading the article, we can see that the Symbiote uses the DNS Protocol to exfiltrate data out of the infected machine, the way that it does that is by chunking it into a bunch of A Resource Records (RR) that it sends through the UDP."><meta property="og:type" content="article"><meta property="og:url" content="https://sy1.sh/posts/dns-c2-communcation/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-26T20:45:03+03:00"><meta property="article:modified_time" content="2022-10-26T20:45:03+03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using DNS as C2 Communication - Evasive Techniques (Part 3)"><meta name=twitter:description content="Series Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1) Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2) (this one) Overview Following my last post about some evasion techniques that the Symbiote uses which I tried to recreate in their simplest form, this post will see how the Symbiote is communicating to the command and control C2 server.
Upon reading the article, we can see that the Symbiote uses the DNS Protocol to exfiltrate data out of the infected machine, the way that it does that is by chunking it into a bunch of A Resource Records (RR) that it sends through the UDP."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://sy1.sh/posts/"},{"@type":"ListItem","position":3,"name":"Using DNS as C2 Communication - Evasive Techniques (Part 3)","item":"https://sy1.sh/posts/dns-c2-communcation/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using DNS as C2 Communication - Evasive Techniques (Part 3)","name":"Using DNS as C2 Communication - Evasive Techniques (Part 3)","description":"Series Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1) Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2) (this one) Overview Following my last post about some evasion techniques that the Symbiote uses which I tried to recreate in their simplest form, this post will see how the Symbiote is communicating to the command and control C2 server.\nUpon reading the article, we can see that the Symbiote uses the DNS Protocol to exfiltrate data out of the infected machine, the way that it does that is by chunking it into a bunch of A Resource Records (RR) that it sends through the UDP.","keywords":[],"articleBody":"Series Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1) Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2) (this one) Overview Following my last post about some evasion techniques that the Symbiote uses which I tried to recreate in their simplest form, this post will see how the Symbiote is communicating to the command and control C2 server.\nUpon reading the article, we can see that the Symbiote uses the DNS Protocol to exfiltrate data out of the infected machine, the way that it does that is by chunking it into a bunch of A Resource Records (RR) that it sends through the UDP. The A Record looks like this:\n{PACKET_NUMBER}.{MACHINE_ID}.{HEX_ENCODED_PAYLOAD}.{DOMAIN_NAME} I will deliberately skip the whole authentication process that the malware uses, since it gets out of the scope of the post.\nWhy DNS and not {arbitrary protocol}? DNS is being used in order to avoid/bypass the firewall rules and in some special scenarios that no TCP outgoing communication is possible.\nBypassing security products via DNS data exfiltration\nImplementation I will explain it briefly from the agent’s point of view. We are sending the C2 server a beam (in a shape of a DNS request) every n seconds to check if there is a command for us to execute if we receive a non empty Answer with a TXT Record (containing a command such as ls) we execute that command and after we have the output of the command, we exfiltrate it back to the C2 Server. This happens by sending multiple DNS A record questions (chunks) back to the server. I used the same format that the Symbiote uses for the records.\nNote: Each element of a domain name can contain up to 63 chars of information, a full domain name can contain 253 chars. More info\nAfter the server receives a request with the packet number and the total number of packets (that’s the first part of the message) it starts building the output message that we will see after we receive all the packets (through the {HEX_ENCODED_PAYLOAD} part of the message).\nCode / Demo Repository - The repository is created for a starting point to improve/build upon.\nThe repository contains both the agent and the server. When the server is being ran it sets the default handler dns.HandleFunc(\".\", AgentHandler) to handle any pattern for domain question this is for convenience, in some other cases you will want to specify some special handles.\nUsage Start the server $ go run main.go 127.0.0.1:8053 Start the agent $ go run ./agent/main.go Execute commands on the server side shell (In the case below simple dir). Note that I type cmd /C dir - Why? \u003e\u003c((((\u003e dns c2 by syl \u003c))))\u003e\u003c dnsc2\u003e cmd /C dir Volume in drive C is OS Volume Serial Number is XXXX-XXXX Directory of C:\\code\\dnsc2\\agent 10/28/2022 08:40 PM . 10/29/2022 11:03 PM .. 10/28/2022 08:40 PM 481 go.mod 10/28/2022 08:40 PM 3,755 go.sum 10/30/2022 12:37 PM 1,762 main.go 3 File(s) 5,998 bytes 2 Dir(s) 107,561,959,424 bytes free Conclusion Please note that there could be some easier ways to do this, and some information can be wrong I did my best to research everything that I post here, if you find an error or if you think that something can be improved somewhere you can drop me a message!\nResources https://blogs.blackberry.com/en/2022/06/symbiote-a-new-nearly-impossible-to-detect-linux-threat https://stackoverflow.com/a/28918017 https://www.cloudflare.com/learning/dns/what-is-dns/ https://resources.infosecinstitute.com/topic/bypassing-security-products-via-dns-data-exfiltration/ ","wordCount":"559","inLanguage":"en","datePublished":"2022-10-26T20:45:03+03:00","dateModified":"2022-10-26T20:45:03+03:00","author":{"@type":"Person","name":"Dimitar Ganev"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sy1.sh/posts/dns-c2-communcation/"},"publisher":{"@type":"Organization","name":"0x73796C31","logo":{"@type":"ImageObject","url":"https://sy1.sh/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://sy1.sh accesskey=h title="0x73796C31 (Alt + H)">0x73796C31</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://sy1.sh/posts/ title=Archive><span>Archive</span></a></li><li><a href=https://sy1.sh/cv title=CV><span>CV</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://sy1.sh>Home</a>&nbsp;»&nbsp;<a href=https://sy1.sh/posts/>Posts</a></div><h1 class=post-title>Using DNS as C2 Communication - Evasive Techniques (Part 3)</h1><div class=post-meta><span title='2022-10-26 20:45:03 +0300 +0300'>2022-10-26</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;Dimitar Ganev&nbsp;|&nbsp;<a href=https://github.com/syrull/syrull.github.io/tree/main/content/posts/DNS-c2-communcation.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><ul><li><a href=#series aria-label=Series>Series</a></li><li><a href=#overview aria-label=Overview>Overview</a></li><li><a href=#why-dns-and-not-arbitrary-protocol aria-label="Why DNS and not {arbitrary protocol}?">Why DNS and not {arbitrary protocol}?</a></li><li><a href=#implementation aria-label=Implementation>Implementation</a></li><li><a href=#code--demo aria-label="Code / Demo">Code / Demo</a><ul><li><a href=#usage aria-label=Usage>Usage</a></li></ul></li><li><a href=#conclusion aria-label=Conclusion>Conclusion</a></li></ul><li><a href=#resources aria-label=Resources>Resources</a></li></ul></div></details></div><div class=post-content><h2 id=series>Series<a hidden class=anchor aria-hidden=true href=#series>#</a></h2><ol><li><a href=https://sy1.sh/posts/dynamic-linker-hijacking-experiments/>Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1)</a></li><li><a href=https://sy1.sh/posts/dynamic-linker-hijacking-experiments-2/>Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2)</a></li><li>(this one)</li></ol><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p>Following my last post about some evasion techniques that the <a href=https://blogs.blackberry.com/en/2022/06/symbiote-a-new-nearly-impossible-to-detect-linux-threat>Symbiote</a> uses which I tried to recreate in their simplest form, this post will see how the Symbiote is communicating to the command and control <a href=https://www.malwarepatrol.net/command-control-servers-c2-servers-fundamentals/>C2</a> server.</p><p>Upon reading the article, we can see that the Symbiote uses the DNS Protocol to exfiltrate data out of the infected machine, the way that it does that is by chunking it into a bunch of <a href=https://www.cloudflare.com/learning/dns/dns-records/dns-a-record/>A</a> Resource Records (RR) that it sends through the UDP. The <code>A</code> Record looks like this:</p><pre tabindex=0><code>{PACKET_NUMBER}.{MACHINE_ID}.{HEX_ENCODED_PAYLOAD}.{DOMAIN_NAME}
</code></pre><p>I will deliberately skip the whole authentication process that the malware uses, since it gets out of the scope of the post.</p><h2 id=why-dns-and-not-arbitrary-protocol>Why DNS and not {arbitrary protocol}?<a hidden class=anchor aria-hidden=true href=#why-dns-and-not-arbitrary-protocol>#</a></h2><p>DNS is being used in order to avoid/bypass the firewall rules and in some special scenarios that no TCP outgoing communication is possible.</p><p><a href=https://resources.infosecinstitute.com/topic/bypassing-security-products-via-dns-data-exfiltration/>Bypassing security products via DNS data exfiltration</a></p><h2 id=implementation>Implementation<a hidden class=anchor aria-hidden=true href=#implementation>#</a></h2><p>I will explain it briefly from the agent&rsquo;s point of view. We are sending the C2 server a beam (in a shape of a DNS request) every n seconds to check if there is a command for us to execute if we receive a non empty Answer with a <code>TXT</code> Record (containing a command such as <code>ls</code>) we execute that command and after we have the output of the command, we exfiltrate it back to the C2 Server. This happens by sending multiple DNS A record questions (chunks) back to the server. I used the same format that the Symbiote uses for the records.</p><p>Note: Each element of a domain name can contain up to 63 chars of information, a full domain name can contain 253 chars. <a href=https://stackoverflow.com/a/28918017>More info</a></p><p>After the server receives a request with the packet number and the total number of packets (that&rsquo;s the first part of the message) it starts building the output message that we will see after we receive all the packets (through the <code>{HEX_ENCODED_PAYLOAD}</code> part of the message).</p><h2 id=code--demo>Code / Demo<a hidden class=anchor aria-hidden=true href=#code--demo>#</a></h2><p><a href=https://github.com/syrull/dnsc2>Repository</a> - The repository is created for a starting point to improve/build upon.</p><p><img loading=lazy src=/dnsc2/demo.gif alt=DNSC2Demo></p><p>The repository contains both the agent and the server. When the server is being ran it sets the default handler <code>dns.HandleFunc(".", AgentHandler)</code> to handle any pattern for domain question this is for convenience, in some other cases you will want to specify some special handles.</p><h3 id=usage>Usage<a hidden class=anchor aria-hidden=true href=#usage>#</a></h3><ol><li>Start the server<div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> go run main.go 127.0.0.1:8053 
</span></span></code></pre></div></li><li>Start the agent<div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> go run ./agent/main.go
</span></span></code></pre></div></li><li>Execute commands on the server side shell (In the case below simple <code>dir</code>). Note that I type <code>cmd /C dir</code> - <a href=https://superuser.com/a/1246360>Why?</a><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>&gt;</span>&lt;<span class=o>((((</span>&gt; dns c2 by syl &lt;<span class=o>))))</span>&gt;&lt;
</span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>dnsc2&gt; cmd /C dir
</span></span></span><span class=line><span class=cl><span class=go>Volume in drive C is OS
</span></span></span><span class=line><span class=cl><span class=go>Volume Serial Number is XXXX-XXXX
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>Directory of C:\code\dnsc2\agent
</span></span></span><span class=line><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=go>10/28/2022  08:40 PM    &lt;DIR&gt;          .
</span></span></span><span class=line><span class=cl><span class=go>10/29/2022  11:03 PM    &lt;DIR&gt;          ..
</span></span></span><span class=line><span class=cl><span class=go>10/28/2022  08:40 PM               481 go.mod
</span></span></span><span class=line><span class=cl><span class=go>10/28/2022  08:40 PM             3,755 go.sum
</span></span></span><span class=line><span class=cl><span class=go>10/30/2022  12:37 PM             1,762 main.go
</span></span></span><span class=line><span class=cl><span class=go>            3 File(s)          5,998 bytes
</span></span></span><span class=line><span class=cl><span class=go>            2 Dir(s)  107,561,959,424 bytes free
</span></span></span></code></pre></div></li></ol><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Please note that there could be some easier ways to do this, and some information can be wrong I did my best to research everything that I post here, if you find an error or if you think that something can be improved somewhere you can drop me a message!</p><h1 id=resources>Resources<a hidden class=anchor aria-hidden=true href=#resources>#</a></h1><ul><li><a href=https://blogs.blackberry.com/en/2022/06/symbiote-a-new-nearly-impossible-to-detect-linux-threat>https://blogs.blackberry.com/en/2022/06/symbiote-a-new-nearly-impossible-to-detect-linux-threat</a></li><li><a href=https://stackoverflow.com/a/28918017>https://stackoverflow.com/a/28918017</a></li><li><a href=https://www.cloudflare.com/learning/dns/what-is-dns/>https://www.cloudflare.com/learning/dns/what-is-dns/</a></li><li><a href=https://resources.infosecinstitute.com/topic/bypassing-security-products-via-dns-data-exfiltration/>https://resources.infosecinstitute.com/topic/bypassing-security-products-via-dns-data-exfiltration/</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://sy1.sh/posts/static-analysis-research-p1/><span class=title>« Prev</span><br><span>Static Analysis Research - Windows PE</span></a>
<a class=next href=https://sy1.sh/posts/dynamic-linker-hijacking-experiments-2/><span class=title>Next »</span><br><span>Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2)</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://sy1.sh>0x73796C31</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>